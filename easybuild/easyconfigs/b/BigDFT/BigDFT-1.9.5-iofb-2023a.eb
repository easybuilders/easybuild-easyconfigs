##
# Author: Ali Kerrache, University of Manitoba. Bart Oldeman, CQ, McGill
# Date: May 17, 2018, Nov 13, 2024
##

easyblock = 'CmdCp'

name = 'BigDFT'
version = '1.9.5'

homepage = 'http://bigdft.org/Wiki/index.php?title=BigDFT_website'
description = """BigDFT is a DFT massively parallel electronic structure code using a wavelet basis set with the capability to use a linear scaling method. Wavelets form a real space basis set distributed on an adaptive mesh (two levels of resolution in our implementation).
 GTH or HGH pseudopotentials are used to remove the core electrons. The code BigDFT is available in ABINIT v5.5 and higher but can also be downloaded in a standalone version from the website. Thanks to our Poisson solver based on a Green function formalism, periodic systems, surfaces and isolated systems can be simulated with explicit boundary conditions. The Poisson solver can also be downloaded and used independently and is integrated in ABINIT, Octopus and CP2K. The code is free software, available under GNU-GPL license and the BigDFT developer community encourages anyone willing to contribute to join the team."""

toolchain = {'name': 'iofb', 'version': '2023a'}
toolchainopts = {'usempi': True, 'pic': True}

source_urls = ['https://gitlab.com/l_sim/%(namelower)s-suite/-/archive/%(version)s/']
sources = ['%(namelower)s-suite-%(version)s.tar.gz']
checksums = ['5fe51e92bb746569207295feebbcd154ce4f1b364a3981bace75c45e983b2741']

builddependencies = [('SciPy-Stack', '2024b')]
multi_deps = {"Python": ["3.12", "3.11", "3.10"]}

dependencies = [
    #('ETSF_IO', '1.0.4', '-mpi'), #does not compile with ETSF support
    ('ScaLAPACK', '2.2.0', '-fb'),
    ('netCDF', '4.9.2', '-mpi'),
    ('netCDF-Fortran', '4.6.1', '-mpi'),
]

local_cmds = """
    sed -i "s/skip = \[\]/skip = \['libyaml', 'PyYAML', 'PyBigDFT'\]/" defaults.jhbuildrc
    cd PyBigDFT
    pip install . --prefix ../../build/install
    cd ../../build
    ../%(namelower)s-suite-%(version)s/Installer.py build -y -c --with-ext-linalg='"$LIBLAPACK -lscalapack"'
"""

cmds_map = [('.*', local_cmds)]
files_to_copy = ['../build/install/*']

local_binary_files = [ 
     "abscalc", "bader", "bigdft-tool", "frequencies", "matchrotation", 
     "rotate_posinp", "unitconversion_posinp", "analyze_georelax", 
     "bigdft", "fermi", "memguess", "p_axis_posinp", "wocc",
]

sanity_check_paths = {
    'files': ['bin/%s' % x for x in local_binary_files],
    'dirs': ['lib/pkgconfig', 'include'],
}

modextrapaths = {'EBPYTHONPREFIXES': ''}

moduleclass = 'chem'
