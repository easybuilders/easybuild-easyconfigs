easyblock = 'ConfigureMake'

name = 'pbs_python'
version = '4.3.5'

homepage = ''
description = """The pbs_python package is a wrapper class for the Torque Batch
System C library. With this package, you now can write utilities and extensions
in Python instead of C. This package was developed to replace xpbsmon by an
ASCII version named pbsmon. PBSQuery is also included in this package. This is a
Python module built on top of the pbs Python module to simplify querying the
batch server. There are a lot of examples included in the source package.  """

toolchain = {'name': 'intel', 'version': '2015a'}
toolchainopts = {'usempi': True}

source_urls = [
    'http://ftp.sara.nl/pub/outgoing/',
    'https://raw.github.com/adaptivecomputing/torque/4.2-dev/src/include/',
    'https://oss.trac.surfsara.nl/pbs_python/raw-attachment/ticket/36/',
    ]

# torque-devel is missing a log.h file we need, so we ship it.
my_startdir = "%s-%s/" % (name, version)

place_for_include_file = "include/torque"
copy_cmd = 'mkdir -p %s%%s && cp %%%%s %s%%s ' % (my_startdir, my_startdir)

sources = [
    SOURCE_TAR_GZ,
    ('log.h', copy_cmd % (place_for_include_file, place_for_include_file)),
    ('pbs_wrap_4.2.c', copy_cmd % ('src', 'src')),
]

patches = [
    'docdir.patch',
    'setup.py.in_4.2.patch',
]

python = 'Python'
pythonver = '2.7.9'
pythonshortver = '.'.join(pythonver.split('.')[0:2])
versionsuffix = '-%s-%s' % (python, pythonver)

osdependencies = ['torque-devel']
dependencies = [
    (python, pythonver),
]

# this is needed for setup.py script
preconfigopts = 'export PBS_PYTHON_INCLUDEDIR="$PWD/%s" && ' % place_for_include_file
configopts = "--datarootdir=%(installdir)s --docdir=%(installdir)s"
prebuildopts = ' %s export CFLAGS="$CFLAGS -I$PWD/%s -I/usr/include/torque/" && ' % (preconfigopts, place_for_include_file)
preinstallopts = prebuildopts

pythonpath = 'lib/python%s/site-packages/' % pythonshortver
modextrapaths = {"PYTHONPATH": pythonpath}

sanity_check_paths = {
    'files': [],
    'dirs': ["%spbs" % pythonpath]
}

moduleclass = 'tools'
