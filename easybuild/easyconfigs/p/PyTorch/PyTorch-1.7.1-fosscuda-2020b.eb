name = 'PyTorch'
version = '1.7.1'

homepage = 'https://pytorch.org/'
description = """Tensors and Dynamic neural networks in Python with strong GPU acceleration.
PyTorch is a deep learning framework that puts Python first."""

toolchain = {'name': 'fosscuda', 'version': '2020b'}

osdependencies = [OS_PKG_IBVERBS_DEV]

builddependencies = [
    ('CMake', '3.18.4'),
    ('hypothesis', '5.41.5'),
]

dependencies = [
    ('Ninja', '1.10.1'),  # Required for JIT compilation of C++ extensions
    ('Python', '3.8.6'),
    ('protobuf', '3.14.0'),
    ('protobuf-python', '3.14.0'),
    ('pybind11', '2.6.0'),
    ('SciPy-bundle', '2020.11'),
    ('typing-extensions', '3.7.4.3'),
    ('PyYAML', '5.3.1'),
    ('MPFR', '4.1.0'),
    ('GMP', '6.2.0'),
    ('numactl', '2.0.13'),
    ('FFmpeg', '4.3.1'),
    ('Pillow', '8.0.1'),
    ('cuDNN', '8.0.4.30', '-CUDA-%(cudaver)s', SYSTEM),
    ('magma', '2.5.4'),
    ('NCCL', '2.8.3', '-CUDA-%(cudaver)s'),
]

# default CUDA compute capabilities to use (override via --cuda-compute-capabilities)
cuda_compute_capabilities = ['3.5', '3.7', '5.2', '6.0', '6.1', '7.0', '7.2', '7.5', '8.0']

# PyTorch pulls in a bunch of submodules that are not releases.
# We download the submodule revisions from their repos.
# The list is generated by easybuild-framework/easybuild/scripts/createSubmoduleDeps.sh
local_extract_cmd_pattern = 'tar -C pytorch-%%(version)s/third_party/%s --strip-components=1 -xf %%s'

source_urls = ['https://github.com/pytorch/pytorch/archive']
sources = [
    'v%(version)s.tar.gz',  # PyTorch
    {
        'source_urls': ['https://github.com/Maratyszcza/FP16/archive'],
        'download_filename': '4dfe081cf6bcd15db339cf2680b9281b8451eeb3.tar.gz',
        'filename': 'FP16-20200514.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'FP16',
    },
    {
        'source_urls': ['https://github.com/Maratyszcza/FXdiv/archive'],
        'download_filename': 'b408327ac2a15ec3e43352421954f5b1967701d1.tar.gz',
        'filename': 'FXdiv-20200417.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'FXdiv',
    },
    {
        'source_urls': ['https://github.com/Maratyszcza/NNPACK/archive'],
        'download_filename': '24b55303f5cf65d75844714513a0d1b1409809bd.tar.gz',
        'filename': 'NNPACK-20191007.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'NNPACK',
    },
    {
        'source_urls': ['https://github.com/pytorch/QNNPACK/archive'],
        'download_filename': '7d2a4e9931a82adc3814275b6219a03e24e36b4c.tar.gz',
        'filename': 'QNNPACK-20190828.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'QNNPACK',
    },
    {
        'source_urls': ['https://github.com/google/XNNPACK/archive'],
        'download_filename': '1b354636b5942826547055252f3b359b54acff95.tar.gz',
        'filename': 'XNNPACK-20200323.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'XNNPACK',
    },
    {
        'source_urls': ['https://github.com/google/benchmark/archive'],
        'download_filename': '505be96ab23056580a3a2315abba048f4428b04e.tar.gz',
        'filename': 'benchmark-20180606.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'benchmark',
    },
    {
        'source_urls': ['https://github.com/pytorch/cpuinfo/archive'],
        'download_filename': '63b254577ed77a8004a9be6ac707f3dccc4e1fd9.tar.gz',
        'filename': 'cpuinfo-20200611.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'cpuinfo',
    },
    {
        'source_urls': ['https://github.com/NVlabs/cub/archive'],
        'download_filename': 'd106ddb991a56c3df1b6d51b2409e36ba8181ce4.tar.gz',
        'filename': 'cub-20200512.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'cub',
    },
    {
        'source_urls': ['https://github.com/eigenteam/eigen-git-mirror/archive'],
        'download_filename': 'd41dc4dd74acce21fb210e7625d5d135751fa9e5.tar.gz',
        'filename': 'eigen-20190125.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'eigen',
    },
    {
        'source_urls': ['https://github.com/pytorch/fbgemm/archive'],
        'download_filename': '1d710393d5b7588f5de3b83f51c22bbddf095229.tar.gz',
        'filename': 'fbgemm-20200914.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'fbgemm',
    },
    {
        'source_urls': ['https://github.com/asmjit/asmjit/archive'],
        'download_filename': '9057aa30b620f0662ff51e2230c126a345063064.tar.gz',
        'filename': 'asmjit-20200429.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'fbgemm/third_party/asmjit',
    },
    {
        'source_urls': ['https://github.com/pytorch/cpuinfo/archive'],
        'download_filename': 'd5e37adf1406cf899d7d9ec1d317c47506ccb970.tar.gz',
        'filename': 'cpuinfo-20190201.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'fbgemm/third_party/cpuinfo',
    },
    {
        'source_urls': ['https://github.com/google/googletest/archive'],
        'download_filename': '0fc5466dbb9e623029b1ada539717d10bd45e99e.tar.gz',
        'filename': 'googletest-20180925.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'fbgemm/third_party/googletest',
    },
    {
        'source_urls': ['https://github.com/fmtlib/fmt/archive'],
        'download_filename': 'cd4af11efc9c622896a3e4cb599fa28668ca3d05.tar.gz',
        'filename': 'fmt-20200806.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'fmt',
    },
    {
        'source_urls': ['https://github.com/houseroad/foxi/archive'],
        'download_filename': '4aba696ec8f31794fd42880346dc586486205e0a.tar.gz',
        'filename': 'foxi-20200922.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'foxi',
    },
    {
        'source_urls': ['https://github.com/google/gemmlowp/archive'],
        'download_filename': '3fb5c176c17c765a3492cd2f0321b0dab712f350.tar.gz',
        'filename': 'gemmlowp-20181126.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'gemmlowp/gemmlowp',
    },
    {
        'source_urls': ['https://github.com/facebookincubator/gloo/archive'],
        'download_filename': '3dc0328fe6a9d47bd47c0c6ca145a0d8a21845c6.tar.gz',
        'filename': 'gloo-20200918.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'gloo',
    },
    {
        'source_urls': ['https://github.com/google/googletest/archive'],
        'download_filename': '2fe3bd994b3189899d93f1d5a881e725e046fdc2.tar.gz',
        'filename': 'googletest-20180831.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'googletest',
    },
    {
        'source_urls': ['https://github.com/intel/ideep/archive'],
        'download_filename': 'ba885200dbbc1f144c7b58eba487378eb324f281.tar.gz',
        'filename': 'ideep-20200915.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'ideep',
    },
    {
        'source_urls': ['https://github.com/intel/mkl-dnn/archive'],
        'download_filename': '5ef631a030a6f73131c77892041042805a06064f.tar.gz',
        'filename': 'mkl-dnn-20200909.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'ideep/mkl-dnn',
    },
    {
        'source_urls': ['https://github.com/onnx/onnx/archive'],
        'download_filename': 'a82c6a7010e2e332d8f74ad5b0c726fd47c85376.tar.gz',
        'filename': 'onnx-20200531.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'onnx',
    },
    {
        'source_urls': ['https://github.com/google/benchmark/archive'],
        'download_filename': 'e776aa0275e293707b6a0901e0e8d8a8a3679508.tar.gz',
        'filename': 'benchmark-20180525.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'onnx/third_party/benchmark',
    },
    {
        'source_urls': ['https://github.com/onnx/onnx-tensorrt/archive'],
        'download_filename': 'c153211418a7c57ce071d9ce2a41f8d1c85a878f.tar.gz',
        'filename': 'onnx-tensorrt-20190916.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'onnx-tensorrt',
    },
    {
        'source_urls': ['https://github.com/Maratyszcza/psimd/archive'],
        'download_filename': '072586a71b55b7f8c584153d223e95687148a900.tar.gz',
        'filename': 'psimd-20200517.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'psimd',
    },
    {
        'source_urls': ['https://github.com/Maratyszcza/pthreadpool/archive'],
        'download_filename': '029c88620802e1361ccf41d1970bd5b07fd6b7bb.tar.gz',
        'filename': 'pthreadpool-20200615.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'pthreadpool',
    },
    {
        'source_urls': ['https://github.com/Maratyszcza/PeachPy/archive'],
        'download_filename': '07d8fde8ac45d7705129475c0f94ed8925b93473.tar.gz',
        'filename': 'PeachPy-20180218.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'python-peachpy',
    },
    {
        'source_urls': ['https://github.com/shibatch/sleef/archive'],
        'download_filename': '7f523de651585fe25cade462efccca647dcc8d02.tar.gz',
        'filename': 'sleef-20190730.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'sleef',
    },
    {
        'source_urls': ['https://github.com/01org/tbb/archive'],
        'download_filename': 'a51a90bc609bb73db8ea13841b5cf7aa4344d4a9.tar.gz',
        'filename': 'tbb-20181009.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'tbb',
    },
    {
        'source_urls': ['https://github.com/pytorch/tensorpipe/archive'],
        'download_filename': '95ff9319161fcdb3c674d2bb63fac3e94095b343.tar.gz',
        'filename': 'tensorpipe-20200928.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'tensorpipe',
    },
    {
        'source_urls': ['https://github.com/google/googletest/archive'],
        'download_filename': '2fe3bd994b3189899d93f1d5a881e725e046fdc2.tar.gz',
        'filename': 'googletest-20180831.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'tensorpipe/third_party/googletest',
    },
    {
        'source_urls': ['https://github.com/google/libnop/archive'],
        'download_filename': 'aa95422ea8c409e3f078d2ee7708a5f59a8b9fa2.tar.gz',
        'filename': 'libnop-20200723.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'tensorpipe/third_party/libnop',
    },
    {
        'source_urls': ['https://github.com/libuv/libuv/archive'],
        'download_filename': '02a9e1be252b623ee032a3137c0b0c94afbe6809.tar.gz',
        'filename': 'libuv-20200419.tar.gz',
        'extract_cmd': local_extract_cmd_pattern % 'tensorpipe/third_party/libuv',
    },
]
patches = [
    'PyTorch-1.6.0_fix-test-dataloader-fixed-affinity.patch',
    'PyTorch-1.7.0_fix_altivec_defines.patch',
    'PyTorch-1.7.0_fix_test_DistributedDataParallel.patch',
    'PyTorch-1.7.0_fix-fbgemm-not-implemented-issue.patch',
    'PyTorch-1.7.0_avoid-nan-in-test-torch.patch',
    'PyTorch-1.7.0_increase-distributed-test-timeout.patch',
    'PyTorch-1.7.0_disable-dev-shm-test.patch',
    'PyTorch-1.7.1_add-jit-support-for-cuda11.patch',
    'PyTorch-1.7.1_correctly-pass-jit_opt_level.patch',
    'PyTorch-1.7.1_detect-max-ccc-from-nvrtc.patch',
    'PyTorch-1.7.1_dont-use-gpu-ccc-in-test.patch',
    'PyTorch-1.7.1_validate-num-gpus-in-distributed-test.patch',
    'PyTorch-1.7.1_complex32.patch',
    'PyTorch-1.7.1_bypass-nan-compare.patch',
    'PyTorch-1.7.1_fix-alias-violation-in-bitwise-ops.patch',
    'PyTorch-1.7.1_fix-err-variable.patch',
    'PyTorch-1.7.1_fix-use-after-destruct-in-cudaipctypes.patch',
    'PyTorch-1.7.1_disable-tf32-in-distributed-tests.patch',
    'PyTorch-1.7.1_relax_precision_in_test_nn.patch',
    'PyTorch-1.7.1_run-large-tests-on-GPU.patch',
    'PyTorch-1.7.1_disable-failing-cuda-11.2-tests.patch',
]
checksums = [
    'fc8d6aaf0bdedd4221617be8d47ac39af57605bdcc814fabc28739427b55e9c7',  # v1.7.1.tar.gz
    '90f20492621d5ed80b442aa682ff92d7ccf333ac8fac4a10e7e02afb159f3c13',  # FP16-20200514.tar.gz
    '9ccf554541666b5c089ad5dd465141d671c99971f36d72f313652f5c49ffce14',  # FXdiv-20200417.tar.gz
    '1f11dbbfad78d0a4c39fe94e52a28c0821cb25f9880420bb304f6302f73fe002',  # NNPACK-20191007.tar.gz
    '0d752bd75f46ce4d7c6f0a60b0d6c0e5918a7b4683c825284f8db3706dd24f76',  # QNNPACK-20190828.tar.gz
    'b55a6ef3a0b4c0d3c39ad5578eb4fa9a7b2d7ee1ef06592b8a808a59a8e6589b',  # XNNPACK-20200323.tar.gz
    '0de43b6eaddd356f1d6cd164f73f37faf2f6c96fd684e1f7ea543ce49c1d144e',  # benchmark-20180606.tar.gz
    '18a99130ced1eaacab2ba8f75a1435f9955aab54fa0436b60468f020876ee902',  # cpuinfo-20200611.tar.gz
    'd87f6737be1b544c299340b64b9303c1d6ec0447b49b3aaf6642838b4f8280d7',  # cub-20200512.tar.gz
    '2ec954f18cec50a7063a7358ce555f7e11788a7f6d4e7e597d83687dc2f3b989',  # eigen-20190125.tar.gz
    'e7e495fee65a73fa40cf1644f5b9496a6498c7a4209ce4b6b4d7d80f3d3941a4',  # fbgemm-20200914.tar.gz
    '5c7ecb03ede09a38fa9bcf2527a0f1454cd67a34c0e6fd939ae4d93b276ce982',  # asmjit-20200429.tar.gz
    '3f2dc1970f397a0e59db72f9fca6ff144b216895c1d606f6c94a507c1e53a025',  # cpuinfo-20190201.tar.gz
    'e99b904983d08ac8e9bddb5b0d21196b78ad9499e3c5d12192cee2ddd2b7515c',  # googletest-20180925.tar.gz
    '0654ea5a1899f373fee87ae00ca3478aef227c3cf23916572421c6ce25d274bc',  # fmt-20200806.tar.gz
    '10a3774a2ebef7a09dd5c9a6b7bfdc9d3e4eb153711572864d4cc560637727c3',  # foxi-20200922.tar.gz
    'fdd6f08bdb33d33f4df516ffb91730fdb163479c19502cfc983083fd9cf43bfa',  # gemmlowp-20181126.tar.gz
    '9c6bace1c2af3ee186a84c791ba61a6ba92ecbe8a3990839d895771219a73ebc',  # gloo-20200918.tar.gz
    'd0d447b4feeedca837a0d46a289d4223089b32ac2f84545fa4982755cc8919be',  # googletest-20180831.tar.gz
    'f205584378d9b0b6aeae9558b9d578469235f4e394e71b44ead616881e5fb210',  # ideep-20200915.tar.gz
    '4234ce25fd8bb64899493bb21c2473559d6bcfe098309fe74e351945475da930',  # mkl-dnn-20200909.tar.gz
    'c3bf8cc8091b24c43aa205a1f2037a518d249eb5997bea7f543b7fc880e80e21',  # onnx-20200531.tar.gz
    'c7682e9007ddfd94072647abab3e89ffd9084089460ae47d67060974467b58bf',  # benchmark-20180525.tar.gz
    '314cde420a7cf692bdb6877bc6af6bc514805f6cdb8bee90f32566ed08d94b1c',  # onnx-tensorrt-20190916.tar.gz
    'f6c4dab91ae9a03b3019e7cab0572743afd0e1b6e75b97fcca50259c737c924e',  # psimd-20200517.tar.gz
    'd13818a10a645d557202aa005606337b2a0cdf690e5655253800ab11abb0c076',  # pthreadpool-20200615.tar.gz
    '13100c3deed300bbf16f87d8af3539f432462bfef9d38f0c7e3e387dc2e88676',  # PeachPy-20180218.tar.gz
    '8cb5fae822077ca9cbc14dcc7bba9a3a35ad519284fc5169f9a176672c63860a',  # sleef-20190730.tar.gz
    # checksum for original download of tbb-20181009.tar.gz from https://github.com/intel/tbb/archive
    ('dc0a8d8d96cb8765782aa6ac1b509ad4db955d9bbb58fa5cc2265f0292756d72',
     # checksum for download of tbb-20181009.tar.gz from https://github.com/01org/tbb/archive
     'be111cf161b587812fa3b106fe550efb6f129b8b0b702fef32fac23af9580e5e'),
    '0039658ffed8d4ff21575651a6f5258853cf8e1ca8bf564822b51f94da28b7fd',  # tensorpipe-20200928.tar.gz
    'd0d447b4feeedca837a0d46a289d4223089b32ac2f84545fa4982755cc8919be',  # googletest-20180831.tar.gz
    '9ee3f3b1efc629dbc3703ece3892e7e05c7048eed7031d06020e38bb30bee3ab',  # libnop-20200723.tar.gz
    '5ca4e9091f3231d8ad8801862dc4e851c23af89c69141d27723157776f7291e7',  # libuv-20200419.tar.gz
    # PyTorch-1.6.0_fix-test-dataloader-fixed-affinity.patch
    'a4208a46cd2098744daaba96cebb96cd91166f8fc616924315e05974bad80c67',
    '98a32023292772984aa53ef739e444ec8b20617b72bd7593c62e884f5d8b2e6c',  # PyTorch-1.7.0_fix_altivec_defines.patch
    # PyTorch-1.7.0_fix_test_DistributedDataParallel.patch
    '5e70e6aecb1916bb8369b8d3f5e4b3cbf7e2b7a015f8099eea330b42775e25c5',
    # PyTorch-1.7.0_fix-fbgemm-not-implemented-issue.patch
    '97febb91ae2d051db9541e1e4c5924c77555ab73ee49ad7d62ef3e4714110297',
    'b899aa94d9e60f11ee75a706563312ccefa9cf432756c470caa8e623991c8f18',  # PyTorch-1.7.0_avoid-nan-in-test-torch.patch
    # PyTorch-1.7.0_increase-distributed-test-timeout.patch
    '95abb468a35451fbd0f864ca843f6ad15ff8bfb909c3fd580f65859b26c9691c',
    '622cb1eaeadc06e13128a862d9946bcc1f1edd3d02b259c56a9aecc4d5406b8a',  # PyTorch-1.7.0_disable-dev-shm-test.patch
    # PyTorch-1.7.1_add-jit-support-for-cuda11.patch
    '7a5a6ca64196f5fe0dc954d387e188695a683cc37790da67f903c52a5dd5a1e7',
    # PyTorch-1.7.1_correctly-pass-jit_opt_level.patch
    'd4d967d47f8a6172fcbf57f0a61835482968850967c4fdb01108b720696a988d',
    # PyTorch-1.7.1_detect-max-ccc-from-nvrtc.patch
    '96241088dbfcd4db93bd5faadecabce6259a495ffd24b75101444cd0e164c12b',
    '12be5139e4e7aeec214bb38b123b09b391cd1ca72ce5ded6e61590cfae801824',  # PyTorch-1.7.1_dont-use-gpu-ccc-in-test.patch
    # PyTorch-1.7.1_validate-num-gpus-in-distributed-test.patch
    'd27f7b5149632512b6fe226837df914aad35c88f8b490856dc6dd90ea1e5d7e6',
    '6028bff2be720cf70acad2129db60fd10872e02c9e460c72bb274228cf90b320',  # PyTorch-1.7.1_complex32.patch
    '0943496231b6857801e2424e561d03897a6982d098cba5b6967017b391a7e977',  # PyTorch-1.7.1_bypass-nan-compare.patch
    # PyTorch-1.7.1_fix-alias-violation-in-bitwise-ops.patch
    'e92f054f1297df83ace901e7af38222787b709ee29580f5f2b89a300ca03666b',
    'abb79e7ffd10be87adfb62e79131c50079c32470031ac22b12b273cfae85ca4c',  # PyTorch-1.7.1_fix-err-variable.patch
    # PyTorch-1.7.1_fix-use-after-destruct-in-cudaipctypes.patch
    '250345aad08fb72deaaee9b249d9661d4ce93d08661b32d7856ed57e4aa8142e',
    # PyTorch-1.7.1_disable-tf32-in-distributed-tests.patch
    '18ecad081a8c940add64040ad9698d3273366acf738a8a44eab1c793d3f49950',
    # PyTorch-1.7.1_relax_precision_in_test_nn.patch
    '4089bd3d2ee1939108ed9ebe9cd98da306df626ea6e59fac52fa877a5ea8a163',
    # PyTorch-1.7.1_run-large-tests-on-GPU.patch
    '06651b6746a27bee1adf15af24e356e188d683241bb186343009dc69c8d5aa9b',
    # PyTorch-1.7.1_disable-failing-cuda-11.2-tests.patch
    '2a9df4face04798f51eee0db83d28a905ea7ac53569cf25ed9f049b0a547702e',
]

excluded_tests = {
    '': [
        # Test from this suite timeout often. The process group backend is deprecated anyway
        'distributed/rpc/test_process_group_agent',
        # Potentially problematic save/load issue with test_lstm on only some machines. Tell users to verify save&load!
        # https://github.com/pytorch/pytorch/issues/43209
        'test_quantization',
    ]
}

runtest = 'cd test && PYTHONUNBUFFERED=1 %(python)s run_test.py --continue-through-error --verbose %(excluded_tests)s'

sanity_check_commands = ["python -c 'import caffe2.python'"]
tests = ['PyTorch-check-cpp-extension.py']

moduleclass = 'devel'
