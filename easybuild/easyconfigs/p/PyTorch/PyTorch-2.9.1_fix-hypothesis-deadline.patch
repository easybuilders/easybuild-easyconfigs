The assertion at the bottom sometimes fails.

From c4312b443fed1fd8e0e28dfe049ce61226936e99 Mon Sep 17 00:00:00 2001
From: FFFrog <ljw1101.vip@gmail.com>
Date: Thu, 25 Sep 2025 16:32:19 +0800
Subject: [PATCH] [Tools] Adapting the Hypothesis library (version 5.x) for use
 with the PyTorch framework (#163748)

Starting from version 5.x, the Hypothesis library removed the timeout setting and only retained the deadline.
Pull Request resolved: https://github.com/pytorch/pytorch/pull/163748
Approved by: https://github.com/albanD, https://github.com/Skylion007
---
 torch/testing/_internal/hypothesis_utils.py | 24 +++++++++++++++------
 1 file changed, 18 insertions(+), 6 deletions(-)

diff --git a/torch/testing/_internal/hypothesis_utils.py b/torch/testing/_internal/hypothesis_utils.py
index f02ef4c9e04b0..a00e1e1a048a0 100644
--- a/torch/testing/_internal/hypothesis_utils.py
+++ b/torch/testing/_internal/hypothesis_utils.py
@@ -7,6 +7,7 @@
 
 import hypothesis
 from functools import reduce
+from importlib.metadata import version
 from hypothesis import assume
 from hypothesis import settings
 from hypothesis import strategies as st
@@ -346,22 +347,33 @@ def tensor_conv(
 
     return X, W, b, groups, tr
 
+
 # We set the deadline in the currently loaded profile.
 # Creating (and loading) a separate profile overrides any settings the user
 # already specified.
-hypothesis_version = hypothesis.version.__version_info__
-current_settings = settings._profiles[settings._current_profile].__dict__
-current_settings['deadline'] = None
-if hypothesis_version >= (3, 16, 0) and hypothesis_version < (5, 0, 0):
-    current_settings['timeout'] = hypothesis.unlimited
+hypothesis_version = tuple(map(int, version("hypothesis").split(".")[:3]))
+
+if (3, 16, 0) <= hypothesis_version < (3, 27, 0):
+    # Hypothesis 3.16 â†’ 3.26: use `timeout` instead of `deadline`
+    settings.register_profile("no_deadline", timeout=hypothesis.unlimited)
+else:
+    # Hypothesis >=3.27: use `deadline=None`
+    settings.register_profile("no_deadline", deadline=None)
+
+# Activate the profile
+settings.load_profile("no_deadline")
+
+
 def assert_deadline_disabled():
+    """Check that deadlines are effectively disabled across Hypothesis versions."""
     if hypothesis_version < (3, 27, 0):
         import warnings
+
         warning_message = (
             "Your version of hypothesis is outdated. "
             "To avoid `DeadlineExceeded` errors, please update. "
             f"Current hypothesis version: {hypothesis.__version__}"
         )
-        warnings.warn(warning_message)
+        warnings.warn(warning_message, stacklevel=2)
     else:
         assert settings().deadline is None
