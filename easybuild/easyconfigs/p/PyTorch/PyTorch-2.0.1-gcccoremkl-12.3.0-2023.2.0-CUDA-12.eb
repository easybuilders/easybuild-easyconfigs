name = 'PyTorch'
version = '2.0.1'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://pytorch.org/'
description = """Tensors and Dynamic neural networks in Python with strong GPU acceleration.
PyTorch is a deep learning framework that puts Python first."""

toolchain = {'name': 'gcccoremkl', 'version': '12.3.0-2023.2.0'}

source_urls = [GITHUB_RELEASE]
sources = ['%(namelower)s-v%(version)s.tar.gz']
patches = [
    'PyTorch-1.7.0_disable-dev-shm-test.patch',
    # 'PyTorch-1.10.0_skip_cmake_rpath.patch',
    # 'PyTorch-1.10.0_fix-kineto-crash.patch',
    # 'PyTorch-1.11.0_fix-fp16-quantization-without-fbgemm.patch',
    'PyTorch-1.11.1_skip-test_init_from_local_shards.patch',
    # 'PyTorch-1.12.0_fix-EmbeddingBag-without-fbgemm.patch',
    'PyTorch-1.12.1_add-hypothesis-suppression.patch',
    # 'PyTorch-1.12.1_fix-skip-decorators.patch',
    'PyTorch-1.12.1_fix-test_cpp_extensions_jit.patch',
    # 'PyTorch-1.12.1_fix-test_wishart_log_prob.patch',
    'PyTorch-1.12.1_fix-TestTorch.test_to.patch',
    # 'PyTorch-1.12.1_fix-use-after-free-in-tensorpipe-agent.patch',
    # 'PyTorch-1.12.1_fix-vsx-loadu.patch',
    # 'PyTorch-1.12.1_fix-vsx-vector-funcs.patch',
    'PyTorch-1.12.1_skip-test_round_robin.patch',
    # 'PyTorch-1.13.1_fix-flaky-jit-test.patch',
    # 'PyTorch-1.13.1_fix-fsdp-fp16-test.patch',
    # 'PyTorch-1.13.1_fix-gcc-12-missing-includes.patch',
    'PyTorch-1.13.1_fix-gcc-12-warning-in-fbgemm.patch',
    # 'PyTorch-1.13.1_fix-numpy-deprecations.patch',
    'PyTorch-1.13.1_fix-protobuf-dependency.patch',
    # 'PyTorch-1.13.1_fix-pytest-args.patch',
    # 'PyTorch-1.13.1_fix-python-3.11-compat.patch',
    'PyTorch-1.13.1_fix-test-ops-conf.patch',
    'PyTorch-1.13.1_fix-warning-in-test-cpp-api.patch',
    # 'PyTorch-1.13.1_increase-tolerance-test_ops.patch',
    # 'PyTorch-1.13.1_install-vsx-vec-headers.patch',
    # 'PyTorch-1.13.1_no-cuda-stubs-rpath.patch',
    # 'PyTorch-1.13.1_remove-flaky-test-in-testnn.patch',
    # 'PyTorch-1.13.1_skip-failing-grad-test.patch',
    'PyTorch-1.13.1_skip-failing-singular-grad-test.patch',
    'PyTorch-1.13.1_skip-tests-without-fbgemm.patch',
]
checksums = [
    {'pytorch-v2.0.1.tar.gz': '9c564ca440265c69400ef5fdd48bf15e28af5aa4bed84c95efaad960a6699998'},
    {'PyTorch-1.7.0_disable-dev-shm-test.patch': '622cb1eaeadc06e13128a862d9946bcc1f1edd3d02b259c56a9aecc4d5406b8a'},
    # {'PyTorch-1.10.0_skip_cmake_rpath.patch': 'ac05943bb205623f91ef140aa00869efc5fe844184bd666bebf5405808610448'},
    #  {'PyTorch-1.10.0_fix-kineto-crash.patch': 'dc467333b28162149af8f675929d8c6bf219f23230bfc0d39af02ba4f6f882eb'},
    #  {'PyTorch-1.11.0_fix-fp16-quantization-without-fbgemm.patch':
    #   'cc526130b6446bbbf5f0f7372d3aeee3e7d4c4d6e471524dff028b430b152934'},
    {'PyTorch-1.11.1_skip-test_init_from_local_shards.patch':
     '4aeb1b0bc863d4801b0095cbce69f8794066748f0df27c6aaaf729c5ecba04b7'},
    #  {'PyTorch-1.12.0_fix-EmbeddingBag-without-fbgemm.patch':
    #  '090598592283e3fc46ee08a68b6a6afe07be41b26514afba51834408bf1c98ed'},
    {'PyTorch-1.12.1_add-hypothesis-suppression.patch':
     'e71ffb94ebe69f580fa70e0de84017058325fdff944866d6bd03463626edc32c'},
    # {'PyTorch-1.12.1_fix-skip-decorators.patch': 'e3ca6e42b2fa592ea095939fb59ab875668a058479407db3f3684cc5c6f4146c'},
    {'PyTorch-1.12.1_fix-test_cpp_extensions_jit.patch':
     '1efc9850c431d702e9117d4766277d3f88c5c8b3870997c9974971bce7f2ab83'},
    # {'PyTorch-1.12.1_fix-test_wishart_log_prob.patch':
    #  'cf475ae6e6234b96c8d1bf917597c5176c94b3ccd940b72f2e1cd0c979580f45'},
    {'PyTorch-1.12.1_fix-TestTorch.test_to.patch': '75f27987c3f25c501e719bd2b1c70a029ae0ee28514a97fe447516aee02b1535'},
    # {'PyTorch-1.12.1_fix-use-after-free-in-tensorpipe-agent.patch':
    #  '0bd7e88b92c4c6f0fecf01746009858ba19f2df68b10b88c41485328a531875d'},
    # {'PyTorch-1.12.1_fix-vsx-loadu.patch': '8bfe3c94ada1dd1f7974a1261a8b576fb7ae944050fa1c7830fca033831123b2'},
    # {'PyTorch-1.12.1_fix-vsx-vector-funcs.patch': 'caccbf60f62eac313896c1eaec78b08f5d0fdfcb907079087490bb13d1561aa2'},
    {'PyTorch-1.12.1_skip-test_round_robin.patch': '63d4849b78605aa088fdff695637d9473ea60dee603a3ff7f788690d70c55349'},
    # {'PyTorch-1.13.1_fix-flaky-jit-test.patch': '71efdeb29b5e5b4982c9f5cb2182733654a34d52f85bb5487bc4d7d99b86101b'},
    # {'PyTorch-1.13.1_fix-fsdp-fp16-test.patch': '8ae68e60d6e1f92f50322b7f0381c7e65251fba32d7606e3a238a36a2f55b5cf'},
    # {'PyTorch-1.13.1_fix-gcc-12-missing-includes.patch':
    #  '18df8c61ecaa9fb659346c1e172828bca6b069f0145bb8f6a36b0a23b7bef0a6'},
    {'PyTorch-1.13.1_fix-gcc-12-warning-in-fbgemm.patch':
     '5c7be91a6096083a0b1315efe0001537499c600f1f569953c6a2c7f4cc1d0910'},
    # {'PyTorch-1.13.1_fix-numpy-deprecations.patch': 'f461b570efe0434ddd806bf2fa7020eb213e3ed89d0eb4403e076f4276ba2a46'},
    {'PyTorch-1.13.1_fix-protobuf-dependency.patch':
     '8bd755a0cab7233a243bc65ca57c9630dfccdc9bf8c9792f0de4e07a644fcb00'},
    # {'PyTorch-1.13.1_fix-pytest-args.patch': 'd3e3c841cf8d73683750f29326f2be56ee0bb5df7ff522baf7d7c3f301a91ec2'},
    # {'PyTorch-1.13.1_fix-python-3.11-compat.patch': 'fa4eb0e27e00a90bb217b77c0023089c4659c03f37d781ab4a681bdcb4f0432f'},
    {'PyTorch-1.13.1_fix-test-ops-conf.patch': 'df652eec7753864ebebbfeca546929a53e3fb8f24259d5c9b964266a8551198c'},
    {'PyTorch-1.13.1_fix-warning-in-test-cpp-api.patch':
     'bdde0f2105215c95a54de64ec4b1a4520528510663174fef6d5b900eb1db3937'},
    # {'PyTorch-1.13.1_increase-tolerance-test_ops.patch':
    #  'c909fdfc2b12df457e1eb5514265ffec3eab653994949416f3f048668421e223'},
    # {'PyTorch-1.13.1_install-vsx-vec-headers.patch':
    #  '7b678f54bb947afd4767f5877ac424b4b94ce5db609ea20f5a869ccf4027035f'},
    # {'PyTorch-1.13.1_no-cuda-stubs-rpath.patch': '4c636059850fc9d1ecb27ce275f8aad5d5b6fdc19e35aff0c25b86cb3201352a'},
    # {'PyTorch-1.13.1_remove-flaky-test-in-testnn.patch':
    #  'be83ff61fe2dedab6d49c232936d5622df81ab49154264490021c6c828e53315'},
    # {'PyTorch-1.13.1_skip-failing-grad-test.patch': '6681200f9509893cb9231b5c93ac9bc5e6d9d9ae4febefca52e7cbc843ba8f51'},
    {'PyTorch-1.13.1_skip-failing-singular-grad-test.patch':
     '72688a57b2bb617665ad1a1d5e362c5111ae912c10936bb38a089c0204729f48'},
    {'PyTorch-1.13.1_skip-tests-without-fbgemm.patch':
     '481e595f673baf8ae58b41697a6792b83048b0264aa79b422f48cd8c22948bb7'},
]

osdependencies = [OS_PKG_IBVERBS_DEV]

builddependencies = [
    ('CMake', '3.26.3'),
    ('hypothesis', '6.82.0'),
    # For tests
    ('pytest-rerunfailures', '12.0'),
    ('pytest-shard', '0.1.2'),
]

dependencies = [
    ('CUDA', '12', '', SYSTEM),
    ('Ninja', '1.11.1'),  # Required for JIT compilation of C++ extensions
    ('Python', '3.11.3'),
    ('Python-bundle-PyPI', '2023.06'),
    ('protobuf', '3.19.4'),
    ('protobuf-python', '3.19.4'),
    ('pybind11', '2.11.1'),
    ('SciPy-bundle', '2023.07', '', ('gcccoremkl', '12.3.0-2023.2.0')),
    ('PyYAML', '6.0'),
    ('MPFR', '4.2.0'),
    ('GMP', '6.2.1'),
    ('numactl', '2.0.16'),
    ('FFmpeg', '6.0'),
    ('Pillow-SIMD', '9.5.0'),
    ('cuDNN', '8.9.4.25', '-CUDA-%(cudaver)s', SYSTEM),
    ('magma', '2.7.2', '-CUDA-12', ('gcccoremkl', '12.3.0-2023.2.0')),
    ('NCCL', 'default', '-CUDA-%(cudaver)s'),
    ('expecttest', '0.1.5'),
    ('sympy', '1.12'),
    ('networkx', '3.1'),
]

configopts = '-DCUDA_CUDA_LIB=/usr/lib64/libcuda.so'
prebuildopts = "CXXFLAGS='-Wno-maybe-uninitialized -Wno-uninitialized -Wno-free-nonheap-object -Wno-nonnull ' "
prebuildopts += "CFLAGS='-Wno-maybe-uninitialized -Wno-uninitialized -Wno-free-nonheap-object -Wno-nonnull ' "

excluded_tests = {
    '': [
        # This test seems to take too long on NVIDIA Ampere at least.
        'distributed/test_distributed_spawn',
        # Broken on CUDA 11.6/11.7: https://github.com/pytorch/pytorch/issues/75375
        'distributions/test_constraints',
        # no xdoctest
        'doctests',
        'distributed/_shard/sharded_tensor/ops/test_linear',
        'distributed/rpc/test_tensorpipe_agent',
        'distributed/test_launcher',
        'test_ops_gradients',
        'test_optim',
        # Tests failing on juwels booster login:
        'distributed/test_c10d_common',
        'distributed/test_c10d_gloo',
        'distributed/test_c10d_nccl',
        'test_ops_fwd_gradients',
        'test_quantization',
        'test_sparse_csr',
        # Tests failing on the compute node"',
        'backends/xeon/test_launch',
        'benchmark_utils/test_benchmark_utils',
        'distributed/_composable/fully_shard/test_fully_shard_init',
        'distributed/_composable/fully_shard/test_fully_shard_mixed_precision',
        'distributed/_composable/fully_shard/test_fully_shard_model_checkpoint',
        'distributed/_composable/fully_shard/test_fully_shard_optim_checkpoint',
        'distributed/_composable/fully_shard/test_fully_shard_runtime',
        'distributed/_composable/test_checkpoint',
        'distributed/_composable/test_compose',
        'distributed/_composable/test_contract',
        'distributed/_composable/test_replicate',
        'distributed/_shard/sharded_optim/test_sharded_optim',
        'distributed/_shard/sharded_tensor/ops/test_binary_cmp',
        'distributed/_shard/sharded_tensor/ops/test_chunk',
        'distributed/_shard/sharded_tensor/ops/test_elementwise_ops',
        'distributed/_shard/sharded_tensor/ops/test_embedding',
        'distributed/_shard/sharded_tensor/ops/test_embedding_bag',
        'distributed/_shard/sharded_tensor/ops/test_init',
        'distributed/_shard/sharded_tensor/ops/test_matrix_ops',
        'distributed/_shard/sharded_tensor/ops/test_softmax',
        'distributed/_shard/sharded_tensor/ops/test_tensor_ops',
        'distributed/_shard/sharded_tensor/test_megatron_prototype',
        'distributed/_shard/sharded_tensor/test_sharded_tensor',
        'distributed/_shard/sharded_tensor/test_sharded_tensor_reshard',
        'distributed/_shard/sharding_plan/test_sharding_plan',
        'distributed/_shard/sharding_spec/test_sharding_spec',
        'distributed/_shard/test_partial_tensor',
        'distributed/_tensor/test_api',
        'distributed/_tensor/test_common_rules',
        'distributed/_tensor/test_device_mesh',
        'distributed/_tensor/test_dtensor',
        'distributed/_tensor/test_dtensor_ops',
        'distributed/_tensor/test_init',
        'distributed/_tensor/test_math_ops',
        'distributed/_tensor/test_matrix_ops',
        'distributed/_tensor/test_pointwise_ops',
        'distributed/_tensor/test_redistribute',
        'distributed/_tensor/test_tensor_ops',
        'distributed/_tensor/test_tp_sharding_ops',
        'distributed/_tensor/test_view_ops',
        'distributed/_tools/test_memory_tracker',
        'distributed/algorithms/ddp_comm_hooks/test_ddp_hooks',
        'distributed/algorithms/quantization/test_quantization',
        'distributed/algorithms/test_join',
        'distributed/checkpoint/test_2d_fsdp_dt_checkpoint',
        'distributed/checkpoint/test_checkpoint',
        'distributed/checkpoint/test_dedup_tensors',
        'distributed/checkpoint/test_file_system_checkpoint',
        'distributed/checkpoint/test_file_system_checkpoint_cpu',
        'distributed/checkpoint/test_fsdp_model_state',
        'distributed/checkpoint/test_fsdp_optim_state',
        'distributed/checkpoint/test_nested_dict',
        'distributed/checkpoint/test_planner',
        'distributed/checkpoint/test_traverse',
        'distributed/checkpoint/test_utils',
        'distributed/elastic/metrics/api_test',
        'distributed/elastic/multiprocessing/api_test',
        'distributed/elastic/timer/local_timer_example',
        'distributed/elastic/timer/local_timer_test',
        'distributed/elastic/utils/distributed_test',
        'distributed/elastic/utils/logging_test',
        'distributed/elastic/utils/util_test',
        'distributed/fsdp/test_checkpoint_wrapper',
        'distributed/fsdp/test_distributed_checkpoint',
        'distributed/fsdp/test_fsdp_apply',
        'distributed/fsdp/test_fsdp_checkpoint',
        'distributed/fsdp/test_fsdp_clip_grad_norm',
        'distributed/fsdp/test_fsdp_comm',
        'distributed/fsdp/test_fsdp_comm_hooks',
        'distributed/fsdp/test_fsdp_core',
        'distributed/fsdp/test_fsdp_exec_order',
        'distributed/fsdp/test_fsdp_flatten_params',
        'distributed/fsdp/test_fsdp_freezing_weights',
        'distributed/fsdp/test_fsdp_fx',
        'distributed/fsdp/test_fsdp_grad_acc',
        'distributed/fsdp/test_fsdp_hybrid_shard',
        'distributed/fsdp/test_fsdp_ignored_modules',
        'distributed/fsdp/test_fsdp_input',
        'distributed/fsdp/test_fsdp_memory',
        'distributed/fsdp/test_fsdp_meta',
        'distributed/fsdp/test_fsdp_misc',
        'distributed/fsdp/test_fsdp_mixed_precision',
        'distributed/fsdp/test_fsdp_multiple_forward',
        'distributed/fsdp/test_fsdp_multiple_wrapping',
        'distributed/fsdp/test_fsdp_optim_state',
        'distributed/fsdp/test_fsdp_overlap',
        'distributed/fsdp/test_fsdp_pure_fp16',
        'distributed/fsdp/test_fsdp_sharded_grad_scaler',
        'distributed/fsdp/test_fsdp_state_dict',
        'distributed/fsdp/test_fsdp_tp_integration',
        'distributed/fsdp/test_fsdp_traversal',
        'distributed/fsdp/test_fsdp_uneven',
        'distributed/fsdp/test_fsdp_unshard_params',
        'distributed/fsdp/test_fsdp_use_orig_params',
        'distributed/fsdp/test_utils',
        'distributed/fsdp/test_wrap',
        'distributed/nn/jit/test_instantiator',
        'distributed/optim/test_zero_redundancy_optimizer',
        'distributed/rpc/cuda/test_tensorpipe_agent',
        'distributed/rpc/test_share_memory',
        'distributed/tensor/parallel/test_2d_parallel',
        'distributed/tensor/parallel/test_parallelize_api',
        'distributed/tensor/parallel/test_tp_examples',
        'distributed/tensor/parallel/test_tp_style',
        'distributed/tensor/parallel/test_view_sharding_dim_change',
        'distributed/test_c10d_error_logger',
        'distributed/test_c10d_object_collectives',
        'distributed/test_c10d_pypg',
        'distributed/test_c10d_spawn_gloo',
        'distributed/test_c10d_spawn_nccl',
        'distributed/test_c10d_spawn_ucc',
        'distributed/test_data_parallel',
        'distributed/test_multi_threaded_pg',
        'distributed/test_nccl',
        'distributed/test_pg_wrapper',
        'distributed/test_store',
        'distributions/test_distributions',
        'lazy/test_debug_util',
        'lazy/test_reuse_ir',
        'lazy/test_step_closures',
        'lazy/test_ts_opinfo',
        'nn/test_convolution',
        'nn/test_dropout',
        'nn/test_embedding',
        'nn/test_lazy_modules',
        'nn/test_module_hooks',
        'nn/test_multihead_attention',
        'nn/test_packed_sequence',
        'nn/test_parametrization',
        'nn/test_pooling',
        'nn/test_pruning',
        'profiler/test_memory_profiler',
        'profiler/test_profiler',
        'profiler/test_profiler_tree',
        'test_ao_sparsity',
        'test_autocast',
        'test_autograd',
        'test_binary_ufuncs',
        'test_bundled_inputs',
        'test_complex',
        'test_cpp_api_parity',
        'test_cpp_extensions_aot_ninja',
        'test_cpp_extensions_aot_no_ninja',
        'test_cpp_extensions_jit',
        'test_cpp_extensions_open_device_registration',
        'test_cuda',
        'test_cuda_nvml_based_avail',
        'test_cuda_primary_ctx',
        'test_cuda_sanitizer',
        'test_cuda_trace',
        'test_dataloader',
        'test_datapipe',
        'test_dispatch',
        'test_dlpack',
        'test_dynamic_shapes',
        'test_expanded_weights',
        'test_fake_tensor',
        'test_foreach',
        'test_function_schema',
        'test_functional_autograd_benchmark',
        'test_functional_optim',
        'test_functionalization',
        'test_futures',
        'test_fx',
        'test_fx_experimental',
        'test_fx_passes',
        'test_fx_reinplace_pass',
        'test_import_stats',
        'test_indexing',
        'test_itt',
        'test_jit',
        'test_jit_autocast',
        'test_jit_cuda_fuser',
        'test_jit_disabled',
        'test_jit_fuser_legacy',
        'test_jit_fuser_te',
        'test_jit_legacy',
        'test_jit_llga_fuser',
        'test_jit_profiling',
        'test_jiterator',
        'test_legacy_vmap',
        'test_license',
        'test_linalg',
        'test_logging',
        'test_masked',
        'test_maskedtensor',
        'test_matmul_cuda',
        'test_meta',
        'test_mkl_verbose',
        'test_mkldnn',
        'test_mkldnn_fusion',
        'test_mkldnn_verbose',
        'test_mobile_optimizer',
        'test_model_dump',
        'test_module_init',
        'test_modules',
        'test_monitor',
        'test_multiprocessing',
        'test_multiprocessing_spawn',
        'test_namedtensor',
        'test_namedtuple_return_api',
        'test_native_functions',
        'test_native_mha',
        'test_nestedtensor',
        'test_nn',
        'test_numba_integration',
        'test_numpy_interop',
        'test_nvfuser_dynamo',
        'test_nvfuser_frontend',
        'test_openmp',
        'test_overrides',
        'test_package',
        'test_per_overload_api',
        'test_prims',
        'test_proxy_tensor',
        'test_public_bindings',
        'test_python_dispatch',
        'test_pytree',
        'test_reductions',
        'test_scatter_gather_ops',
        'test_schema_check',
        'test_serialization',
        'test_set_default_mobile_cpu_allocator',
        'test_shape_ops',
        'test_show_pickle',
        'test_sort_and_select',
        'test_sparse',
        'test_spectral_ops',
        'test_stateless',
        'test_subclass',
        'test_tensor_creation_ops',
        'test_tensorboard',
        'test_tensorexpr',
        'test_tensorexpr_pybind',
        'test_testing',
        'test_torch',
        'test_transformers',
        'test_type_hints',
        'test_type_info',
        'test_type_promotion',
        'test_unary_ufuncs',
        'test_utils',
        'test_view_ops',
        'test_vulkan',
        'test_weak',
        'test_xnnpack_integration',
    ]
}

runtest = 'cd test && PYTHONUNBUFFERED=1 %(python)s run_test.py --continue-through-error  --verbose %(excluded_tests)s'

# The readelf sanity check command can be taken out once the TestRPATH test from
# https://github.com/pytorch/pytorch/pull/87593 is accepted, since it is then checked as part of the PyTorch test suite
local_libcaffe2 = "$EBROOTPYTORCH/lib/python%%(pyshortver)s/site-packages/torch/lib/libcaffe2_nvrtc.%s" % SHLIB_EXT
sanity_check_commands = [
    "readelf -d %s | egrep 'RPATH|RUNPATH' | grep -v stubs" % local_libcaffe2,
]

tests = ['PyTorch-check-cpp-extension.py']

moduleclass = 'ai'
