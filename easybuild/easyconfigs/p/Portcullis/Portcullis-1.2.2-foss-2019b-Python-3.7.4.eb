easyblock = 'Bundle'

name = 'Portcullis'
version = '1.2.2'
versionsuffix = '-Python-%(pyver)s'

homepage = "https://github.com/maplesond/portcullis"
description = """Portcullis stands for PORTable CULLing of Invalid Splice junctions from
pre-aligned RNA-seq data. It is known that RNAseq mapping tools generate many
invalid junction predictions, particularly in deep datasets with high coverage
over splice sites. In order to address this, instead for creating a new RNAseq
mapper, with a focus on SJ accuracy we created a tool that takes in a BAM file
generated by an RNAseq mapper of the user's own choice (e.g. Tophat2, Gsnap,
STAR2 or HISAT2) as input (i.e. it's portable). It then, analyses and quantifies
all splice junctions in the file before, filtering (culling) those which are
unlikely to be genuine. Portcullis output's junctions in a variety of formats
making it suitable for downstream analysis (such as differential splicing
analysis and gene modelling) without additional work. Portcullis can also filter
the original BAM file removing alignments associated with bad junctions."""

toolchain = {'name': 'foss', 'version': '2019b'}

builddependencies = [
    ('Autotools', '20180311'),
    ('pkg-config', '0.29.2'),
]

dependencies = [
    ('Python', '3.7.4'),
    ('SciPy-bundle', '2019.10', versionsuffix),
    ('matplotlib', '3.1.1', versionsuffix),
    ('Boost', '1.71.0'),
    ('SAMtools', '1.10'),
    ('zlib', '1.2.11'),
]

# 1.2.2.tar.gz
local_source_chksum = 'b5788bd257dfabd454716e3425136f9350c0eb3654d4768db0ea21b45a1479ef'
# Portcullis-1.2.2_fix-datadir-path.patch
local_patch_chksum = 'ad318978e2cba236b1e19fee8318c81499a874a4d714a314f5072742ca12cfaa'

# Explicitly set the names of Boost libraries from EB
local_config_boostlibs = "--with-boost-system=boost_system --with-boost-filesystem=boost_filesystem "
local_config_boostlibs += "--with-boost-chrono=boost_chrono --with-boost-program-options=boost_program_options "

# Disable installation of Python packages from makefiles, as those are installed by EB
local_config_pyinstall = "--disable-py-install "

github_account = 'maplesond'

default_component_specs = {
    'source_urls': [GITHUB_LOWER_SOURCE],
    'sources': ['%(version)s.tar.gz'],
    'checksums': [local_source_chksum],
}

components = [
    (name, version, {
        'easyblock': 'ConfigureMake',
        'patches': ['Portcullis-1.2.2_fix-datadir-path.patch'],
        'checksums': [local_source_chksum, local_patch_chksum],
        'start_dir': '%(namelower)s-%(version)s',
        'preconfigopts': './autogen.sh &&',
        'configopts': local_config_boostlibs + local_config_pyinstall,
        'runtest': 'check',
    }),
    ('junctools', version, {
        'easyblock': 'PythonPackage',
        'start_dir': 'portcullis-%(version)s/scripts/%(name)s',
    }),
    ('portcullis-python', version, {
        'easyblock': 'PythonPackage',
        'start_dir': 'portcullis-%(version)s/scripts/portcullis',
        'options': {'modulename': 'portcullis'},
    }),
]

sanity_check_paths = {
    'files': ['bin/portcullis', 'bin/portcullis_rule_filter', 'bin/junctools', 'lib/libportcullis.a'],
    'dirs': ['include', 'lib/pkgconfig', 'lib/python%(pyshortver)s/site-packages', 'share/portcullis'],
}

sanity_check_commands = [
    "portcullis --version",
    "python -c 'import junctools'",
    "python -c 'import portcullis'",
]

modextrapaths = {'PYTHONPATH': 'lib/python%(pyshortver)s/site-packages'}

moduleclass = "bio"
