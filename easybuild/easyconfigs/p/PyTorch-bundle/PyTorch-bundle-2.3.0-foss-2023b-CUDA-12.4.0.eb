easyblock = 'PythonBundle'

name = 'PyTorch-bundle'
version = '2.3.0'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://pytorch.org/'
description = """PyTorch with compatible versions of official Torch extensions."""

toolchain = {'name': 'foss', 'version': '2023b'}

builddependencies = [
    ('CMake', '3.27.6'),
    ('RE2', '2024-03-01'),  # for torchtext
    ('parameterized', '0.9.0'),  # for torchtext and torchaudio tests
    ('scikit-learn', '1.3.2'),  # for torchaudio and pytorch-ignite tests
    ('scikit-image', '0.24.0'),  # for pytorch-ignite tests
    ('dill', '0.3.8'),  # for pytorch-ignite tests
    ('matplotlib', '3.8.2'),  # for pytorch-ignite tests
    ('librosa', '0.10.2.post1'),  # for torchaudio tests
    ('NLTK', '3.8.1'),  # for torchtext tests
    ('Scalene', '1.5.35'),  # for pynvml in ignite tests
]

dependencies = [
    ('CUDA', '12.4.0', '', SYSTEM),
    ('Python', '3.11.5'),
    ('PyTorch', version, versionsuffix),
    ('Pillow-SIMD', '10.4.0'),  # for torchvision
    ('libjpeg-turbo', '3.0.1'),  # for torchvision
    ('FFmpeg', '6.0'),  # for torchvision and torchaudio
    ('SoX', '14.4.2'),  # for torchaudio
    ('SentencePiece', '0.2.0'),  # for torchtext
    ('tqdm', '4.66.2'),  # for torchtext
    ('double-conversion', '3.3.0'),  # for torchtext
    ('utf8proc', '2.9.0'),  # for torchtext
    ('tensorboard', '2.15.1'),  # for torch-tb-profiler
    ('h5py', '3.11.0'),  # for tensordict
]

local_preinstall_opts = ' '.join([
    'USE_SYSTEM_LIBS=1',
    'USE_OPENMP=1',
    'USE_CUDA=1', 'TORCH_CUDA_ARCH_LIST="%(cuda_cc_semicolon_sep)s"',
    'USE_CUDNN=1',
    'USE_FFMPEG=1', 'FFMPEG_ROOT="$EBROOTFFMPEG"',
    'CMAKE_BUILD_PARALLEL_LEVEL=%(parallel)s',
]) + ' '

exts_default_options = {
    'preinstallopts': local_preinstall_opts,
    'prebuildopts': local_preinstall_opts,
    'sources': [{'download_filename': V_VERSION_TAR_GZ, 'filename': SOURCE_TAR_GZ}],  # Most are git downloads
}

# Check with https://pytorch.org/audio/stable/installation.html#compatibility-matrix
exts_list = [
    ('portalocker', '2.8.2', {
        'sources': [SOURCE_TAR_GZ],
        'checksums': ['2b035aa7828e46c58e9b31390ee1f169b98e1066ab10b9a6a861fe7e25ee4f33'],
    }),
    ('torchdata', '0.8.0', {
        'source_urls': ['https://github.com/pytorch/data/archive'],
        'checksums': ['d5d27b264e79d7d00ad4998f14d097b770332d979672dceb6d038caf204f1208'],
        'runtest': False,  # circular test requirements
    }),
    ('torchtext', '0.16.2', {
        'patches': [
            'torchtext-0.14.1_use-system-libs.patch',
            'torchtext-0.16.2_download-to-project-root.patch',
        ],
        'source_urls': ['https://github.com/pytorch/text/archive'],
        'checksums': [
            {'torchtext-0.16.2.tar.gz': '6574b012804f65220329a2ad34a95c18e4df0d4cff2f862fb7862d57b374b013'},
            {'torchtext-0.14.1_use-system-libs.patch':
             'a29ce29259d8c1cf3533cdc23c66e68eec660d6206ae04ced0220a7c02712b53'},
            {'torchtext-0.16.2_download-to-project-root.patch':
             '9d5599a9983729cf1fc7ab2a2f65d1887f223f528e15662ba1b4a5e359c9686d'},
        ],
        'runtest': (
            'pytest test/torchtext_unittest'
            ' -k "not test_vocab_from_raw_text_file"'  # segfaults
            '" and not test_get_tokenizer_moses"'  # requires sacremoses
            '" and not test_get_tokenizer_spacy"'  # requires spaCy
            '" and not test_download_charngram_vectors"'  # requires internet access and required host may fail
            '" and not test_download_glove_vectors"'  # requires internet access and required host may fail
            '" and not test_vectors_get_vecs"'  # requires internet access and required host may fail
        ),
        'testinstall': True,
    }),
    ('pytest-mock', '3.11.1', {  # for torchvision tests
        'sources': [SOURCE_TAR_GZ],
        'checksums': ['7f6b125602ac6d743e523ae0bfa71e1a697a2f5534064528c6ff84c2f7c2fc7f'],
    }),
    ('torchvision', '0.16.2', {
        'installopts': '-v',
        'patches': [
            'torchvision-0.16.2_ffmpeg-6.0-fix.patch',
            'torchvision-0.16.2_quantized_tol.patch',
        ],
        'source_urls': ['https://github.com/pytorch/vision/archive'],
        'checksums': [
            {'torchvision-0.16.2.tar.gz': '8c1f2951e98d8ada6e5a468f179af4be9f56d2ebc3ab057af873da61669806d7'},
            {'torchvision-0.16.2_ffmpeg-6.0-fix.patch':
             'a49336e7bfa1c950e886852bff37a3ea2146ac7bda87241e3ffb31c5cb869cce'},
            {'torchvision-0.16.2_quantized_tol.patch':
             '457cdf8ad6653838c552890bce95dbe30b7573b1643334284f5f4a58f74f6e40'},
        ],
        'runtest': (
            'pytest'
            ' -m "not xfail"'  # don't run tests that are expected that they might fail
            ' -k "not test_frame_reading_mem_vs_file"'  # this one hangs
        ),
        'testinstall': True,
    }),
    ('torchaudio', version, {
        'patches': [
            'torchaudio-2.1.2_transform_test_tol.patch',
            'torchaudio-2.3.0_remove-librosa-version-check.patch',
            'torchaudio-2.3.0_use-external-sox.patch',
        ],
        'preinstallopts': ('unset BUILD_VERSION && '
                           'rm -r third_party/{sox,ffmpeg/multi}; '  # runs twice when testinstall
                           + local_preinstall_opts),
        'source_urls': ['https://github.com/pytorch/audio/archive'],
        'checksums': [
            {'torchaudio-2.3.0.tar.gz': '83f6351754ed57cb625b1322bab8e12c9140213a9b79626cc5bf7dfd122f869d'},
            {'torchaudio-2.1.2_transform_test_tol.patch':
             '57f315c60db70ed2bd9711bcf6f7c7c24dac8c2f04e00488996eb2dc507bdfd2'},
            {'torchaudio-2.3.0_remove-librosa-version-check.patch':
             'a98ce800ef0f3bd551b5f7ecec00f7164c4066e1799bdc9838c3f231e2b06622'},
            {'torchaudio-2.3.0_use-external-sox.patch':
             'da765487aa7ec83f9ebe603b11365bfe3a70b3492982a6aa504d945b9aa91da8'},
        ],
        'runtest': (
            'pytest test/torchaudio_unittest/'
            ' -k "not TestProcessPoolExecutor"'  # hang maybe related https://github.com/pytorch/audio/issues/1021
            '" and not FilterGraphWithCudaAccel"'  # requires FFmpeg with CUDA support
            '" and not kaldi_io_test"'  # requires kaldi_io
            '" and not test_dup_hw_acel"'  # requires special render device permissions
            '" and not test_h264_cuvid"'  # requires special render device permissions
            '" and not test_hevc_cuvid"'  # requires special render device permissions
        ),
        'testinstall': True,
    }),
    ('pytorch-ignite', '0.4.13', {
        'modulename': 'ignite',
        'source_urls': ['https://github.com/pytorch/ignite/archive'],
        'patches': ['torch-ignite-0.4.13_dont_destroy_python_path_in_test_launcher.patch'],
        'checksums': [
            {'pytorch-ignite-0.4.13.tar.gz': 'bfe4b6f1cd96e78c021a65a0c51350cdb89d6ef5a8b9609638666ca95bae51d7'},
            {'torch-ignite-0.4.13_dont_destroy_python_path_in_test_launcher.patch':
             'fd5dfe99f4c8804d6c57e4d9140d9e556e0724b379f9eaae8aeaf1b7bd058686'},
        ],
        'runtest': (
            'pytest'
            ' -m "not distributed"'
            ' --ignore=tests/ignite/contrib/handlers/test_clearml_logger.py'  # requires clearml
            ' --ignore=tests/ignite/contrib/handlers/test_mlflow_logger.py'  # requires mlflow
            ' --ignore=tests/ignite/contrib/handlers/test_neptune_logger.py'  # requires neptune
            ' --ignore=tests/ignite/contrib/handlers/test_polyaxon_logger.py'  # requires polyaxon
            ' --ignore=tests/ignite/contrib/handlers/test_tensorboard_logger.py'  # requires tensorboardX
            ' --ignore=tests/ignite/contrib/handlers/test_visdom_logger.py'  # requires visdom
            ' --ignore=tests/ignite/contrib/handlers/test_wandb_logger.py'  # requires wandb
            ' --ignore=tests/ignite/metrics/gan/test_fid.py'  # requires pytorch_fid
            ' --ignore=tests/ignite/metrics/nlp/test_rouge.py'  # requires rouge
            ' --ignore=tests/ignite/handlers/test_checkpoint.py'  # fails by comparing tensors on different devices
            ' --ignore=tests/ignite/contrib/handlers/test_tqdm_logger.py'  # fragile tests on some platforms
            ' -k "not test_setup_visdom_logging"'  # requires visdom
            '" and not test_setup_plx_logging"'  # requires polyaxon
            '" and not test_setup_mlflow_logging"'  # requires mlflow
            '" and not test_setup_clearml_logging"'  # requires clearml
            '" and not test_setup_neptune_logging"'  # requires neptune
            '" and not test__setup_ddp_vars_from_slurm_env_bad_configs"'  # fails sometimes
            '" and not test__native_dist_model_create_from_backend_bad_config"'  # fails sometimes
            '" and not test_inception_score"'  # fails sometimes due to connection problem with download.pytorch.org
        ),
        'testinstall': True,
    }),
    ('torch-tb-profiler', '0.4.3', {
        'modulename': 'torch.profiler',
        'sources': ['torch_tb_profiler-%(version)s.tar.gz'],
        'checksums': ['8b8d29b2de960b3c4423087b23cec29beaf9ac3a8c7b046c18fd25b218f726b1'],
        'runtest': (
            'pytest'
            ' --ignore=test/test_tensorboard_end2end.py'  # timeouts
            ' -k "not test_dump_gpu_metrics"'  # missing file
            '" and not test_profiler_api_with_record_shapes_memory_stack"'  # fails
            '" and not test_profiler_api_without_record_shapes_memory_stack"'  # fails
            '" and not test_profiler_api_without_step"'  # fails
            '" and not test_autograd_api"'  # fails
        ),
        'testinstall': True,
    }),
    ('tensordict', '0.4.0', {
        'source_urls': ['https://github.com/pytorch/%(name)s/archive'],
        'checksums': ['c6a565cc88d4f8bc1e1f5e6aba23c2c099f08799730c2716fe6b8706d015b7a5'],
    }),
    ('torchrl', '0.4.0', {
        'source_urls': ['https://github.com/pytorch/rl/archive'],
        'checksums': ['8851a84316f2a1d61d23ec753c90b545bc6479890ec65c5278987ae7c8a2ceec'],
    }),
]

moduleclass = 'ai'
