easyblock = 'CmdCp'

name = 'rMATS'
version = '4.3.0'

homepage = 'http://rnaseq-mats.sourceforge.net/'
description = """MATS is a computational tool to detect differential alternative splicing events from RNA-Seq data. The statistical model of MATS calculates the P-value and false discovery rate that the difference in the isoform ratio of a gene between two conditions exceeds a given user-defined threshold. From the RNA-Seq data, MATS can automatically detect and analyze alternative splicing events corresponding to all major types of alternative splicing patterns. MATS handles replicate RNA-Seq data from both paired and unpaired study design."""

toolchain = {'name': 'gccflexiblas', 'version': '2023a'}

source_urls = ['https://github.com/Xinglab/rmats-turbo/archive']
sources = ['v%(version)s.tar.gz']
patches = ["rMATS-4.3.0-fix_makefile_blaslapack.patch"]
checksums = [
    {'v4.3.0.tar.gz': '8825a16f3ea8186d833ead55df0899c54a3da72b440f9674bcf3a9245d971805'},
    {'rMATS-4.3.0-fix_makefile_blaslapack.patch': 'b5d4cbc6ca6783416589a57655571358aaf3b21c99c7c0415e3bd16fb267aaa4'},
]

dependencies = [
    ('SciPy-Stack', '2024b'),
]

multi_deps = {'Python': ['3.10', '3.11', '3.12']}
builddependencies = [
    ('BamTools', '2.5.2'),
    ('SAMtools', '1.18'),
    ('GSL', '2.7'),
    ('Cython', '3.0.10'),
]

build_cmd = " && ".join([
    "cd %(builddir)s/%(namelower)s-turbo-%(version)s/bamtools && mkdir build && cd build && cmake .. && make",
    "cd %(builddir)s/%(namelower)s-turbo-%(version)s/rMATS_C && make",
    'cd %(builddir)s/%(namelower)s-turbo-%(version)s/rMATS_pipeline && python setup.py build',
    'mkdir -p %(installdir)s/lib/python%(pyshortver)s/site-packages'
])

cmds_map = [('.*', build_cmd)]

files_to_copy = [
    (['rMATS_C/rMATSexe'], 'rMATS_C'),
    (['rMATS_P', 'rMATS_R','rmats.py', 'rMATS_pipeline/build/lib.linux-x86_64*/rmats/*.so',], ''),
    (['rMATS_pipeline/build/lib.linux-x86_64*/rmats/*.so',], 'lib/python%(pyshortver)s/site-packages'),
    (['tests'], ''),
]

sanity_check_paths = {
    'files': ['rMATS_C/rMATSexe',
              'rMATS_P/FDR.py',
              'rMATS_P/inclusion_level.py',
              'rMATS_P/joinFiles.py',
              'rMATS_P/paste.py',
              'rMATS_R/paired_model.R',
              'rmats.py',
              'rmatspipeline.cpython-310-x86_64-linux-gnu.so',
              'rmatspipeline.cpython-311-x86_64-linux-gnu.so',
              'rmatspipeline.cpython-312-x86_64-linux-gnu.so',
    ],
    'dirs':  [
        'rMATS_C',
        'rMATS_R',
        'rMATS_P',
        'tests',
    ],
}

sanity_check_commands = [
    "python %(installdir)s/rmats.py -h",
]

usage = "python $EBROOTRMATS/rmats.py ..."

moduleclass = 'bio'
