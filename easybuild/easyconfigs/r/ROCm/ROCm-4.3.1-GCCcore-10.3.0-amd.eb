easyblock = 'EB_ROCM'

name = 'ROCm'
version = '4.3.1'
versionsuffix = '-amd'

homepage = 'https://github.com/RadeonOpenCompute'
description = "Platform for GPU Enabled HPC and UltraScale Computing"
docurls = ['https://rocmdocs.amd.com']

toolchain = {'name': 'GCCcore', 'version': '10.3.0'}

builddependencies = [('CMake', '3.20.1')]

dependencies = [
    ('GMP', '6.2.1'),  # required by Clang
    ('Mesa', '21.1.1'),  # required by ROCclr (for GL/glx.h)
    ('Perl', '5.32.1'),  # required by hipamd
    ('Python', '3.9.5'),  # required by HIP and LLVM OpenMP
    ('Z3', '4.8.11'),  # required by Clang
    ('binutils', '2.36.1'),  # required by Clang
    ('elfutils', '0.185'),  # required by ROCR-Runtime
    ('libffi', '3.3'),  # required by OpenMP offloading
    ('libxml2', '2.9.10'),  # required by Clang
    ('ncurses', '6.2'),  # required by Clang
    ('pkgconfig', '1.5.4', '-python'),  # required by OpenMP
    ('zlib', '1.2.11'),  # required by aomp-extra
]

# being a member of the 'video' group is required,
# and need to run 'newgrp video' to have write access to /dev/kfd
# cfr. https://rocmdocs.amd.com/en/latest/Installation_Guide/Installation-Guide.html
# group = 'video'

default_easyblock = 'CMakeMake'

default_component_specs = {
    'source_urls': ['https://github.com/RadeonOpenCompute/%(name)s/archive/'],
    'sources': [{
        'download_filename': '%(version)s.tar.gz',
        'filename': '%(name)s-%(version)s.tar.gz',
    }],
    'srcdir': '%(name)s-%(version)s',
}

# Same build order as AOMP
# https://github.com/ROCm-Developer-Tools/aomp/blob/aomp-dev/bin/build_aomp.sh#L98
components = [
    ('ROCT-Thunk-Interface', 'rocm-4.3.1', {
        'checksums': ['9d0727e746d4ae6e2709e3534d91046640be511a71c027f47db25e529fe3b4d4'],
    }),
    ('ROCR-Runtime', 'rocm-4.3.1', {
        'checksums': ['85fbd1645120b71635844090ce8bd9f7af0a3d1065d5fae476879f99ba0c0475'],
    }),
    ('llvm-project', 'rocm-4.3.1', {
        'checksums': ['b53c6b13be7d77dc93a7c62e4adbb414701e4e601e1af2d1e98da4ee07c9837f'],
    }),
    ('ROCm-Device-Libs', 'rocm-4.3.1', {
        'checksums': ['a7291813168e500bfa8aaa5d1dccf5250764ddfe27535def01b51eb5021d4592'],
    }),
    ('Clang-OpenMP', 'rocm-4.3.1', {
        # uses same sources as llvm-project component
        'sources': ['llvm-project-%(version)s.tar.gz'],
        'patches': ['llvm-4.3.1-openmp-remove-hardcoded-source-paths.patch'],
        'checksums': ['b53c6b13be7d77dc93a7c62e4adbb414701e4e601e1af2d1e98da4ee07c9837f',
                      '39eb1ca42069a502762c8724319733eec3bdce5962a887f62b077fad5e94d0d8'],
    }),
    ('aomp-extras', 'rocm-4.3.1', {
        'source_urls': ['https://github.com/ROCm-Developer-Tools/%(name)s/archive/'],
        'patches': ['aomp-extras-4.3.1-remove-hardcoded-devicelib-path.patch'],
        'checksums': ['94973bee033145157aafdfc42f9028a27c23fe27291c6fa151f6ceb74c1cee00',
                      '9b5f555ad3c4048cdd6ab5ed4b6ddaa24357e7dc4d9d4516f4d8846d5e06c757'],
    }),
    ('ROCm-CompilerSupport', 'rocm-4.3.1', {
        'checksums': ['f1d99550383ed7b3a01d304eedc3d86a8e45b271aa5a80b1dd099c22fda3f745'],
    }),
    ('rocminfo', 'rocm-4.3.1', {
        'checksums': ['d042947d3f29e943a2e3294a2a2d759ca436cebe31151ce048e49bc4f02d6993'],
    }),
    ('rocm-cmake', 'rocm-4.3.1', {
        'checksums': ['acf2a58e2cd486f473194bf01247c52dbf20bd5f6465810fb221470298f2557f'],
    }),
    # NOTE: pgmath must be built before 'flang'
    # ('pgmath', 'rocm-4.3.1', {
    #     'source_urls': ['https://github.com/ROCm-Developer-Tools/flang/archive/'],
    #     'checksums': ['7685c27ecc65b7989e5b02bf26d626cd7b003acbbcc03e143c5918eccdd45985'],
    # }),
    # ('flang', 'rocm-4.3.1', {
    #     'sources': ['flang-%(version)s.tar.gz'],
    #     'patches': ['flang-4.3.1-remove-git-sha-extraction.patch'],
    #     'checksums': ['7685c27ecc65b7989e5b02bf26d626cd7b003acbbcc03e143c5918eccdd45985',
    #                   '6da329429596dea5a9e652899c9615be3cfc28802ee0eb1d0bba2de111f39da1'],
    # }),
    # ('flang-runtime', 'rocm-4.3.1', {
    #     'sources': ['flang-%(version)s.tar.gz'],
    #     'checksums': ['7685c27ecc65b7989e5b02bf26d626cd7b003acbbcc03e143c5918eccdd45985'],
    # }),
    # ('hipamd', 'd2d2cacfe210307ec10c77400e1dafdeafefbc0f', {
    #     'source_urls': ['https://github.com/ROCm-Developer-Tools/%(name)s/archive/'],
    #     'checksums': ['44c31b7594899e2d79f77640a30d3fa60acbeac67286768fe000e18e4944fb96'],
    # }),
    # ('ROCclr', 'rocm-4.3.1', {
    #     'source_urls': ['https://github.com/ROCm-Developer-Tools/%(name)s/archive/'],
    #     'checksums': ['bda52c65f03a69a9d8ab1a118d45646d76843249fb975d67e5141e63fa3acc79'],
    # }),
    # ('HIP', 'rocm-4.3.1', {
    #     'source_urls': ['https://github.com/ROCm-Developer-Tools/%(name)s/archive/'],
    #     'checksums': ['955311193819f487f9a2d64bffe07c4b8c3a0dc644dc3ad984f7c66a325bdd6f'],
    # }),
    # ('ROCm-OpenCL-Runtime', 'rocm-4.3.1', {
    #     'checksums': ['7f98f7d4707b4392f8aa7017aaca9e27cb20263428a1a81fb7ec7c552e60c4ca'],
    # }),
]

moduleclass = 'tools'
