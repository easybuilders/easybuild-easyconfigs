# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2025/06
easyblock = 'PythonBundle'

name = 'RFdiffusion'
version = '1.1.0'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://github.com/RosettaCommons/RFdiffusion'
description = """RFdiffusion is an open source method for structure generation, with or without
conditional information (a motif, target etc). It can perform a whole range of
protein design challenges as we have outlined in the RFdiffusion paper
https://www.biorxiv.org/content/10.1101/2022.12.09.519842v1
"""

toolchain = {'name': 'foss', 'version': '2023a'}

_pysp = '%(installdir)s/lib/python%(pyshortver)s/site-packages'

dependencies = [
    ('Python', '3.11.3'),
    ('wandb', '0.16.1'),
    ('CUDA', '12.1.1', '', SYSTEM),
    ('PyTorch', '2.1.2', versionsuffix),  # compat 1.x ?
    ('e3nn', '0.3.3', versionsuffix),
    ('Hydra', '1.3.2'),
    ('DGL', '1.1.3', versionsuffix),
    ('RFdiffusion-models', '1.1.0', '', SYSTEM),
    ('RFdiffusion-schedules', '1.1.0', '', SYSTEM),
]

exts_list = [
    ('asttokens', '2.4.1', {
        'checksums': ['b03869718ba9a6eb027e134bfdf69f38a236d681c83c160d510768af11254ba0'],
    }),
    ('executing', '2.2.0', {
        'checksums': ['5d108c028108fe2551d1a7b2e8b713341e2cb4fc0aa7dcf966fa4327a5226755'],
    }),
    ('icecream', '2.1.4', {
        'checksums': ['58755e58397d5350a76f25976dee7b607f5febb3c6e1cddfe6b1951896e91573'],
    }),
    ('dllogger', '1.0.0', {
        'source_urls': ['https://github.com/NVIDIA/dllogger/archive/refs/tags'],
        'sources': ['v%(version)s.zip'],
        'checksums': ['07d0cd9b9b56f454f0c186a0889137e9f94e1979fca3d35911967c874c93c191'],
    }),
    ('nvidia_ml_py', '12.575.51', {
        'modulename': 'pynvml',
        'checksums': ['6490e93fea99eb4e966327ae18c6eec6256194c921f23459c8767aee28c54581'],
    }),
    ('SE3Transformer', version, {
        'modulename': 'se3_transformer',
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/RosettaCommons/RFdiffusion/archive/refs/tags/'],
        'start_dir': 'env/SE3Transformer',
        'checksums': ['57d82f0d43540c2912eda3f1d34ad90b13db14966ee069c427e217fe78f0297f'],
    }),
    (name, version, {
        'patches': [
            'RFdiffusion-1.1.0_fix-find-packages.patch',
            # change default paths of models and schedules to $RFDIFFUSION_MODELS and RFDIFFUSION_SCHEDULES
            # to be set by dependencies RFDiffusion-models and RFDiffusion-schedules.
            # Expect default config in  _pysp/rfdiffusion/config/inference:
            'RFdiffusion-1.1.0_data_paths.patch',
        ],
        'source_urls': ['https://github.com/RosettaCommons/RFdiffusion/archive/refs/tags/'],
        'sources': [{'filename': '%(name)s-%(version)s.tar.gz', 'download_filename': 'v%(version)s.tar.gz'}],
        'checksums': [
            {'RFdiffusion-1.1.0.tar.gz': '57d82f0d43540c2912eda3f1d34ad90b13db14966ee069c427e217fe78f0297f'},
            {'RFdiffusion-1.1.0_fix-find-packages.patch':
             'e25da7f476acacb6af58bd84f40aca712538900b0b48532b22f9a133d6886da2'},
            {'RFdiffusion-1.1.0_data_paths.patch': '3d1ddd1684004b4757958ef3d07b96a0f8976091fe670381fc723ad4eb6d65a5'},
        ],
    }),
]

postinstallcmds = [
    'cp -rpP config examples %s/%%(namelower)s' % _pysp,
    'cp -rpP config examples helper_scripts %s/%%(namelower)s' % _pysp,  # acc. to WilleBell
    'cp -pP %%(namelower)s/inference/sym_rots.npz %s/%%(namelower)s/inference/' % _pysp,  # acc. to WilleBell
]

sanity_check_commands = [
    "run_inference.py --help",
    "run_inference.py 'contigmap.contigs=[150-150]' " +
    "inference.output_prefix=test_outputs/test inference.num_designs=1"
]

sanity_check_paths = {
    'files': [],
    'dirs': [
        '%s/%%(namelower)s/inference' % _pysp,
        '%s/%%(namelower)s/examples' % _pysp,
        '%s/%%(namelower)s/config/inference' % _pysp]
}

moduleclass = 'bio'
