# The installation requires a data-base to be installed. See here:
# https://github.com/uw-ipd/RoseTTAFold2NA/tree/main
# of how to do that. The run_RF2NA.sh file contains a variable for
# the path of that data-base, that might need to be changed to run
# the examples to test the installation. 
# Author: J. Sassmannshausen (Imperial College London)

easyblock = 'PythonBundle'

name = 'RoseTTAFold2NA'
version = '0.2'
versionsuffix = '-CUDA-11.7.0'

homepage = 'https://github.com/uw-ipd/RoseTTAFold2NA'
description = "RoseTTAFold2 with nucleic acids"

toolchain = {'name': 'foss', 'version': '2022a'}

builddependencies = [
    ('CMake', '3.24.3'),
]

dependencies = [
    ('CUDA', '11.7.0', '', SYSTEM),
    ('PyTorch', '1.13.1', versionsuffix),
    ('Python', '3.10.4'),
    ('wandb', '0.13.6'),
    ('tqdm', '4.64.0'),
    ('DGL', '1.1.3', versionsuffix),
    ('e3nn', '0.3.3', versionsuffix),
    ('CSBLAST', '2.2.4'),
    ('CD-HIT', '4.8.1'),
    ('Infernal', '1.1.4'),
    ('BLAST+', '2.13.0'),
    ('MAFFT', '7.505', '-with-extensions'),
    ('psutil', '5.9.3'),
    ('HMMER', '3.3.2'),
    ('HH-suite', '3.3.0'),
    ('requests', '2.28.2'),
    ('wandb', '0.13.6'),
]

use_pip = True
sanity_pip_check = True

exts_list = [
    ('dllogger', '1.0.0', {
        'source_urls': ['https://github.com/NVIDIA/dllogger/archive'],
        'source_tmpl': 'v%(version)s.tar.gz',
        'checksums': ['abae2b2ac73b9e176fa87144bf6c2048ddd3dae8e7002d6d5a270bc7e4da6b4d'],
    }),
    ('pynvml', '11.0.0', {
        'checksums': ['d5fc4a22d355b40c341d6ba0aa888a2d4d2253177d243900f8401b7e6cacb1bb'],
    }),
    (name, version, {
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/uw-ipd/RoseTTAFold2NA/archive'],
        'checksums': ['48680223ae69290c3aa0f13d2d86d485b8b1c07516d14647ed39501c3e6bf4b4'],
        'start_dir': 'SE3Transformer',
        'modulename': 'se3_transformer'
    }),
]

postinstallcmds = [
    "mv %(start_dir)s/RoseTTAFold2NA/RoseTTAFold2NA-0.2/input_prep %(installdir)s/bin",
    "mv %(start_dir)s/RoseTTAFold2NA/RoseTTAFold2NA-0.2/network %(installdir)s/"
]

fix_perl_shebang_for = ['bin/*.pl']

sanity_check_paths = {
    'files': ['bin/make_pMSAs_prot_RNA.py', 'bin/reprocess_rnac.pl', 'bin/make_protein_msa.sh'],
    'dirs': ['lib/python%(pyshortver)s/site-packages/se3_transformer',
             'lib/python%(pyshortver)s/site-packages/dllogger'],
}
moduleclass = 'bio'
