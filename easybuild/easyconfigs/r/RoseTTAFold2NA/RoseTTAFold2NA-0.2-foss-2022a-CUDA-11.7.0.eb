# The installation requires a data-base to be installed. See here:
# https://github.com/uw-ipd/RoseTTAFold2NA/tree/main
# of how to do that and see below in the script.
# The run_RF2NA.sh file contains a variable for the path of that
# data-base, that might need to be changed to run the examples to
# test the installation.
# Author: J. Sassmannshausen (Imperial College London)

easyblock = 'PythonBundle'

name = 'RoseTTAFold2NA'
version = '0.2'
versionsuffix = '-CUDA-11.7.0'

homepage = 'https://github.com/uw-ipd/RoseTTAFold2NA'
description = "RoseTTAFold2 with nucleic acids"

toolchain = {'name': 'foss', 'version': '2022a'}

builddependencies = [
    ('CMake', '3.24.3'),
]

dependencies = [
    ('CUDA', '11.7.0', '', SYSTEM),
    ('PyTorch', '1.13.1', versionsuffix),
    ('Python', '3.10.4'),
    ('wandb', '0.13.6'),
    ('tqdm', '4.64.0'),
    ('DGL', '1.1.3', versionsuffix),
    ('e3nn', '0.3.3', versionsuffix),
    ('CSBLAST', '2.2.4'),
    ('CD-HIT', '4.8.1'),
    ('Infernal', '1.1.4'),
    ('BLAST+', '2.13.0'),
    ('MAFFT', '7.505', '-with-extensions'),
    ('psutil', '5.9.3'),
    ('HMMER', '3.3.2'),
    ('HH-suite', '3.3.0'),
    ('wandb', '0.13.6'),
]

exts_list = [
    ('requests', '2.28.2', {
        'checksums': ['98b1b2782e3c6c4904938b84c0eb932721069dfdb9134313beff7c83c2df24bf'],
    }),
    ('dllogger', '1.0.0', {
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/NVIDIA/dllogger/archive'],
        'checksums': ['abae2b2ac73b9e176fa87144bf6c2048ddd3dae8e7002d6d5a270bc7e4da6b4d'],
    }),
    ('pynvml', '11.0.0', {
        'checksums': ['d5fc4a22d355b40c341d6ba0aa888a2d4d2253177d243900f8401b7e6cacb1bb'],
    }),
    (name, version, {
        'modulename': 'se3_transformer',
        'patches': ['%(name)s-%(version)s-conda-remove-dbdir-add.patch'],
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/uw-ipd/RoseTTAFold2NA/archive'],
        'start_dir': 'SE3Transformer',
        'checksums': [
            {'v0.2.tar.gz': '48680223ae69290c3aa0f13d2d86d485b8b1c07516d14647ed39501c3e6bf4b4'},
            {'RoseTTAFold2NA-0.2-conda-remove-dbdir-add.patch':
             'a15f006a022ada02cbe5b1f2eed29b966b7b1dc6a0e9a09738128dbcd73f9646'},
        ],
    }),
]

postinstallcmds = [
    "mkdir -p %(installdir)s/bin",
    "mv %(start_dir)s/RoseTTAFold2NA/RoseTTAFold2NA-0.2/run_RF2NA.sh %(installdir)s/bin/",
    "mv %(start_dir)s/RoseTTAFold2NA/RoseTTAFold2NA-0.2/input_prep %(installdir)s/bin/",
    "mv %(start_dir)s/RoseTTAFold2NA/RoseTTAFold2NA-0.2/network %(installdir)s/bin/",
    "cd %(installdir)s/bin/network && wget https://files.ipd.uw.edu/dimaio/RF2NA_apr23.tgz && "
    "tar xvfz RF2NA_apr23.tgz && rm RF2NA_apr23.tgz",
]

fix_perl_shebang_for = ['bin/*.pl']

sanity_check_paths = {
    'files': ['bin/input_prep/make_pMSAs_prot_RNA.py', 'bin/input_prep/reprocess_rnac.pl',
              'bin/input_prep/make_protein_msa.sh'],
    'dirs': ['lib/python%(pyshortver)s/site-packages/requests',
             'lib/python%(pyshortver)s/site-packages/se3_transformer',
             'lib/python%(pyshortver)s/site-packages/dllogger',
             'bin/network', 'bin/input_prep'],
}

# This needs to be changed, depending on where your data-base is:
modextravars = {'DB_DIR': '/foo/baa/data/rosettafold2na/'}

moduleclass = 'bio'
