easyblock = 'CMakeMake'

name = 'RELION'
version = '4.0.0'

homepage = 'http://www2.mrc-lmb.cam.ac.uk/relion/index.php/Main_Page'
description = """RELION (for REgularised LIkelihood OptimisatioN, pronounce rely-on) is a stand-alone computer
 program that employs an empirical Bayesian approach to refinement of (multiple) 3D reconstructions or 2D class
 averages in electron cryo-microscopy (cryo-EM)."""

toolchain = {'name': 'foss', 'version': '2022a'}
toolchainopts = {'openmp': True, 'usempi': True, 'opt': True}

github_account = '3dem'
source_urls = [GITHUB_SOURCE]
sources = ['%(version)s.tar.gz']
patches = [
    '%(name)s-%(version)s_target-all-cuda-compute-capabilities.patch',
    '%(name)s-%(version)s_no_which_cmd.patch',
    '%(name)s-%(version)s_drop_usage_of_mpi_include_path.patch',
    '%(name)s-%(version)s_add_generic_slurm_args.patch',
    # This patch is a site specific patch. Either adapt or ignore.
    # '%(name)s-%(version)s_hpc2n_add_slurm_account+gpu_args.patch',
    # This submit file template is used by the both the
    # add_generic_slurm_args and hpc2n_add_slurm_account+gpu_args patches.
    ('relion_sbatch.sh', '.'),
]
checksums = [
    {'4.0.0.tar.gz': 'b52cfb75faf59ca4f702a77d206fdec18f1d97512eb7a1b6fd6a0eaca749c0f6'},
    {'RELION-4.0.0_target-all-cuda-compute-capabilities.patch':
     'aaecad29e2479ccd72a6157e311cdc8f508994a0744762af5c73f6c04c30302b'},
    {'RELION-4.0.0_no_which_cmd.patch': '6390e0dfe74d5a2e34818214d4bc5e745c7ecb4cdb73d8d8323360eb6b8eacaf'},
    {'RELION-4.0.0_drop_usage_of_mpi_include_path.patch':
     '36a0f5a15402b910e823fccc2caa7afa1e1c7dbf7b7589513c079d9eae906641'},
    {'RELION-4.0.0_add_generic_slurm_args.patch': '35b6fae6bfa1784ae1cd7d7e595e104b2ba4a0091ac7388dff920498f26a9fea'},
    # {'RELION-4.0.0_hpc2n_add_slurm_account+gpu_args.patch':
    #  '17dc7af3d6721d82d266614a03616eef812d858748f65b1e9457384e17bce8d9'},
    {'relion_sbatch.sh': '9305f869a07a1beaaa7e3a4670625a045c0cc4762b6b542039123e5a2731023d'},
]

builddependencies = [('CMake', '3.23.1')]

dependencies = [
    ('X11', '20220504'),
    ('FLTK', '1.3.8'),
    ('LibTIFF', '4.3.0'),
    ('libpng', '1.6.37'),
    ('zlib', '1.2.12'),
    ('tbb', '2021.5.0'),
    ('ctffind', '4.1.14'),
    ('MotionCor2', '1.5.0'),
    ('Gctf', '1.06', '', SYSTEM),
    ('gnuplot', '5.4.4'),
    ('Ghostscript', '9.56.1'),
]

separate_build_dir = False

configopts = "-DCMAKE_SHARED_LINKER_FLAGS='-lpthread' "

postinstallcmds = [
    'cp relion_sbatch.sh %(installdir)s/bin',
    'chmod +x %(installdir)s/bin/relion_sbatch.sh',
]

sanity_check_paths = {
    'files': ['bin/relion', 'bin/relion_refine_mpi'],
    'dirs': []
}

sanity_check_commands = ["relion --version"]

modextravars = {
    'RELION_QSUB_TEMPLATE': '%(installdir)s/bin/relion_sbatch.sh',
    'RELION_QUEUE_NAME': 'batch',  # Adjust as needed to site config
    'RELION_QSUB_COMMAND': 'sbatch',
    'RELION_ERROR_LOCAL_MPI': '1',
    'RELION_CTFFIND_EXECUTABLE': 'ctffind',
    'RELION_GCTF_EXECUTABLE': 'Gctf',
    'RELION_MOTIONCOR2_EXECUTABLE': 'motioncor2',
}

moduleclass = 'bio'
