#
easyblock = 'CMakeMake'

name = 'RELION'
version = '4.0.0'

homepage = 'http://www2.mrc-lmb.cam.ac.uk/relion/index.php/Main_Page'
description = """RELION (for REgularised LIkelihood OptimisatioN,
 pronounce rely-on) is a stand-alone computer
 program that employs an empirical Bayesian approach to refinement
 of (multiple) 3D reconstructions or 2D class
 averages in electron cryo-microscopy (cryo-EM)."""

toolchain = {'name': 'fosscuda', 'version': '2020b'}

local_scr_default_walltime = "1-00:00:00"


source_urls = ['https://github.com/3dem/relion/archive/refs/tags/']
sources = ['%(version)s.zip']
patches = ['RELION-3.0_beta_cuda_capabilities.patch']
checksums = [
    '0987e684e9d2dfd630f1ad26a6847493fe9fcd829ec251d8bc471d11701d51dd',  # 4.0.0.zip
    'aedc0c7e1806094274d8442680aade810943648b08875148f5da226121753a0e',  # RELION-3.0_beta_cuda_capabilities.patch
]

builddependencies = [('CMake', '3.20.1')]

dependencies = [
    ('X11', '20201008'),
    ('FLTK', '1.3.5'),
    ('LibTIFF', '4.1.0'),
    ('ctffind','4.1.14'),
#    ('Gctf','1.06'),
#    ('MotionCor2','1.4.4'),
    ('topaz-em','0.2.5a-20210519_01_77f9831_a'),
    ('Ghostscript','9.53.3'),
]

#  lowest supported capability is 3.5
local_cuda_compute_capabilities = ['3.5', '3.7', '5.0', '5.2', '5.3', '6.0', '6.1', '6.2', '7.0']
local_caps = [''.join(x.split('.')) for x in local_cuda_compute_capabilities]
local_cuda_arch = ';'.join(['-gencode arch=compute_%s,code=\"sm_%s,compute_%s\"' % (x, x, x) for x in local_caps])

configopts = "-DCMAKE_SHARED_LINKER_FLAGS='-lpthread' -DMPI_INCLUDE_PATH=$EBROOTOPENMPI/include "
configopts += "-DCUDA=ON -DCudaTexture=ON "
configopts += '-DCUDA_ARCH=\'' + local_cuda_arch + '\''

files_to_copy = [(['*'],'etc/templates')]

modextravars = {
    'RELION_SCRATCH_DIR': '\$SCRATCHDIR',
    'RELION_QSUB_NRMPI': '3',
    'RELION_QSUB_NRTHREADS': '7',
    'RELION_MINIMUM_DEDICATED': '15',
    'RELION_QSUB_EXTRA_COUNT': '7',
    #  'RELION_MPI_MAX': '20',
    #  'RELION_THREAD_MAX': '24',
    'RELION_QUEUE_USE': 'true',
    'RELION_QUEUE_NAME': 'gpu',
    'RELION_QSUB_COMMAND': 'sbatch -C rome',
    'RELION_QSUB_EXTRA2_DEFAULT': '60GB',
    'RELION_QSUB_EXTRA2': 'Memory',
    'RELION_QSUB_EXTRA1':'GPU count',
    'RELION_QSUB_EXTRA1_DEFAULT': '2',
    'RELION_QSUB_EXTRA3': 'Walltime',
    'RELION_QSUB_EXTRA3_DEFAULT': local_scr_default_walltime,
    'RELION_QSUB_EXTRA4': 'Extra modules',
    'RELION_QSUB_EXTRA4_DEFAULT': '',
    'RELION_QSUB_EXTRA5': 'Extra slurm parameter',
    'RELION_QSUB_EXTRA5_DEFAULT': "#SBATCH --ntasks-per-core=1",
    'RELION_QSUB_EXTRA6': 'Preprocess command',
    'RELION_QSUB_EXTRA6_DEFAULT': "",
    'RELION_QSUB_EXTRA7': 'Postprocess command',
    'RELION_QSUB_EXTRA7_DEFAULT': "#POSTPROC: replace, if required",
    'RELION_TEMPLATES': '%(installdir)s/etc/templates/',
    'RELION_QSUB_TEMPLATE': '${RELION_TEMPLATES}/gpu.slurm.script',
    'RELION_MOTIONCOR2_EXECUTABLE': "\\`which MotionCor2\\`",
    'RELION_GCTF_EXECUTABLE': '\\`which Gctf\\`',
    'RELION_CTFFIND_EXECUTABLE': '\\`which ctffind\\`',
    'RELION_SUMMOVIE_EXECUTABLE': '\\`which summovie\\`',
    'RELION_RESMAP_EXECUTABLE': '\\`which ResMap\\`',
    'RELION_TOPAZ_EXECUTABLE': '\\`which topaz\\`',
    'RELION_USE_GPU_ACCELERATION': '1',
    #  'RELION_DO_OWN_MOTIONCOR': '0'
}

sanity_check_paths = {
    'files': ['bin/relion'],
    'dirs': []
}

moduleclass = 'bio'
