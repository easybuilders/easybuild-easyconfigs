name = 'RELION'
version = '3.1.0'

homepage = 'http://www2.mrc-lmb.cam.ac.uk/relion/index.php/Main_Page'
description = """
RELION (for REgularised LIkelihood OptimisatioN, pronounce rely-on) is a
stand-alone computer program that employs an empirical Bayesian approach to
refinement of (multiple) 3D reconstructions or 2D class averages in electron
cryo-microscopy (cryo-EM)."""

toolchain = {'name': 'fosscuda', 'version': '2019b'}
toolchainopts = {'openmp': True, 'usempi': True, 'opt': True}

github_account = '3dem'
source_urls = [GITHUB_SOURCE]
sources = ['%(version)s.tar.gz']
patches = ['RELION-3.0.4_drop_usage_of_mpi_include_path.patch']

checksums = [
    'fa5ebef27a15f1df856a64dc8960e7c381ff646818f778fe746249d0b7682ba2',  # 3.1.0.tar.gz
    # RELION-3.0.4_drop_usage_of_mpi_include_path.patch
    'c135b72ff8d4c3015a3b293fa07a2283396bfb3fd0658d5e938ec33fca4dcebc',
]

builddependencies = [('CMake', '3.15.3')]

dependencies = [
    ('X11', '20190717'),
    ('FLTK', '1.3.5'),
    ('libpng', '1.6.37'),
    ('LibTIFF', '4.0.10'),
    ('tbb', '2019_U9'),
    ('zlib', '1.2.11'),
    ('ctffind', '4.1.14'),       # optional, RELION provides wrapper
    ('MotionCor2', '1.3.2'),     # optional, RELION provides wrapper
    ('Gctf', '1.06', '', True),  # optional, RELION provides wrapper
    ('gnuplot', '5.2.8'),        # optional, RELION provides wrapper
    ('tcsh', '6.22.02'),         # optional, needed by RELION shell
]

# Execute commands in the pipeline directly, not through `which`
local_pipejob_src = '%(builddir)s/%(namelower)s-%(version)s/src/pipeline_jobs.cpp'
preconfigopts = "sed -i 's/`which \([a-z_]*\)`/\\1/g;s/`//g' %s &&" % local_pipejob_src

# Lowest supported CUDA capability is 3.5
cuda_compute_capabilities = ['3.5', '3.7', '5.0', '5.2', '5.3', '6.0', '6.1', '6.2', '7.0']

#
# Site-specific configuration of RELION
#
# RELION includes a job manager that integrates with the job scheduler of the cluster
queue_cmd = 'qsub'    # options: qsub, sbatch
queue_name = 'batch'  # name of the default queue used by RELION (user can change it at runtime)

# Default and maximum parameters related to job resources
# These parameters can be edited by the user in RELION's GUI
# qsub_mpi = 4            # default MPI processes
# qsub_mpi_max = 20       # maximum MPI processes
# qsub_mpi_interact = 20  # maximum MPI processes allowed in RELION's interactive session
# qsub_threads = 4        # default number of threads
# qsub_threads_max = 20   # maximum number of threads
# qsub_ppn = 1            # default number of cores per node
# qsub_ppn_edit = False   # allow user to change the minimum dedicated cores per node
# tmp = '/tmp'            # path to temporary directory

# Extra parameters: additional parameters for the scheduler can be added at will
# These parameters can be edited by the user in RELION's GUI
# Note: the easyblock of RELION will automatically the following parameters: walltime, number of GPUs
# List of tuples including: 1) Descriptive name of the parameter, 2) value of the parameter
qsub_extra_params = [
    ('Account', 'default_user_account'),
    ('Extra Parameters', ''),
]

moduleclass = 'bio'
