easyblock = "Binary"

name = "RheoTool"
version = "5.0"

homepage = "https://github.com/fppimenta/rheoTool"
description = """RheoTool is an open-source toolbox based on OpenFOAM to simulate Generalized Newtonian Fluids (GNF)
and viscoelastic fluids under pressure-driven and/or electrically-driven flows."""

toolchain = {"name": "foss", "version": "2019b"}

source_urls = ["https://github.com/fppimenta/rheoTool/archive/refs/tags/"]
sources = ["v%(version)s.tar.gz"]
checksums = ["2e0899684d6d7f9ddee0d93b39a6ed56262b171bc4e5536914645209b66003ed"]

dependencies = [
    ("OpenFOAM", "7", "-20200508"),
    ("Eigen", "3.3.7", "", True),
    ("PETSc", "3.12.4", "-Python-3.7.4"),
]

extract_sources = True

# workaround
install_cmd = "export HOME_orig=$HOME && "
install_cmd += "export HOME=%(installdir)s && "

install_cmd += "source $FOAM_BASH && "
install_cmd += "export EIGEN_RHEO=$EBROOTEIGEN && "
install_cmd += "cd of70/src && "

# this should be the proper way to set installdir - acc. to https://github.com/fppimenta/rheoTool/issues/85
# but for now, changing $HOME works as a workaround
# install_cmd += "export FOAM_USER_APPBIN=%(installdir)s/bin && "
# install_cmd += "export FOAM_USER_LIBBIN=%(installdir)s/lib && "
# install_cmd += "export WM_PROJECT_USER_DIR=%(installdir)s/ && "

install_cmd += "./Allwmake -j %(parallel)s  && "

# workaround
install_cmd += "export HOME=$HOME_orig && "
install_cmd += "mv %(installdir)s/OpenFOAM/vsc*/platforms/linux*/* %(installdir)s/ "

sanity_check_paths = {
    "files": ["bin/rheoBDFoam", "lib/libthermoRheoTool.so"],
    "dirs": [],
}

# source $FOAM_BASH must run before using RheoTool, otherwise there will be missing libraries
sanity_check_commands = ["source $FOAM_BASH && rheoBDFoam -help"]

modloadmsg = 'Please run command "source $FOAM_BASH " before using RheoTool, otherwise there will be missing libraries.'

moduleclass = "cae"
