# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2024/05
easyblock = 'CMakePythonPackage'

name = 'gemmi'
version = '0.7.1'

homepage = 'https://gemmi.readthedocs.io/'
description = """Gemmi is a library, accompanied by a set of programs, developed primarily for
use in macromolecular crystallography (MX). For working with:

macromolecular models (content of PDB, PDBx/mmCIF and mmJSON files), refinement
restraints (CIF files), reflection data (MTZ and mmCIF formats), data on a 3D
grid (electron density maps, masks, MRC/CCP4 format) crystallographic symmetry.
Parts of this library can be useful in structural bioinformatics (for symmetry-
aware analysis of protein models), and in other molecular-structure sciences
that use CIF files (we have the fastest open-source CIF parser)."""

toolchain = {'name': 'GCC', 'version': '13.3.0'}
toolchainopts = {'opt': True}

github_account = 'project-gemmi'
source_urls = [GITHUB_SOURCE]
sources = ['v%(version)s.tar.gz']
checksums = ['5d87c3e82ee159f5642d7c083a74e00ca9cc038ccf9be2522d7ae985f3377393']

builddependencies = [
    ('pybind11', '2.12.0'),
    ('pybind11-stubgen', '2.5.4'),
    ('scikit-build-core', '0.10.6'),
    ('meson-python', '0.16.0'),
    ('nanobind', '2.5.0'),
    ('CMake', '3.29.3'),
]
dependencies = [
    ('Python', '3.12.3'),
]

configopts = [
    f'-DSTRIP_BINARY=ON -DUSE_FORTRAN=1 -DBUILD_SHARED_LIBS={x} -DPYTHON_INSTALL_DIR=%(installdir)s'
    for x in ['OFF', 'ON']
]

_pip_opts = ' '.join([
    '--config-settings="cmake.args=-DSTANDALONE_PYTHON_MODULE=OFF"',  # use lib/libgemmi_cpp.so
    '--config-settings="cmake.args=-DBUILD_GEMMI_PROGRAM=OFF"',
    '--config-settings="cmake.args=-DINSTALL_DEV_FILES=OFF"',
    '-Cbuild-dir=%(builddir)s/pybuild'
])

exts_defaultclass = 'PythonPackage'
exts_list = [
    (name, version, {
        'nosource': True,
        'installopts': _pip_opts,
    }),
]

sanity_check_paths = {
    'files': ['bin/gemmi', f'lib/libgemmi_cpp.{SHLIB_EXT}', 'lib/libgemmi_cpp.a'],
    'dirs': ['bin', 'lib', 'include/gemmi', 'lib/python%(pyshortver)s/site-packages/%(name)s-%(version)s.dist-info']
}

sanity_check_commands = ['gemmi -h']

moduleclass = 'bio'
