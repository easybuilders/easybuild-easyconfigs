easyblock = 'Bundle'

name = 'gnina'
version = '1.3.1'

homepage = 'https://github.com/gnina/gnina'
description = """
gnina (pronounced NEE-na) is a molecular docking program with integrated support for scoring and optimizing ligands using convolutional neural networks. It is a fork of smina, which is a fork of AutoDock Vina.
"""

toolchain = {'name': 'gccflexiblascuda', 'version': '2023a'}

builddependencies = [
    ('Boost', '1.82.0'),
    ('OpenBabel', '3.1.1'),
    ('numpy', '2.1.1'),
    ("protobuf", "24.4"),
    ('Abseil', '20230125.3'),
    ('CMake', '3.31.1'),
    ('RDKit', '2023.09.5'),
    ('pytest', '8.2.2'),
    ('JsonCpp', '1.9.5'),
    ('cuDNN', '9.2.1'),
]

default_easyblock = 'CMakeMake'
default_component_specs = {
    'sources': ['v%(version)s.tar.gz'],
    'start_dir': '%(name)s-%(version)s',
}

components = [
    (
        'libmolgrid', '0.5.5', {
            'source_urls': ['https://github.com/gnina/libmolgrid/archive/refs/tags'],
            'checksums': ['fe038d4c5fe96d73eadbe433cfd13c109446e8fd0af8d8739394966ea57afecd'],
            'configopts': '-DOPENBABEL3_INCLUDE_DIR=$EBROOTOPENBABEL/include/openbabel3',
            'preconfigopts': " sed -i -e 's/-Werror//' %(builddir)s/%(name)s-%(version)s/CMakeLists.txt && ",
        }
    ),
    (
        'gnina', '1.3.1', {
            'source_urls': ['https://github.com/gnina/gnina/archive'],
            #'patches': ['gnina-1.0.1_fix_eigen_include.patch'],
            'checksums': ['ee2921ed940734dfdecd9760ed2402aa22da7fb4845313b2860efd03001b016b'],
            'configopts': ' -DBUILD_TESTING=OFF -DCMAKE_CUDA_ARCHITECTURES=80 -DTORCH_CUDA_ARCH_LIST=8.0 -DBLA_VENDOR=FlexiBLAS -DRDKIT_INCLUDE_DIR=$EBROOTRDKIT/include/rdkit',
        }
    ),
]

postinstallcmds = [
    'setrpaths.sh --path %(installdir)s --add_path %(installdir)s/lib/gnina --any_interpreter',
]

sanity_check_paths = {
    'files': [
        'bin/gnina',
        'lib/libgnina.so',
        'lib/libmolgrid.so',
    ],
    'dirs': [
        'bin', 'lib', "include"
    ]
}

sanity_check_commands = [
    "gnina --version"
]

moduleclass = 'chem'
