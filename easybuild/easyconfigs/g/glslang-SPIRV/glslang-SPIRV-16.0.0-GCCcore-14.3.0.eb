easyblock = 'CMakeMake'

name = 'glslang-SPIRV'
version = '16.0.0'

homepage = 'https://www.khronos.org/opengles/sdk/tools/Reference-Compiler/'
description = """Glslang is the official reference compiler front end for the OpenGL ES and OpenGL shading languages.
It implements a strict interpretation of the specifications for these languages. It is open and free for anyone to use,
either from a command line or programmatically. The OpenGL and OpenGL ES working groups are committed to maintaining
consistency between the reference compiler and the corresponding shading language specifications."""

toolchain = {'name': 'GCCcore', 'version': '14.3.0'}
toolchainopts = {'pic': True}

# From https://github.com/KhronosGroup/glslang/blob/15.3.0/known_good.json
local_spirv_tools_commit = '7f2d9ee926f98fc77a3ed1e1e0f113b8c9c49458'
local_spirv_headers_commit = '01e0577914a75a2569c846778c2f93aa8e6feddd'
local_googletest_commit = 'f8d7d77c06936315286eb55f8de22cd23c188571'  # equivalent to tag v1.14.0

local_github_repos = [
    ("KhronosGroup", "SPIRV-Tools", local_spirv_tools_commit, 'spirv-tools'),
    ("KhronosGroup", "SPIRV-Headers", local_spirv_headers_commit, 'spirv-tools/external/spirv-headers'),
    ("google", "googletest", local_googletest_commit, 'googletest'),
]

sources = ['https://github.com/KhronosGroup/glslang/archive/%(version)s.tar.gz']
checksums = [
    {'16.0.0.tar.gz': '172385478520335147d3b03a1587424af0935398184095f24beab128a254ecc7'},
    {'SPIRV-Tools-7f2d9ee9.tar.xz': '2f6fd816aa257e55f6da47a791f067bd0f1b8abd8841c71b6edae26d82be179f'},
    {'SPIRV-Headers-01e05779.tar.xz': 'b8a67fa4e39a3678f68f38f5ba978f4108b86618ee0b98cc648e66631c8cda58'},
    {'googletest-f8d7d77c.tar.xz': '8dd1ff67f8abca903d3f03c78eaae7b2076a73f465cb1f369f3698bfbd6f4aad'},
]

# Extend the sources by adding external components from their respective GitHub repos at the known good commits
local_ext_dir = "%(builddir)s/glslang-%(version)s/External"  # Where the external components are expected to be
local_ext_cmd = "tar xvf %s --strip-components=1 -C $_"
for local_owner, local_repo, local_commit, local_dir in local_github_repos:
    sources.append({
        "filename": f"{local_repo}-{local_commit[:8]}.tar.xz",
        "extract_cmd": f"mkdir -p {local_ext_dir}/{local_dir} && {local_ext_cmd}",
        "git_config": {
            "url": f"https://github.com/{local_owner}",
            "repo_name": local_repo,
            "commit": local_commit,
        },
    })


builddependencies = [
    ('CMake', '3.31.8'),
    ('binutils', '2.44'),
    ('Bison', '3.8.2'),
]

dependencies = [
    ('Python', '3.13.5'),  # Only needed with SPIRV
]

configopts = "-DENABLE_OPT=ON"  # Needed if SPIRV is used

runtest = True

sanity_check_paths = {
    'files': [
        'bin/glslang',
        'lib/libglslang.a', 'lib/libGenericCodeGen.a', 'lib/libSPIRV.a',
    ],
    'dirs': ['include/glslang'],
}

sanity_check_commands = [
    'glslang --version',
]

moduleclass = 'compiler'
