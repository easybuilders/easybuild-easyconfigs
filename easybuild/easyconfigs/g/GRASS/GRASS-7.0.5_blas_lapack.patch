#Make configure to take into account EB's BLAS and LAPACK libraries 
#Use -parallel OMPCFLAG in case of intel icc compiler
#Use -parallel LDFLAGS in case of intel icc compiler
#Oct 19th 2016 by B. Hajgato (Free University Brussels - VUB)
--- grass-7.0.5/configure.orig	2015-12-30 18:05:23.000000000 +0100
+++ grass-7.0.5/configure	2016-10-19 15:02:56.070597800 +0200
@@ -1490,6 +1490,10 @@
 	    SHLIB_SUFFIX=".so"
 	    SHLIB_LD="${CC} -shared"
             LDFLAGS="-Wl,--export-dynamic"
+            if test ${CC} = "icc" ; then
+                    # Intel compiler
+                    LDFLAGS="-parallel -Wl,--export-dynamic"
+            fi
             LD_SEARCH_FLAGS='-Wl,-rpath-link,${LIB_RUNTIME_DIR}'
             LD_LIBRARY_PATH_VAR="LD_LIBRARY_PATH"
             ;;
@@ -10239,12 +10243,12 @@
 
 
 
-echo $ac_n "checking for dnrm2_ in -lblas""... $ac_c" 1>&6
-echo "configure:10244: checking for dnrm2_ in -lblas" >&5
+echo $ac_n "checking for dnrm2_ in $LIBBLAS""... $ac_c" 1>&6
+echo "configure:10244: checking for dnrm2_ in $LIBBLAS" >&5
 ac_lib_var=`echo blas'_'dnrm2_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-lblas $MATHLIB  $LIBS"
+LIBS="$LIBBLAS $MATHLIB  $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 10250 "configure"
 #include "confdefs.h"
@@ -10271,16 +10275,16 @@
 
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-  BLASLIB="$BLASLIB -lblas "
+  BLASLIB="$BLASLIB $LIBBLAS "
 else
   echo "$ac_t""no" 1>&6
 
-echo $ac_n "checking for dnrm2_ in -lblas""... $ac_c" 1>&6
-echo "configure:10280: checking for dnrm2_ in -lblas" >&5
+echo $ac_n "checking for dnrm2_ in $LIBBLAS""... $ac_c" 1>&6
+echo "configure:10280: checking for dnrm2_ in $LIBBLAS" >&5
 ac_lib_var=`echo blas'_'dnrm2_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-lblas $MATHLIB -lg2c $LIBS"
+LIBS="$LIBBLAS $MATHLIB -lg2c $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 10286 "configure"
 #include "confdefs.h"
@@ -10307,7 +10311,7 @@
 
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-  BLASLIB="$BLASLIB -lblas -lg2c"
+  BLASLIB="$BLASLIB $LIBBLAS -lg2c"
 else
   echo "$ac_t""no" 1>&6
 
@@ -10490,12 +10494,12 @@
 
 # BLAS in PhiPACK libraries? (requires generic BLAS, too)
 if test $blas_ok = no; then
-	echo $ac_n "checking for sgemm_ in -lblas""... $ac_c" 1>&6
-echo "configure:10495: checking for sgemm_ in -lblas" >&5
+	echo $ac_n "checking for sgemm_ in $LIBBLAS""... $ac_c" 1>&6
+echo "configure:10495: checking for sgemm_ in $LIBBLAS" >&5
 ac_lib_var=`echo blas'_'sgemm_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-lblas  $LIBS"
+LIBS="$LIBBLAS  $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 10501 "configure"
 #include "confdefs.h"
@@ -10527,7 +10531,7 @@
 ac_lib_var=`echo dgemm'_'dgemm_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-ldgemm -lblas $LIBS"
+LIBS="-ldgemm $LIBBLAS $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 10533 "configure"
 #include "confdefs.h"
@@ -10559,7 +10563,7 @@
 ac_lib_var=`echo sgemm'_'sgemm_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-lsgemm -lblas $LIBS"
+LIBS="-lsgemm $LIBBLAS $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 10565 "configure"
 #include "confdefs.h"
@@ -10586,7 +10590,7 @@
 
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-  blas_ok=yes; BLASLIB="-lsgemm -ldgemm -lblas"
+  blas_ok=yes; BLASLIB="-lsgemm -ldgemm $LIBBLAS"
 else
   echo "$ac_t""no" 1>&6
 fi
@@ -10684,12 +10688,12 @@
 
 # Generic BLAS library
 if test $blas_ok = no; then
-	echo $ac_n "checking for sgemm_ in -lblas""... $ac_c" 1>&6
-echo "configure:10689: checking for sgemm_ in -lblas" >&5
+	echo $ac_n "checking for sgemm_ in $LIBBLAS""... $ac_c" 1>&6
+echo "configure:10689: checking for sgemm_ in $LIBBLAS" >&5
 ac_lib_var=`echo blas'_'sgemm_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-lblas  $LIBS"
+LIBS="$LIBBLAS  $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 10695 "configure"
 #include "confdefs.h"
@@ -10716,7 +10720,7 @@
 
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-  blas_ok=yes; BLASLIB="-lblas"
+  blas_ok=yes; BLASLIB="$LIBBLAS"
 else
   echo "$ac_t""no" 1>&6
 fi
@@ -10904,12 +10908,12 @@
 if test $lapack_ok = no; then
 	save_libs="$LIBS"; LIBS="$BLASLIB $MATHLIB $LIBS"
 	save_LDFLAGS="$LDFLAGS"; LDFLAGS="$LAPACKLIB $LDFLAGS"
-	echo $ac_n "checking for desgv_ in -llapack""... $ac_c" 1>&6
-echo "configure:10909: checking for desgv_ in -llapack" >&5
+	echo $ac_n "checking for desgv_ in $LIBLAPACK""... $ac_c" 1>&6
+echo "configure:10909: checking for desgv_ in $LIBLAPACK" >&5
 ac_lib_var=`echo lapack'_'desgv_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-llapack $FLIBS $LIBS"
+LIBS="$LIBLAPACK $FLIBS $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 10915 "configure"
 #include "confdefs.h"
@@ -10936,7 +10940,7 @@
 
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-  lapack_ok=yes; LAPACKLIB="-llapack"
+  lapack_ok=yes; LAPACKLIB="$LIBLAPACK"
 else
   echo "$ac_t""no" 1>&6
 fi
@@ -10953,12 +10957,12 @@
 
 
 
-echo $ac_n "checking for dgesv_ in -llapack""... $ac_c" 1>&6
-echo "configure:10958: checking for dgesv_ in -llapack" >&5
+echo $ac_n "checking for dgesv_ in $LIBLAPACK""... $ac_c" 1>&6
+echo "configure:10958: checking for dgesv_ in $LIBLAPACK" >&5
 ac_lib_var=`echo lapack'_'dgesv_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-llapack $BLASLIB $MATHLIB  $LIBS"
+LIBS="$LIBLAPACK $BLASLIB $MATHLIB  $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 10964 "configure"
 #include "confdefs.h"
@@ -10985,16 +10989,16 @@
 
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-  LAPACKLIB="$LAPACKLIB -llapack "
+  LAPACKLIB="$LAPACKLIB $LIBLAPACK "
 else
   echo "$ac_t""no" 1>&6
 
-echo $ac_n "checking for dgesv_ in -llapack""... $ac_c" 1>&6
-echo "configure:10994: checking for dgesv_ in -llapack" >&5
+echo $ac_n "checking for dgesv_ in $LIBLAPACK""... $ac_c" 1>&6
+echo "configure:10994: checking for dgesv_ in $LIBLAPACK" >&5
 ac_lib_var=`echo lapack'_'dgesv_ | sed 'y%./+-%__p_%'`
 
 ac_save_LIBS="$LIBS"
-LIBS="-llapack $BLASLIB $MATHLIB -lg2c $LIBS"
+LIBS="$LIBLAPACK $BLASLIB $MATHLIB -lg2c $LIBS"
 cat > conftest.$ac_ext <<EOF
 #line 11000 "configure"
 #include "confdefs.h"
@@ -11021,7 +11025,7 @@
 
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-  LAPACKLIB="$LAPACKLIB -llapack -lg2c"
+  LAPACKLIB="$LAPACKLIB $LIBLAPACK -lg2c"
 else
   echo "$ac_t""no" 1>&6
 
@@ -12475,9 +12479,10 @@
 if test x$GCC = xyes ; then
 	# GNU C compiler (>= 4.2.1)
 	OMPCFLAGS=-fopenmp
-elif test ${CC} = "icc" ; then
+fi
+if test ${CC} = "icc" ; then
 	# Intel compiler
-	OMPCFLAGS=-openmp
+	OMPCFLAGS=-parallel
 elif test ${CC} = "opencc" ; then
 	# AMD's x86 Open64 compiler
 	OMPCFLAGS=-mp
