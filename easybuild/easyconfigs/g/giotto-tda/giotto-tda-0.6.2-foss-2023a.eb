easyblock = 'PythonBundle'

name = 'giotto-tda'
version = '0.6.2'

homepage = 'https://github.com/giotto-ai/giotto-tda'
description = """
giotto-tda is a high-performance topological machine learning toolbox in Python built on top of
scikit-learn and is distributed under the GNU AGPLv3 license. It is part of the Giotto family of
open-source projects.
"""

toolchain = {'name': 'foss', 'version': '2023a'}

builddependencies = [
    ('CMake', '3.26.3'),
    ('Eigen', '3.4.0'),
    ('pybind11', '2.11.1'),  # Needed for pyflagser
    ('Boost', '1.82.0'),
]

dependencies = [
    ('Python', '3.11.3'),
    ('SciPy-bundle', '2023.07'),
    ('scikit-learn', '1.4.2'),
    ('plotly.py', '5.16.0'),
    ('jupyter-server', '2.14.0'),
    ('python-igraph', '0.11.4'),
]

_flagser_commit = '7ffe927'
_junction_commit = '5ad3be7'
_turf_commit = '9ae0d4b'
_hera_commit = '2c5e6c6'
_gudhi_commit = 'a265b03'
components = [
    ('flagser', _flagser_commit, {
        'easyblock': 'CMakeMake',
        'sources': [{
            'filename': SOURCE_TAR_XZ,
            'git_config': {
                'url': 'https://github.com/luetge/',
                'repo_name': 'flagser',
                'commit': _flagser_commit,
            },
        }],
        'preconfigopts': (
            "sed -i '/^add_custom_command(/,/^)/d' ../flagser/CMakeLists.txt && "
            "sed -i '/^add_custom_target(generate_custom_algorithms DEPENDS include\\/algorithms.h)/d'"
            " ../flagser/CMakeLists.txt && "
            "sed -i '/#include <queue>/a #include <limits>' ../flagser/include/persistence.h && "
        ),
        'start_dir': 'flagser',
        'checksums': ['054d73f6d565ff88e8521703ef6eee38ffd640836c22de71f8dab01c35d09f00'],
    }),
    ('junction', _junction_commit, {
        'easyblock': 'PackedBinary',
        'sources': [{
            'filename': SOURCE_TAR_XZ,
            'git_config': {
                'url': 'https://github.com/preshing/',
                'repo_name': 'junction',
                'commit': _junction_commit,
            },
        }],
        'checksums': ['557bddeed06ba670b095e47da77189fb4ddbb0769e5f85885e8a78c1a8161f5e'],
    }),
    ('turf', _turf_commit, {
        'easyblock': 'PackedBinary',
        'sources': [{
            'filename': SOURCE_TAR_XZ,
            'git_config': {
                'url': 'https://github.com/preshing/',
                'repo_name': 'turf',
                'commit': _turf_commit,
            },
        }],
        'checksums': ['d0e113689b86ee0d6fdb2bfd575032cffbc4dde2092268f97651f3a33edffc5d'],
    }),
    ('hera', _hera_commit, {
        'easyblock': 'PackedBinary',
        'sources': [{
            'filename': SOURCE_TAR_XZ,
            'git_config': {
                'url': 'https://github.com/anigmetov/',
                'repo_name': 'hera',
                'commit': _hera_commit,
            },
        }],
        'checksums': ['c7455ac90c231ce000b2e9b2df5ea5a5004a69f910ffe63834b6069083e422d5'],
    }),
    ('gudhi-devel', _gudhi_commit, {
        'easyblock': 'PackedBinary',
        'sources': [{
            'filename': SOURCE_TAR_XZ,
            'git_config': {
                'url': 'https://github.com/giotto-ai/',
                'repo_name': 'gudhi-devel',
                'commit': _gudhi_commit,
            },
        }],
        'checksums': ['9d0439a6c3484216ec6672c185576837dc39334f326b6524359068fb38ec4af4'],
    }),
]

github_account = 'giotto-ai'

exts_list = [
    ('pyflagser', '0.4.7', {
        'preinstallopts': (
            "sed -i 's| self.install_dependencies()||' setup.py && "
            "sed -i 's|flagser/src/|../../flagser/src/|' src/flagser*.cpp && "
            "sed -i 's|add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/pybind11)|find_package(pybind11 REQUIRED)|' "
            "CMakeLists.txt && "
        ),
        'source_urls': ['https://github.com/%(github_account)s/%(name)s/archive'],
        'sources': ['v%(version)s.tar.gz'],
        'checksums': ['cf93c15208c2c8d1094eff75fa098027d07eb919f087e883f623596b84755968'],
    }),
    ('giotto-ph', '0.2.4', {
        'modulename': 'gph',
        'preinstallopts': (
            "sed -i 's| self.install_dependencies()||' setup.py && "
            "sed -i 's|add_subdirectory(${EXT_DIR}/pybind11)|find_package(pybind11 REQUIRED)|' "
            "CMakeLists.txt && "
            "sed -i 's|add_subdirectory(${EXT_DIR}/junction)|add_subdirectory(../../junction junction)|' "
            "CMakeLists.txt && "
            "sed -i 's|add_subdirectory(${EXT_DIR}/turf)|add_subdirectory(../../turf turf)|' CMakeLists.txt && "
        ),
        'source_urls': ['https://github.com/%(github_account)s/%(name)s/archive'],
        'sources': ['v%(version)s.tar.gz'],
        'checksums': ['22fb5e5030f1e19bbef69efab855e57e19e445b5ef78cc9c1c8887c3abb569d3'],
    }),
    (name, version, {
        'modulename': 'gtda',
        'preinstallopts': (
            "sed -i 's| self.install_dependencies()||' setup.py && "
            "sed -i 's|add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/gtda/externals/pybind11)| "
            "find_package(pybind11 REQUIRED)|' CMakeLists.txt && "
            "sed -i 's|set(HERA_DIR \"gtda/externals/hera\")|set(HERA_DIR \"%(builddir)s/hera\")|' CMakeLists.txt && "
            "sed -i 's|set(GUDHI_SRC_DIR \"gtda/externals/gudhi-devel/src\")|"
            "set(GUDHI_SRC_DIR \"%(builddir)s/gudhi-devel/src\")|' CMakeLists.txt && "
            "sed -i 's|scikit-learn ==|scikit-learn >=|' requirements.txt && "
        ),
        'source_urls': ['https://github.com/%(github_account)s/%(name)s/archive'],
        'sources': ['v%(version)s.tar.gz'],
        'checksums': ['a0070e56a0bb4866b82462e489a4ce22be96ab921ecf69f5bc3194d905d69ef0'],
    }),
]

moduleclass = 'ai'
