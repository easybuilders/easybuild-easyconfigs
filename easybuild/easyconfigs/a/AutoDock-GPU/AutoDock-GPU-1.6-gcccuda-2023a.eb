easyblock = 'MakeCp'

name = 'AutoDock-GPU'
version = '1.6'

homepage = 'https://github.com/ccsb-scripps/AutoDock-GPU'
description = """OpenCL and Cuda accelerated version of AutoDock. It leverages its embarrasingly
parallelizable LGA by processing ligand-receptor poses in parallel over
multiple compute units.
AutoDock is a suite of automated docking tools. It is designed to predict how
small molecules, such as substrates or drug candidates, bind to a receptor of
known 3D structure."""

toolchain = {'name': 'gcccuda', 'version': '2023a'}
toolchainopts = {'cstd': 'c++17'}

# Fetching from Github to obtain vendored dependency which is not part of released tarball
sources = [{
	'filename': 'v%(version)s.tar.gz',
	'git_config': {
        	'url': 'https://github.com/ccsb-scripps',
		'repo_name': 'AutoDock-GPU',
		'tag': 'v%(version)s',
	        'recursive': True,
	        'keep_git_dir': False,
	    },
	}
]

parallel = 1

# put CUDA compute capabilities in a shell variable to strip dots in make command
local_prebuildopts = '' #CUDA_CC_TARGETS="%(cuda_cc_space_sep)s"; '

# Use complation flags from EB
local_prebuildopts += "sed -i 's/^LFLAGS=.*/LFLAGS=$(LDFLAGS)/;s/^CFLAGS=.*/CFLAGS+=$(IFLAGS) $(LFLAGS)/' Makefile.Cuda && "
local_prebuildopts += 'GPU_INCLUDE_PATH=$EBROOTCUDA/include '
local_prebuildopts += 'GPU_LIBRARY_PATH=$EBROOTCUDA/lib '

# build for CUDA with defined CUDA compute capabilities
local_buildsopts = 'TENSOR=ON DEVICE=GPU' # TARGETS="${CUDA_CC_TARGETS//./}"'

local_nwi = [64, 128, 256]
buildopts = ['DEVICE=GPU NUMWI=32'] 
buildopts += [ "%s NUMWI=%s" % (local_buildsopts, x) for x in local_nwi ]
prebuildopts = len(buildopts) * [ local_prebuildopts ]

files_to_copy = [
    (['bin/*'], 'bin'),
    (['doc', 'examples', 'LICENSE', 'LICENSE_LGPL', 'README.md'], 'share'),
    (['input'], 'share/examples'),
]

postinstallcmds = [
    "cd %(installdir)s/bin && ln -s autodock_gpu_128wi autodock_gpu",
]

sanity_check_paths = {
    'files': ['bin/autodock_gpu', 'bin/adgpu_analysis'] +
    	     ['bin/autodock_gpu_%swi' % x for x in local_nwi ],
    'dirs': ['share'],
}

sanity_check_commands = [('autodock_gpu', '--help')] + [('autodock_gpu_%swi' % x, '--help') for x in local_nwi]

moduleclass = 'tools'
