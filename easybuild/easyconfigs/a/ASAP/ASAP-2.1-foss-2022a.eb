easyblock = 'CMakeMake'

name = 'ASAP'
version = '2.1'

homepage = 'https://computationalpathologygroup.github.io/ASAP/'
description = """ASAP focuses on fast and fluid image viewing with an easy-to-use interface 
for making annotations. It consists of two main components: an IO library for reading and writing 
multi-resolution images and a viewer component for visualizing such images."""

toolchain = {'name': 'foss', 'version': '2022a'}

source_urls = ['https://github.com/computationalpathologygroup/%(name)s/archive']
sources = [SOURCE_TAR_GZ]
patches = [
    'ASAP-2.1-libjpeg.patch',
    'ASAP-2.1-pugixml.patch',
    'ASAP-2.1-cmath.patch',
]
checksums = [
    '7ba9f39d09bada808f760c5dc9ac0cda0d221fd1393a0a3f9decfd6b5e913b3c',  # ASAP-2.1.tar.gz
    'dbdf26324a7521b4beaa7ec2c0585f0816619cd73b3125efd313eb48c4813a43',  # ASAP-2.1-libjpeg.patch
    'f578bb3ec4cbce573d4b9acd695eb55446592f4ac00551656a06f113ba09a9a7',  # ASAP-2.1-pugixml.patch
    'e33d83853e0bd51113a886d0793504ce0abfb15fdf88410a19287d46fafd33c4',  # ASAP-2.1-cmath.patch
]

builddependencies = [
    ('binutils', '2.38'),
    ('CMake', '3.23.1'),
]
dependencies = [
    ('Boost', '1.79.0'),
    ('Python', '3.10.4'),
    ('OpenCV', '4.6.0', '-contrib'),
    ('Qt5', '5.15.5'),
    ('LibTIFF', '4.3.0'),
    ('libjpeg-turbo', '2.1.3'),
    ('JasPer', '2.0.33'),
    ('DCMTK', '3.6.7'),
    ('SWIG', '4.0.2'),
    ('OpenSlide', '3.4.1', '-largefiles'),
    ('pugixml', '1.12.1'),
    ('zlib', '1.2.12'),
]

configopts = " ".join([
    "-DOPENSLIDE_INCLUDE_DIR=$EBROOTOPENSLIDE/include/openslide",
    "-DPugiXML_INCLUDE_DIR=$EBROOTPUGIXML/include",
    "-DDCMTKJPEG_INCLUDE_DIR=$EBROOTDCMTK/include",
    "-DWRAP_MULTIRESOLUTIONIMAGEINTERFACE_PYTHON=TRUE",
    "-DBUILD_ASAP=TRUE",
    "-DBUILD_EXECUTABLES=TRUE",
    "-DBUILD_IMAGEPROCESSING=TRUE",
    "-DBUILD_MULTIRESOLUTIONIMAGEINTERFACE_VSI_SUPPORT=TRUE",
    "-DSWIG_EXECUTABLE=$EBROOTSWIG/bin/swig"
])


sanity_check_paths = {
    'files': [
        'bin/%(name)s',
        'bin/multiresolutionimageinterface.py',
        'lib/libmultiresolutionimageinterface.%s' % SHLIB_EXT],
    'dirs': ['bin'],
}

sanity_check_commands = ['python -c "import multiresolutionimageinterface"']

# ASAP installs its python interface in bin. Ugly, but we'll need to add it to PYTHONPATH
modextrapaths = {'PYTHONPATH': ['bin']}

moduleclass = 'vis'
