*******> update.2

Author: Charles Lin

Date: June 17, 2024

Programs: pmemd, pmemd.decomp

Description: Adds compilation target pmemd.decomp and adds support for
Thermodynamic Integration Atomic Decomposition accessable in pmemd.decomp
and only through the ntwd variable which can be fine tuned with the
following masks: decompmask, ligmask, proteinmask, cofacmask
--------------------------------------------------------------------------------

 src/pmemd/src/CMakeLists.txt                |    31 +-
 src/pmemd/src/angles.i                      |    22 +
 src/pmemd/src/bonds.i                       |    20 +
 src/pmemd/src/dihedrals.i                   |    28 +
 src/pmemd/src/extra_pnts_nb14.i             |    22 +
 src/pmemd/src/file_io_dat.F90               |     2 +
 src/pmemd/src/get_cmdline.F90               |     8 +
 src/pmemd/src/master_setup.F90              |    12 +
 src/pmemd/src/mdin_ctrl_dat.F90             |    27 +-
 src/pmemd/src/nb_exclusions.F90             |    20 +
 src/pmemd/src/pairs_calc_ti_AUTO.i          |  3040 +-
 src/pmemd/src/pme_force.F90                 |    38 +
 src/pmemd/src/pme_slab_recip.F90            |    30 +
 src/pmemd/src/runfiles.F90                  |     7 +-
 src/pmemd/src/runmd.F90                     |    16 +-
 src/pmemd/src/runreweight.F90               |    16 +
 src/pmemd/src/scalar_sum_slab.i             |   110 +
 src/pmemd/src/ti_code2.py                   |   107 +-
 src/pmemd/src/ti_decomp.F90                 |   270 +
 19 files changed, 3666 insertions(+), 160 deletions(-)

diff --git src/pmemd/src/CMakeLists.txt src/pmemd/src/CMakeLists.txt
index baa8395efa..01fff28973 100644
--- src/pmemd/src/CMakeLists.txt
+++ src/pmemd/src/CMakeLists.txt
@@ -33,7 +33,8 @@ set(PMEMD_FORTRAN_SOURCES gbl_constants.F90 gbl_datatypes.F90 state_info.F90 fil
         xray_interface_pre_init_data.F90
         constants.F90 assert.F90
         hybridsolvent_remd.F90
-        md_scheme.F90)
+        md_scheme.F90
+        ti_decomp.F90)
 
 set(PMEMD_FORTRAN_GPU_SOURCES
     xray_interface_impl_gpu.F90
@@ -214,6 +215,34 @@ endif()
 
 install(TARGETS pmemd DESTINATION ${BINDIR} COMPONENT pmemd)
 
+add_executable(pmemd.decomp ${PMEMD_C_SOURCES} ${PMEMD_CXX_SOURCES} ${PMEMD_FORTRAN_SOURCES} ${PMEMD_NFE_SOURCES} ${PLUMED_SOURCE})
+config_module_dirs(pmemd.decomp ${PMEMD_MOD_DIR} ${AMBER_COMMON_MOD_DIR} ${NETCDF_FORTRAN_MOD_DIR})
+
+# Address sanitizer must be first linked library
+target_link_libraries(pmemd.decomp emil amber_common netcdff netlib boost_headers ${KMMD_LIB} PMEMD::xray_cpu)
+list(APPEND PMEMD_DEFINITIONS TIDECOMP)
+target_compile_definitions(pmemd.decomp PRIVATE ${PMEMD_DEFINITIONS})
+set_property(TARGET pmemd.decomp PROPERTY LINKER_LANGUAGE Fortran)
+
+# PLUMED
+if(PLUMED_RUNTIME_LINK)
+    target_link_libraries(pmemd.decomp dl)
+    set_target_properties(pmemd.decomp PROPERTIES ENABLE_EXPORTS TRUE)
+else()
+    if(plumed_ENABLED)
+        target_link_libraries(pmemd.decomp plumed::plumed)
+    endif()
+endif()
+
+if(mbx_ENABLED)
+    target_link_libraries(pmemd.decomp MBX::mbx)
+    target_compile_definitions(pmemd.decomp PRIVATE MBX)
+endif()
+
+install(TARGETS pmemd.decomp DESTINATION ${BINDIR} COMPONENT pmemd_decomp)
+
+list(REMOVE_ITEM PMEMD_DEFINITIONS TIDECOMP)
+
 # MPI parallelization
 if(MPI)
 	make_mpi_version(pmemd pmemd.MPI LANGUAGES Fortran)
diff --git src/pmemd/src/angles.i src/pmemd/src/angles.i
index 30f219c7fe..70db38464c 100644
--- src/pmemd/src/angles.i
+++ src/pmemd/src/angles.i
@@ -6,6 +6,9 @@
   use omp_lib
 #endif
   use mdin_ctrl_dat_mod
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -142,6 +145,25 @@ if(master) then
 #endif
             call ti_update_ene(eaw, si_angle_ene, ti_region, 2)
 
+#ifdef TIDECOMP
+            lig_dvdl_decomp(id_atom_region(i)+id_atom_region(j)) = &
+               lig_dvdl_decomp(id_atom_region(i)+id_atom_region(j)) + &
+               eaw * ti_item_dweights(2, ti_region)
+ 
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),i) = &
+               lig_ti_decomp(id_atom_region(i)+id_atom_region(j),i) + &
+               eaw * ti_item_dweights(2, ti_region) / 3.0
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),j) = &
+               lig_ti_decomp(id_atom_region(i)+id_atom_region(j),j) + &
+               eaw * ti_item_dweights(2, ti_region) / 3.0
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),k) = &
+               lig_ti_decomp(id_atom_region(i)+id_atom_region(j),k) + &
+               eaw * ti_item_dweights(2, ti_region) / 3.0
+
+            ti_decomp(i) = ti_decomp(i) + eaw * ti_item_dweights(2, ti_region) / 3.0d0
+            ti_decomp(j) = ti_decomp(j) + eaw * ti_item_dweights(2, ti_region) / 3.0d0
+            ti_decomp(k) = ti_decomp(k) + eaw * ti_item_dweights(2, ti_region) / 3.0d0
+#endif
 #ifdef MPI
 #ifdef GBorn
             !$OMP END CRITICAL
diff --git src/pmemd/src/bonds.i src/pmemd/src/bonds.i
index 24f72d066c..fc376fc8d8 100644
--- src/pmemd/src/bonds.i
+++ src/pmemd/src/bonds.i
@@ -1,3 +1,6 @@
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   use nmr_calls_mod
   use parallel_dat_mod
   use prmtop_dat_mod
@@ -118,6 +121,23 @@
             ! Linear scaling
             call ti_update_ene((df * da) + (df_press * da_press) + (df_pull * da_pull), &
                                si_bond_ene, ti_region, 2)
+
+#ifdef TIDECOMP
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),i) = &
+               lig_ti_decomp(id_atom_region(i)+id_atom_region(j),i) + &
+               df * da * ti_item_dweights(2, ti_region) / 2.0
+
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),j) = &
+               lig_ti_decomp(id_atom_region(i)+id_atom_region(j),j) + &
+               df * da * ti_item_dweights(2, ti_region) / 2.0
+
+            lig_dvdl_decomp(id_atom_region(i)+id_atom_region(j)) = &
+               lig_dvdl_decomp(id_atom_region(i)+id_atom_region(j)) + &
+               df * da * ti_item_dweights(2, ti_region)
+
+            ti_decomp(i) = ti_decomp(i) + df * da * ti_item_dweights(2, ti_region) / 2.0d0
+            ti_decomp(j) = ti_decomp(j) + df * da * ti_item_dweights(2, ti_region) / 2.0d0
+#endif
           else
 
             ! No need to scale da as we always scale df
diff --git src/pmemd/src/dihedrals.i src/pmemd/src/dihedrals.i
index 0ac752d8fe..dcdece0b7f 100644
--- src/pmemd/src/dihedrals.i
+++ src/pmemd/src/dihedrals.i
@@ -1,3 +1,6 @@
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   use gbl_constants_mod
   use mdin_ctrl_dat_mod
   use parallel_dat_mod
@@ -215,6 +218,31 @@ if(master) then
 #endif
           if (ti_mode .eq. 1 .or. ti_lscale) then !linear scaling 
             call ti_update_ene(epw, si_dihedral_ene, ti_region, 2)
+
+#ifdef TIDECOMP
+            lig_dvdl_decomp(id_atom_region(i)+id_atom_region(j)) = &
+              lig_dvdl_decomp(id_atom_region(i)+id_atom_region(j)) + &
+              epw * ti_item_dweights(2, ti_region)
+
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),i) = &
+              lig_ti_decomp(id_atom_region(i)+id_atom_region(j),i) + &
+              epw * ti_item_dweights(2, ti_region)/4.0
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),j) = &
+              lig_ti_decomp(id_atom_region(i)+id_atom_region(j),j) + &
+              epw * ti_item_dweights(2, ti_region)/4.0
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),k) = &
+              lig_ti_decomp(id_atom_region(i)+id_atom_region(j),k) + &
+              epw * ti_item_dweights(2, ti_region)/4.0
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),l) = &
+              lig_ti_decomp(id_atom_region(i)+id_atom_region(j),l) + &
+              epw * ti_item_dweights(2, ti_region)/4.0
+
+            ti_decomp(i) = ti_decomp(i) + epw * ti_item_dweights(2, ti_region) / 4.0d0
+            ti_decomp(j) = ti_decomp(j) + epw * ti_item_dweights(2, ti_region) / 4.0d0
+            ti_decomp(k) = ti_decomp(k) + epw * ti_item_dweights(2, ti_region) / 4.0d0
+            ti_decomp(l) = ti_decomp(l) + epw * ti_item_dweights(2, ti_region) / 4.0d0
+#endif
+
             epw = epw * ti_item_weights(2,ti_region)
           else
             ti_ene(ti_region,si_dihedral_ene) = &
diff --git src/pmemd/src/extra_pnts_nb14.i src/pmemd/src/extra_pnts_nb14.i
index d6b39a55f1..d742d29502 100644
--- src/pmemd/src/extra_pnts_nb14.i
+++ src/pmemd/src/extra_pnts_nb14.i
@@ -1,3 +1,6 @@
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   use prmtop_dat_mod, only : ntypes, gbl_one_scee, gbl_one_scnb
   use parallel_dat_mod
   use ti_mod
@@ -139,6 +142,25 @@
           if(ti_mode .eq. 1 .or. ti_lscale) then !linear scaling
             call ti_update_ene(g, si_elect_14_ene, ti_region, 4)
             call ti_update_ene((f12 - f6) * scnb0, si_vdw_14_ene, ti_region, 6)
+
+#ifdef TIDECOMP
+            lig_dvdl_decomp(id_atom_region(i)+id_atom_region(j)) = &
+               lig_dvdl_decomp(id_atom_region(i)+id_atom_region(j)) + &
+               g*ti_item_dweights(5, ti_region) + (f12-f6)*scnb0*ti_item_dweights(6, ti_region)
+
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),i) = &
+               lig_ti_decomp(id_atom_region(i)+id_atom_region(j),i) + &
+               g*ti_item_dweights(5, ti_region)/2.0 + (f12-f6)*scnb0*ti_item_dweights(6, ti_region) / 2.0
+            lig_ti_decomp(id_atom_region(i)+id_atom_region(j),j) = &
+               lig_ti_decomp(id_atom_region(i)+id_atom_region(j),j) + &
+               g*ti_item_dweights(5, ti_region)/2.0 + (f12-f6)*scnb0*ti_item_dweights(6, ti_region) / 2.0
+
+            ti_decomp(i) = ti_decomp(i) &
+               + g/2.0d0*ti_item_dweights(5, ti_region) + (f12-f6)*scnb0/2.0d0*ti_item_dweights(6, ti_region)
+            ti_decomp(j) = ti_decomp(j) &
+               + g/2.0d0*ti_item_dweights(5, ti_region) + (f12-f6)*scnb0/2.0d0*ti_item_dweights(6, ti_region)
+#endif
+
             g = g * ti_item_weights(5,ti_region)    
             f12 = f12 * ti_item_weights(6,ti_region)
             f6 = f6 * ti_item_weights(6,ti_region)       
diff --git src/pmemd/src/file_io_dat.F90 src/pmemd/src/file_io_dat.F90
index dc367c0483..29a0fc3be4 100644
--- src/pmemd/src/file_io_dat.F90
+++ src/pmemd/src/file_io_dat.F90
@@ -47,6 +47,7 @@ module file_io_dat_mod
   character(max_fn_len), save   :: phmdrestrt_name
   character(max_fn_len), save   :: phmdstrt_name
   character(max_fn_len), save   :: phmdparm_name
+  character(max_fn_len), save   :: decomp_name
 
 !AMD file for reweighting values
   character(max_fn_len), save   :: amdlog_name = 'amd.log'
@@ -145,6 +146,7 @@ module file_io_dat_mod
   integer, parameter    :: hybridsolvent_remd_traj = 45
 ! Lig-GaMD  
   integer, parameter    :: gamdlig       = 47
+  integer, parameter    :: decomp_unit   = 48
 ! Flags to allow certain risky simulations
   integer, save         :: smbx_permit = 0
 
diff --git src/pmemd/src/get_cmdline.F90 src/pmemd/src/get_cmdline.F90
index 18ca19caeb..cefcabc8a2 100644
--- src/pmemd/src/get_cmdline.F90
+++ src/pmemd/src/get_cmdline.F90
@@ -185,6 +185,9 @@ subroutine get_cmdline(terminal_flag)
   phmdstrt_name = 'phmdstrt'
   phmdparm_name = 'phmdparm'
   phmdrestrt_name = 'phmdrestrt'
+#ifdef TIDECOMP
+  decomp_name = 'decomp.log'
+#endif
 #ifdef MPI
   proc_map_name = ' '
 
@@ -303,6 +306,11 @@ subroutine get_cmdline(terminal_flag)
   else if (arg .eq. '-phmdparm') then
     iarg = iarg + 1
     call getarg_wrap(iarg, phmdparm_name)
+#ifdef TIDECOMP
+  else if (arg .eq. '-decomp') then
+    iarg = iarg + 1
+    call getarg_wrap(iarg, decomp_name)
+#endif
   else if (arg .eq. '-cpin') then
     iarg = iarg + 1
     call getarg_wrap(iarg, cpin_name)
diff --git src/pmemd/src/master_setup.F90 src/pmemd/src/master_setup.F90
index 34f31b1e9c..81d4db348a 100644
--- src/pmemd/src/master_setup.F90
+++ src/pmemd/src/master_setup.F90
@@ -77,6 +77,9 @@ subroutine master_setup(num_ints, num_reals, new_stack_limit, terminal_flag)
   use ramd_mod
   use remd_mod
   use ti_mod
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   use shake_mod
 #ifdef GTI
   use gti_mod
@@ -869,6 +872,15 @@ subroutine master_setup(num_ints, num_reals, new_stack_limit, terminal_flag)
       gbl_labres, atm_crd, crgmask, atm_qterm)
   end if
 
+#ifdef TIDECOMP
+  call init_ti_decomp(natom, ntwd)
+  call init_pme_decomp_bookkeeping !(nfft1,nfft2,nfft3,order)
+  call init_ti_decomp_mask(natom, nres, atm_igraph, atm_isymbl, &
+       gbl_res_atms, gbl_labres, atm_crd)
+  call init_region_decomp(natom, nres, atm_igraph, atm_isymbl, &
+       gbl_res_atms, gbl_labres, atm_crd)
+#endif
+
 #ifdef GTI
   !! REAF
   if (ifreaf .ne. 0) then
diff --git src/pmemd/src/mdin_ctrl_dat.F90 src/pmemd/src/mdin_ctrl_dat.F90
index d34f863ef1..cf545a24b2 100644
--- src/pmemd/src/mdin_ctrl_dat.F90
+++ src/pmemd/src/mdin_ctrl_dat.F90
@@ -68,8 +68,9 @@ use file_io_dat_mod
                                 gbion, &           !GB-ion option
                                 ischeme, ithermostat, & !middle_scheme
                                 gti_resv_velmode, & ! Mode for scaling velocities of dummy atoms
-                                gti_resv_mapmode, &! Mode for determining how dummy atoms are mapped to reservoir structures
-                                asm !ASM
+                                gti_resv_mapmode, & ! Mode for determining how dummy atoms are mapped to reservoir structures
+                                asm, & !ASM
+                                ntwd ! decomp
 
   integer, dimension(3) :: gti_resv_anch
   integer, dimension(5)::  rmsd_ti
@@ -129,11 +130,12 @@ use file_io_dat_mod
              mcwatretry, & !173
              gbion, &       !174
              ischeme, ithermostat, & !176
-             gti_resv_velmode, gti_resv_mapmode  !178
+             gti_resv_velmode, gti_resv_mapmode, &  !178
+             ntwd !179
 
   ! This variable must be set to the total number of integers in the
   ! mdin_ctrl_int common block.
-  integer, parameter    :: mdin_ctrl_int_cnt = 186 !! add 8 for the two extra arrays
+  integer, parameter    :: mdin_ctrl_int_cnt = 187 !! add 8 for the two extra arrays
   save  :: / mdin_ctrl_int /
 
 
@@ -267,7 +269,7 @@ use file_io_dat_mod
 
   character(256), public :: restraintmask, bellymask, timask1, timask2, &
                             crgmask, noshakemask, scmask1, scmask2, ligmask, &
-                            ti_vdw_mask, &
+                            decompmask, cofacmask, proteinmask, ti_vdw_mask, &
                             sc_bond_mask1, sc_angle_mask1, sc_torsion_mask1, &
                             sc_bond_mask2, sc_angle_mask2, sc_torsion_mask2, &
                             mcwatmask, &
@@ -427,6 +429,7 @@ use file_io_dat_mod
                         mcboxshift, mcligshift, midpoint, reservoir_exchange_step, &
                         ramdboost, ramdint, ramdmaxdist, ramdboostrate, &
                         ramdboostfreq, ramdligmask, ramdproteinmask, &
+                        decompmask, ligmask, ntwd, cofacmask, proteinmask, &
                         reweight, iextpot, ionstepvelocities, hybridgb, numwatkeep, &
                         gbion, gi_coef, gi_coef_1, gi_coef_2, gb_neckscale_ion_1, gb_neckscale_ion_2, &
                         intdiel_ion_1, intdiel_ion_2, &
@@ -545,6 +548,7 @@ subroutine init_mdin_ctrl_dat(remd_method, rremd_type)
   sigma0D = 6.0 ! 10*kB*T
   sigma0P = 6.0 ! 10*kB*T
   sigma0B = 6.0 ! 10*kB*T
+  ligmask = ''
   bgpro2atm=0
   edpro2atm=0
   ibblig = 0
@@ -565,6 +569,11 @@ subroutine init_mdin_ctrl_dat(remd_method, rremd_type)
   no_intermolecular_bonds = 1
   ene_avg_sampling = -1         ! -1 means "set to default value".
   ntx = 1
+  ntwd = 0
+  decompmask = ''
+  ligmask = ''
+  proteinmask = ''
+  cofacmask = ''
   irest = 0
   ntrx = 1
 #ifdef BINTRAJ
@@ -1387,6 +1396,14 @@ subroutine validate_mdin_ctrl_dat(remd_method, rremd_type)
 #endif
   end if
   
+#ifndef TIDECOMP
+    write(0,*)ntwd
+    if(ntwd .ne. 0) then
+      write(mdout, '(a,a)') error_hdr, 'ntwd (TI decomp) is only supported in the executible pmemd.decomp'
+      inerr = 1
+    end if
+#endif
+
   if(mcwat .eq. 1) then
 #ifdef MPI
     if(remd_method .eq. 0) then
diff --git src/pmemd/src/nb_exclusions.F90 src/pmemd/src/nb_exclusions.F90
index c95d1febb4..45e629bc92 100644
--- src/pmemd/src/nb_exclusions.F90
+++ src/pmemd/src/nb_exclusions.F90
@@ -709,6 +709,9 @@ subroutine nb_adjust(atm_cnt, &
                      frc, ene, virial)
 #endif
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   use mdin_ewald_dat_mod
 #ifdef MPI
   use parallel_dat_mod, only : mytaskid
@@ -884,6 +887,23 @@ subroutine nb_adjust(atm_cnt, &
           if (ti_region .ne. 0) then
             !undo the recip calc which was scaled by ti_weights
             ene_stk = ene_stk + cgi_cgj * d0 * ti_item_weights(5,ti_region)
+
+#ifdef TIDECOMP
+            lig_dvdl_decomp(id_atom_region(atm_i)+id_atom_region(atm_j))= &
+               lig_dvdl_decomp(id_atom_region(atm_i)+id_atom_region(atm_j)) + &
+               cgi_cgj * d0 * ti_item_dweights(5, ti_region)
+
+            lig_ti_decomp(id_atom_region(atm_i)+id_atom_region(atm_j), atm_i)= &
+               lig_ti_decomp(id_atom_region(atm_i)+id_atom_region(atm_j), atm_i) + &
+               cgi_cgj * d0 * ti_item_dweights(5, ti_region) / 2.0
+            lig_ti_decomp(id_atom_region(atm_i)+id_atom_region(atm_j), atm_j)= &
+               lig_ti_decomp(id_atom_region(atm_i)+id_atom_region(atm_j), atm_j) + &
+               cgi_cgj * d0 * ti_item_dweights(5, ti_region) / 2.0
+
+            ti_decomp(atm_i) = ti_decomp(atm_i) + cgi_cgj * d0 * ti_item_dweights(5, ti_region) / 2.0d0
+            ti_decomp(atm_j) = ti_decomp(atm_j) + cgi_cgj * d0 * ti_item_dweights(5, ti_region) / 2.0d0
+#endif
+
             call ti_update_ene(cgi_cgj * d0, si_elect_ene, ti_region,5)
           else
             ene_stk = ene_stk + cgi_cgj * d0
diff --git src/pmemd/src/pairs_calc_ti_AUTO.i src/pmemd/src/pairs_calc_ti_AUTO.i
index 66a0313c5a..9dfe9ba5ec 100644
--- src/pmemd/src/pairs_calc_ti_AUTO.i
+++ src/pmemd/src/pairs_calc_ti_AUTO.i
@@ -2,6 +2,9 @@
 subroutine pairs_calc_ti_linear_V0_cut1_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -57,7 +60,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -138,9 +144,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -229,9 +250,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -242,11 +278,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
         end do
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(1) = ti_pot_vdw_stk(1) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
           do bar_i = 1, bar_states
@@ -289,6 +337,9 @@ end subroutine pairs_calc_ti_linear_V0_cut1_mefv_vac
 subroutine pairs_calc_ti_linear_V0_cut1_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -344,7 +395,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -426,9 +480,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -518,9 +587,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -531,11 +615,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
         end do
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(1) = ti_pot_vdw_stk(1) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
           do bar_i = 1, bar_states
@@ -578,6 +674,9 @@ end subroutine pairs_calc_ti_linear_V0_cut1_mefv
 subroutine pairs_calc_ti_linear_V0_cut1_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -633,7 +732,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -714,9 +816,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -800,19 +917,46 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(1) = ti_pot_vdw_stk(1) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
       dfx = delx * df
@@ -850,6 +994,9 @@ end subroutine pairs_calc_ti_linear_V0_cut1_efv_vac
 subroutine pairs_calc_ti_linear_V0_cut1_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -905,7 +1052,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -987,9 +1137,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -1074,19 +1239,46 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(1) = ti_pot_vdw_stk(1) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
       dfx = delx * df
@@ -1124,6 +1316,9 @@ end subroutine pairs_calc_ti_linear_V0_cut1_efv
 subroutine pairs_calc_ti_linear_V0_cut1_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -1179,7 +1374,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -1262,6 +1460,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -1347,11 +1546,13 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -1392,6 +1593,9 @@ end subroutine pairs_calc_ti_linear_V0_cut1_fv_vac
 subroutine pairs_calc_ti_linear_V0_cut1_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -1447,7 +1651,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -1531,6 +1738,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -1617,11 +1825,13 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -1662,6 +1872,9 @@ end subroutine pairs_calc_ti_linear_V0_cut1_fv
 subroutine pairs_calc_ti_linear_V0_cut1_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -1717,7 +1930,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -1800,6 +2016,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
      
@@ -1877,10 +2094,12 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -1914,6 +2133,9 @@ end subroutine pairs_calc_ti_linear_V0_cut1_f_vac
 subroutine pairs_calc_ti_linear_V0_cut1_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -1969,7 +2191,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -2053,6 +2278,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
      
@@ -2131,10 +2357,12 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -2168,6 +2396,9 @@ end subroutine pairs_calc_ti_linear_V0_cut1_f
 subroutine pairs_calc_ti_linear_V0_cut2_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -2223,7 +2454,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -2304,9 +2538,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -2396,9 +2645,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -2414,11 +2678,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(1) = ti_pot_vdw_stk(1) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
           do bar_i = 1, bar_states
@@ -2461,6 +2737,9 @@ end subroutine pairs_calc_ti_linear_V0_cut2_mefv_vac
 subroutine pairs_calc_ti_linear_V0_cut2_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -2516,7 +2795,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -2598,9 +2880,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -2691,9 +2988,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -2709,11 +3021,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(1) = ti_pot_vdw_stk(1) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
           do bar_i = 1, bar_states
@@ -2756,6 +3080,9 @@ end subroutine pairs_calc_ti_linear_V0_cut2_mefv
 subroutine pairs_calc_ti_linear_V0_cut2_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -2811,7 +3138,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -2892,9 +3222,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -2979,9 +3324,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -2992,11 +3352,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(1) = ti_pot_vdw_stk(1) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
       dfx = delx * df
@@ -3034,6 +3406,9 @@ end subroutine pairs_calc_ti_linear_V0_cut2_efv_vac
 subroutine pairs_calc_ti_linear_V0_cut2_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -3089,7 +3464,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -3171,9 +3549,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -3259,9 +3652,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -3272,11 +3680,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(1) = ti_pot_vdw_stk(1) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
       dfx = delx * df
@@ -3314,6 +3734,9 @@ end subroutine pairs_calc_ti_linear_V0_cut2_efv
 subroutine pairs_calc_ti_linear_V0_cut2_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -3369,7 +3792,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -3452,6 +3878,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -3538,6 +3965,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -3548,6 +3976,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -3588,6 +4017,9 @@ end subroutine pairs_calc_ti_linear_V0_cut2_fv_vac
 subroutine pairs_calc_ti_linear_V0_cut2_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -3643,7 +4075,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -3727,6 +4162,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -3814,6 +4250,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
@@ -3824,6 +4261,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -3864,6 +4302,9 @@ end subroutine pairs_calc_ti_linear_V0_cut2_fv
 subroutine pairs_calc_ti_linear_V0_cut2_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -3919,7 +4360,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -4002,6 +4446,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
      
@@ -4080,6 +4525,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
 
@@ -4089,6 +4535,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -4122,6 +4569,9 @@ end subroutine pairs_calc_ti_linear_V0_cut2_f_vac
 subroutine pairs_calc_ti_linear_V0_cut2_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -4177,7 +4627,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -4261,6 +4714,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
      
@@ -4340,6 +4794,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,1)
+      ele_dweight = ti_item_dweights(4,1)
       df = b1 * delr2inv
       df = df * ele_weight
 
@@ -4349,6 +4804,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -4382,6 +4838,9 @@ end subroutine pairs_calc_ti_linear_V0_cut2_f
 subroutine pairs_calc_ti_linear_V1_cut1_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -4437,7 +4896,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -4518,9 +4980,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -4609,9 +5086,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -4622,11 +5114,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
         end do
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(2) = ti_pot_vdw_stk(2) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
           do bar_i = 1, bar_states
@@ -4669,6 +5173,9 @@ end subroutine pairs_calc_ti_linear_V1_cut1_mefv_vac
 subroutine pairs_calc_ti_linear_V1_cut1_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -4724,7 +5231,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -4806,9 +5316,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -4898,9 +5423,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -4911,11 +5451,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
         end do
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(2) = ti_pot_vdw_stk(2) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
           do bar_i = 1, bar_states
@@ -4958,6 +5510,9 @@ end subroutine pairs_calc_ti_linear_V1_cut1_mefv
 subroutine pairs_calc_ti_linear_V1_cut1_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -5013,7 +5568,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -5094,9 +5652,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -5180,19 +5753,46 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(2) = ti_pot_vdw_stk(2) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
       dfx = delx * df
@@ -5230,6 +5830,9 @@ end subroutine pairs_calc_ti_linear_V1_cut1_efv_vac
 subroutine pairs_calc_ti_linear_V1_cut1_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -5285,7 +5888,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -5367,9 +5973,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -5454,19 +6075,46 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(2) = ti_pot_vdw_stk(2) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
       dfx = delx * df
@@ -5504,6 +6152,9 @@ end subroutine pairs_calc_ti_linear_V1_cut1_efv
 subroutine pairs_calc_ti_linear_V1_cut1_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -5559,7 +6210,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -5642,6 +6296,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -5727,11 +6382,13 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -5772,6 +6429,9 @@ end subroutine pairs_calc_ti_linear_V1_cut1_fv_vac
 subroutine pairs_calc_ti_linear_V1_cut1_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -5827,7 +6487,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -5911,6 +6574,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -5997,11 +6661,13 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -6042,6 +6708,9 @@ end subroutine pairs_calc_ti_linear_V1_cut1_fv
 subroutine pairs_calc_ti_linear_V1_cut1_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -6097,7 +6766,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -6180,6 +6852,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
      
@@ -6257,10 +6930,12 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -6294,6 +6969,9 @@ end subroutine pairs_calc_ti_linear_V1_cut1_f_vac
 subroutine pairs_calc_ti_linear_V1_cut1_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -6349,7 +7027,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -6433,6 +7114,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
      
@@ -6511,10 +7193,12 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -6548,6 +7232,9 @@ end subroutine pairs_calc_ti_linear_V1_cut1_f
 subroutine pairs_calc_ti_linear_V1_cut2_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -6603,7 +7290,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -6684,9 +7374,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -6776,9 +7481,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -6794,11 +7514,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(2) = ti_pot_vdw_stk(2) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
           do bar_i = 1, bar_states
@@ -6841,6 +7573,9 @@ end subroutine pairs_calc_ti_linear_V1_cut2_mefv_vac
 subroutine pairs_calc_ti_linear_V1_cut2_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -6896,7 +7631,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -6978,9 +7716,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -7071,9 +7824,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -7089,11 +7857,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(2) = ti_pot_vdw_stk(2) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
           do bar_i = 1, bar_states
@@ -7136,6 +7916,9 @@ end subroutine pairs_calc_ti_linear_V1_cut2_mefv
 subroutine pairs_calc_ti_linear_V1_cut2_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -7191,7 +7974,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -7272,9 +8058,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -7359,9 +8160,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -7372,11 +8188,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(2) = ti_pot_vdw_stk(2) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
       dfx = delx * df
@@ -7414,6 +8242,9 @@ end subroutine pairs_calc_ti_linear_V1_cut2_efv_vac
 subroutine pairs_calc_ti_linear_V1_cut2_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -7469,7 +8300,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -7551,9 +8385,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -7639,9 +8488,24 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       b1 = (b0 - cgi_cgj * d_switch_dx * dxdr)
 
       delr2inv = delrinv * delrinv
+
+      ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -7652,11 +8516,23 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
 
     ti_pot_vdw_stk(2) = ti_pot_vdw_stk(2) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
     df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight
 
       dfx = delx * df
@@ -7694,6 +8570,9 @@ end subroutine pairs_calc_ti_linear_V1_cut2_efv
 subroutine pairs_calc_ti_linear_V1_cut2_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -7749,7 +8628,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -7832,6 +8714,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -7918,6 +8801,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -7928,6 +8812,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -7968,6 +8853,9 @@ end subroutine pairs_calc_ti_linear_V1_cut2_fv_vac
 subroutine pairs_calc_ti_linear_V1_cut2_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -8023,7 +8911,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -8107,6 +8998,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -8194,6 +9086,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
       eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
@@ -8204,6 +9097,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -8244,6 +9138,9 @@ end subroutine pairs_calc_ti_linear_V1_cut2_fv
 subroutine pairs_calc_ti_linear_V1_cut2_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -8299,7 +9196,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -8382,6 +9282,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
      
@@ -8460,6 +9361,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
 
@@ -8469,6 +9371,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -8502,6 +9405,9 @@ end subroutine pairs_calc_ti_linear_V1_cut2_f_vac
 subroutine pairs_calc_ti_linear_V1_cut2_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -8557,7 +9463,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -8641,6 +9550,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
      
@@ -8720,6 +9630,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       delr2inv = delrinv * delrinv
 
       ele_weight = ti_item_weights(4,2)
+      ele_dweight = ti_item_dweights(4,2)
       df = b1 * delr2inv
       df = df * ele_weight
 
@@ -8729,6 +9640,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -8762,6 +9674,9 @@ end subroutine pairs_calc_ti_linear_V1_cut2_f
 subroutine pairs_calc_ti_sc_common_V0_cut1_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -8817,7 +9732,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -8921,8 +9839,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -9052,8 +9993,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -9100,7 +10064,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(1) = sc_dvdl_vdw_stk(1) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,1)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -9157,6 +10144,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut1_mefv_vac
 subroutine pairs_calc_ti_sc_common_V0_cut1_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -9212,7 +10202,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -9317,8 +10310,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -9449,8 +10465,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -9497,7 +10536,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(1) = sc_dvdl_vdw_stk(1) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,1)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -9554,6 +10616,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut1_mefv
 subroutine pairs_calc_ti_sc_common_V0_cut1_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -9609,7 +10674,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -9713,8 +10781,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -9826,8 +10917,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -9856,7 +10970,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(1) = sc_dvdl_vdw_stk(1) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,1)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -9896,6 +11033,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut1_efv_vac
 subroutine pairs_calc_ti_sc_common_V0_cut1_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -9951,7 +11091,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -10056,8 +11199,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -10170,8 +11336,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -10200,7 +11389,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(1) = sc_dvdl_vdw_stk(1) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,1)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -10240,6 +11452,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut1_efv
 subroutine pairs_calc_ti_sc_common_V0_cut1_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -10295,7 +11510,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -10563,6 +11781,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut1_fv_vac
 subroutine pairs_calc_ti_sc_common_V0_cut1_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -10618,7 +11839,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -10888,6 +12112,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut1_fv
 subroutine pairs_calc_ti_sc_common_V0_cut1_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -10943,7 +12170,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -11195,6 +12425,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut1_f_vac
 subroutine pairs_calc_ti_sc_common_V0_cut1_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -11250,7 +12483,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -11504,6 +12740,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut1_f
 subroutine pairs_calc_ti_sc_common_V0_cut2_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -11559,7 +12798,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -11663,8 +12905,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -11795,8 +13060,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -11848,7 +13136,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(1) = sc_dvdl_vdw_stk(1) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,1)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -11905,6 +13216,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut2_mefv_vac
 subroutine pairs_calc_ti_sc_common_V0_cut2_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -11960,7 +13274,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -12065,8 +13382,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -12198,8 +13538,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -12251,7 +13614,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(1) = sc_dvdl_vdw_stk(1) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,1)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -12308,6 +13694,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut2_mefv
 subroutine pairs_calc_ti_sc_common_V0_cut2_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -12363,7 +13752,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -12467,8 +13859,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -12581,8 +13996,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -12616,7 +14054,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(1) = sc_dvdl_vdw_stk(1) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,1)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -12656,6 +14117,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut2_efv_vac
 subroutine pairs_calc_ti_sc_common_V0_cut2_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -12711,7 +14175,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -12816,8 +14283,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -12931,8 +14421,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(1) = ti_pot_elect_stk(1) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(1) = sc_dvdl_elect_stk(1)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -12966,7 +14479,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(1) = sc_dvdl_vdw_stk(1) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,1)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -13006,6 +14542,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut2_efv
 subroutine pairs_calc_ti_sc_common_V0_cut2_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -13061,7 +14600,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -13335,6 +14877,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut2_fv_vac
 subroutine pairs_calc_ti_sc_common_V0_cut2_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -13390,7 +14935,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -13666,6 +15214,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut2_fv
 subroutine pairs_calc_ti_sc_common_V0_cut2_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -13721,7 +15272,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -13979,6 +15533,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut2_f_vac
 subroutine pairs_calc_ti_sc_common_V0_cut2_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -14034,7 +15591,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -14294,6 +15854,9 @@ end subroutine pairs_calc_ti_sc_common_V0_cut2_f
 subroutine pairs_calc_ti_sc_common_V1_cut1_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -14349,7 +15912,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -14453,8 +16019,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -14584,8 +16173,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -14632,7 +16244,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(2) = sc_dvdl_vdw_stk(2) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,2)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -14689,6 +16324,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut1_mefv_vac
 subroutine pairs_calc_ti_sc_common_V1_cut1_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -14744,7 +16382,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -14849,8 +16490,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -14981,8 +16645,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -15029,7 +16716,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(2) = sc_dvdl_vdw_stk(2) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,2)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -15086,6 +16796,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut1_mefv
 subroutine pairs_calc_ti_sc_common_V1_cut1_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -15141,7 +16854,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -15245,8 +16961,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -15358,8 +17097,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -15388,7 +17150,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(2) = sc_dvdl_vdw_stk(2) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,2)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -15428,6 +17213,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut1_efv_vac
 subroutine pairs_calc_ti_sc_common_V1_cut1_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -15483,7 +17271,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -15588,8 +17379,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -15702,8 +17516,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -15732,7 +17569,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(2) = sc_dvdl_vdw_stk(2) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,2)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -15772,6 +17632,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut1_efv
 subroutine pairs_calc_ti_sc_common_V1_cut1_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -15827,7 +17690,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -16095,6 +17961,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut1_fv_vac
 subroutine pairs_calc_ti_sc_common_V1_cut1_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -16150,7 +18019,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -16420,6 +18292,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut1_fv
 subroutine pairs_calc_ti_sc_common_V1_cut1_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -16475,7 +18350,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -16727,6 +18605,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut1_f_vac
 subroutine pairs_calc_ti_sc_common_V1_cut1_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -16782,7 +18663,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -17036,6 +18920,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut1_f
 subroutine pairs_calc_ti_sc_common_V1_cut2_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -17091,7 +18978,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -17195,8 +19085,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -17327,8 +19240,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -17380,7 +19316,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(2) = sc_dvdl_vdw_stk(2) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,2)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -17437,6 +19396,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut2_mefv_vac
 subroutine pairs_calc_ti_sc_common_V1_cut2_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -17492,7 +19454,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -17597,8 +19562,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -17730,8 +19718,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -17783,7 +19794,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(2) = sc_dvdl_vdw_stk(2) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,2)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -17840,6 +19874,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut2_mefv
 subroutine pairs_calc_ti_sc_common_V1_cut2_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -17895,7 +19932,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -17999,8 +20039,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -18113,8 +20176,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -18148,7 +20234,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(2) = sc_dvdl_vdw_stk(2) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,2)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -18188,6 +20297,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut2_efv_vac
 subroutine pairs_calc_ti_sc_common_V1_cut2_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -18243,7 +20355,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -18348,8 +20463,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -18463,8 +20601,31 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(2) = ti_pot_elect_stk(2) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(2) = sc_dvdl_elect_stk(2)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
       df = - ((b0 - b1) * denom * delrinv) + &
@@ -18498,7 +20659,30 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(2) = sc_dvdl_vdw_stk(2) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,2)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
       ti_sigma6(ic) * (12.0d0 * f6 - 6.0d0)
@@ -18538,6 +20722,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut2_efv
 subroutine pairs_calc_ti_sc_common_V1_cut2_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -18593,7 +20780,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -18867,6 +21057,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut2_fv_vac
 subroutine pairs_calc_ti_sc_common_V1_cut2_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -18922,7 +21115,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -19198,6 +21394,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut2_fv
 subroutine pairs_calc_ti_sc_common_V1_cut2_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -19253,7 +21452,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -19511,6 +21713,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut2_f_vac
 subroutine pairs_calc_ti_sc_common_V1_cut2_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -19566,7 +21771,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -19826,6 +22034,9 @@ end subroutine pairs_calc_ti_sc_common_V1_cut2_f
 subroutine pairs_calc_ti_sc_sc_V0_cut1_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -19881,7 +22092,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -19969,7 +22183,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -20075,7 +22299,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -20096,6 +22330,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
         end do
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -20137,6 +22372,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut1_mefv_vac
 subroutine pairs_calc_ti_sc_sc_V0_cut1_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -20192,7 +22430,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -20281,7 +22522,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -20388,7 +22639,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -20409,6 +22670,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
         end do
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -20450,6 +22712,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut1_mefv
 subroutine pairs_calc_ti_sc_sc_V0_cut1_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -20505,7 +22770,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -20593,7 +22861,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -20694,7 +22972,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -20710,6 +22998,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
     eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -20751,6 +23040,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut1_efv_vac
 subroutine pairs_calc_ti_sc_sc_V0_cut1_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -20806,7 +23098,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -20895,7 +23190,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -20997,7 +23302,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -21013,6 +23328,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
     eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -21054,6 +23370,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut1_efv
 subroutine pairs_calc_ti_sc_sc_V0_cut1_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -21109,7 +23428,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -21294,6 +23616,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
     eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -21334,6 +23657,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut1_fv_vac
 subroutine pairs_calc_ti_sc_sc_V0_cut1_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -21389,7 +23715,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -21576,6 +23905,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
     eedvir_stk_sc(1) = eedvir_stk_sc(1) - df * delr2
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -21616,6 +23946,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut1_fv
 subroutine pairs_calc_ti_sc_sc_V0_cut1_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -21671,7 +24004,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -21847,6 +24183,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       df = df + cgi_cgj * delrinv * delr2inv
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -21880,6 +24217,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut1_f_vac
 subroutine pairs_calc_ti_sc_sc_V0_cut1_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -21935,7 +24275,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -22113,6 +24456,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       df = df + cgi_cgj * delrinv * delr2inv
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -22146,6 +24490,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut1_f
 subroutine pairs_calc_ti_sc_sc_V0_cut2_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -22201,7 +24548,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -22289,7 +24639,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -22396,7 +24756,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -22422,6 +24792,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -22463,6 +24834,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut2_mefv_vac
 subroutine pairs_calc_ti_sc_sc_V0_cut2_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -22518,7 +24892,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -22607,7 +24984,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -22715,7 +25102,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -22741,6 +25138,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -22782,6 +25180,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut2_mefv
 subroutine pairs_calc_ti_sc_sc_V0_cut2_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -22837,7 +25238,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -22925,7 +25329,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -23027,7 +25441,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -23048,6 +25472,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -23089,6 +25514,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut2_efv_vac
 subroutine pairs_calc_ti_sc_sc_V0_cut2_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -23144,7 +25572,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -23233,7 +25664,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -23336,7 +25777,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(1) = &
          ti_pot_elect_stk(1) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(1) = &
          sc_elect_stk(1) + cgi_cgj * delrinv
@@ -23357,6 +25808,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -23398,6 +25850,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut2_efv
 subroutine pairs_calc_ti_sc_sc_V0_cut2_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -23453,7 +25908,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -23644,6 +26102,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -23684,6 +26143,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut2_fv_vac
 subroutine pairs_calc_ti_sc_sc_V0_cut2_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -23739,7 +26201,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -23932,6 +26397,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -23972,6 +26438,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut2_fv
 subroutine pairs_calc_ti_sc_sc_V0_cut2_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -24027,7 +26496,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -24209,6 +26681,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -24242,6 +26715,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut2_f_vac
 subroutine pairs_calc_ti_sc_sc_V0_cut2_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -24297,7 +26773,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -24481,6 +26960,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,1)
+    vdw_dweight = ti_item_dweights(6,1)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -24514,6 +26994,9 @@ end subroutine pairs_calc_ti_sc_sc_V0_cut2_f
 subroutine pairs_calc_ti_sc_sc_V1_cut1_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -24569,7 +27052,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -24657,7 +27143,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -24763,7 +27259,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -24784,6 +27290,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
         end do
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -24825,6 +27332,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut1_mefv_vac
 subroutine pairs_calc_ti_sc_sc_V1_cut1_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -24880,7 +27390,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -24969,7 +27482,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -25076,7 +27599,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -25097,6 +27630,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
         end do
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -25138,6 +27672,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut1_mefv
 subroutine pairs_calc_ti_sc_sc_V1_cut1_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -25193,7 +27730,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -25281,7 +27821,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -25382,7 +27932,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -25398,6 +27958,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
     eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -25439,6 +28000,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut1_efv_vac
 subroutine pairs_calc_ti_sc_sc_V1_cut1_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -25494,7 +28058,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -25583,7 +28150,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -25685,7 +28262,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -25701,6 +28288,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
     eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -25742,6 +28330,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut1_efv
 subroutine pairs_calc_ti_sc_sc_V1_cut1_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -25797,7 +28388,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -25982,6 +28576,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
     eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -26022,6 +28617,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut1_fv_vac
 subroutine pairs_calc_ti_sc_sc_V1_cut1_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -26077,7 +28675,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -26264,6 +28865,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
     eedvir_stk_sc(2) = eedvir_stk_sc(2) - df * delr2
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -26304,6 +28906,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut1_fv
 subroutine pairs_calc_ti_sc_sc_V1_cut1_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -26359,7 +28964,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -26535,6 +29143,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       df = df + cgi_cgj * delrinv * delr2inv
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -26568,6 +29177,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut1_f_vac
 subroutine pairs_calc_ti_sc_sc_V1_cut1_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -26623,7 +29235,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -26801,6 +29416,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       df = df + cgi_cgj * delrinv * delr2inv
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -26834,6 +29450,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut1_f
 subroutine pairs_calc_ti_sc_sc_V1_cut2_mefv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -26889,7 +29508,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -26977,7 +29599,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -27084,7 +29716,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -27110,6 +29752,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -27151,6 +29794,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut2_mefv_vac
 subroutine pairs_calc_ti_sc_sc_V1_cut2_mefv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -27206,7 +29852,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -27295,7 +29944,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -27403,7 +30062,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -27429,6 +30098,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -27470,6 +30140,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut2_mefv
 subroutine pairs_calc_ti_sc_sc_V1_cut2_efv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -27525,7 +30198,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -27613,7 +30289,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -27715,7 +30401,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -27736,6 +30432,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -27777,6 +30474,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut2_efv_vac
 subroutine pairs_calc_ti_sc_sc_V1_cut2_efv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -27832,7 +30532,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -27921,7 +30624,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -28024,7 +30737,17 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(2) = &
          ti_pot_elect_stk(2) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(2) = &
          sc_elect_stk(2) + cgi_cgj * delrinv
@@ -28045,6 +30768,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -28086,6 +30810,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut2_efv
 subroutine pairs_calc_ti_sc_sc_V1_cut2_fv_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -28141,7 +30868,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -28332,6 +31062,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -28372,6 +31103,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut2_fv_vac
 subroutine pairs_calc_ti_sc_sc_V1_cut2_fv(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -28427,7 +31161,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -28620,6 +31357,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -28660,6 +31398,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut2_fv
 subroutine pairs_calc_ti_sc_sc_V1_cut2_f_vac(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -28715,7 +31456,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -28897,6 +31641,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -28930,6 +31675,9 @@ end subroutine pairs_calc_ti_sc_sc_V1_cut2_f_vac
 subroutine pairs_calc_ti_sc_sc_V1_cut2_f(img_crd, img_qterm, ef_tbl, & 
 eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -28985,7 +31733,10 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
@@ -29169,6 +31920,7 @@ eed_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)
       end if
 
     vdw_weight = ti_item_weights(6,2)
+    vdw_dweight = ti_item_dweights(6,2)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
diff --git src/pmemd/src/pme_force.F90 src/pmemd/src/pme_force.F90
index c1fbcb8301..d900618c22 100644
--- src/pmemd/src/pme_force.F90
+++ src/pmemd/src/pme_force.F90
@@ -259,6 +259,9 @@ subroutine pme_force(atm_cnt, crd, frc, img_atm_map, atm_img_map, &
   use gamd_mod
   use scaledMD_mod
   use ti_mod
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   use phmd_mod
   ! This #ifdef section can be merged with the section on top
   use processor_mod !, only : proc_atm_crd, proc_atm_frc, proc_atm_qterm, &
@@ -3321,6 +3324,9 @@ subroutine pme_force(atm_cnt, crd, frc, img_atm_map, atm_img_map, &
   use gamd_mod
   use scaledMD_mod
   use ti_mod
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   use nfe_setup_mod, only : nfe_on_force => on_force
   use nfe_lib_mod
 #if defined(CUDA) && !defined(GTI)
@@ -4375,6 +4381,10 @@ subroutine pme_force(atm_cnt, crd, frc, img_atm_map, atm_img_map, &
         if (nrespa .gt. 1) call respa_scale(atm_cnt, img_frc, nrespa)
       else
         ti_mask_piece = 2
+#ifdef TIDECOMP
+        decomp_region = 1
+        if(ti_mode .eq. 3) decomp_region = 0
+#endif
         call do_slab_pmesh_kspace(img_frc, pot_ene%elec_recip, &
                                   ti_vir(1,:,:), need_pot_enes, need_virials)
         do i = 1, atm_cnt
@@ -4386,6 +4396,9 @@ subroutine pme_force(atm_cnt, crd, frc, img_atm_map, atm_img_map, &
         pot_ene%elec_recip = 0.d0
         ti_mask_piece = 1
         if (ti_mode .ne. 3) then
+#ifdef TIDECOMP
+          decomp_region =2
+#endif
           call do_slab_pmesh_kspace(img_frc, pot_ene%elec_recip, &
                                     ti_vir(2,:,:), need_pot_enes, need_virials)
           do i = 1, atm_cnt
@@ -5064,6 +5077,9 @@ subroutine self(ene, ewaldcof, vol, vir, params_may_change)
   use gbl_constants_mod
   use prmtop_dat_mod
   use ti_mod
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
 #ifdef GTI
   use reaf_mod
 #endif
@@ -5078,6 +5094,9 @@ subroutine self(ene, ewaldcof, vol, vir, params_may_change)
 ! Local variables:
 
   integer                       :: i
+#ifdef TIDECOMP
+  integer                       :: j
+#endif
   double precision              :: ee_plasma
   logical, save                 :: setup_not_done = .true.
   double precision, save        :: factor
@@ -5186,6 +5205,25 @@ subroutine self(ene, ewaldcof, vol, vir, params_may_change)
     do i = 1, 2 !this is TI region to use
       ti_ee_plasma(i) = (factor * sumql(i) * sumql(i) / vol)
       ti_pot(i) = ti_ee_plasma(i) - sumq2l(i) * ewaldcof / sqrt_pi
+#ifdef TIDECOMP
+      ! This block of code is for decomp most likely incorrect
+      do j = 1, natom
+        if(ti_lst(i,j) .ne. 0 .or. ti_lst(3,j) .ne. 0) then
+            lig_dvdl_decomp(id_atom_region(j)) = &
+                            lig_dvdl_decomp(id_atom_region(j)) - &
+                            atm_qterm(j) * atm_qterm(j) * ewaldcof / sqrt_pi * &
+                            ti_item_dweights(3,i) + ti_ee_plasma(i)/natom * ti_signs(i)
+
+            lig_ti_decomp(id_atom_region(j), j) = &
+                            lig_ti_decomp(id_atom_region(j),j) - &
+                            atm_qterm(j) * atm_qterm(j) * ewaldcof / sqrt_pi * &
+                            ti_item_dweights(3,i) + ti_ee_plasma(i)/natom * ti_signs(i)
+
+            ti_decomp(j) = ti_decomp(j) - atm_qterm(j) * atm_qterm(j) * ewaldcof / sqrt_pi * &
+                            ti_item_dweights(3,i) + ti_ee_plasma(i)/natom * ti_signs(i)
+        end if
+      end do
+#endif
       ee_plasma = ee_plasma + ti_ee_plasma(i) * ti_weights(i)
     end do
     call ti_update_ene_all(ti_pot, si_elect_ene, ene, 3)
diff --git src/pmemd/src/pme_slab_recip.F90 src/pmemd/src/pme_slab_recip.F90
index 41cb3b0349..af2938db5a 100644
--- src/pmemd/src/pme_slab_recip.F90
+++ src/pmemd/src/pme_slab_recip.F90
@@ -309,6 +309,10 @@ subroutine fill_charge_grid(q, theta, order, img_qterm, ifracts)
   use pme_slab_fft_mod
   use prmtop_dat_mod
   use ti_mod
+#ifdef TIDECOMP
+  use ti_decomp_mod
+  use mdin_ctrl_dat_mod
+#endif
 
   implicit none
 
@@ -330,6 +334,9 @@ subroutine fill_charge_grid(q, theta, order, img_qterm, ifracts)
   integer               :: i_base, j_base, k_base
   integer               :: ith1, ith2, ith3
   integer               :: my_chg_idx
+#ifdef TIDECOMP
+  integer               :: atmidx
+#endif
   double precision      :: charge
   double precision      :: k_term, j_term
 #ifdef MPI
@@ -422,6 +429,9 @@ subroutine fill_charge_grid(q, theta, order, img_qterm, ifracts)
       end if
       charge = img_qterm(my_chg_idx)
 #endif
+#ifdef TIDECOMP
+      atmidx =  gbl_img_atm_map(my_chg_idx)     
+#endif
 
       i_base = ifracts(1, my_chg_idx)
       j_base = ifracts(2, my_chg_idx)
@@ -450,6 +460,26 @@ subroutine fill_charge_grid(q, theta, order, img_qterm, ifracts)
                                        theta(3, 1, my_chg_idx) * j_term
             q(i_tbl(i_base+4), j, k) = q(i_tbl(i_base+4), j, k) + &
                                        theta(4, 1, my_chg_idx) * j_term
+#ifdef TIDECOMP
+            if(ntwd .gt. 0) then
+                pme_cell_cnt(i_tbl(i_base+1),j,k,1) = pme_cell_cnt(i_tbl(i_base+1),j,k,1)+1
+                pme_cell_cnt(i_tbl(i_base+2),j,k,1) = pme_cell_cnt(i_tbl(i_base+2),j,k,1)+1
+                pme_cell_cnt(i_tbl(i_base+3),j,k,1) = pme_cell_cnt(i_tbl(i_base+3),j,k,1)+1
+                pme_cell_cnt(i_tbl(i_base+4),j,k,1) = pme_cell_cnt(i_tbl(i_base+4),j,k,1)+1
+                pme_cell_cnt(i_tbl(i_base+1),j,k,2) = pme_cell_cnt(i_tbl(i_base+1),j,k,2)+order*3-ith3-ith2
+                pme_cell_cnt(i_tbl(i_base+2),j,k,2) = pme_cell_cnt(i_tbl(i_base+2),j,k,2)+order*3-ith3-ith2-1
+                pme_cell_cnt(i_tbl(i_base+3),j,k,2) = pme_cell_cnt(i_tbl(i_base+3),j,k,2)+order*3-ith3-ith2-2
+                pme_cell_cnt(i_tbl(i_base+4),j,k,2) = pme_cell_cnt(i_tbl(i_base+4),j,k,2)+order*3-ith3-ith2-3
+                pme_cell_atom(i_tbl(i_base+1),j,k,pme_cell_cnt(i_tbl(i_base+1),j,k,1)) = atmidx
+                pme_cell_atom(i_tbl(i_base+2),j,k,pme_cell_cnt(i_tbl(i_base+2),j,k,1)) = atmidx
+                pme_cell_atom(i_tbl(i_base+3),j,k,pme_cell_cnt(i_tbl(i_base+3),j,k,1)) = atmidx
+                pme_cell_atom(i_tbl(i_base+4),j,k,pme_cell_cnt(i_tbl(i_base+4),j,k,1)) = atmidx
+                pme_cell_weight(i_tbl(i_base+1),j,k,pme_cell_cnt(i_tbl(i_base+1),j,k,1)) = order*3-ith3-ith2
+                pme_cell_weight(i_tbl(i_base+2),j,k,pme_cell_cnt(i_tbl(i_base+2),j,k,1)) = order*3-ith3-ith2-1
+                pme_cell_weight(i_tbl(i_base+3),j,k,pme_cell_cnt(i_tbl(i_base+3),j,k,1)) = order*3-ith3-ith2-2
+                pme_cell_weight(i_tbl(i_base+4),j,k,pme_cell_cnt(i_tbl(i_base+4),j,k,1)) = order*3-ith3-ith2-3
+            end if
+#endif
           end do
 #ifdef MPI
         end if
diff --git src/pmemd/src/runfiles.F90 src/pmemd/src/runfiles.F90
index dd13258603..bb620233eb 100644
--- src/pmemd/src/runfiles.F90
+++ src/pmemd/src/runfiles.F90
@@ -888,7 +888,12 @@ endif
       close(phmdout_unit)
       open(unit=phmdout_unit, file=phmdout_name, status='OLD',position='APPEND')
     end if
-
+#ifdef TIDECOMP
+    if (ntwd .gt. 0) then
+      close(decomp_unit)
+      open(unit=decomp_unit, file=decomp_name, status='OLD',position='APPEND')
+    end if
+#endif
   else
     if (current_sec .ge. next_6flush_sec) then
       next_6flush_sec = current_sec + mdout_flush_interval
diff --git src/pmemd/src/runmd.F90 src/pmemd/src/runmd.F90
index e3cf0a7a6c..519331428f 100644
--- src/pmemd/src/runmd.F90
+++ src/pmemd/src/runmd.F90
@@ -88,6 +88,9 @@ subroutine runmd(atm_cnt, crd, mass, frc, vel, last_vel)
   use gamd_mod
   use scaledMD_mod
   use ti_mod
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   use sams_mod  
 #ifdef GTI
   use gti_mod
@@ -1418,6 +1421,10 @@ DBG_ARRAYS_TIME_STEP(nstep)
     do
       DBG_ARRAYS_TIME_STEP(nstep)
 
+#ifdef TIDECOMP
+      call zero_decomp_energies
+#endif
+
       ! Calculate the force. This also does ekcmt if a regular pme run:
 
       ! Full energies are only calculated every nrespa steps, and may actually be
@@ -5299,7 +5306,14 @@ DBG_ARRAYS_TIME_STEP(nstep)
         !--------------------------------------------------------------------
         !--------------------------------------------------------------------
 
-        if (nstep .ge. nstlim) exit
+        if (nstep .ge. nstlim) then
+#ifdef TIDECOMP
+                if (ntwd .gt. 0) then
+               call mddecomp(total_nstep)
+           end if
+#endif
+           exit
+        end if
 
         ! Stop the run if timlim is set and reached. One more step will be taken
         ! to ensure a final restart is written.
diff --git src/pmemd/src/runreweight.F90 src/pmemd/src/runreweight.F90
index 8b442f4ddf..9f5c3fafd4 100644
--- src/pmemd/src/runreweight.F90
+++ src/pmemd/src/runreweight.F90
@@ -70,6 +70,9 @@ subroutine runreweight(atm_cnt, crd, mass, frc, vel, last_vel)
   use timers_mod, only : fcve_dist_time, runmd_time, run_end_walltime, &
                  run_start_walltime, update_time, wall, zero_time
   use ti_mod
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
 
 #ifdef DBG_ARRAYS
   use dbg_arrays_mod
@@ -568,6 +571,10 @@ DBG_ARRAYS_TIME_STEP(nstep)
         update_gamd = .false.
       end if
 
+#ifdef TIDECOMP
+      call zero_decomp_energies
+#endif
+
       ! Calculate the force. This also does ekcmt if a regular pme run:
 
       ! Full energies are only calculated every nrespa steps, and may actually be
@@ -1692,6 +1699,15 @@ DBG_ARRAYS_TIME_STEP(nstep)
         !--------------------------------------------------------------------
         !--------------------------------------------------------------------
 
+        if (nstep .ge. nstlim) then
+#ifdef TIDECOMP
+            if (ntwd .gt. 0) then
+                call mddecomp(total_nstep)
+            end if
+            exit
+#endif
+        end if
+        ! Stop the run if timlim is set and reached. One more step will be taken
         if (nstep .ge. nstlim) exit
 
         ! Stop the run if timlim is set and reached. One more step will be taken
diff --git src/pmemd/src/scalar_sum_slab.i src/pmemd/src/scalar_sum_slab.i
index 128c2ef73c..e796329357 100644
--- src/pmemd/src/scalar_sum_slab.i
+++ src/pmemd/src/scalar_sum_slab.i
@@ -23,6 +23,10 @@ subroutine scalar_sumrc(q, ewaldcof, vol, prefac1, prefac2, prefac3, &
   use parallel_dat_mod
   use pbc_mod
   use pme_slab_fft_mod
+#ifdef TIDECOMP
+  use ti_mod
+  use ti_decomp_mod
+#endif
 
   implicit none
 
@@ -65,6 +69,24 @@ subroutine scalar_sumrc(q, ewaldcof, vol, prefac1, prefac2, prefac3, &
 #endif
   integer               :: nf1, nf2, nf3
   integer               :: m3_tbl(nfft3)
+#ifdef  TIDECOMP
+  double precision      :: test_sum
+  double precision      :: ti_wt, de_sign
+  integer               :: i
+
+  if(ti_mode .ne. 0) then
+     if(decomp_region .eq. 0) then
+         ti_wt =0.0
+         de_sign =0.0
+     else
+        ti_wt = ti_item_weights(3,decomp_region)
+        de_sign = ti_item_dweights(3,decomp_region)
+     end if
+  else
+     ti_wt = 1.0d0
+     de_sign = 1.0d0
+  end if
+#endif
 
   recip_11 = recip(1, 1)
   recip_22 = recip(2, 2)
@@ -196,6 +218,25 @@ subroutine scalar_sumrc(q, ewaldcof, vol, prefac1, prefac2, prefac3, &
           eterms = eterms12 * m3_exp_tbl(m3s) * prefac3(k3s) * msqs_inv
           eterms_struc2s = eterms * qterm
           energy = energy + eterm_struc2 + eterms_struc2s
+#ifdef TIDECOMP
+          do i=1,pme_cell_cnt(k1s,k2s,k3s,1)
+               lig_dvdl_decomp(id_atom_region(pme_cell_atom(k1s,k2s,k3s,i))) = &
+                           lig_dvdl_decomp(id_atom_region(pme_cell_atom(k1s,k2s,k3s,i))) + &
+                           (eterm_struc2 + eterms_struc2s) * 0.5d0 * de_sign * &
+                           dble(pme_cell_weight(k1s,k2s,k3s,i))/dble(pme_cell_cnt(k1s,k2s,k3s,2))
+
+               lig_ti_decomp(id_atom_region(pme_cell_atom(k1s,k2s,k3s,i)),pme_cell_atom(k1s,k2s,k3s,i)) = &
+                           lig_ti_decomp(id_atom_region(pme_cell_atom(k1s,k2s,k3s,i)),pme_cell_atom(k1s,k2s,k3s,i)) + &
+                           (eterm_struc2 + eterms_struc2s) * 0.5d0 * de_sign * &
+                           dble(pme_cell_weight(k1s,k2s,k3s,i))/dble(pme_cell_cnt(k1s,k2s,k3s,2))
+
+               ti_decomp(pme_cell_atom(k1s,k2s,k3s,i))=ti_decomp(pme_cell_atom(k1s,k2s,k3s,i)) + &
+                           (eterm_struc2 + eterms_struc2s) * 0.5d0 * de_sign * &
+                           dble(pme_cell_weight(k1s,k2s,k3s,i))/dble(pme_cell_cnt(k1s,k2s,k3s,2))
+          end do
+          if(pme_cell_cnt(k1s,k2s,k3s,1) .ne. 0) &
+            test_sum = test_sum + (eterm_struc2+eterms_struc2s)*0.5d0
+#endif
 #endif
 #if VIRIAL
           vterm = (fac_2 + 2.d0 * msq_inv) * eterm_struc2
@@ -228,6 +269,23 @@ subroutine scalar_sumrc(q, ewaldcof, vol, prefac1, prefac2, prefac3, &
 #if POT_ENES
           eterm_struc2 = eterm * qterm
           energy = energy + eterm_struc2
+#ifdef TIDECOMP
+          do i=1,pme_cell_cnt(k1,k2q,k3,1)
+              lig_dvdl_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)))= &
+                        lig_dvdl_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i))) + &
+                         eterm_struc2 * 0.5d0 * de_sign *  &
+                         dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+              lig_ti_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)),pme_cell_atom(k1,k2q,k3,i))= &
+                        lig_ti_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)),pme_cell_atom(k1,k2q,k3,i)) + &
+                         eterm_struc2 * 0.5d0 * de_sign *  &
+                         dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+               ti_decomp(pme_cell_atom(k1,k2q,k3,i))=ti_decomp(pme_cell_atom(k1,k2q,k3,i)) + &
+                          eterm_struc2 * 0.5d0 * de_sign *  &
+                          dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+          end do
+          if(pme_cell_cnt(k1,k2q,k3,1) .ne. 0) &
+              test_sum = test_sum + eterm_struc2*0.5d0
+#endif
 #endif
 #if VIRIAL
           vterm = (fac_2 + 2.d0 * msq_inv) * eterm_struc2
@@ -299,6 +357,10 @@ subroutine scalar_sumrc_nonorthog(q, ewaldcof, vol, &
   use parallel_dat_mod
   use pbc_mod
   use pme_slab_fft_mod
+#ifdef TIDECOMP
+  use ti_mod
+  use ti_decomp_mod
+#endif
 
   implicit none
 
@@ -340,6 +402,24 @@ subroutine scalar_sumrc_nonorthog(q, ewaldcof, vol, &
   integer               :: k1s, k2s, k3s, m1s, m2s, m3s
 #endif
   integer               :: nf1, nf2, nf3
+#ifdef TIDECOMP
+  integer               :: i
+  double precision      :: test_sum
+  double precision      :: ti_wt, de_sign
+
+  if(ti_mode .ne. 0) then
+     if(decomp_region .eq. 0) then
+         ti_wt =0.0
+         de_sign =0.0
+     else
+        ti_wt = ti_item_weights(3,decomp_region)
+        de_sign = ti_item_dweights(3,decomp_region)
+     end if
+  else
+     ti_wt = 1.0d0
+     de_sign = 1.0d0
+  end if
+#endif
 
   recip_stk(:,:) = recip(:,:)
 
@@ -460,6 +540,21 @@ subroutine scalar_sumrc_nonorthog(q, ewaldcof, vol, &
         eterm_struc2 = eterm * (q(1, k3, k1, k2q) * q(1, k3, k1, k2q) + &
                                 q(2, k3, k1, k2q) * q(2, k3, k1, k2q))
         energy = energy + eterm_struc2
+#ifdef TIDECOMP
+        do i=1,pme_cell_cnt(k1,k2q,k3,1)
+            lig_dvdl_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)))= &
+                        lig_dvdl_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i))) + &
+                        eterm_struc2 * 0.5d0 * de_sign *  &
+                        dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+            lig_ti_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)),pme_cell_atom(k1,k2q,k3,i))= &
+                        lig_ti_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)),pme_cell_atom(k1,k2q,k3,i)) + &
+                        eterm_struc2 * 0.5d0 * de_sign *  &
+                        dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+            ti_decomp(pme_cell_atom(k1,k2q,k3,i))=ti_decomp(pme_cell_atom(k1,k2q,k3,i)) + &
+                        eterm_struc2 * 0.5d0 * de_sign *  &
+                        dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+        end do
+#endif
 #endif
 #if VIRIAL
         vterm = fac_2 + 2.d0 * msq_inv
@@ -500,6 +595,21 @@ subroutine scalar_sumrc_nonorthog(q, ewaldcof, vol, &
           eterms_struc2s = eterms * (q(1, k3, k1, k2q) * q(1, k3, k1, k2q) + &
                                      q(2, k3, k1, k2q) * q(2, k3, k1, k2q))
           energy = energy + eterms_struc2s
+#ifdef TIDECOMP
+          do i=1,pme_cell_cnt(k1,k2q,k3,1)
+              lig_dvdl_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)))= &
+                          lig_dvdl_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i))) + &
+                          eterms_struc2s * 0.5d0 * de_sign *  &
+                          dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+              lig_ti_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)),pme_cell_atom(k1,k2q,k3,i))= &
+                          lig_ti_decomp(id_atom_region(pme_cell_atom(k1,k2q,k3,i)),pme_cell_atom(k1,k2q,k3,i)) + &
+                          eterms_struc2s * 0.5d0 * de_sign *  &
+                          dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+              ti_decomp(pme_cell_atom(k1,k2q,k3,i))=ti_decomp(pme_cell_atom(k1,k2q,k3,i)) + &
+                          eterms_struc2s * 0.5d0 * de_sign *  &
+                          dble(pme_cell_weight(k1,k2q,k3,i))/dble(pme_cell_cnt(k1,k2q,k3,2))
+          end do
+#endif
 #endif
 #if VIRIAL
           vterms = fac_2 + 2.d0 * msqs_inv
diff --git src/pmemd/src/ti_code2.py src/pmemd/src/ti_code2.py
index d834bed290..63cbf067e6 100644
--- src/pmemd/src/ti_code2.py
+++ src/pmemd/src/ti_code2.py
@@ -12,9 +12,25 @@ vac = ['_vac','']
 def ti_eed_i(ti_region, f_pair_idx, f_cut_idx, f_ctype_idx):
   if (pair[f_pair_idx] == 'linear_V0' or pair[f_pair_idx] == 'linear_V1'):
     if ('e' in ctype[f_ctype_idx]): #NEED_ENE
-      f.write('      ti_pot_elect_stk(%(tireg)d) = ti_pot_elect_stk(%(tireg)d) + b0\n'%{'tireg': ti_region})
+      f.write("""
+      ele_weight = ti_item_weights(4,%(tireg)d)
+      ele_dweight = ti_item_dweights(4,%(tireg)d)
+      ti_pot_elect_stk(%(tireg)d) = ti_pot_elect_stk(%(tireg)d) + b0
+#ifdef  TIDECOMP
+      decomp_dvdl = b0 * ele_dweight
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                + decomp_dvdl/2.0d0
+#endif
+"""%{'tireg': ti_region})
     f.write("""
       ele_weight = ti_item_weights(4,%(tireg)d)
+      ele_dweight = ti_item_dweights(4,%(tireg)d)
       df = b1 * delr2inv
       df = df * ele_weight
 """%{'tireg': ti_region})
@@ -53,8 +69,31 @@ def ti_eed_i(ti_region, f_pair_idx, f_cut_idx, f_ctype_idx):
       !cgi_cgj * delrinv          
       ti_pot_elect_stk(%(tireg)d) = ti_pot_elect_stk(%(tireg)d) + &
         (switch * denom)
+#ifdef TIDECOMP
+      region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+      decomp_dvdl = ele_dweight * (switch * denom)
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
       sc_dvdl_elect_stk(%(tireg)d) = sc_dvdl_elect_stk(%(tireg)d)+&
         (switch * denom_n * scbeta * ele_dweight * sceeorderinv)
+#ifdef TIDECOMP
+      decomp_dvdl = ele_dweight * (switch * denom_n * scbeta * sceeorderinv) * ele_weight
+      ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+        decomp_dvdl/2.0d0
+      ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+        decomp_dvdl/2.0d0
+      lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+      lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                      + decomp_dvdl/2.0d0
+      lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                      + decomp_dvdl/2.0d0
+#endif
 """%{'tireg': ti_region})
     f.write("""
       !b0 - b1 = cgi_cgj * d_switch_dx * dxdr
@@ -95,7 +134,17 @@ def ti_eed_i(ti_region, f_pair_idx, f_cut_idx, f_ctype_idx):
        ! remove the reciprocal contribution from the main energy array          
        ti_pot_elect_stk(%(tireg)d) = &
          ti_pot_elect_stk(%(tireg)d) + b0 - cgi_cgj * delrinv
-
+#ifdef TIDECOMP
+       region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+       decomp_dvdl = (b0 - cgi_cgj * delrinv) * ele_dweight
+       ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+       ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+       lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+       lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                       + decomp_dvdl/2.0d0
+       lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                       + decomp_dvdl/2.0d0
+#endif
        ! add the full non-switched coulomb pot to the softcore energy array
        sc_elect_stk(%(tireg)d) = &
          sc_elect_stk(%(tireg)d) + cgi_cgj * delrinv
@@ -128,6 +177,7 @@ def ti_vdw_i(ti_region, f_pair_idx, f_cut_idx, f_ctype_idx):
   if (pair[f_pair_idx] == 'linear_V0' or pair[f_pair_idx] == 'linear_V1'):
     f.write("""
     vdw_weight = ti_item_weights(6,%(tireg)d)
+    vdw_dweight = ti_item_dweights(6,%(tireg)d)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -135,6 +185,17 @@ def ti_vdw_i(ti_region, f_pair_idx, f_cut_idx, f_ctype_idx):
     if ('e' in ctype[f_ctype_idx]): #NEED_ENE
       f.write("""
     ti_pot_vdw_stk(%(tireg)d) = ti_pot_vdw_stk(%(tireg)d) + (f12 - f6)
+#ifdef TIDECOMP
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 """%{'tireg': ti_region})     
     f.write('    df = df + (12.d0*f12 - 6.d0*f6) * delr2inv * vdw_weight\n'%{'tireg': ti_region})
     if ('m' in ctype[f_ctype_idx]): #NEED_MBAR
@@ -167,7 +228,30 @@ def ti_vdw_i(ti_region, f_pair_idx, f_cut_idx, f_ctype_idx):
       ti_foureps(ic) * ( f12 - f6 ) 
 
     sc_dvdl_vdw_stk(%(tireg)d) = sc_dvdl_vdw_stk(%(tireg)d) + &
-      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0) 
+      ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)
+
+#ifdef TIDECOMP
+    vdw_dweight = ti_item_dweights(6,%(tireg)d)
+    region_decomp=id_atom_region(img_atm_map(img_i)) + id_atom_region(img_atm_map(img_j))
+    decomp_dvdl = vdw_dweight * ti_foureps(ic) * (f12 - f6)
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp) = lig_dvdl_decomp(region_decomp) + decomp_dvdl
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+    decomp_dvdl = ti_foureps(ic)*scalpha*vdw_dweight*f12*(2.0d0*f6-1.0d0)*vdw_weight
+    ti_decomp(img_atm_map(img_i))= ti_decomp(img_atm_map(img_i))+ &
+      decomp_dvdl / 2.0d0
+    ti_decomp(img_atm_map(img_j))= ti_decomp(img_atm_map(img_j))+ &
+      decomp_dvdl / 2.0d0
+    lig_dvdl_decomp(region_decomp)=lig_dvdl_decomp(region_decomp) + decomp_dvdl 
+    lig_ti_decomp(region_decomp,img_atm_map(img_i))=lig_ti_decomp(region_decomp,img_atm_map(img_i)) &
+                    + decomp_dvdl/2.0d0
+    lig_ti_decomp(region_decomp,img_atm_map(img_j))=lig_ti_decomp(region_decomp,img_atm_map(img_j)) &
+                    + decomp_dvdl/2.0d0
+#endif
 """%{'tireg': ti_region})
     f.write("""
     df = df + vdw_weight * ti_foureps(ic) * delr2 * delr2 * f12 * &
@@ -195,6 +279,7 @@ def ti_vdw_i(ti_region, f_pair_idx, f_cut_idx, f_ctype_idx):
   elif (pair[f_pair_idx] == 'sc_sc_V0' or pair[f_pair_idx] == 'sc_sc_V1'):
     f.write("""
     vdw_weight = ti_item_weights(6,%(tireg)d)
+    vdw_dweight = ti_item_dweights(6,%(tireg)d)
     r6 = delr2inv * delr2inv * delr2inv
     f6 = cn2(ic) * r6
     f12 = cn1(ic) * (r6 * r6)
@@ -206,14 +291,17 @@ def ti_vdw_i(ti_region, f_pair_idx, f_cut_idx, f_ctype_idx):
 #END ti_vdw.i    
     
 # Now loop over all possible functions and write to pairs_calc_ti_AUTO.i    
-for f_pair_idx in xrange(0,len(pair)):
-  for f_cut_idx in xrange(0,len(cut)):
-    for f_ctype_idx in xrange(0,len(ctype)):
-      for f_vac_idx in xrange(0,len(vac)):
+for f_pair_idx in range(0,len(pair)):
+  for f_cut_idx in range(0,len(cut)):
+    for f_ctype_idx in range(0,len(ctype)):
+      for f_vac_idx in range(0,len(vac)):
         ti_region = int(pair[f_pair_idx][-1]) + 1
         f.write('subroutine pairs_calc_ti_%s_%s_%s%s'%(pair[f_pair_idx],cut[f_cut_idx],ctype[f_ctype_idx],vac[f_vac_idx]))
         f.write('(img_crd, img_qterm, ef_tbl, & \need_cub, ico, ipairs_sublst, img_iac, cn1, cn2, x_tran)\n')
         f.write("""
+#ifdef TIDECOMP
+  use ti_decomp_mod
+#endif
   implicit none
 
 ! Formal arguments:
@@ -269,7 +357,10 @@ for f_pair_idx in xrange(0,len(pair)):
 
   double precision      :: nxt_delx, nxt_dely, nxt_delz
   double precision      :: delx, dely, delz, delr2, delr2inv
-
+#ifdef TIDECOMP
+  double precision      :: decomp_dvdl
+  integer               :: region_decomp
+#endif
   double precision      :: vdw_weight, vdw_dweight, ele_weight, ele_dweight
  
   dens_efs = efs_tbl_dens
diff --git src/pmemd/src/ti_decomp.F90 src/pmemd/src/ti_decomp.F90
new file mode 100644
index 0000000000..279f13c129
--- /dev/null
+++ src/pmemd/src/ti_decomp.F90
@@ -0,0 +1,270 @@
+#ifdef TIDECOMP
+#include "copyright.i"
+
+!*******************************************************************************
+!
+! Module: ti_decomp_mod
+!
+! Description: <TBS>
+!              
+!*******************************************************************************
+
+module ti_decomp_mod
+
+  implicit none
+
+  ! Atomic Decomposition
+  double precision, allocatable :: ti_decomp(:)
+  integer, allocatable :: pme_cell_cnt(:,:,:,:)
+  integer, allocatable :: pme_cell_atom(:,:,:,:)
+  integer, allocatable :: pme_cell_weight(:,:,:,:)
+  integer, private     :: total_atom
+  integer              :: decomp_region
+  integer, allocatable :: outputmask(:)
+  integer :: protstart, protend,cofacstart,cofacend
+
+  ! Ligand Decomposition
+  double precision :: lig_dvdl_decomp(30)
+  integer, allocatable :: id_atom_region(:)
+  double precision, allocatable :: lig_ti_decomp(:,:)
+
+  contains
+
+!*******************************************************************************
+!
+! Subroutine: init_region_decomp
+!
+! Description: <TBS>
+!
+!*******************************************************************************
+
+  subroutine init_region_decomp(atm_cnt, nres, igraph, isymbl, res_atms, labres, crd)
+
+      use mdin_ctrl_dat_mod
+      use file_io_dat_mod
+      use findmask_mod
+#if defined(CUDA)
+      use pmemd_lib_mod !I think we just need setup_alloc_error
+#endif
+
+      implicit none
+
+      ! Formal arguments:
+      integer, intent(in)             :: atm_cnt, nres
+      integer, intent(in)             :: res_atms(nres)
+      character(len=4), intent(in)    :: igraph(atm_cnt)
+      character(len=4), intent(in)    :: isymbl(atm_cnt)
+      character(len=4), intent(in)    :: labres(nres)
+      double precision, intent(in)    :: crd(3 * atm_cnt)
+       
+      integer :: i
+#if defined(CUDA)
+      integer                         :: alloc_failed
+#endif
+      integer :: cofac_region(atm_cnt)
+      integer :: protein_region(atm_cnt)
+      integer :: lig_region(atm_cnt)
+      
+      cofac_region(:)=0
+      protein_region(:)=0
+      lig_region(:)=0 
+
+      allocate(id_atom_region(atm_cnt))
+
+      if(ligmask .ne. '') then
+        call atommask(atm_cnt, nres, 0, igraph, isymbl, res_atms, labres, &
+               crd, ligmask, lig_region)
+      end if
+      if(cofacmask .ne. '') then
+        call atommask(atm_cnt, nres, 0, igraph, isymbl, res_atms, labres, &
+               crd, cofacmask, cofac_region)
+      end if
+      if(proteinmask .ne. '') then
+        call atommask(atm_cnt, nres, 0, igraph, isymbl, res_atms, labres, &
+               crd, proteinmask, protein_region)
+      end if
+
+      ! For ligand decomposition we use 30 because we identify the regions using
+      ! a set of n numbers where the subset of any sum of 1 or 2 numbers in set n
+      ! is unique.
+      ! Ligand - 1
+      ! Protein - 3
+      ! Cofactor - 7
+      ! Water - 15
+      ! Then ligand-ligand interactions are 2, lig-protein 4, lig-cofactor-8, lig-water-16
+      protstart=0
+      protend=0
+
+      do i=1,atm_cnt
+          id_atom_region(i) = 7*cofac_region(i) + lig_region(i) + 3*protein_region(i)
+          if(id_atom_region(i) .eq. 0) id_atom_region(i)=15
+          if(protstart .eq. 0 .and. protein_region(i) .eq. 1) protstart=i
+          if(protein_region(i) .eq. 1) protend=i
+          if(cofacstart .eq. 0 .and. cofac_region(i) .eq. 1) cofacstart=i
+          if(cofac_region(i) .eq. 1) cofacend=i
+      end do 
+
+  end subroutine init_region_decomp
+
+!*******************************************************************************
+!
+! Subroutine: init_ti_decomp
+!
+! Description: <TBS>
+!              
+!*******************************************************************************
+
+  subroutine init_ti_decomp(natom, output)
+ 
+      use file_io_mod
+      use ti_mod
+
+      implicit none
+   
+      integer,intent(in)        :: natom
+      integer,intent(in)        :: output
+      integer :: i
+
+      allocate(ti_decomp(natom))
+      allocate(outputmask(natom))
+      allocate(lig_ti_decomp(30,natom))
+      total_atom = natom
+      decomp_region = 1
+
+      ti_decomp(:)=0.0d0
+      lig_ti_decomp(:,:)=0.0d0
+
+      if(output .gt. 0) call amopen(decomp_unit,decomp_name,'R', 'F', 'W')
+ 
+  end subroutine init_ti_decomp
+
+!*******************************************************************************
+!
+! Subroutine:  init_ti_decomp_mask
+!
+! Description: Fill in the ti_lst array, based on the amber mask.
+!
+!*******************************************************************************
+
+subroutine init_ti_decomp_mask(atm_cnt, nres, igraph, isymbl, res_atms, labres, &
+                            crd)
+  use file_io_dat_mod
+  use findmask_mod
+#if defined(CUDA)
+  use pmemd_lib_mod !I think we just need setup_alloc_error
+#endif
+  use mdin_ctrl_dat_mod, only : decompmask
+  implicit none
+
+! Formal arguments:
+  integer, intent(in)             :: atm_cnt, nres
+  integer, intent(in)             :: res_atms(nres)
+  character(len=4), intent(in)    :: igraph(atm_cnt)
+  character(len=4), intent(in)    :: isymbl(atm_cnt)
+  character(len=4), intent(in)    :: labres(nres)
+  double precision, intent(in)    :: crd(3 * atm_cnt)
+
+#if defined(CUDA)
+  integer                         :: alloc_failed
+#endif
+
+       outputmask(:)=1
+       if(decompmask .ne. '') then
+         call atommask(atm_cnt, nres, 0, igraph, isymbl, res_atms, labres, &
+                crd, decompmask, outputmask)
+       end if
+
+end subroutine init_ti_decomp_mask
+
+!*******************************************************************************
+!
+! Subroutine: init_pme_decomp_bookkeeping
+!
+! Description: <TBS>
+!              
+!*******************************************************************************
+
+  subroutine init_pme_decomp_bookkeeping
+
+      use mdin_ewald_dat_mod
+   
+      implicit none
+
+      ! xdim, ydim, zdim 1 stores cnt
+      ! xdim, ydim, zdim 2 stores total parts of the order
+      allocate(pme_cell_cnt(nfft1,nfft2,nfft3,2))
+      pme_cell_cnt(:,:,:,:) = 0
+      ! xdim, ydim, zdim, 1..n stores atoms in xdim, ydim, zdim cell
+      allocate(pme_cell_atom(nfft1,nfft2,nfft3,(bspl_order*2+1)**3))
+      ! xdim, ydim, zdim, 1..n stores weights.
+      ! Divide weight/cnt for contribution.
+      allocate(pme_cell_weight(nfft1,nfft2,nfft3,(bspl_order*2+1)**3))
+
+  end subroutine init_pme_decomp_bookkeeping
+
+!*******************************************************************************
+!
+! Subroutine: zero_decomp_energies
+!
+! Description: zeroes decomp arrays if they're allocated
+!              
+!*******************************************************************************
+
+  subroutine zero_decomp_energies
+
+      implicit none
+
+      if(allocated(pme_cell_cnt))pme_cell_cnt(:,:,:,:)=0
+      if(allocated(pme_cell_atom))pme_cell_atom(:,:,:,:)=0
+      if(allocated(pme_cell_weight))pme_cell_weight(:,:,:,:)=0
+
+!      lig_dvdl_decomp(:)=0
+
+  end subroutine zero_decomp_energies
+
+!*******************************************************************************
+!
+! Subroutine: mddecomp
+!
+! Description: Writes data to output file
+!              
+!*******************************************************************************
+
+  subroutine mddecomp(total_nstep)
+
+      use file_io_dat_mod
+      use ti_mod, only : ti_mode, ti_ti_atm_cnt, ti_latm_cnt
+
+      implicit none
+
+      integer, intent(in)         :: total_nstep
+      integer                     :: i
+
+      write(decomp_unit,*) "Steps ran:", total_nstep
+
+      ! Atomic Decomp
+      if(ti_mode .gt. 0) then
+          !Region Decomp
+          write(decomp_unit,*)"Ligand-Ligand DV/DL", lig_dvdl_decomp(2)+lig_dvdl_decomp(1)
+          write(decomp_unit,*)"Ligand-Protein DV/DL", lig_dvdl_decomp(4)+lig_dvdl_decomp(3)
+          write(decomp_unit,*)"Ligand-Cofactor DV/DL", lig_dvdl_decomp(8)+lig_dvdl_decomp(7)
+          write(decomp_unit,*)"Ligand-Water/Bulk DV/DL", lig_dvdl_decomp(16)+lig_dvdl_decomp(15)+&
+                  lig_dvdl_decomp(30)+lig_dvdl_decomp(18)  !Water-water / Water-protein
+          write(decomp_unit,*)"Atom   ","LigDecomp   ","ProtDecomp   ","WatDecomp   ","DV/DL"
+      end if
+
+      do i=1, total_atom
+        if(outputmask(i) .eq. 1) then
+          if(ti_mode .gt. 0) then
+              write(decomp_unit,*)i,' ', lig_ti_decomp(2,i)+lig_ti_decomp(1,i), &
+                                         lig_ti_decomp(4,i)+lig_ti_decomp(3,i), &
+                                         lig_ti_decomp(16,i)+lig_ti_decomp(15,i), &
+                                         ti_decomp(i)
+          end if
+        end if
+      end do
+
+  end subroutine mddecomp
+
+end module
+#endif
