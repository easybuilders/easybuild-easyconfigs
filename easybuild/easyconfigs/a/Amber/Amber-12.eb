#
# author: Benjamin P. Roberts (University of Auckland)
#
# based on work by Marios Constantinou (University of Cyprus)
#

easyblock = 'MakeCp'

name = 'AMBER'
version = "12"

homepage = 'http://ambermd.org/amber.html'
description = """AMBER is a Molecular Dynamics Simulation Software"""

toolchain = {'name': 'ictce', 'version': '5.4.0'}
toolchainopts = {'usempi': True}

#source_urls = ['http://www.example.com']
sources = ['amber-%(version_major)s.tar.gz']

# Amber is now patched using the following command run in the AMBERHOME
# directory:
# ./update_amber --update
#patches = ["bugfix.all"]

dependencies = [('CUDA', '5.0'), (']

start_dir = 'src'

with_configure = True

preconfigopts = 'export AMBERHOME=%(installdir)s && export MPI_HOME=$EBROOTIMPI && export MKL_HOME=$EBROOTIMKL && '

# HACK, should be done in easyblock
# BPR asks: Does this really need to be in an EasyBlock? If so, how does
# one prepare such a thing?
# We need a NetCDF installation with C and Fortran support, and the
# directory containing this installation needs to be supplied to configure
# following the "--with-netcdf" flag as the form "--with-netcdf <path>"
# Also, the final argument to ./configure should be the word "intel"
preconfigopts += "./configure -static -noX11"
# Serial (neither -mpi nor -cuda) first
# Then -mpi, but not -cuda
# Then -cuda, but not -mpi
# I think "make clean" has to be run between each build
preconfigopts += "-mpi"
preconfigopts += "-cuda"

# It seems that "make parallel" is no longer necessary if -mpi was supplied
# at configure time. There is no "parallel" rule in the Makefile.
makeopts = "parallel"

# Get a better list of files to copy
files_to_copy = [(['../exe/lmodprmtop', '../exe/sander.LES.MPI', '../exe/sander.MPI', '../exe/sander.PIMD.MPI'], 'bin')]

# What on Earth does this do?
sanity_check_paths = {
	'files': ['bin/lmodprmtop'],
	'dirs': ["."]
}

moduleclass = 'chem'
