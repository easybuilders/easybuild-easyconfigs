easyblock = 'ConfigureMake'

name = 'AOCL-BLAS'
version = '5.1'
modaltsoftname = 'aocl-blascore'
hidden = True

homepage = 'https://github.com/amd/blis'
description = """AOCL-BLAS is AMD's optimized version of
                 BLAS targeted for AMD EPYC and Ryzen CPUs."""

toolchain = SYSTEM
source_urls = ['https://github.com/amd/blis/archive/']
sources = ['AOCL-%(version)s-GA.tar.gz']
patches = [
    'AOCL-BLAS-5.0_family-x86_64_v3.patch',
]
checksums = [
    'de75e940d57fdcf3ed868c15774412cdfb7e92bebf60fb9e418f86d7dde6e923',
    # AOCL-BLAS-5.0_family-x86_64_v3.patch
    'f00b3d8cc238d84fd65b4f6988f6346e59811917ac462515c695ec8421a78e06',
]

builddependencies = [
    ('GCCcore', '13.3.0'),
    ('Python', '3.11.5'),
    ('Perl', '5.38.2'),
]

preconfigopts = 'cp config/amdzen/bli_family_amdzen.h config/x86_64_v3 && '
local_configopts = '--enable-cblas --enable-threading=openmp --enable-shared CC=$CC x86_64_v3'
configopts = ['-i64 -b64 ' + local_configopts, local_configopts]
local_buildopts = 'CC="$CC -O2 -ftree-vectorize -march=x86-64-v3 -fno-math-errno"'
buildopts = ['LIBBLIS=libblis-mt64 ' + local_buildopts, local_buildopts]
installopts = buildopts

runtest = 'check'

sanity_check_paths = {
    'files': ['include/blis/cblas.h', 'include/blis/blis.h',
              'lib/libblis-mt64.a', 'lib/libblis-mt64.%s' % SHLIB_EXT,
              'lib/libblis-mt.a', 'lib/libblis-mt.%s' % SHLIB_EXT],
    'dirs': [],
}

modextrapaths = {'CPATH': 'include/blis'}

moduleclass = 'numlib'
