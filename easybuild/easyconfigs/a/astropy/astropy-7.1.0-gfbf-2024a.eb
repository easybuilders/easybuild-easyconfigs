easyblock = 'PythonBundle'

name = 'astropy'
version = '7.1.0'

homepage = 'https://www.astropy.org/'
description = """The Astropy Project is a community effort to develop a common
core package for Astronomy in Python and foster an ecosystem of interoperable
astronomy packages.

The Astropy community is committed to supporting diversity and inclusion."""

toolchain = {'name': 'gfbf', 'version': '2024a'}

builddependencies = [
    ('Cython', '3.0.10'),
    ('astropy-testing', '7.1.0'),  # Only needed for test step
    ('hatchling', '1.27.0'),
]
dependencies = [
    ('Python', '3.12.3'),
    ('SciPy-bundle', '2024.05'),
    ('PyYAML', '6.0.2'),
    ('matplotlib', '3.9.2'),
]

local_pytest_args = "not test_delay_doc_updates and not test_datetime_timedelta_roundtrip"
# Also disable tests that need remote data, see
# https://git.shrewdly.se/mirror/guix/commit/2aa0127d4e3d2363c04caab88137b070b6cf1318?style=unified&whitespace=show-all&show-outdated=
local_pytest_args += " and not remote_data"
# This test fails if the Easybuild tempdir is in a location for which the path is not equal to the realpath
local_pytest_args += " and not test_write_jsviewer_local"
# This test fails with small precision errors
local_pytest_args += " and not test_datetime_timedelta_sum"
# This test fails due to trying broken import statement "from astropy import tests.stores" which is invalid syntax.
local_pytest_args += " and not test_imports"


exts_list = [
    ('colorlog', '6.9.0', {
        'checksums': ['bfba54a1b93b94f54e1f4fe48395725a3d92fd2a4af702f6bd70946bdc0c6ac2'],
    }),
    ('pyerfa', '2.0.1.5', {
        'modulename': 'erfa',
        'checksums': ['17d6b24fe4846c65d5e7d8c362dcb08199dc63b30a236aedd73875cc83e1f6c0'],
    }),
    ('extension-helpers', '1.4.0', {
        'modulename': 'extension_helpers',
        'source_tmpl': 'extension_helpers-%(version)s.tar.gz',
        'checksums': ['78d04185f196e3e0bc5fd8418ce298b014c46f7ac609f6a8c10bf70e8c978324'],
    }),
    ('astropy-iers-data', '0.2025.10.6.0.35.25', {
        'source_tmpl': 'astropy_iers_data-%(version)s.tar.gz',
        'checksums': ['60a0a8ff69dcb2d3470071f444c58685b06299c48214349a1a0ce2d44e178f76'],
    }),
    (name, version, {
        'patches': ['astropy-7.0.0_test_quantities_fitting.patch'],
        'checksums': [
            {'astropy-7.1.0.tar.gz': 'c8f254322295b1b8cf24303d6f155bf7efdb6c1282882b966ce3040eff8c53c5'},
            {'astropy-7.0.0_test_quantities_fitting.patch':
             '2a55b32d8cf85f55343afc8011ea6329d1273a04e450d88414006e856f355563'},
        ],
        # Create test installation, since Astropy tests cannot be run on the source / build dir since the import at
        # https://github.com/astropy/astropy/blob/465a7ffe0cc9c776bc668a6938d029ffb83b68de/astropy/__init__.py#L146
        # will fail
        'testinstall': 'True',
        # Run tests, but skip test_delay_doc_updates, which has a known issues
        # https://github.com/astropy/astropy/issues/17558
        # (Probably) fixed in 7.0.X and 7.1 https://github.com/astropy/astropy/pull/17559
        'runtest': 'cd $EB_PYTHONPACKAGE_TEST_INSTALLDIR'
                   ' && pytest -n %%(parallel)s -k "%s" --pyargs astropy' % local_pytest_args
    }),
]

moduleclass = 'astro'
