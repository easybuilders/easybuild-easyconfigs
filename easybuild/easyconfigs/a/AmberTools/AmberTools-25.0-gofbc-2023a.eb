easyblock = 'EB_Amber'

name = 'AmberTools'
local_ambertools_ver = 25
# Patch levels from http://ambermd.org/AmberPatches.php and http://ambermd.org/ATPatches.php
patchlevels = (0, 0)  # (AmberTools, Amber)
version = '%s.%s' % (local_ambertools_ver, patchlevels[0])

homepage = "https://ambermd.org/AmberTools.php"
description = """AmberTools consists of several independently developed packages that work well by themselves,
 and with Amber itself. The suite can also be used to carry out complete molecular dynamics simulations,
 with either explicit water or generalized Born solvent models."""

toolchain = {'name': 'gofbc', 'version': '2023a'}
toolchainopts = {'usempi': True, 'openmp': True}

# download requires registration
local_download_credentials = '?Name=Easybuild&Institution=Easybuild&City=Internet&State=Other&Country=Belgium'
source_urls = ['https://ambermd.org/cgi-bin/AmberTools%s-get.pl' % local_ambertools_ver]
sources = [{
    'download_filename': local_download_credentials,
    'filename': 'AmberTools%s.tar.bz2' % local_ambertools_ver,
}]
patches = [
    'AmberTools-20_cmake-locate-netcdf.patch',
    'AmberTools-20_fix_missing_MPI_LIBRARY_error.patch',
    'AmberTools-20_fix_xblas_missing_make_dependency.patch',
    'AmberTools-22_CMake-FlexiBLAS.patch',
    'AmberTools-21_fix_incorrect_dvout_call.patch',
    'AmberTools-21_fix_potential_use_before_init.patch',
    'AmberTools-21_fix_rism_argument_mismatch.patch',
    'AmberTools-21_fix_xray_fftpack_arg_mismatch.patch',
    'AmberTools-24_fix_test_missing_cuda_dir.patch',
    'AmberTools-25_Cmake-PythonBuildConfig.patch',
    'AmberTools-25_Makefile-pip.patch',
    'AmberTools-25_CMakeLists-pytraj.patch',
    'AmberTools-25_Sander-CMakeLists-pip.patch',
    'AmberTools-25_CudaConfig.patch',
    'AmberTools-25_CudaConfig_quick.patch',
    'AmberTools-25_Find_NCCL.patch',
    'AmberTools-25_Find_NCCL_quick.patch',
    'AmberTools-25_PMEMDCompilerFlags.patch',
    'AmberTools-25_QUICKCudaConfig.patch',
]
checksums = [
    {'AmberTools25.tar.bz2': 
    'ac009b2adeb25ccd2191db28905b867df49240e038dc590f423edf0d84f8a13b'},
    {'AmberTools-20_cmake-locate-netcdf.patch': 
    '473e07c53b6f641d96d333974a6af2e03413fecef79f879d3fdecf7fecaab4d0'},
    {'AmberTools-20_fix_missing_MPI_LIBRARY_error.patch':
     '0b89a0624167bc23876bcdefcb1055f591e38e3bd559a71d5749e342bd311acc'},
    {'AmberTools-20_fix_xblas_missing_make_dependency.patch':
     'ff25e91fdc72347a778c3837b581e174d6a8c71efa5b46e11391b18bca84fd65'},
    {'AmberTools-22_CMake-FlexiBLAS.patch': 
    '9543812c24c4b7842f64f1f8abaf2c92b5c4c0fadcdbd9811e76b81a778f0d36'},
    {'AmberTools-21_fix_incorrect_dvout_call.patch':
     '1054d4007f5c79126a41582e1e80514267cf406416ed6c471574cd708b16319b'},
    {'AmberTools-21_fix_potential_use_before_init.patch':
     '377e645b5bd2c91ebb4d0b6fbca0407a94289e5ddc5b1e7ed0cb0b0724ad2139'},
    {'AmberTools-21_fix_rism_argument_mismatch.patch':
     '14255e5739cec39303df570f06820c7532f7395e1b73b1e4104377984e2c9fc1'},
    {'AmberTools-21_fix_xray_fftpack_arg_mismatch.patch':
     '99c954e693659efc2a1d121f91510f56408006f0751d91595f45a34b03364e2f'},
    {'AmberTools-24_fix_test_missing_cuda_dir.patch':
     'e44e5eb3cab8501e5a4889fd6cec76b8b9b0b02a232eb68633c79e7f68d60993'},
    {'AmberTools-25_Cmake-PythonBuildConfig.patch': 
    '5d444bb751379c578ff36d61db93e2f3a497b9b34e86e6c4e79725646b2a0979'},
    {'AmberTools-25_Makefile-pip.patch': 
    '2840a010a3a5532f6875a0027668c1bb49a9fdc584a24804c1b74357aa669ef2'},
    {'AmberTools-25_CMakeLists-pytraj.patch':
    '7aae1bb5669192734db0a43de87056931e749b93b23790e4899bc87438c46159'},
    {'AmberTools-25_Sander-CMakeLists-pip.patch':
    '7ea1692e77e95b46018cb921135fb454a72a032a5fea6fd443c9305e443ed18f'},
    {'AmberTools-25_CudaConfig.patch':
    'a78f8cceb09d5733e796d06bd348e48b24e1302a6d8eb4c78ddd2ec382356349'},
    {'AmberTools-25_CudaConfig_quick.patch':
    'b38c97763327ce207a2f3c8ee82364ffc41bcca5f470ffa445113b72b81ee684'},
    {'AmberTools-25_Find_NCCL.patch': 
    '57f03151c46eb1ed54390fe02c337b7cda151cdea002c2819846e5a77b4bf7eb'},    
    {'AmberTools-25_Find_NCCL_quick.patch':
    '091d8cf6e4d7bac6b738ac95e5879c5254f5fd2ec2adeab83612eaecb132ff54'},
    {'AmberTools-25_PMEMDCompilerFlags.patch':
    '280076758c3ad738799f4f585c55a940b96cec60006138aed419b0570d4a81c1'},
    {'AmberTools-25_QUICKCudaConfig.patch':
    'f078e435121b3fda4e391e42ce11e6fba78fd6a03503714c29c48a91871edab8'},
]


builddependencies = [
    ('CMake', '3.31.0'),
]

dependencies = [
    ('Python', '3.11'),
    ('SciPy-Stack', '2023b'),  # mpi4py required for MMPBSA
    ('Perl', '5.36.1'),
    ('Boost', '1.82.0'),
    ('CUDAcore', '12.2.2'),
#    ('libreadline', '8.1'),
#    ('matplotlib', '3.4.3'),
    ('netCDF', '4.9.2'),
    ('netCDF-Fortran', '4.6.1'),
    ('arpack-ng', '3.9.1'),
    ('PnetCDF', '1.12.3'),
    ('Tkinter', '3.11.3'),
    ('X11', '20230603'),
    ('FFTW.MPI', '3.3.10'),
    ('mpi4py', '3.1.4'),
    ('PLUMED', '2.9.0'),    
]

separate_build_dir = True
# All tests are expected to pass or be skipped
runtest = True

#preconfigopts = 'export NCCL_HOME=/cvmfs/soft.computecanada.ca/easybuild/software/2023/x86-64-v3/CUDA/gcccore/cuda12.2/nccl/2.18.3 &&'

#static = False
configopts = ' ' 
configopts =  ' -DBUILD_QUICK=TRUE'    
configopts += ' -DNCCL=TRUE'

postinstallcmds = [
    ' '.join([
        '/cvmfs/soft.computecanada.ca/easybuild/bin/setrpaths.sh',
        '--path %(installdir)s/',
        '--any_interpreter',
        '--add_origin',
        '--add_path %(installdir)s/lib',
    ]),
]

enhance_sanity_check = True
sanity_check_commands = [
    'python -c "import sander  "'
]

modextravars = {
    'AMBERHOME': '%(installdir)s',
    'QUICK_BASIS': '%(installdir)s/AmberTools/src/quick/basis',
}

modextrapaths = {
    'EBPYTHONPREFIXES': [''],
    'PERL5LIB': ['lib/perl'],
}

moduleclass = 'chem'
