# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2025/02
#
# DRAFT!
easyblock = 'PythonBundle'

name = 'AlphaFold3'
version = '3.0.1'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://deepmind.google/technologies/alphafold'
description = """This package provides an implementation of the inference pipeline of AlphaFold3.
See below for how to access the model parameters. You may only use AlphaFold3
model parameters if received directly from Google. Use is subject to these
terms of use:
https://github.com/google-deepmind/alphafold3/blob/main/WEIGHTS_TERMS_OF_USE.md"""

toolchain = {'name': 'foss', 'version': '2024a'}

github_account = 'google-deepmind'

builddependencies = [
    ('scikit-build', '0.17.6'),
    ('poetry', '1.8.3'),
    ('Python-bundle-PyPI', '2024.06'),
    ('scikit-build-core', '0.10.6'),
    ('pybind11', '2.12.0'),
    ('pybind11_abseil', '202402.0'),
]

dependencies = [
    ('Python', '3.12.3'),
    ('CUDA', '12.6.0', '', SYSTEM),
    ('tqdm', '4.66.5'),
    ('jax', '0.6.2', versionsuffix),
    ('dm-tree', '0.1.9'),
    ('dm-haiku', '0.0.14', versionsuffix),
    ('RDKit', '2025.03.3'),
    ('jax-triton', '0.3.0', versionsuffix),
    ('jaxtyping', '0.2.38', versionsuffix),
    ('dssp', '4.4.10'),
    ('Abseil', '20240722.0'),
    ('HMMER', '3.4'),
]
exts_list = [
    ('zstandard', '0.23.0', {
        'checksums': ['b2d8c62d08e7255f68f7a740bae85b3c9b8e5466baa9cbf7f57f1cde0ac6bc09'],
    }),
    ('typeguard', '2.13.3', {
        'checksums': ['00edaa8da3a133674796cf5ea87d9f4b4c367d77476e185e80251cc13dfbb8c4'],
    }),
    (name, version, {
        'patches': [
            '%(name)s-3.0.0.20250109_relax_requirements.patch',
            '%(name)s-3.0.0_disable_fetch.patch',
            '%(name)s-3.0.0.20250109_data_path.patch',
        ],
        'postinstallcmds': [
            'cp run_alphafold.py %(installdir)s/bin',
            'cp run_alphafold_data_test.py %(installdir)s/lib/python%(pyshortver)s/site-packages/%(namelower)s',  # for tests without models/DBs
            'chmod +x %(installdir)s/bin/run_alphafold.py',
            '%(installdir)s/bin/build_data',
        ],
        # 'runtest': "python run_alphafold_test.py",  # only with models/weights
        # 'runtest': "python run_alphafold_data_test.py",  # also without DBs and models, but it needs to build_data first (can not test before postinstallcmds)
        'source_urls': ['https://github.com/%(github_account)s/%(namelower)s/archive'],
        'sources': [{'download_filename': 'v%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        # 'testinstall': True,
        'checksums': [
            {'AlphaFold3-3.0.1.tar.gz': 'cfe1ae5f6e5c0d7e64570255d296a440955beaf4a8b9f05aaf142f36478a4503'},
            {'AlphaFold3-3.0.0.20250109_relax_requirements.patch':
             '5a60638e63f7b44f30447d306f0c196bd2505860e93c6670f646cd8967ea999b'},
            {'AlphaFold3-3.0.0_disable_fetch.patch':
             '041a35a09f783405f40e3ba47566ad6d063a10cfd98f0efd2e2a04c78e2c155e'},
            {'AlphaFold3-3.0.0.20250109_data_path.patch':
             'a06a971460df5e4cbe7a59042100512d2f96755d6dcdef01d4bc4e8c55122287'},
        ],
    }),
]

fix_python_shebang_for = ['bin/run_alphafold.py']

sanity_check_paths = {
    'files': ['bin/run_alphafold.py'],
    'dirs': ['lib'],
}
sanity_check_commands = [
    ('run_alphafold.py --help|grep "AlphaFold 3 structure prediction script"')
]

modextravars = {
    # 'DB_DIR': '/scratch/AlphaFold_DBs/%s/' % version,   # adapt
    # acc. to:
    # https://github.com/google-deepmind/alphafold3/
    #  blob/main/docs/performance.md#compilation-time-workaround-with-xla-flags
    'XLA_FLAGS': '--xla_gpu_enable_triton_gemm=false ',
    # https://github.com/google-deepmind/alphafold3/blob/main/docs/performance.md#cuda-capability-7x-gpus:
    # 'XLA_FLAGS': '"--xla_gpu_enable_triton_gemm=false --xla_disable_hlo_passes=custom-kernel-fusion-rewriter"',
    # Unified memory:
    'XLA_PYTHON_CLIENT_PREALLOCATE': 'false',
    'TF_FORCE_UNIFIED_MEMORY': 'true',
    'XLA_CLIENT_MEM_FRACTION': '3.2',
}

modextrapaths = {'PYTHONPATH': 'bin'}  # to be able import run_alphafold (for run_alphafold_data_test.py)

# modluafooter = """
# setenv("AF3_MODEL_DIR", os.getenv("HOME") .. "/.alphafold3/models");
# eb_tmpdir = os.getenv("TMPDIR")
# if not eb_tmpdir then eb_tmpdir='/tmp' end
# setenv("TRITON_HOME", eb_tmpdir .. "/" .. os.getenv("USER") .. "/triton_home")
# """

# modtclfooter = """
# setenv AF3_MODEL_DIR $::env(HOME)/.alphafold3/models
# if { [info exists ::env(TMPDIR)] } {
#   setenv AF3_MODEL_DIR $::env(TMPDIR)/$::env(USER)/triton_home
# } else {
#   setenv AF3_MODEL_DIR /tmp/$::env(USER)/triton_home
# }
# """

moduleclass = 'bio'
