# Based on the template for a minimal python bundle for GCCcore 13.2.0
# Author: J. Sa√ümannshausen (Imperial College London/UK)

easyblock = 'PythonBundle'

name = 'Underworld'
version = '2.16.4'

homepage = 'https://www.underworldcode.'
description = """
Underworld is a Python API (Application Programming Interface) which provides
functionality for the modelling of geodynamics processes, and is designed to
work (almost) seamlessly across PC, cloud and HPC infrastructure. Primarily
the API consists of a set of Python classes from which numerical geodynamics
models may be constructed. The API also provides the tools required for inline
analysis and data management. For scalability across multiprocessor platforms,
MPI (Message Passing Interface) is leveraged, and for performant operation all
heavy computations are executed within a statically typed layer.
"""
citing = """
Mansour, J., Giordani, J., Moresi, L., Beucher, R., Kaluza, O., Velic, M.,
Farrington, R., Quenette, S., Beall, A., 2020, Underworld2:
Python Geodynamics Modelling for Desktop, HPC and Cloud,
Journal of Open Source Software, 5(47), 1797,
https://doi.org/10.21105/joss.01797

Beucher et al., (2019). UWGeodynamics: A teaching and research tool for
numerical geodynamic modelling.
Journal of Open Source Software, 4(36), 1136,
https://doi.org/10.21105/joss.01136

Zenodo: https://doi.org/10.5281/zenodo.1436039
"""

toolchain = {'name': 'foss', 'version': '2023b'}

builddependencies = [
    ('CMake', '3.27.6'),
    ('Ninja', '1.11.1'),
    ('SWIG', '4.1.1'),
]

dependencies = [
    ('Python', '3.11.5'),
    ('SciPy-bundle', '2023.11'),
    ('Python-bundle-PyPI', '2023.10'),
    # ('PETSc', '3.22.5'),  # needs to be changed once PETSc is build with MUMPS
    ('PETSc', '3.22.5', '-MUMPS'),
    ('HDF5', '1.14.3'),
    ('libxml2', '2.11.5'),
    ('LavaVu', '1.9.9'),
    ('h5py', '3.11.0'),
    ('mpi4py', '3.1.5'),
    ('scikit-image', '0.24.0'),
    ('Pint', '0.24'),
    ('Triangle', '1.6'),
    ('meshio', '5.3.5'),
    ('poetry', '1.7.1'),
    ('hatchling', '1.18.0'),
    ('pytest', '8.2.2'),  # required for testing
]

exts_list = [
    ('npx', '0.1.6', {
        'source_tmpl': '%(name)s-%(version)s-py3-none-any.whl',
        'checksums': ['42311219c2af12470c6785f49c366798d67f3583aea18d73c2679d3eb13359a9'],
    }),
    ('url-normalize', '1.4.3', {
        'checksums': ['d23d3a070ac52a67b83a1c59a0e68f8608d1cd538783b401bc9de2c0fac999b2'],
    }),
    ('cattrs', '23.2.3', {
        'checksums': ['a934090d95abaa9e911dac357e3a8699e0b4b14f8529bcc7d2b1ad9d51672b9f'],
    }),
    ('requests-cache', '1.2.0', {
        'source_tmpl': 'requests_cache-%(version)s.tar.gz',
        'checksums': ['db1c709ca343cc1cd5b6c8b1a5387298eceed02306a6040760db538c885e3838'],
    }),
    ('getmac', '0.9.5', {
        'checksums': ['456435cdbf1f5f45c433a250b8b795146e893b6fc659060f15451e812a2ab17d'],
    }),
    ('py-machineid', '0.8.0', {
        'modulename': 'machineid',
        'checksums': ['5515d5f9779073d0caa2e8aaf15a0fdd0ad4247fd0b86d9c447431c96d3e3467'],
    }),
    ('python_package_info', '0.0.19', {
        'source_tmpl': '%(name)s-%(version)s-py3-none-any.whl',
        'checksums': ['8123cf349fa5d1b80a08de20d13de9041884d9962055797a37c22d2647f42bd9'],
    }),
    ('rich_argparse', '1.6.0', {
        'checksums': ['092083c30da186f25bcdff8b1d47fdfb571288510fb051e0488a72cc3128de13'],
    }),
    ('x22', '0.2.1', {
        'source_tmpl': 'x22-%(version)s-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl',
        'checksums': ['296562cf37c8d000c6da441f2d2a61dad321eb6e29bb4e3f7ccd591784268218'],
    }),
    ('stonefish_license_manager', '0.5.36', {
        'source_tmpl': '%(name)s-%(version)s-py3-none-any.whl',
        'checksums': ['6d4aad933120dde0d8168406e0c4d743ea2cb515a754e1f848e609fac30ab0e8'],
    }),
    ('x21', '0.5.3', {
        'source_tmpl': 'x21-%(version)s-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl',
        'checksums': ['a00de9a78b66adec4dfdbac3ef2a224d37879333cd37b3bae2b132b1da3b1001'],
    }),
    ('meshplex', '0.19.7', {
        'source_tmpl': '%(name)s-%(version)s-py3-none-any.whl',
        'checksums': ['43817e5283bfd97e0262559e5a2fc2c31b79b864e29b3db4b4331ee65f5f26bd'],
    }),
    ('gflex', '1.2.0', {
        'checksums': ['dce6ee399c193e2de5effa2736c3c289afdb99953649b7f7993938908b16b74f'],
    }),
    ('triangle', '20250106', {
        'source_tmpl': 'triangle-%(version)s-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl',
        'checksums': ['80da149e4584cc599fc9bcff31dddd524528a41119f5af321911e599d82ad6e1'],
    }),
    ('badlands', '2.2.4', {
        'checksums': ['5b44259aa5975155f05c0e5a2bc72a832131aba5481d82e7bfe81504c895130e'],
    }),
    ('nbmake', '1.5.5', {
        'checksums': ['239dc868ea13a7c049746e2aba2c229bd0f6cdbc6bfa1d22f4c88638aa4c5f5c'],
    }),
    ('underworld', version, {
        'patches': ['Underworld-2.16.4_ninja-job.patch'],
        'source_urls': ['https://github.com/underworldcode/underworld2/archive'],
        'sources': ['v%(version)s.tar.gz'],
        'checksums': [
            {'v2.16.4.tar.gz': '70b2ccadc4917b82cf64819956acf2a0c8b69fcb3117188e801ef435da2c2f28'},
            {'Underworld-2.16.4_ninja-job.patch': '45d6af4a3a13e4065e003f2a9d222170e6898ac635677681f8f94a4d6d706dfe'},
        ],
    }),
]

# Some of the tests take quite some time, so you might want to disable them. 
sanity_check_commands = [
    'cd %(start_dir)s/underworld/underworld2-%(version)s && '
    'pytest -vvv docs/pytests/tests.py docs/pytests/test_examples.py  docs/pytests/test_user_guide.py'
]

moduleclass = 'geo'
