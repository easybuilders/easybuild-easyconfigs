easyblock = 'CMakeMake'

name = 'librmn'
version = '20.0.9'

homepage = 'https://github.com/ECCC-ASTD-MRD/librmn/'
description = """rmnlib is a library of functions for numerical weather prediction used primarily by Environment and and Climate Change Canada.

Its main components are Standard RPN files and the EZ interpolator."""

toolchain = {'name': 'gompi', 'version': '2023a'}
toolchainopts = {'openmp': True, 'usempi': True}

sources = [{
    'filename': '%(name)s-%(version)s.tar',
    'git_config': {
        'url': 'https://github.com/ECCC-ASTD-MRD',
        'repo_name': '%(name)s',
        'tag': '%(version)s',
        'recursive': True,
        'keep_git_dir': True,
    }
}]
checksums = [None]

builddependencies = [
    ('CMake', '3.31.1'),
]

start_dir='%(name)s'

# remove -march=native
preconfigopts = 'sed -i -e "s/-march=\${TARGET_PROC}//" %(builddir)s/%(name)s/cmake_rpn/modules/ec_compiler_presets/default/Linux-x86_64/gnu.cmake %(builddir)s/%(name)s/App/cmake_rpn/modules/ec_compiler_presets/default/Linux-x86_64/gnu.cmake && '

configopts = "-DCOMPILER_SUITE=gnu"

sanity_check_paths = {
    'files': ['include/rmn.h'] + [f'lib/{lib}{ext}' for lib in ('libApp-ompi','libApp','librmn-ompi','librmn') for ext in ('.a', '.so')],
    'dirs': ['include', 'lib']
}

moduleclass = 'geo'
