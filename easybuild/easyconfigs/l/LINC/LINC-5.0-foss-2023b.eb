easyblock = 'PythonBundle'

name = 'LINC'
version = '5.0'

homepage = "https://linc.readthedocs.io/en/latest/"

description = """
LINC is a pipeline to correct for various instrumental and ionospheric effects in both LOFAR HBA and LOFAR LBA
observations.
"""

toolchain = {'name': 'foss', 'version': '2023b'}

builddependencies = [
    ('CMake', '3.27.6'),
    ('scikit-build', '0.17.6'),
    ('wget', '1.21.4'),  # Needed for the test step
]

# Based on https://git.astron.nl/RD/LINC/-/tree/releases/v5.0?ref_type=heads#software-requirements
dependencies = [
    ('Boost', '1.83.0'),
    ('Boost.Python-NumPy', '1.83.0'),  # Boost_numpy is required for bdsf
    ('DP3', '6.2'),
    ('LoSoTo', '2.5.0'),
    ('LSMTool', '1.7.0'),
    ('EveryBeam', '0.6.1'),  # Should be 0.6.2 or newer according to the docs?
    ('SAGECal', '0.8.4'),
    ('RMextract', '0.5.1'),
    ('AOFlagger', '3.4.0'),
    ('WSClean', '3.5'),
    ('IDG', '1.2.0',),
    ('LofarStMan', '1.0'),
    ('dysco', '1.3'),
    ('Python', '3.11.5'),
    ('Python-bundle-PyPI', '2023.10'),
    ('SciPy-bundle', '2023.11'),
    ('matplotlib', '3.8.2'),
    ('python-casacore', '3.5.2'),
    ('astropy', '7.0.0'),
    ('h5py', '3.11.0'),
    ('cwltool', '3.1.20250110105449'),
    ('toil-cwl', '8.2.0'),
]

# Get data needed to run the test
local_pretestopts = 'mkdir -p data && '
local_pretestopts += 'wget -nv https://support.astron.nl/software/ci_data/linc/test_data.tar.gz '
local_pretestopts += '-O test_data.tar.gz && '
local_pretestopts += 'wget -nv https://support.astron.nl/software/ci_data/linc/results_calibrator.tar.gz '
local_pretestopts += '-O results_calibrator.tar.gz && tar xfz test_data.tar.gz -C data && '
local_pretestopts += 'tar xfz results_calibrator.tar.gz -C data && '

# Patch the workflow file so that it looks for the skymodels within the LINC (temporary) install dir
local_pretestopts += 'sed -i -e "s|\"/usr/local/share/linc/skymodels/A-Team_Midres.skymodel\"|'
local_pretestopts += '\"${EB_PYTHONPACKAGE_TEST_INSTALLDIR}/share/linc/skymodels/A-Team_Midres.skymodel\"|" '
local_pretestopts += '-e "s|\"/usr/local/share/linc/skymodels\"|'
local_pretestopts += '\"${EB_PYTHONPACKAGE_TEST_INSTALLDIR}/share/linc/skymodels\"|" test_jobs/HBA_target.json && '

# Ensure SLURM env vars are emptied, otherwise OpenMPI may complain that OMPI wasn't build with SLURMs PMI support
local_pretestopts += 'for i in $(env | grep SLURM); do unset "${i%=*}"; done && '

# Disable OpenMP parallelism, to avoid BLAS error with DP3 and hang in clocktek
# LINC uses its own threading, which seems to clash with a multithreaded BLAS
local_pretestopts += 'export OMP_NUM_THREADS=1 && export OPENBLAS_NUM_THREADS=1 && '

# Set the LINC_DATA_ROOT and make sure to include the python scripts (which are in /bin for some reason)
# to the PYTHONPATH
local_pretestopts += 'export LINC_DATA_ROOT=$EB_PYTHONPACKAGE_TEST_INSTALLDIR/share/linc && '
local_pretestopts += 'export PYTHONPATH=$PYTHONPATH:$EB_PYTHONPACKAGE_TEST_INSTALLDIR/bin && '
local_testopts = '--no-container --preserve-entire-environment --outdir results --leave-tmpdir '
local_testopts += '--tmpdir-prefix run_hba_calibrator '
local_testopts += '$EB_PYTHONPACKAGE_TEST_INSTALLDIR/share/linc/workflows/HBA_target.cwl '
local_testopts += 'test_jobs/HBA_target.json'

exts_list = [
    ('pyregion', '2.3.0', {
        'checksums': ['e8498711421173239689de523bb465245f5551a18a181cb4956d87f9c7464925'],
    }),
    ('backports.shutil_get_terminal_size', '1.0.0', {
        'checksums': ['713e7a8228ae80341c70586d1cc0a8caa5207346927e23d09dcbcaf18eadec80'],
    }),
    ('bdsf', '1.13.0.post2', {
        'checksums': ['2a91647fcdb1f6574958312d85decd4529a10e710926f11300a2388f4c9e25cd'],
        'preinstallopts': 'export CMAKE_ARGS="-DF2PY_EXECUTABLE=$EBROOTSCIPYMINBUNDLE/bin/f2py" && ',
    }),
    (name, version, {
        'modulename': False,
        'sources': [{
            'filename': '%(name)s-v%(version)s.tar.xz',
            'git_config': {
                'url': 'https://git.astron.nl/RD/',
                'repo_name': 'LINC',
                'commit': 'v%(version)s',
                'recursive': True,
                'keep_git_dir': True
            },
        }],
        # We cannot get a reproducible checksum, because we need to do keep_git_dir for
        # setuptools_scm to determine the version
        'checksums': [None],
        'testinstall': True,
        'pretestopts': local_pretestopts,
        'runtest': 'cwltool',
        'testopts': local_testopts,
    }),
]

modloadmsg = """
Certain components of LINC (e.g. DP3) do not support a multithreaded BLAS. You may need to set OMP_NUM_THREADS=1 and
OPENBLAS_NUM_THREADS=1. If you're running the pipeline within a SLURM environment, you may need to clear all SLURM
environment variables from your environment (e.g. using 'for i in $(env | grep SLURM); do unset "${i%=*}"; done').
"""

moduleclass = 'astro'
