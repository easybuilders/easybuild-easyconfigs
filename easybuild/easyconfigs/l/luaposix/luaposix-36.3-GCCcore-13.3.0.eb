easyblock = 'ConfigureMake'

name = 'luaposix'
version = '36.3'

homepage = 'http://luaposix.github.io/luaposix'
description = """
 A library binding various POSIX APIs. POSIX is the IEEE Portable Operating System
 Interface standard. luaposix is based on lposix.
"""

toolchain = {'name': 'GCCcore', 'version': '13.3.0'}
toolchainopts = {'pic': True}

source_urls = [GITHUB_LOWER_SOURCE]
sources = ['v%(version)s.tar.gz']
checksums = ['82cd9a96c41a4a3205c050206f0564ff4456f773a8f9ffc9235ff8f1907ca5e6']

local_luaver = '5.4.7'
local_luashortver = '.'.join(local_luaver.split('.')[:2])

builddependencies = [
    ('binutils', '2.42'),
]
dependencies = [
    ('Lua', local_luaver),
]

skipsteps = ['configure']

# Don't want -j added to our custom build command
maxparallel = 0

local_luke_opts = f'PREFIX=%(installdir)s LUAVERSION={local_luashortver} LUA_DIR=$EBROOTLUA '
local_luke_opts += 'LUA_INCDIR=$EBROOTLUA/include'

prebuildopts = local_luke_opts
build_cmd = f'build-aux/luke package={name} version={version} {local_luke_opts}'

preinstallopts = local_luke_opts
install_cmd = f'build-aux/luke install {local_luke_opts} --quiet'

local_libdir = f'lib/lua/{local_luashortver}/posix'
local_libs = [
    'ctype', 'poll', 'unistd', 'fcntl', 'signal', 'time', 'syslog',
]

sanity_check_paths = {
    'files': [f'{local_libdir}/{lib}.{SHLIB_EXT}' for lib in local_libs],
    'dirs': [f'share/lua/{local_luashortver}/posix'],
}
sanity_check_commands = ['lua -e \'local posix = require("posix"); print(posix.uname())\'']

# Lua supports extensions via the path-like variables below
# They syntax is different though, ';' is the separator (';;' at the end also tells it to also look in the default
# locations, but ours is empty so we don't worry about that).
# Ideally we would like direct support, but as these variables allow wild cards ('?') this is not currently supported
# by EasyBuild (which expects paths to exist). To work around this we use module footers:
modluafooter = f"""
prepend_path("LUA_PATH", pathJoin("%(installdir)s", "share", "lua", "{local_luashortver}", "?", "init.lua"), ";")
prepend_path("LUA_PATH", pathJoin("%(installdir)s", "share", "lua", "{local_luashortver}", "?.lua"), ";")
prepend_path("LUA_CPATH", pathJoin("%(installdir)s", "lib", "lua", "{local_luashortver}", "?.so"), ";")
"""
modtclfooter = f"""
prepend-path -delim ";" "LUA_PATH" "%(installdir)s/share/lua/{local_luashortver}/?/init.lua"
prepend-path -delim ";" "LUA_PATH" "%(installdir)s/share/lua/{local_luashortver}/?.lua"
prepend-path -delim ";" "LUA_CPATH" "%(installdir)s/lib/lua/{local_luashortver}/?.so"
"""

moduleclass = 'lang'
