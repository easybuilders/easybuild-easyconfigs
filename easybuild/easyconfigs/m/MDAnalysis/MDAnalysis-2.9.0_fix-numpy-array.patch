From d96d84fe38c79f8b13dec7462b8db9c2f10e1d37 Mon Sep 17 00:00:00 2001
From: Hugo MacDermott-Opeskin <hugomacdermott@gmail.com>
Date: Mon, 23 Jun 2025 11:09:33 +1000
Subject: [PATCH 1/3] Change NPY_ARRAY macros in transformations.c

---
 .../lib/src/transformations/transformations.c  | 18 +++++++++---------
 1 file changed, 9 insertions(+), 9 deletions(-)

diff --git a/package/MDAnalysis/lib/src/transformations/transformations.c b/package/MDAnalysis/lib/src/transformations/transformations.c
index 92a02bab11d..716305d7181 100644
--- a/package/MDAnalysis/lib/src/transformations/transformations.c
+++ b/package/MDAnalysis/lib/src/transformations/transformations.c
@@ -775,7 +775,7 @@ PyConverter_DoubleArray(
     PyObject *object,
     PyObject **address)
 {
-    *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_IN_ARRAY);
+    *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_ARRAY_IN_ARRAY);
      if (*address == NULL) return NPY_FAIL;
      return NPY_SUCCEED;
 }
@@ -808,7 +808,7 @@ PyConverter_DoubleArrayOrNone(
     if ((object == NULL) || (object == Py_None)) {
         *address = NULL;
     } else {
-        *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_IN_ARRAY);
+        *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_ARRAY_IN_ARRAY);
         if (*address == NULL) {
             PyErr_Format(PyExc_ValueError, "can not convert to array");
             return NPY_FAIL;
@@ -823,7 +823,7 @@ PyConverter_DoubleMatrix44(
     PyObject **address)
 {
     PyArrayObject *obj;
-    *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_IN_ARRAY);
+    *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_ARRAY_IN_ARRAY);
     if (*address == NULL) {
         PyErr_Format(PyExc_ValueError, "can not convert to array");
         return NPY_FAIL;
@@ -846,7 +846,7 @@ PyConverter_DoubleMatrix44Copy(
 {
     PyArrayObject *obj;
     *address = PyArray_FROM_OTF(object, NPY_DOUBLE,
-                                NPY_ENSURECOPY|NPY_IN_ARRAY);
+                                NPY_ENSURECOPY|NPY_ARRAY_IN_ARRAY);
     if (*address == NULL) {
         PyErr_Format(PyExc_ValueError, "can not convert to array");
         return NPY_FAIL;
@@ -868,7 +868,7 @@ PyConverter_DoubleVector3(
     PyObject **address)
 {
     PyArrayObject *obj;
-    *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_IN_ARRAY);
+    *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_ARRAY_IN_ARRAY);
     if (*address == NULL) {
         PyErr_Format(PyExc_ValueError, "can not convert to array");
         return NPY_FAIL;
@@ -890,7 +890,7 @@ PyConverter_DoubleVector4(
     PyObject **address)
 {
     PyArrayObject *obj;
-    *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_IN_ARRAY);
+    *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_ARRAY_IN_ARRAY);
     if (*address == NULL) {
         PyErr_Format(PyExc_ValueError, "can not convert to array");
         return NPY_FAIL;
@@ -913,7 +913,7 @@ PyConverter_DoubleVector4Copy(
 {
     PyArrayObject *obj;
     *address = PyArray_FROM_OTF(object, NPY_DOUBLE,
-                                NPY_ENSURECOPY|NPY_IN_ARRAY);
+                                NPY_ENSURECOPY|NPY_ARRAY_IN_ARRAY);
     if (*address == NULL) {
         PyErr_Format(PyExc_ValueError, "can not convert to array");
         return NPY_FAIL;
@@ -938,7 +938,7 @@ PyConverter_DoubleVector3OrNone(
         *address = NULL;
     } else {
         PyArrayObject *obj;
-        *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_IN_ARRAY);
+        *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_ARRAY_IN_ARRAY);
         if (*address == NULL) {
             PyErr_Format(PyExc_ValueError, "can not convert to array");
             return NPY_FAIL;
@@ -3137,7 +3137,7 @@ py_inverse_matrix(
         goto _fail;
 
     matrix = (PyArrayObject *)PyArray_FROM_OTF(object, NPY_DOUBLE,
-                                               NPY_IN_ARRAY);
+                                               NPY_ARRAY_IN_ARRAY);
     if (matrix == NULL) {
         PyErr_Format(PyExc_ValueError, "not an array");
         goto _fail;

From 46a1bf55546db4fdcdf21af7bb3f3f4b84e588f6 Mon Sep 17 00:00:00 2001
From: Hugo MacDermott-Opeskin <hugomacdermott@gmail.com>
Date: Mon, 23 Jun 2025 11:17:00 +1000
Subject: [PATCH 2/3] Change ENSURECOPY and ALIGNED macros

---
 .../MDAnalysis/lib/src/transformations/transformations.c    | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/package/MDAnalysis/lib/src/transformations/transformations.c b/package/MDAnalysis/lib/src/transformations/transformations.c
index 716305d7181..e792d9b0dc0 100644
--- a/package/MDAnalysis/lib/src/transformations/transformations.c
+++ b/package/MDAnalysis/lib/src/transformations/transformations.c
@@ -791,7 +791,7 @@ PyConverter_AnyDoubleArray(
         Py_INCREF(object);
         return NPY_SUCCEED;
     } else {
-        *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_ALIGNED);
+        *address = PyArray_FROM_OTF(object, NPY_DOUBLE, NPY_ARRAY_ALIGNED);
         if (*address == NULL) {
             PyErr_Format(PyExc_ValueError, "can not convert to array");
             return NPY_FAIL;
@@ -846,7 +846,7 @@ PyConverter_DoubleMatrix44Copy(
 {
     PyArrayObject *obj;
     *address = PyArray_FROM_OTF(object, NPY_DOUBLE,
-                                NPY_ENSURECOPY|NPY_ARRAY_IN_ARRAY);
+                                NPY_ARRAY_ENSURECOPY|NPY_ARRAY_IN_ARRAY);
     if (*address == NULL) {
         PyErr_Format(PyExc_ValueError, "can not convert to array");
         return NPY_FAIL;
@@ -913,7 +913,7 @@ PyConverter_DoubleVector4Copy(
 {
     PyArrayObject *obj;
     *address = PyArray_FROM_OTF(object, NPY_DOUBLE,
-                                NPY_ENSURECOPY|NPY_ARRAY_IN_ARRAY);
+                                NPY_ARRAY_ENSURECOPY|NPY_ARRAY_IN_ARRAY);
     if (*address == NULL) {
         PyErr_Format(PyExc_ValueError, "can not convert to array");
         return NPY_FAIL;
