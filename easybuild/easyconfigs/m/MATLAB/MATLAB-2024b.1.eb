name = 'MATLAB'
version = '2024b.1'

homepage = 'http://www.mathworks.com/products/matlab'
description = """MATLAB is a high-level language and interactive environment
 that enables you to perform computationally intensive tasks faster than with
 traditional programming languages such as C, C++, and Fortran."""

toolchain = SYSTEM

# be sure to copy both DVD content to the SAME directory, 
# including the hidden files, especially .dvd1 and .dvd2 
source_urls = ['https://ssd.mathworks.com/supportfiles/downloads/MathWorksServiceHost/v2024.11.0.2/release/glnxa64/']
sources = [
    'R%(version_major)s_Update_%(version_minor)s_Linux.iso',
    {
        'filename': 'managed_mathworksservicehost_2024.11.0.2_package_glnxa64.zip',
        'extract_cmd': 'unzip -d ServiceHost -qq %s',
    },
]
checksums = [
    'cd00952625bde47a2510900fec51e2dc4798e4b250b20597e45266df384a9133',
    '30dc96c2e041fd7e6ad39ba44e2f0c7c93428bb53982b403069b5082576cda98',
]

#skipsteps = ['fetch', 'ready', 'source', 'patch', 'prepare', 'configure', 'build', 'test', 'install']
preinstallopts = 'rmdir %(installdir)s && p=$(dirname %(installdir)s) && bwrap --dev-bind / / --tmpfs $p --bind $p $p/orig bash -c "'
installopts = " && " + " && ".join ([
	'chmod -R u+w %(installdir)s ',
	# install the python engines with both python 3.10, 3.11
	'module load python/3.10 && pushd %(installdir)s/extern/engines/python && python setup.py install --prefix=%(installdir)s/extern/engines/python && popd ', 
	'module load python/3.11 && pushd %(installdir)s/extern/engines/python && python setup.py install --prefix=%(installdir)s/extern/engines/python && popd ', 
	'module load python/3.12 && pushd %(installdir)s/extern/engines/python && python setup.py install --prefix=%(installdir)s/extern/engines/python && popd ',
	'sed -i "s!/usr!$EBROOTGENTOO!g" %(installdir)s/bin/ldd',
	'sed -i "s!/usr!$EBROOTGENTOO!g" %(installdir)s/bin/mex',
	"find %(installdir)s/sys/os/glnxa64 -name 'libstdc++.so*' -exec mv {} {}.bak \;",
	"find %(installdir)s/sys/os/glnxa64 -name 'libgcc_s.so*' -exec mv {} {}.bak \;",
	"find %(installdir)s/sys/os/glnxa64 -name 'libgfortran.so*' -exec mv {} {}.bak \;",
	"find %(installdir)s/sys/os/glnxa64 -name 'libquadmath.so*' -exec mv {} {}.bak \;",
	# never use included Mesa software OpenGL implementation
	'ln -sf $EPREFIX/bin/true %(installdir)s/bin/glnxa64/need_softwareopengl',
        # install central ServiceHost
        'cp -rp ServiceHost %(installdir)s',
        'echo LatestDSInstallerVersion 2024.11.0.2 > %(installdir)s/ServiceHost/LatestInstall.info',
        'echo LatestDSInstallRoot %(installdir)s/ServiceHost >> %(installdir)s/ServiceHost/LatestInstall.info',
        'echo DSLauncherExecutable %(installdir)s/ServiceHost/bin/glnxa64/MathWorksServiceHost >> %(installdir)s/ServiceHost/LatestInstall.info',
	'/cvmfs/soft.computecanada.ca/easybuild/bin/setrpaths.sh --path %(installdir)s --add_origin',
	'/cvmfs/soft.computecanada.ca/easybuild/bin/setrpaths.sh --path %(installdir)s/extern/engines/python --add_path %(installdir)s/bin/glnxa64 --add_origin --any_interpreter ',
	'mv %(installdir)s $p/orig',
]) + '"'
java_options = '-Xmx2048m'
dependencies = [('Java', '17')]
modextrapaths = {'EBPYTHONPREFIXES': ['extern/engines/python']}

# Uncomment and modify the following variables if needed 
# for installation with floating license server

# license_server = 'my-license-server'
# license_server_port = '1234'
# key = '00000-00000-00000-00000-00000-00000-00000-00000-00000-00000-00000-00000'
# modextravars = {'LM_LICENSE_FILE': '%s@%s' % (license_server_port, license_server)}
modextravars = {'MATHWORKS_SERVICE_HOST_MANAGED_INSTALL_ROOT': '%(installdir)s/ServiceHost'}

moduleclass = 'math'

modluafooter = """
require("SitePackage")
local found = find_and_define_license_file("MLM_LICENSE_FILE","matlab")
if (not found) then
        local error_message = [[
	We did not find a suitable license for Matlab. If you have access to one, you can create the file $HOME/.licenses/matlab.lic with the license information. If you think you should have access to one as    part of your institution, please write to support@computecanada.ca so that we can configure it.

	Nous n'avons pas trouve de licence utilisable pour Matlab. Si vous avez acces a une licence de Matlab, vous pouvez creer le fichier $HOME/.licenses/matlab.lic avec l'information de la licence. Si vous    pensez que vous devriez automatiquement avoir acces a une licence via votre institution, veuillez ecrire a support@calculcanada.ca pour que nous puissions la configurer.
	]]
	LmodError(error_message)
end
setenv("MATLAB_LOG_DIR","/tmp")
"""

