easyblock = 'PythonBundle'

name = 'mfai'
version = '5.1.1'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://github.com/meteofrance/mfai'
description = """
MFAI is a Python package that provides the following features:
A variety of PyTorch Neural Network architectures (CNN, Vision Transformers, small LLMs, small
mulitmodal LMs...) adapted to our needs, tested on our projects and datasets. For each architecture,
we provide the reference to the original paper and source code if applicable and also the
modifications we made.
Per architecture schema validated settings using dataclasses-json
A NamedTensor class to handle multi-dimensional data with named dimensions and named features (a
single containing object for a tensor and its metadata)
Various losses from the litterature, often tailored to our projects and experimental results
Lightning module to speedup recurring tasks: segmentation, regression, DGMR training, ...
"""

toolchain = {'name': 'foss', 'version': '2024a'}

builddependencies = [
    ('poetry', '1.8.3'),
]

dependencies = [
    ('CUDA', '12.6.0', '', SYSTEM),
    ('Python', '3.12.3'),
    ('Python-bundle-PyPI', '2024.06'),
    ('PyTorch', '2.6.0', versionsuffix),
    ('MONAI', '1.4.0', versionsuffix),
    ('ONNX-Runtime', '1.23.2', versionsuffix),
    ('ONNX-Script', '0.5.6'),
    ('PyTorch-Geometric', '2.6.1', versionsuffix),
    ('SentencePiece', '0.2.1'),
    ('tiktoken', '0.9.0'),
    ('timm', '1.0.20', versionsuffix),
    ('TensorFlow', '2.18.1', versionsuffix),
]

github_account = 'meteofrance'

exts_list = [
    ('axial-attention', '0.6.1', {
        'checksums': ['0157e77a3132acf8438c819670fc03be1b849b0b03e9e4c281566b61fcc676dc'],
    }),
    ('dunamai', '1.25.0', {
        'checksums': ['a7f8360ea286d3dbaf0b6a1473f9253280ac93d619836ad4514facb70c0719d1'],
    }),
    ('poetry-dynamic-versioning', '1.9.1', {
        'checksums': ['d6e7b9df817aa2ca4946cd695c6c89e1379d2e6c640f008a9b6170d081a9da48'],
    }),
    ('typing-inspect', '0.9.0', {
        'checksums': ['b23fc42ff6f6ef6954e4852c1fb512cdd18dbea03134f91f856a95ccc9461f78'],
    }),
    ('marshmallow', '3.26.2', {
        'checksums': ['bbe2adb5a03e6e3571b573f42527c6fe926e17467833660bebd11593ab8dfd57'],
    }),
    ('dataclasses-json', '0.6.7', {
        'checksums': ['b6b3e528266ea45b9535223bc53ca645f5208833c29229e847b3f26a1cc55fc0'],
    }),
    ('lightning', '2.6.0', {
        'use_pip_extras': 'pytorch-extra',
        'checksums': ['881841716b59c1837ae0c562c2e64fea9bcf49ef9de3867bd1f868557ec23d04'],
    }),
    ('pytorch-lightning', '1.9.5', {
        'checksums': ['925fe7b80ddf04859fa385aa493b260be4000b11a2f22447afb4a932d1f07d26'],
    }),
    ('lightning-bolts', '0.7.0', {
        'modulename': 'pl_bolts',
        'checksums': ['6071cda7721087890ba01523d6580fe72b03b842766fd5018a8eb9caa99fe75c'],
    }),
    ('docstring-parser', '0.17.0', {
        'checksums': ['583de4a309722b3315439bb31d64ba3eebada841f2e2cee23b99df001434c912'],
    }),
    ('typeshed-client', '2.8.2', {
        'checksums': ['9d8e29fb74574d87bf9a719f77131dc40f2aeea20e97d25d4a3dc2cc30debd31'],
    }),
    ('jsonargparse', '4.44.0', {
        'use_pip_extras': 'signatures',
        'checksums': ['54836d2bbb37483dc93fbd21d67241bb3ff0fad6ec513176776c659b2133b287'],
    }),
    (name, version, {
        'preinstallopts': (
            """export SETUPTOOLS_SCM_PRETEND_VERSION="%(version)s" && """
            """sed -i 's/pandas>=2.2.3/pandas>=2.2.2/g' requirements.txt && """
            """sed -i 's/scipy>=1.14.1/scipy>=1.13.1/g' requirements.txt && """
        ),
        'source_urls': ['https://github.com/%(github_account)s/%(name)s/archive'],
        'sources': ['v%(version)s.tar.gz'],
        'checksums': ['e8d31c43ba8e8ed0d2913d77b0974ff8696f2be4831c6e6b0dc51684aa1ba531'],
    }),
]
