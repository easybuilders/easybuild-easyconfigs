# This file is an EasyBuild reciPY as per https://github.com/hpcugent/easybuild
# Author: Pablo Escobar Lopez
# sciCORE - University of Basel
# SIB Swiss Institute of Bioinformatics 

easyblock = 'Bundle'

name = 'QIIME'
version = '1.9.1'

homepage = 'http://qiime.sourceforge.net/'
description = """QIIME (canonically pronounced Chime) is a pipeline for performing microbial community analysis
 that integrates many third party tools which have become standard in the field."""

toolchain = {'name': 'goolf', 'version': '1.7.20'}

python = 'Python'
pythonver = '2.7.11'
pyshortver = '.'.join(pythonver.split('.')[:2])
versionsuffix = '-%s-%s' % (python, pythonver)

# build deps are not loaded when building extensions so I add GHC as a normal dependency. 
# this will be fixed in coming easybuild releases (I think EB 2.8)
#builddependencies = [('GHC', '6.12.3', '', True)]

dependencies = [
    (python, pythonver),  # also provides numpy, scipy, pandas, matplotlib
    ('GHC', '6.12.3', '', True), # required to build Denoiser
    #('PyNAST', '1.2.1', versionsuffix),
    #('qiime-default-reference', '0.1.3', versionsuffix),
    ('UCLUST', '1.2.22q', '-i86linux64', True),
    ('biom-format', '2.1.5', versionsuffix),
    #('qcli', '0.1.0', versionsuffix),
    ('emperor', '0.9.51', versionsuffix),
    ('FastTree', '2.1.3'),
    ('CD-HIT', '3.1.1', '-2007-02-01'),
    ('MUSCLE', '3.8.31'),
    ('BLAST', '2.2.22', '-Linux_x86_64', True),
    ('BLAT', '3.5'),
    ('RDP-Classifier', '2.2', '-Java-1.7.0_80', True),
    ('RAxML', '7.3.0', '-pthreads'),
    ('tax2tree', '1.0', versionsuffix),
    ('R', '3.2.4'),
    ('Mothur', '1.25.0'),
    ('clearcut', '1.0.9'),
    ('cdbfasta', '20100722'),
    ('microbiomeutil', '2010-04-29', '-Perl-5.22.2'),  # provides ChimeraSlayer
    ('BWA', '0.7.10'),
    ('Infernal', '1.0.2'),
    ('AmpliconNoise', '1.27'),
    ('USEARCH', '5.2.236-6.1.544', '-i86linux32', True),
    ('rtax', '0.984', '', True),
    ('ea-utils', '1.1.2-537'),
    ('SeqPrep', '1.1'),
    ('gdata', '2.0.17', versionsuffix),
    ('Cytoscape', '2.7.0', '-Java-1.7.0_80', True),
    ('ParsInsert', '1.04'),
    ('SourceTracker', '0.9.6', '', True),
    ('sumaclust', '1.0.00'),
    ('swarm', '1.2.19'),
    ('SortMeRNA', '2.0'),
    ('PyCogent', '1.5.3', versionsuffix),
]

exts_defaultclass = 'PythonPackage'
exts_filter = ('python -c "import %(ext_name)s"', '')
exts_list = [
    ('click', '6.3', {
        'source_urls': ['https://pypi.io/packages/source/c/click/'],
    }),
    ('future', '0.15.2', {
        'source_urls': ['https://pypi.io/packages/source/f/future'],
    }),
    ('qcli', '0.1.1', {
        'source_urls': ['https://pypi.io/packages/source/q/qcli/'],
    }),
    ('qiime-default-reference', '0.1.3', {
        'source_urls': ['https://pypi.io/packages/source/q/qiime-default-reference/'],
        'modulename': 'qiime_default_reference',
    }),
    ('scikit-bio', '0.2.3', {
        'source_urls': ['https://pypi.io/packages/source/s/scikit-bio/'],
        'modulename': 'skbio',
    }),
    ('burrito', '0.9.1', {
        'source_urls': ['https://pypi.io/packages/source/b/burrito/'],
    }),
    ('burrito-fillings', '0.1.1', {
        'source_urls': ['https://pypi.io/packages/source/b/burrito-fillings/'],
        'modulename': 'bfillings',
    }),
    ('pynast', '1.2.2', {
        'source_urls': ['https://pypi.io/packages/source/p/pynast/'],
    }),
    ('natsort', '3.5.6', {
        'source_urls': ['https://pypi.python.org/packages/source/n/natsort/'],
    }),
    ('qiime', version, {
        'source_urls': ['https://pypi.io/packages/source/q/qiime/'],
	'patches': ['qiime-1.9.1-disable-building-external-deps.patch'],
    }),
]

modextrapaths = {'PYTHONPATH': ['lib/python%s/site-packages' % pyshortver]}

sanity_check_commands = [
    ('print_qiime_config.py', '-t'),
    ('print_qiime_config.py', '-tf'),
    #('cd %(builddir)s/qiime/qiime-%(version)s/tests/ && python all_tests.py', ''), # this one crashes
]

moduleclass = 'bio'
