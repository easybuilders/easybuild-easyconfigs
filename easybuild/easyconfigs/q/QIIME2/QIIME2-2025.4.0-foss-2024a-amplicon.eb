easyblock = 'PythonBundle'

name = 'QIIME2'
version = '2025.4.0'
versionsuffix = '-amplicon'

homepage = 'https://qiime2.org'
description = """QIIME 2 is a powerful, extensible, and decentralized microbiome bioinformatics platform that is free,
open source, and community developed."""

toolchain = {'name': 'foss', 'version': '2024a'}

builddependencies = [
    ('hatchling', '1.24.2'),
    ('poetry', '1.8.3'),
]
dependencies = [
    ('Python', '3.12.3'),
    ('SciPy-bundle', '2024.05'),
    ('matplotlib', '3.9.2'),
    ('IPython', '8.28.0'),
    ('PyYAML', '6.0.2'),
    ('Java', '11', '', SYSTEM),
    ('Perl', '5.38.2'),
    ('R', '4.4.2'),
    ('R-bundle-Bioconductor', '3.20', '-R-%(rver)s'),
    ('Parsl', '2025.7.7'),
    ('alsa-lib', '1.2.11'),
    ('BLAST+', '2.16.0'),
    ('bokeh', '3.6.0'),
    ('Bowtie2', '2.5.4'),
    ('bzip2', '1.0.8'),
    ('cairo', '1.18.0'),
    ('cURL', '8.7.1'),
    ('cutadapt', '5.1'),
    ('DendroPy', '5.0.8'),
    ('expat', '2.6.2'),
    ('FastTree', '2.1.11'),
    ('fontconfig', '2.15.0'),
    ('FriBidi', '1.0.15'),
    ('giflib', '5.2.2'),
    ('GLib', '2.80.4'),
    ('GSL', '2.8'),
    ('h5py', '3.12.1'),
    ('HarfBuzz', '9.0.0'),
    ('MAFFT', '7.526', '-with-extensions'),
    ('scikit-bio', '0.6.3'),
    ('scikit-learn', '1.6.1'),
    ('Seaborn', '0.13.2'),
    ('statsmodels', '0.14.4'),
    ('umap-learn', '0.5.9'),
    ('VSEARCH', '2.30.0'),
    ('UniFrac', '1.5'),
    ('attr', '2.5.2'),
    ('Brotli-python', '1.1.0'),
    ('SAMtools', '1.21'),
    ('HTSlib', '1.21'),
    ('HMMER', '3.4'),
    ('networkx', '3.3'),
    ('wrapt', '1.16.0'),
    # replacing nose3 dependency with pynose since the former is not compatible with Python 3.12+
    ('pynose', '1.5.4'),
    ('PyHMMER', '0.11.1'),
    ('gffutils', '0.13'),
    ('protobuf-python', '5.28.0'),
    ('pyfaidx', '0.8.1.2'),
    ('frictionless', '5.18.1'),
]

_version_fix = r"sed -i 's/dynamic = \[\"version\"\]/version = \"%(version)s\"/' pyproject.toml && "

exts_list = [
    ('unifrac', '1.5', {
        'preinstallopts': "export CONDA_PREFIX='%(installdir)s' && ",
        'source_urls': ['https://github.com/biocore/unifrac/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['ab2298db4e92aba081444d8b979f142a0f77455233670f8cfb0d464c758c8167'],
    }),
    ('jsonlines', '4.0.0', {
        'checksums': ['0c6d2c09117550c089995247f605ae4cf77dd1533041d366351f6f298822ea74'],
    }),
    ('ncbi-datasets-pylib', '16.6.1', {
        'modulename': 'ncbi.datasets',
        'preinstallopts': "sed -i 's/==.*//g' requirements/base.txt && ",
        'checksums': ['06ab4409a00ac4c89465dea774558f8e51bc759f869072332399e5dcca0dded8'],
    }),
    ('xmltodict', '0.14.2', {
        'checksums': ['201e7c28bb210e374999d1dde6382923ab0ed1a8a5faeece48ab525b7810a553'],
    }),
    ('toolz', '1.0.0', {
        'checksums': ['2c86e3d9a04798ac556793bced838816296a2f085017664e4995cb40a1047a02'],
    }),
    ('narwhals', '1.46.0', {
        'checksums': ['fd7e53860b233c2b5566d8b4e1b3e8e9c01b5a87649a9f9a322742000f207a60'],
    }),
    ('tzlocal', '5.3.1', {
        'checksums': ['cceffc7edecefea1f595541dbd6e990cb1ea3d19bf01b2809f362a03dd7921fd'],
    }),
    ('bibtexparser', '1.4.3', {
        'checksums': ['a9c7ded64bc137720e4df0b1b7f12734edc1361185f1c9097048ff7c35af2b8f'],
    }),
    ('ijson', '3.4.0', {
        'checksums': ['5f74dcbad9d592c428d3ca3957f7115a42689ee7ee941458860900236ae9bb13'],
    }),
    ('flufl_lock', '8.2.0', {
        'modulename': 'flufl.lock',
        'checksums': ['15b333c35fab1a36b223840057258aeb4cd79f0fbaf82c144f23cdf6cf14d5e3'],
    }),
    ('atpublic', '6.0.1', {
        'modulename': 'public',
        'checksums': ['718932844f5bdfdf5d80ad4c64e13964f22274b4f8937d54a8d3811d6bc5dc05'],
    }),
    ('emperor', '1.0.4', {
        'checksums': ['8b57d6ee3709b62b4dfdd8e1f815dd88e5fee3a05947d72fa32191a16ac08854'],
    }),
    ('interface_meta', '1.3.0', {
        'checksums': ['8a4493f8bdb73fb9655dcd5115bc897e207319e36c8835f39c516a2d7e9d79a1'],
    }),
    ('formulaic', '1.1.1', {
        'checksums': ['ddf80e4bef976dd99698aa27512015276c7b86c314b601ae6fd360c7741b7231'],
    }),
    ('altair', '5.5.0', {
        'checksums': ['d960ebe6178c56de3855a68c47b516be38640b73fb3b5111c2a9ca90546dd73d'],
    }),
    ('iow', '1.0.8', {
        'modulename': 'bp',
        'preinstallopts': "sed -i '88,92d' setup.py && ",
        'checksums': ['8f2397addcf77dfc439686114d5df86c559f705f9ee73a21df4519ce28008ad9'],
    }),
    ('mypy-extensions', '1.1.0', {
        'sources': ['mypy_extensions-1.1.0-py3-none-any.whl'],
        'checksums': ['1be4cccdb0f2482337c4743e60421de3a356cd97508abadd57d47403e94f5505'],
    }),
    ('typing-inspect', '0.9.0', {
        'sources': ['typing_inspect-0.9.0-py3-none-any.whl'],
        'checksums': ['9ee6fc59062311ef8547596ab6b955e1b8aa46242d854bfc78f4f6b0eff35f9f'],
    }),
    ('pandera', '0.26.1', {
        'checksums': ['81a55a6429770d31b3bf4c3e8e1096a38296bd3009f9eca5780fad3c3c17fd82'],
    }),
    ('rnanorm', '2.2.0', {
        'checksums': ['10b3eab8bb692837235f42def6d010abc743f585516451176bf3dfaaea087cb8'],
    }),
    ('rescript', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/bokulich-lab/RESCRIPt/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['745ca5a73b7517703d742cfa540ea12cf59afca351f8b7866eb6fd8e403a9202'],
    }),
    ('rpy2-rinterface', '3.6.3', {
        'sources': ['rpy2_rinterface-3.6.3.tar.gz'],
        'modulename': 'rpy2.rinterface',
        'checksums': ['477bc2f51d007ad1b8567c5d4ba1af0f59951686ee7f10576a06d0834de5776f'],
    }),
    ('rpy2-robjects', '3.6.2', {
        'sources': ['rpy2_robjects-3.6.2.tar.gz'],
        'modulename': 'rpy2.robjects',
        'checksums': ['ac91af32d5c4da236b05a3cd68dafb24cd8f5a880f0078629b8f2bf02505423b'],
    }),
    ('rpy2', '3.6.3', {
        'checksums': ['942618a12521963006d22e88aaa4d481a923821c03a1742c99beee722eb0fc5a'],
    }),
    (name, version, {
        'patches': ['QIIME2-2024.10.1_parallel-fix.patch'],
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/qiime2/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': [
            {'QIIME2-2025.4.0.tar.gz': '8d51d212a6c31d5fa4e82f846d1a2aebcc993eb9d0fbbb3189da6aeac3942e92'},
            {'QIIME2-2024.10.1_parallel-fix.patch': '96c63459ca19b8059845506984b9bf2c0e9d098866aa881d3c6ead9b758cb70d'},
        ],
    }),
    ('q2cli', version, {
        'patches': ['q2cli_conda_prefix_bug.patch'],
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2cli/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['df9a7d47924dc6f952db81beb913d3a186c3efc9f2e634aab9c553c22379a3c3'],
    }),
    ('q2-alignment', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-alignment/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['8f6cfc7816c8579ed8111c2c5abd04cee82ea14a85fd1d54ed5be24af115c7bb'],
    }),
    ('q2-composition', version, {
        'modulename': 'q2_composition',
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-composition/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['5dc1a58c11e47e24a3dc68c30e704e4b16563bf8f0309238a766c64566b1ee4a'],
    }),
    ('q2-cutadapt', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-cutadapt/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['d8ed7a9fad3f41a93f2bc4820770fc03b8a1ee7b3082e172272a0d9b32ff2326'],
    }),
    ('q2-dada2', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-dada2/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['2735f2a2cf963da542be11a8d316a17e825ccc34e4feb96b450de096271d190b'],
    }),
    ('q2-deblur', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-deblur/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['1f46b7561909360b39f8e3e1c36b3c16d9f296dbbc961de4061c1d239250fa01'],
    }),
    ('q2-demux', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-demux/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['5ed3327c0402b99f436752e517ad7ec25fb20bda6f59179e18c340f182692b5c'],
    }),
    ('q2-diversity', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-diversity/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['fd3d6aa828f16600003de87a1eb90a3630e4c5fdb51b33cc7fea2f2d722d3aff'],
    }),
    ('q2-diversity-lib', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-diversity-lib/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['6331f2bcdc41ee0f02b2b3737801528835eb1f60af0a7f60173f32e7c3ac7fb1'],
    }),
    ('q2-emperor', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-emperor/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['dd712818e38bf20782560d781c4aedd81a02ceeba89f429ac5792f72e33653eb'],
    }),
    ('q2-feature-classifier', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-feature-classifier/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['5f3e5b420140b7f2070360b043efd3347b5e948fc271d7ba56535a3a66422084'],
    }),
    ('q2-feature-table', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-feature-table/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['afa74d3e51b46368068019c777cb1e21fb0c797bbb46ce1eaf894a2000bc1361'],
    }),
    ('q2-fragment-insertion', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-fragment-insertion/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['f5058909cfb3a72ddd66132c7fe5beac80c60052d095d5730c9e17e48ebca6a2'],
    }),
    ('q2-longitudinal', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-longitudinal/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['a2264601ca792adbbd5e0e5ef2150234916c58cfa699970974fbb29dbc0912af'],
    }),
    ('q2-metadata', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-metadata/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['f8fa30a32c6647f907cf7704d06818dad9583c1c0b5f2a70d73018275baa93aa'],
    }),
    ('q2-phylogeny', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-phylogeny/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['8b3ca86363ade93abf7ba8000c94dbfa7118363e939442188348126483285973'],
    }),
    ('q2-quality-control', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-quality-control/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['5d2c2dca096fd08c0a7c259cefac621d799eabed6241d8b4882098f95769a515'],
    }),
    ('q2-quality-filter', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-quality-filter/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['e0f4aac649543078aa834047754f385946c3d15b3fec439cbb2c3768334d49ac'],
    }),
    ('q2-sample-classifier', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-sample-classifier/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['b34efbf35f7000571ff3ab445370fa1ccbb4596fc921a758e8efd7906508857f'],
    }),
    ('q2-taxa', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-taxa/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['60f433c379a29692df26fc22188147efce47d1f6ef8afc7fd21b69b6b4f8fb71'],
    }),
    ('q2-types', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-types/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['63790bb495b1e7966c12afaefcbadad0e6e36fb3826ddb4b08cdea3eaef366f7'],
    }),
    ('q2-vsearch', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2-vsearch/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['44ce1fcb4cdc5a200ea49277377d07f442d49d253fcd5a055891fa49661eb403'],
    }),
    ('q2templates', version, {
        'preinstallopts': r"""sed -i 's/dynamic = \["version"\]/version = "%(version)s"/' pyproject.toml && """,
        'source_urls': ['https://github.com/qiime2/q2templates/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['521e24efb91707ab8b4bfbd77e1564c5aea69d814aa4f9f7c2319da66c3eb525'],
    }),
]

sanity_check_paths = {
    'files': ['bin/qiime'],
    'dirs': ['lib/python%(pyshortver)s/site-packages'],
}

sanity_check_commands = [
    "qiime --help",
    "qiime info",
    "qiime tools validate "
    "%(installdir)s/lib/python%(pyshortver)s/site-packages/q2_sample_classifier/tests/data/vaw.qza",
]

moduleclass = 'bio'
