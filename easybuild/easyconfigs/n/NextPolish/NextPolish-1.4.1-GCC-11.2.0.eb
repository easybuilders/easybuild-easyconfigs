easyblock = 'Bundle'

name = 'NextPolish'
version = '1.4.1'

homepage = "https://github.com/Nextomics/NextPolish"
description = """NextPolish is used to fix base errors (SNV/Indel) in the genome generated by noisy long reads. It can
be used with short read or long read data only or a combination of both. It contains two core modules, and is used
in a stepwise fashion to correct the error bases in the reference genome."""

toolchain = {'name': "GCC", 'version': "11.2.0"}

# Note NextPolish sources include BWA, minimap2 and samtools. Excluding these and using proper easyconfigs for those
# dependencies makes this installation much more complicated
dependencies = [
    ("bzip2", "1.0.8"),
    ("XZ", "5.2.5"),
    ("Python", "3.9.6"),
]

default_component_specs = {
    'sources': ['%(name)s.tgz'],
    'source_urls': ["https://github.com/Nextomics/NextPolish/releases/download/v1.4.1/"],
    'checksums': ['2a5f66f3db7f76e583a6b6e28f9c1f3c392258b8d755050d7abe129a2fbb48c4']
}

components = [
    (name, version, {
        'easyblock': 'MakeCp',
        'start_dir': name,
        'buildopts': 'CFLAGS="$CFLAGS -fcommon"',  # from GCC 10 onwards -fnocommon is set by default
        'files_to_copy': ['bin', 'doc', 'lib', 'test_data', 'util', 'LICENSE', 'nextPolish', 'README.md'],
    }),
    ('Paralleltask', '0.1.1', {
        'easyblock': 'PythonPackage',
        'source_urls': [PYPI_SOURCE],
        'sources': [SOURCE_TAR_GZ],
        'checksums': ['9bf84d83acbc208d03adc7c9771f60c4d871bbfdc540f2243721fab5675e97fe'],
        'start_dir': '%(name)s-%(version)s',
        'use_pip': True,
        'download_dep_fail': True,
        'sanity_pip_check': True,
        'options': {'modulename': 'paralleltask'},
    }),
]

# nextPolish Python script has to remain in top level install path; symlink to bin to make it executable when loading
# the module
postinstallcmds = ["ln -s ../nextPolish %(installdir)s/bin/nextPolish"]

modextrapaths = {
    'PYTHONPATH': ['lib/python%(pyshortver)s/site-packages']
}

sanity_check_paths = {
    'files': ['bin/%s' % x for x in ['bwa', 'minimap2', 'samtools', 'seq_count', 'seq_split']],
    'dirs': ['bin', 'doc', 'lib', 'test_data', 'util'],
}

sanity_check_commands = ['nextPolish --help']

moduleclass = 'bio'
