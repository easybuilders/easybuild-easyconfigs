easyblock = 'ConfigureMake'

name = 'neko'
version = '0.9.1'

toolchain = {'name': 'foss', 'version': '2025a'}

homepage = 'https://neko.cfd/'
description = """Neko is a portable framework for high-order spectral element flow simulations."""

source_urls = ['https://github.com/ExtremeFLOW/neko/archive/refs/tags']
sources = ['v%(version)s.tar.gz']

dependencies = [
    ('json-fortran', '8.3.0'),
    ('HDF5', '1.14.6'),  
    ('ParMETIS', '4.0.3'), 
]

# Bypass broken BLAS detection by modifying configure.ac before running regen.sh
preconfigopts = ' && '.join([
    'sed -i "138s/.*/  BLAS_LIBS=\\"-lflexiblas\\" ; LAPACK_LIBS=\\"-lflexiblas\\" ; ax_lapack_ok=yes/" configure.ac',
    './regen.sh',
])

# EESSI requires FlexiBLAS instead of direct OpenBLAS linking
configopts = ' '.join([
    'FCFLAGS="$FCFLAGS -I$EBROOTJSONMINFORTRAN/include"',
    'LDFLAGS="-L$EBROOTFLEXIBLAS/lib"'
    '--enable-openmp',
    '--enable-shared',
])

sanity_check_paths = {
    '--enable-openmp',
    '--enable-shared',
    '--with-hdf5',
    '--with-parmetis=$EBROOTPARMETIS',
    '--with-blas='flexiblas',
    '--with-lapack='flexiblas',
}

moduleclass = 'lib'