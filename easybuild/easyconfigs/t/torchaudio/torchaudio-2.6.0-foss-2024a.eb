easyblock = 'PythonBundle'

name = 'torchaudio'
version = '2.6.0'

homepage = 'https://github.com/pytorch/audio'
description = """ Data manipulation and transformation for audio signal
processing, powered by PyTorch """

toolchain = {'name': 'foss', 'version': '2024a'}

builddependencies = [
    ('CMake', '3.29.3'),
    ('Ninja', '1.12.1'),
    ('parameterized', '0.9.0'),  # for tests
    ('scikit-learn', '1.5.2'),  # for tests
    ('librosa', '0.10.2.post1'),  # for tests
]

dependencies = [
    ('Python', '3.12.3'),
    ('PyTorch', version),
    ('FFmpeg', '7.0.2'),
    ('SoX', '14.4.2'),
]

exts_list = [
    (name, version, {
        'installopts': '-v',
        'patches': [
            'torchaudio-%(version)s_use_ffmpeg7.patch',
            'torchaudio-%(version)s_fix_tests.patch',
        ],
        'preinstallopts': ('unset BUILD_VERSION && rm -r third_party/{sox,ffmpeg/multi};'  # runs twice when testinstall
                           ' USE_CUDA=0 USE_OPENMP=1 USE_FFMPEG=1 FFMPEG_ROOT="$EBROOTFFMPEG" BUILD_SOX=0'),
        'source_urls': ['https://github.com/pytorch/audio/archive'],
        'sources': [{'download_filename': 'v%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'runtest': (
            'export OMP_NUM_THREADS=%(parallel)s && '
            'pytest test/torchaudio_unittest/'
            ' -k "not TestProcessPoolExecutor"'  # hang maybe related https://github.com/pytorch/audio/issues/1021
            '" and not FilterGraphWithCudaAccel"'  # requires FFmpeg with CUDA support
            '" and not kaldi_io_test"'  # requires kaldi_io
            '" and not test_dup_hw_acel"'  # requires special render device permissions
            '" and not test_h264_cuvid"'  # requires special render device permissions
            '" and not test_hevc_cuvid"'  # requires special render device permissions
        ),
        'testinstall': True,
        'checksums': [
            {'torchaudio-2.6.0.tar.gz': '3335d8fcf58c26acf3c628d751103b59226e01c91847ce56efb2a4e7ae8351ef'},
            {'torchaudio-2.6.0_use_ffmpeg7.patch': '1a2f7505efee9852ef393e6f4583cef209ad302db241171bf41be8d4a88920bd'},
            {'torchaudio-2.6.0_fix_tests.patch': '3964df416b64a30eb20928c1392c588ae92def8a4a17b0b0e8b69a8a20e093b0'},
        ],
    }),
]

moduleclass = 'ai'
