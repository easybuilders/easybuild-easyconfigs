# This easyconfig was created by the BEAR Software team at the University of Birmingham.
easyblock = 'CmdCp'

name = 'Thermo-Calc'
version = '2022a'

homepage = "https://www.thermocalc.com"
description = """The Thermo-Calc software is a sophisticated database and programming interface package used to
 perform thermodynamic calculations. It can calculate complex homogeneous and heterogeneous phase equilibria, and then
 plot the results as property diagrams and phase diagrams."""

toolchain = {'name': 'foss', 'version': '2021a'}

# Install files provided by Met&Mat:
# 1. Get the file titled e.g. 'Thermo-Calc-linux-2022.1.95234-411.man' from Met & Mat
# 2. Tar this: "tar -cvz -f Thermo-Calc-2022a.tar.gz Thermo-Calc-linux-2022.1.95234-411.man"
# 3. Copy the resulting file to the sources directory
sources = ["%(name)s-%(version)s.tar.gz"]
checksums = ['9268f9e6a3ffaef9d5f8e75bcbff3ebd0dbb4bedde4d4c9cf7a9cd91387761bb']

dependencies = [
    ('libxslt', '1.1.34'),
]

local_command_list = [
    "./Thermo-Calc*.man",
    "--mode unattended",
    "--enable-components thermo,databases,tcapi,tq",
    "--license_server met-tc.bham.ac.uk",
    "--installation_mode custom",
    "--prefix %(builddir)s",
]

cmds_map = [('.*', " ".join(local_command_list))]

buildininstalldir = True

files_to_copy = []

# Symlink for shared data. Note that the user building this app will need read access to the shared content
postinstallcmds = [
    "ln -s ${BB_APPS_DATA}/Thermo-Calc/*/TT* %(installdir)s/data/"
]

modextravars = {
    'TC22A_HOME': '%(installdir)s',  # Fix this for each version
    'TCPATH': '%(installdir)s',
    'LSHOST': 'met-tc.bham.ac.uk'
}

modextrapaths = {
    'LD_LIBRARY_PATH': './SDK/TQ',
    'PATH': '',
}

modaliases = {"tc": "Console.sh"}

modloadmsg = """Note that if you want to use the Thermo-Calc graphical interface with the BEAR Portal
'BlueBEAR GUI' app, you will need to execute the following command first: `unset XDG_DATA_DIRS`"""

sanity_check_paths = {
    'files': ["Console.sh", "Thermo-Calc.sh"],
    'dirs': ["data/TTAL5"],  # This should exist following the `ln -s` post-install command
}

moduleclass = 'cae'

# Need to ensure that only members of the p-thermocalc group can access the module
local_bham_group = "p-thermocalc"
