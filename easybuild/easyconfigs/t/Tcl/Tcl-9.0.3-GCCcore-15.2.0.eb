easyblock = 'ConfigureMake'

name = 'Tcl'
version = '9.0.3'

homepage = 'https://www.tcl.tk/'
description = """
 Tcl (Tool Command Language) is a very powerful but easy to learn dynamic
 programming language, suitable for a very wide range of uses, including web
 and desktop applications, networking, administration, testing and many more.
"""

toolchain = {'name': 'GCCcore', 'version': '15.2.0'}
toolchainopts = {'cstd': 'gnu99'}

source_urls = ['http://prdownloads.sourceforge.net/%(namelower)s']
sources = ['%(namelower)s%(version)s-src.tar.gz']
checksums = ['2537ba0c86112c8c953f7c09d33f134dd45c0fb3a71f2d7f7691fd301d2c33a6']

builddependencies = [
    ('binutils', '2.45'),
]
dependencies = [
    ('libtommath', '1.3.0'),
]

configopts = 'EXTRA_INSTALL="install-private-headers" '
configopts += '--with-system-libtommath=yes '
# Avoid picking up a system tclsh
configopts += 'ac_cv_path_tclsh=no '
# Use internal minizip and zlib libraries, since using external ones
# creates circular dependencies (e.g. Tcl -> minizip-ng -> CMake -> cURL -> libpsl -> Python -> SQLite -> Tcl)
configopts += 'ac_cv_header_zlib_h=no ac_cv_path_zip=no '

runtest = 'test'

start_dir = 'unix'

postinstallcmds = [
    'ln -s tclsh%(version_major)s.%(version_minor)s %(installdir)s/bin/tclsh',
    f'ln -s libtcl%(version_major)s.%(version_minor)s.{SHLIB_EXT} '
    f'%(installdir)s/lib/libtcl.{SHLIB_EXT}',
] + [
    # Avoid that installations on top of Tcl try to access the (no longer existing) source directory
    # See https://core.tcl-lang.org/tk/tktview/b900dc755201139b5a7cecada73405c7681b7c03
    f"""echo "{d}='%(installdir)s'" >> '%(installdir)s/lib/tclConfig.sh'"""
    for d in ('TCL_SRC_DIR', 'itcl_SRC_DIR', 'ITCL_SRC_DIR', 'tdbc_SRC_DIR', 'TDBC_SRC_DIR')
]

sanity_check_paths = {
    'files': ['bin/tclsh%(version_major)s.%(version_minor)s', 'bin/tclsh',
              'include/tcl.h', 'lib/libtcl%%(version_major)s.%%(version_minor)s.%s' % SHLIB_EXT,
              f'lib/libtcl.{SHLIB_EXT}', 'lib/tclConfig.sh'],
    'dirs': ['share'],
}

moduleclass = 'lang'
