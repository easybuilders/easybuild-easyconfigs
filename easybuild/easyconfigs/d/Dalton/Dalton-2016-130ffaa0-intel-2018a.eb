easyblock = 'CMakeMake'

name = 'Dalton'
version = '2016-130ffaa0'

# This naming scheme is due to the current versioning scheme in the Dalton community for 2016. 
# Due to issues related to cmake-settings; a separarate easyblock might be desirable; fixing path
# in a more elegant way, like done with Gromacs.

homepage = 'http://www.daltonprogram.org'
description = """The Dalton code is a powerful tool for a wide range
 of molecular properties at different levels of theory, whereas LSDalton
 is a linear-scaling HF and DFT code suitable for large molecular systems,
 now also with some CCSD capabilites."""

toolchain = {'name': 'intel', 'version': '2018a'}

# source tarball needs to be created manually,
# git clone --recursive https://gitlab.com/dalton/dalton.git
# cd dalton && git reset --hard <commit_SHA> && cd -
# commit_SHA = 130ffaa0613bb3af6cac766fc8183d6df7d68917
# tar cfz dalton-<VERSION>.tar.gz dalton
sources = [SOURCELOWER_TAR_GZ]

checksums = ['7963ef7a75e925b1dbf3ce1acb84e3d3f8be0decfe48be9ca22a9e97fb943924']

extra_vars = 'preconfigopts' 
separate_build_dir = True

builddependencies = [
    ('CMake', '3.9.1'),
]

# For ref: ./setup in dalton source folder
configopts = "-DCMAKE_Fortran_COMPILER=${MPIFC} -DCMAKE_C_COMPILER=${MPICC} -DCMAKE_CXX_COMPILER=${MPICXX} " 
configopts+= "-DCMAKE_BUILD_TYPE=release -DENABLE_MPI=ON "
#configopts+="-DENABLE_OMP=ON " This has to be fixed in the Dalton code first.
configopts+= "-DMKL_FLAG='-mkl=parallel' -DENABLE_AUTO_BLAS=OFF -DENABLE_AUTO_LAPACK=OFF "
# The flags given under are all intel specific, if anyone finds the corresponding gnu ones,
# we are happy to apply them: Ideally some common var name that just sets it right.
configopts+= "-DEXTRA_Fortran_FLAGS='-xHOST -qopenmp' -DEXTRA_C_FLAGS='-xHOST -qopenmp' -DEXTRA_CXX_FLAGS='-xHOST -qopenmp'"
#configopts+= "-DENABLE_GPU=OFF "

sanity_check_paths = {
    'files': ['dalton/dalton', 'dalton/dalton.x', 'dalton/VERSION'],
    'dirs': ['dalton', 'dalton/basis', 'dalton/tools'],
}

modextrapaths	= {'PATH' : ['dalton', 'dalton/tools'] ,}
#modextravars   = {'BASDIR' : ['dalton/basis'] ,}
moduleclass = 'chem'
