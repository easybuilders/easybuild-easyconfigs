# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2023/11
easyblock = 'PythonBundle'

name = 'DynaMight'
_v = '0.0.0'
_sha = '86870f30f79a22ebbb05a40220226911ec64fcda'
_date = '20231107'
version = '%s.%s.%s' % (_v, _date, _sha[:7])

versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://github.com/3dem/DynaMight'
description = """Estimating dynamics from cryo-EM images and use them to improve your map (maybe)"""

toolchain = {'name': 'foss', 'version': '2022a'}

patches = []

dependencies = [
    ('Python', '3.10.4'),
    ('CUDA', '11.7.0', '', SYSTEM),
    ('mrcfile', '1.4.3'),
    ('matplotlib', '3.5.2'),
    ('Biopython', '1.79'),
    ('napari', '0.4.18'),
    ('starfile', '0.5.1'),
    ('scikit-learn', '1.1.2'),
    ('PyTorch', '1.12.0', versionsuffix),
    ('umap-learn', '0.5.3'),
    ('tensorboard', '2.10.0'),
    ('tsne-cuda', '3.0.1', versionsuffix),
]

use_pip = True

# avoid hatchling requirement to install (compare genomepy-0.15.0-foss-2022a.eb) 
# (since installing it introduces conflicting version requirements with poetry included with Python)
_preinstallopts_no_hatchling = """sed -i -e 's/^build-backend = .*/build-backend = "setuptools.build_meta"/g' """
_preinstallopts_no_hatchling += """-e 's/^requires = .*/requires = ["setuptools"]/g' """
_preinstallopts_no_hatchling += r"""-e 's/dynamic = \["version"\]/version = "%(version)s"/g' pyproject.toml && """
exts_list = [
    (name, '0.0.0.20231107', {
        'preinstallopts': _preinstallopts_no_hatchling,
        'source_urls': ['https://github.com/3dem/DynaMight/archive/'],
        'sources': [{'download_filename': '%s.tar.gz' % _sha, 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['59837bb73588567e9d444945b2687fdf856773fcef8bcf882bae0e021315a945'],
    }),
]

sanity_pip_check = True

sanity_check_paths = {
    'files': [],
    'dirs': ['lib/python%(pyshortver)s/site-packages/%(namelower)s'],
}

moduleclass = 'bio'
