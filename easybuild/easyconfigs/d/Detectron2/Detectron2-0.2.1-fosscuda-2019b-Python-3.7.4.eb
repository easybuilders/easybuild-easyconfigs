easyblock = 'PythonBundle'

name = 'Detectron2'
version = '0.2.1'
versionsuffix = '-Python-%(pyver)s'
local_pytorchver = '1.4.0'

homepage = 'https://github.com/facebookresearch/detectron2'
description = """
Detectron2 is Facebook AI Research's next generation software system that implements state-of-the-art object detection
algorithms. It is a ground-up rewrite of the previous version, Detectron, and it originates from maskrcnn-benchmark."""

toolchain = {'name': 'fosscuda', 'version': '2019b'}

dependencies = [
    ('Python', '3.7.4'),
    ('tqdm', '4.41.1'),
    ('matplotlib', '3.1.1', versionsuffix),
    ('pycocotools', '2.0.1', versionsuffix),
    ('PyYAML', '5.1.2'),
    ('PyTorch', local_pytorchver, versionsuffix),
    ('torchvision', '0.5.0', versionsuffix + '-PyTorch-' + local_pytorchver),
    ('libjpeg-turbo', '2.0.3'),  # required for Pillow-SIMD
    ('libpng', '1.6.37'),  # required for Pillow-SIMD
    ('zlib', '1.2.11'),  # required for Pillow-SIMD
    ('LibTIFF', '4.0.10'),  # required for Pillow-SIMD
    ('freetype', '2.10.1'),  # required for Pillow-SIMD
    ('Graphviz', '2.42.2', '-Java-11'),
    # ('OpenCV', '4.2.0', versionsuffix),  # optional and needed by demo and visualization
]

use_pip = True

exts_default_options = {'source_urls': [PYPI_SOURCE]}

# Pillow-SIMD >=7 required, torchvision-0.5.0 has Pillow-SIMD-6.0.x.post0 dependency
exts_list = [
    ('Pillow-SIMD', '7.0.0.post3', {
        'modulename': 'PIL',
        'checksums': ['c27907af0e7ede1ceed281719e722e7dbf3e1dbfe561373978654a6b64896cb7'],
    }),
    ('termcolor', '1.1.0', {
        'checksums': ['1d6d69ce66211143803fbc56652b41d73b4a400a2891d7bf7a1cdf4c02de613b'],
    }),
    ('yacs', '0.1.8', {
        'checksums': ['efc4c732942b3103bea904ee89af98bcd27d01f0ac12d8d4d369f1e7a2914384'],
    }),
    ('cloudpickle', '1.6.0', {
        'checksums': ['9bc994f9e9447593bd0a45371f0e7ac7333710fcf64a4eb9834bf149f4ef2f32'],
    }),
    ('Werkzeug', '1.0.1', {
        'checksums': ['6c80b1e5ad3665290ea39320b91e1be1e0d5f60652b964a3070216de83d2e47c'],
    }),
    ('Markdown', '3.2.2', {
        'checksums': ['1fafe3f1ecabfb514a5285fca634a53c1b32a81cb0feb154264d55bf2ff22c17'],
    }),
    ('pyasn1-modules', '0.2.8', {
        'modulename': 'pyasn1_modules',
        'checksums': ['905f84c712230b2c592c19470d3ca8d552de726050d1d1716282a1f6146be65e'],
    }),
    ('protobuf', '3.13.0', {
        'modulename': 'google.protobuf',
        'checksums': ['6a82e0c8bb2bf58f606040cc5814e07715b2094caeba281e2e7d0b0e2e397db5'],
    }),
    ('tensorboard-plugin-wit', '1.7.0', {
        'source_tmpl': 'tensorboard_plugin_wit-%(version)s-py3-none-any.whl',
        'unpack_sources': False,
        'checksums': ['ee775f04821185c90d9a0e9c56970ee43d7c41403beb6629385b39517129685b'],
    }),
    ('tensorboard', '2.3.0', {
        'source_tmpl': 'tensorboard-%(version)s-py3-none-any.whl',
        'unpack_sources': False,
        'checksums': ['d34609ed83ff01dd5b49ef81031cfc9c166bba0dabd60197024f14df5e8eae5e'],
    }),
    ('portalocker', '2.0.0', {
        'checksums': ['14487eed81aa914127edf0284e29c7ca8842c05bb33d96dc7e4bdb47282d26e4'],
    }),
    ('fvcore', '0.1.1.post20200716', {
        'checksums': ['4942545bef8ce243cde87cef232202366e2af3cc1a83331f2cf32edec3893f6b'],
    }),
    ('absl-py', '0.10.0', {
        'modulename': 'absl',
        'checksums': ['b20f504a7871a580be5268a18fbad48af4203df5d33dbc9272426cb806245a45'],
    }),
    ('grpcio', '1.31.0', {
        'modulename': 'grpc',
        'checksums': ['5043440c45c0a031f387e7f48527541c65d672005fb24cf18ef6857483557d39'],
    }),
    ('rsa', '4.6', {
        'checksums': ['109ea5a66744dd859bf16fe904b8d8b627adafb9408753161e766a92e7d681fa'],
    }),
    ('cachetools', '4.1.1', {
        'checksums': ['bbaa39c3dede00175df2dc2b03d0cf18dd2d32a7de7beb68072d13043c9edb20'],
    }),
    ('google-auth', '1.21.0', {
        'modulename': 'google.auth',
        'checksums': ['982e1f82cace752134660b4c0ff660761b32146a55abb3ad6d225529012af87c'],
    }),
    ('oauthlib', '3.1.0', {
        'checksums': ['bee41cc35fcca6e988463cacc3bcb8a96224f470ca547e697b604cc697b2f889'],
    }),
    ('requests-oauthlib', '1.3.0', {
        'modulename': 'requests_oauthlib',
        'checksums': ['b4261601a71fd721a8bd6d7aa1cc1d6a8a93b4a9f5e96626f8e4d91e8beeaa6a'],
    }),
    ('google-auth-oauthlib', '0.4.1', {
        'checksums': ['88d2cd115e3391eb85e1243ac6902e76e77c5fe438b7276b297fbe68015458dd'],
    }),
    ('pydot', '1.4.1', {
        'checksums': ['d49c9d4dd1913beec2a997f831543c8cbd53e535b1a739e921642fe416235f01'],
    }),
    (name, version, {
        'patches': ['%(name)s-%(version)s_fix-pillow-simd-version.patch'],
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/facebookresearch/detectron2/archive/'],
        'checksums': [
            'ee3e404f534c03883423846876522d6b1e3e64796abd12caf51e8f8648bd5a63',  # v0.2.1.tar.gz
            # Detectron2-0.2.1_fix-pillow-simd-version.patch
            '66713aa159a0fce4cf0fd3d26cfca6dda449fb1c0ae5c82b47a8ae304aaa118e',
        ],
        'preinstallopts': 'export TORCH_CUDA_ARCH_LIST="3.5 3.7 5.2 6.0 6.1 7.0 7.2 7.5" && ',
    }),
]

sanity_pip_check = True

moduleclass = 'math'
