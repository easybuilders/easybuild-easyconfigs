easyblock = 'Tarball'

name = 'InterProScan'
version = '5.62-94.0'
versionsuffix = '-with_data'

homepage = 'https://interproscan-docs.readthedocs.io/'
# Also https://github.com/ebi-pf-team/interproscan
description = """
InterPro is a database which integrates together predictive information about
proteins’ function from a number of partner resources, giving an overview of the
families that a protein belongs to and the domains and sites it contains.

Users who have novel nucleotide or protein sequences that they wish to
functionally characterise can use the software package InterProScan to run the
scanning algorithms from the InterPro database in an integrated way.  Sequences
are submitted in FASTA format.  Matches are then calculated against all of the
required member database’s signatures and the results are then output in a
variety of formats."""
# Licence: Apache License 2.0.

toolchain = SYSTEM

# We download the code and the data.  This download is available from GitHub.
source_urls = ['https://ftp.ebi.ac.uk/pub/software/unix/iprscan/%(version_major)s/%(version)s/']
sources = ['%(namelower)s-%(version)s-64-bit.tar.gz']  # Note 5.5G in size.
checksums = ['2f4a5d1813dea3aecc6976d7e9dfd8c2fa69e752a3bc12bcc5d03b215f2af310']

dependencies = [
    ('Java',      '11'),
    ('PCRE2',     '10.40',  '',         ('GCCcore', '12.2.0')),
    ('Perl',      '5.36.0', '-minimal', ('GCCcore', '12.2.0')),
    ('pftoolsV3', '3.2.12', '',         ('GCCcore', '12.2.0')),
    ('Python',    '3.11.2', '-bare',    ('GCCcore', '12.2.0')),
    ('SignalP',   '4.1g'),
]

_signalp_config = r"""\
\
# SignalP\
signalp_euk.signature.library.release=4.1\
signalp_gram_positive.signature.library.release=4.1\
signalp_gram_negative.signature.library.release=4.1\
binary.signalp.path=bin/signalp/4.1/signalp\
signalp.perl.library.dir=bin/signalp/4.1/lib\
"""

postinstallcmds = [
    'cd %(installdir)s/bin/prosite && rm -f pfs*V3 && echo "$EBROOTPFTOOLSV3"/bin/pfs*V3 | xargs -n1 ln -s',
    'cd %(installdir)s/bin/signalp/4.1 && echo "$EBROOTSIGNALP"/{bin,signalp} | xargs -n1 ln -s',
    f"sed -i -e '$ a{_signalp_config}' %(installdir)s/interproscan.properties",
    'cd %(installdir)s && python setup.py -f interproscan.properties',
]

modextrapaths = {'PATH': ''}

sanity_check_paths = {
    'files': ['interproscan-%(version_major)s.jar', 'interproscan.sh', 'interproscan.properties'],
    'dirs': ['bin', 'lib'],
}

sanity_check_commands = ["interproscan.sh --version | grep -F 'InterProScan version %(version)s'"]

moduleclass = 'bio'

# Note that some analyses done by InterProScan require extra tools not included
# in its distribution because of license issues.  Those tools are SignalP, TMHMM
# and Phobius.  We include SignalP in this build, but the other two will require
# manual intervention: copy or symlink their executables into the apppropriate
# %(installdir)s/bin/TOOL/VERSION/ directory.
