# Updated to v2.1.3 by
# R.QIAO <rob.qiao@flinders.edu.au>
# DeepThought, Flinders University
# Updates: Petr Kr√°l (INUITS) - steven.vandenbrande@kuleuven.be

easyblock = 'CMakeMake'

name = 'IQ-TREE'
version = '3.0.1'

# HTTPS is not working
homepage = 'http://www.iqtree.org/'
description = """Efficient phylogenomic software by maximum likelihood"""

toolchain = {'name': 'gompi', 'version': '2024a'}
# Including 'usempi' will take precedence and override IQTREE_FLAGS and produces only 'iqtree-mpi' binary

sources = [{
    'filename': 'v%(version)s.tar.xz',
    'git_config': {
        'url': 'https://github.com/iqtree',
        'repo_name': 'iqtree3',
        'tag': 'v%(version)s',
        'recursive': True,
    }
}]
checksums = ['4395c7dd7e5b8443a0a4352896c08be7419ae3335660554297d28d586af84774']

builddependencies = [
    ('CMake', '3.29.3'),
    ('Eigen', '3.4.0'),
]
dependencies = [
    ('zlib', '1.3.1'),
    ('Boost', '1.85.0'),
    ('LSD2', '2.4.1'),
]

local_conf_opts = ' -DUSE_LSD2=ON '

configopts = [
    '-DIQTREE_FLAGS=omp' + local_conf_opts,
    '-DIQTREE_FLAGS=mpi -DCMAKE_C_COMPILER="$MPICC" -DCMAKE_CXX_COMPILER="$MPICXX"' + local_conf_opts,
]

sanity_check_paths = {
    'files': ['bin/iqtree3', 'bin/iqtree3-mpi'],
    'dirs': [],
}

sanity_check_commands = [
    "iqtree3 --help",
    "mkdir -p $TMPDIR/{test-omp,test-mpi}",
    "cd $TMPDIR/test-omp && cp -a %(installdir)s/example.phy . && iqtree3 -s example.phy -redo",
    "cd $TMPDIR/test-mpi && cp -a %(installdir)s/example.phy . && mpirun -np 1 iqtree3-mpi -s example.phy -redo",
]

moduleclass = 'bio'
