# Updated to v2.1.3 by
# R.QIAO <rob.qiao@flinders.edu.au>
# DeepThought, Flinders University
# Update: Petr Kr√°l (INUITS)

easyblock = 'CMakeMake'

name = 'IQ-TREE'
version = '2.3.6'

# HTTPS is not working
homepage = 'http://www.iqtree.org/'
description = """Efficient phylogenomic software by maximum likelihood"""

toolchain = {'name': 'gompi', 'version': '2023b'}
# Including 'usempi' will take precedence and override IQTREE_FLAGS and produces only 'iqtree-mpi' binary

source_urls = ['https://github.com/iqtree/iqtree2/archive/refs/tags/']
sources = ['v%(version)s.tar.gz']
patches = [
    'IQ-TREE-2.3.5_use_EB_LSD2.patch',
    'IQ-TREE-2.3.6_riscv_avoid_msse3.patch',
]
checksums = [
    {'v2.3.6.tar.gz': '2d389ea74e19773496363cd68270b341ac7cc47c60e7f32859682403b34744cf'},
    {'IQ-TREE-2.3.5_use_EB_LSD2.patch': 'b4578b01f06ae52b94b332622c0f6630497cd29cb61010f58f7c5018c2c32a5f'},
    {'IQ-TREE-2.3.6_riscv_avoid_msse3.patch': '71a2c977c046bc93256e96d725bfd982d9f9f43e4fcfca454b80eee9852d0ce0'},
]

builddependencies = [
    ('CMake', '3.27.6'),
    ('Eigen', '3.4.0'),
]
dependencies = [
    ('zlib', '1.2.13'),
    ('Boost', '1.83.0'),
    ('LSD2', '2.4.1'),
]

_iqt_flags = []
if ARCH == 'riscv64':
    _iqt_flags.append('nosse')

_omp_flags = ','.join(['omp'] + _iqt_flags)
_mpi_flags = ','.join(['mpi'] + _iqt_flags)

local_conf_opts = ' -DUSE_LSD2=ON '
configopts = [
    ' '.join([
        f'-DIQTREE_FLAGS={_omp_flags}',
        local_conf_opts
    ]),
    ' '.join([
        f'-DIQTREE_FLAGS={_mpi_flags}',
        '-DCMAKE_C_COMPILER="$MPICC"',
        '-DCMAKE_CXX_COMPILER="$MPICXX"',
        local_conf_opts
    ]),
]

sanity_check_paths = {
    'files': ['bin/iqtree2', 'bin/iqtree2-mpi'],
    'dirs': [],
}

sanity_check_commands = [
    "iqtree2 --help",
    "mkdir -p $TMPDIR/{test-omp,test-mpi}",
    "cd $TMPDIR/test-omp && cp -a %(installdir)s/example.phy . && iqtree2 -s example.phy -redo",
    "cd $TMPDIR/test-mpi && cp -a %(installdir)s/example.phy . && mpirun -np 1 iqtree2-mpi -s example.phy -redo",
]

moduleclass = 'bio'
