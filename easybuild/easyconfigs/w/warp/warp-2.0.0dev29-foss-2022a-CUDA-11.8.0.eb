# Thomas Hoffmann, EMBL Heidelberg,  structures-it@embl.de, 2024/09
easyblock = 'CMakeMake'

name = 'warp'
local_ver = '2.0.0dev29'
version = local_ver
local_cudasuffix = '-CUDA-%(cudaver)s'
# versionsuffix = '%s-debug' % local_cudasuffix  # for debug build see local_configopts->DOTNET_POPTS
versionsuffix = '%s' % local_cudasuffix

local_dotnet_arch = 'x64'


homepage = 'https://github.com/warpem/warp'
description = """Warp is a set of tools for cryo-EM and cryo-ET data processing including, among 
other tools: Warp, M, WarpTools, MTools, MCore, and Noise2Map."""

# stick to CUDA 11.x and therefore GCC < 12 due to use of cudaBindTexture2D in 
# NativeAcceleration/gtom/src/Masking/IrregularSphereMask.cu
toolchain = {'name': 'foss', 'version': '2022a'}
toolchainopts = {'pic': True, 'cstd': 'c++17', 'usempi': True}

github_account = 'warpem'
source_urls = [GITHUB_SOURCE]
sources = ['v%(version)s.tar.gz']
patches = [
    ('warp-2.0.0dev0_cmake.patch', 1),
    'warp-2.0.0dev0_inject_cudacc.patch',
]
checksums = [
    {'v2.0.0dev29.tar.gz': 'c014ec970483c02590f08278de28483f7bffec098883e1cc500393cc3f1bce86'},
    {'warp-2.0.0dev0_cmake.patch': 'd40152f787bde4f527c299d3af026ed5b7ad77f3431fa97446fa22a02b0d2971'},
    {'warp-2.0.0dev0_inject_cudacc.patch': '6a1ab6b3b6760dccb327c2e98f3188b16abc5aa31f2d6484838a39a3452eb86c'},
]

builddependencies = [
    ('CMake', '3.24.3'),
    ('dotNET-SDK', '8.0.204', '-linux-%s' % (local_dotnet_arch), SYSTEM)
]

dependencies = [
    # stick to CUDA 11.x and therefore GCC < 12 due to use of cudaBindTexture2D in 
    # NativeAcceleration/gtom/src/Masking/IrregularSphereMask.cu
    # Use CUDA 11.8 due to https://github.com/pytorch/pytorch/issues/88038
    ('CUDA', '11.8.0', '', SYSTEM),
    ('cuDNN', '8.7.0.84', local_cudasuffix, SYSTEM),
    ('Python', '3.10.4'),
    ('PyTorch', '2.0.1', local_cudasuffix),
    ('LibTIFF', '4.3.0'),
    ('torchvision', '0.15.2', local_cudasuffix),
    ('AreTomo2', '1.0.0', local_cudasuffix),
    # ('IMOD', '4.12.21', local_cudasuffix),  # optional (4.12.62 does not work)
]

local_binaries = [
    'Frankenmap', 'MCore', 'MrcConverter', 'MTools', 'Noise2Half',
    'Noise2Map', 'Noise2Mic', 'Noise2Tomo', 'WarpTools', 'WarpWorker'
]

local_configopts = [
    "-DCMAKE_CUDA_ARCHITECTURES='%(cuda_cc_cmake)s'",
    "-DCUDA_ARCHS='%(cuda_cc_cmake)s'",
    '-DDOTNET_RT=linux-%s' % local_dotnet_arch,
    '-DCMAKE_EXPORT_COMPILE_COMMANDS=ON',
    '-DCUDA_VERBOSE_BUILD=ON',
    '-DCAFFE2_USE_CUDNN=1'
    '-DDOTNET_BINARIES="%s"' % " ".join(local_binaries),
    #  '-DDOTNET_POPTS="-p:PublishSingleFile=true"'  # uncomment for debug build
]
configopts = ' '.join(local_configopts)

postinstallcmds = ['cp %(builddir)s/*/bin/*.pdb %(installdir)s/bin']

build_type = ''

sanity_check_paths = {
    'files': ['lib/libSkiaSharp.%s' % SHLIB_EXT, 'bin/MCore.pdb'],
    'dirs': ['bin', 'lib'],
}

sanity_check_commands = [
    # '%s --help' % x for x in local_binaries  
    'WarpTools --help'
]

modextravars = {
    'RELION_EXTERNAL_RECONSTRUCT_EXECUTABLE': '$(which Noise2Half)',
}

moduleclass = 'bio'
