# Author: J. Sa√ümannshausen (Imperial College London/UK)

easyblock = 'ConfigureMake'

name = 'fluidity'
version = '4.1.20'

homepage = 'https://github.com/FluidityProject'
description = """
The Fluidity Project develops an open source, general purpose, multi-phase
computational fluid dynamics code.
"""

toolchain = {'name': 'foss', 'version': '2024a'}

source_urls = ['https://github.com/FluidityProject/fluidity/archive']
sources = [f'{version}.tar.gz']
patches = ['fluidity-4.1.20_compatibility.patch']
checksums = [
    {'4.1.20.tar.gz': '8b2879be548fab97b94de1ccebf1f3bfa966c06ed8364e457f5ab3e8b3b99792'},
    {'fluidity-4.1.20_compatibility.patch': '27112f37af8272d9e9d4c57b0b517606c0ccba631f2f53790c4fe485ebeee613'},
]

builddependencies = [
    ('binutils', '2.42'),
    ('make', '4.4.1'),
    ('Autotools', '20231222'),
    ('Eigen', '3.4.0'),
]

dependencies = [
    ('Trilinos', '16.1.0', '-zoltan'),
    ('gmsh', '4.14.0'),
    ('libsupermesh', '2025.4'),
    ('Judy', '1.0.5'),
    ('VTK', '9.3.1'),
    ('PETSc', '3.23.5'),
    ('METIS', '5.1.0'),
    ('Python', '3.12.3'),
    ('Python-bundle-PyPI', '2024.06'),
    ('pybind11', '2.12.0'),
    ('SciPy-bundle', '2024.05'),
    ('Boost', '1.85.0'),
    ('HDF5', '1.14.5'),
    ('netCDF-Fortran', '4.6.1'),
    ('netCDF', '4.9.2'),
    ('Rtree', '1.4.0'),
]

# We need to expand some environment variables:
_local_fcflags = '-I$EBROOTPETSC/include -I$EBROOTVTK/include/vtk-9.3 '
_local_fcflags += '-I$EBROOTNETCDFMINFORTRAN/include -I$EBROOTLIBSUPERMESH/include -I$EBROOTTRILINOS/include'
_local_ldflags = '-L$EBROOTFFTW/lib -L$EBROOTSCALAPACK/lib -L$EBROOTSCALAPACK/lib '
_local_ldflags += '-L$EBROOTGCCCORE/lib64 -L$EBROOTGCCCORE/lib'
pre_configure_opts = 'LIBS="-lm -lpthread -lpetsc -lflexiblas -lmpi_mpifh -lzoltan" '
pre_configure_opts += f'FCFLAGS="$FCFLAGS {_local_fcflags}" '
pre_configure_opts += f'LDFLAGS="{_local_ldflags}" '

configure_opts = '--with-blas=flexiblas --with-lapack=flexiblas --enable-shared '
configure_opts += '--with-judy=Judy --enable-2d-adaptivity --enable-libsupermesh '
configure_opts += '-enable-mba3d --with-spatialindex-root=$EBROOTLIBSPATIALINDEX '

# This does currently not work as expected
# pretestopts = 'PRTE_MCA_rmaps_default_mapping_policy=:oversubscribe '
# runtest = 'test serialtest '

post_install_cmds = ['cp -r tests/ %(installdir)s/ && cp -r tools/ %(installdir)s/ ']

sanity_check_paths = {
    'files': ['bin/%(namelower)s'],
    'dirs': ['share'],
}

sanity_check_commands = [
    "%(namelower)s -V",
]

moduleclass = 'geo'
