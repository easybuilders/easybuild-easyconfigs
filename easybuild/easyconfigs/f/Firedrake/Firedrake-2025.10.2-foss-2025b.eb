# Author: J. Saßmannshausen (Imperial College London/UK)
# and Pavel Tomanek (INUITS developer)

easyblock = 'PythonBundle'

name = 'Firedrake'
version = '2025.10.2'

homepage = 'https://www.firedrakeproject.org'
description = """
Firedrake is an automated system for the solution of partial differential
equations using the finite element method (FEM). Firedrake uses sophisticated
code generation to provide mathematicians, scientists, and engineers with a
very high productivity way to create sophisticated high performance
simulations.
"""

citing = """

  title        = Firedrake User Manual
  author       = David A. Ham and Paul H. J. Kelly and Lawrence Mitchell and
                 Colin J. Cotter and Robert C. Kirby and Koki Sagiyama and
                 Nacime Bouziani and Sophia Vorderwuelbecke and
                 Thomas J. Gregory and Jack Betteridge and Daniel R. Shapero
                 and Reuben W. Nixon-Hill and Connor J. Ward and
                 Patrick E. Farrell and Pablo D. Brubeck and India Marsden
                 and Thomas H. Gibson and Miklós Homolya and Tianjiao Sun and
                 Andrew T. T. McRae and Fabio Luporini and Alastair Gregory
                 and Michael Lange and Simon W. Funke and Florian Rather
                 and Gheorghe-Teodor Bercea and Graham R. Markall
  organization = Imperial College London and University of Oxford and Baylor University and University of Washington
  edition      = First edition
  year         = 2023
  month        = 5
  doi          = 10.25561/104839
"""

toolchain = {'name': 'foss', 'version': '2025b'}

builddependencies = [
    ('pybind11', '3.0.0'),
    ('scikit-build-core', '0.11.5'),
    ('Cython', '3.1.2'),
    ('CMake', '4.0.3'),
    ('hatchling', '1.27.0'),
    ('setuptools', '80.10.1'),
    ('meson-python', '0.18.0'),
]

dependencies = [
    ('Python', '3.13.5'),
    ('SciPy-bundle', '2025.07'),
    ('Python-bundle-PyPI', '2025.07'),
    ('sympy', '1.14.0'),
    ('gmpy2', '2.2.0'),
    ('FEniCS-UFL', '2025.2.0'),
    ('typing-extensions', '4.14.1'),
    ('Mako', '1.3.10'),
    ('h5py', '3.14.0'),
    ('SLEPc', '3.24.0'),
    ('slepc4py', '3.24.0'),
    ('petsc4py', '3.24.0'),
    ('PETSc', '3.24.0'),
    ('PnetCDF', '1.14.1'),
    ('netCDF', '4.9.3'),
    ('HDF5', '1.14.6'),
    ('libspatialindex', '2.1.0'),
    ('poetry', '2.1.3'),
    ('nanobind', '2.9.2'),
    ('SymEngine', '0.14.0'),
    ('Rtree', '1.4.1'),
    ('pkgconfig', '1.5.5', '-python'),
]

# This is required for the installation of Firedrake, in particular the -I part of it
local_preinstallopts = 'export CC=mpicc; export CXX=mpicxx; export PETSC_DIR=$EBROOTPETSC; '
local_preinstallopts += 'export PETSC_ARCH=""; export HDF5_MPI=ON; '
local_preinstallopts += 'export CFLAGS="$CFLAGS -I$EBROOTPYTHON/include/python3.13"; '

exts_list = [
    ('petsctools', '2025.3', {
        'checksums': ['5de34fd18f85b56b67d531d3d59e6334fbd030cb3168ca6bf0dc78adb1dd709b'],
    }),
    ('libsupermesh', '2025.4', {
        'checksums': ['91377f4b077cb123380c290d5684f29b7c73ebb5fb3f04eee216657b9045b9e7'],
    }),
    ('cachetools', '6.2.4', {
        'checksums': ['82c5c05585e70b6ba2d3ae09ea60b79548872185d2f24ae1f2709d37299fd607'],
    }),
    ('cgen', '2025.1', {
        'checksums': ['79f01e010d49c13e58b4ca8f2d4996a6b7178968f5f2d906262733480ae7a2d4'],
    }),
    ('checkpoint_schedules', '1.0.4', {
        'checksums': ['aaa9191a6da910fd1b1e0526df2ca7ecea04823fe5106360e3e23d2413dcfeeb'],
    }),
    ('codepy', '2025.1', {
        'checksums': ['ccc8365955050e827368ec0034c74cc3523a5cc60d8aff46a1a5345b769a9b75'],
    }),
    ('constantdict', '2025.3', {
        'source_tmpl': '%(name)s-%(version)s-py3-none-any.whl',
        'checksums': ['a53d66e9604538e269f3168a9a0af3c6a091242d7df0c088fccd5d6a95eb6a24'],
    }),
    ('decorator', '4.4.2', {
        'checksums': ['e3a62f0520172440ca0dcc823749319382e377f37f140a0b99ef45fecb84bfe7'],
    }),
    ('genpy', '2022.1', {
        'checksums': ['14665b4255206c98e7ba20da292fef565ada315985175700424ed2dda3d65f1e'],
    }),
    ('immutabledict', '4.2.2', {
        'checksums': ['cb6ed3090df593148f94cb407d218ca526fd2639694afdb553dc4f50ce6feeca'],
    }),
    ('pcpp', '1.30', {
        'checksums': ['5af9fbce55f136d7931ae915fae03c34030a3b36c496e72d9636cedc8e2543a1'],
    }),
    ('islpy', '2025.2.5', {
        'checksums': ['cfcff7fa20efe50e4b8b518e8e4ce46a4513f7e12ba0b6228fd4f833fe8c6526'],
    }),
    ('loopy', '2025.2', {
        'checksums': ['4bbeebf3a9e37a589a92ac4434d9e60d1382529ff2d4a07a209b1ff51fdd9830'],
    }),
    ('mpi_pytest', '2025.7', {
        'modulename': 'pytest_mpi',
        'checksums': ['a2aba933db13d0d18ca05af1f2cc7c9eed3519c314d587c4ef4d702e1af8cf60'],
    }),
    ('progress', '1.6.1', {
        'checksums': ['c1ba719f862ce885232a759eab47971fe74dfc7bb76ab8a51ef5940bad35086c'],
    }),
    ('pymbolic', '2025.1', {
        'checksums': ['31efa99e1f2a6407d1d7128d356dd625d56d2002d23b3f104da5b9c3fb0a270b'],
    }),
    ('pytools', '2025.2.5', {
        'checksums': ['a7f5350644d46d98ee9c7e67b4b41693308aa0f5e9b188d8f0694b27dc94e3a2'],
    }),
    ('siphash24', '1.8', {
        'checksums': ['aa932f0af4a7335caef772fdaf73a433a32580405c41eb17ff24077944b0aa97'],
    }),
    ('symengine', '0.14.1', {
        'source_tmpl': '%(name)s-%(version)s-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl',
        'checksums': ['4e91af61b854e82ae5382e5f91e66d83ac007c0b19b3946f747bc4fc6ca25d66'],
    }),
    ('recursivenodes', '0.2.0', {
        'checksums': ['306319eccd818fa239e2dcc60bc8d520b1f594167367675b1481256f43861bc3'],
    }),
    ('pyadjoint-ad', '2025.10.1', {
        'modulename': 'pyadjoint',
        'checksums': ['72a7b655c684de6c86d40626608232b0b64c6c48e1c9a4a2407429e561cfef9e'],
    }),
    ('firedrake_fiat', '2025.10.1', {
        'modulename': 'FIAT',
        'checksums': ['70ced629bc339747b98619bc80e0cf11fa01f66e0ee868efbceaecbf031b4278'],
    }),
    ('firedrake', version, {
        'modulename': 'firedrake',
        'patches': ['firedrake-2025.10.2_libspatialindex.patch'],
        'preinstallopts': local_preinstallopts,
        'checksums': [
            {'firedrake-2025.10.2.tar.gz': 'a6d13f9bf6f3fe2b8c7c5f4b26c77b78af0859945081555030a40664ca4f34f5'},
            {'firedrake-2025.10.2_libspatialindex.patch':
             'fb3e69d6f2b0f3600d58bb101f2e376cd694d07271214eec47a0785bc704e0f6'},
        ],
    }),
]

sanity_check_commands = ['firedrake-check']

moduleclass = 'tools'
