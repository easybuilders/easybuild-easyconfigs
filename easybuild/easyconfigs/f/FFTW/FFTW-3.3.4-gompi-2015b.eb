easyblock = 'ConfigureMake'

name = 'FFTW'
version = '3.3.4'

homepage = 'http://www.fftw.org'
description = """FFTW is a C subroutine library for computing the discrete Fourier transform (DFT)
 in one or more dimensions, of arbitrary input size, and of both real and complex data."""

toolchain = {'name': 'gompi', 'version': '2015b'}
toolchainopts = {'optarch': True, 'pic': True}

sources = [SOURCELOWER_TAR_GZ]
source_urls = [homepage]

preconfigopts = """
    grep sse2 /proc/cpuinfo >& /dev/null
    if [ $? -eq 0 ] ; then 
      echo "Found SSE2"
      CLINE1="--enable-single --enable-sse2 --enable-mpi"
      CLINE2="--enable-long-double --enable-mpi"
      CLINE3="--enable-quad-precision"
      CLINE4="--enable-sse2 --enable-mpi"
    else
      grep altivec /proc/cpuinfo >& /dev/null
      if [ $? -eq 0 ] ; then 
        echo "Found Altivec"
        CLINE1="--enable-mpi"
        CLINE2="--enable-single --enable-mpi"
        CLINE3="--enable-long-double --enable-mpi"
        CLINE4="--enable-single --enable-altivec --enable-mpi"
      else
        echo "Unknown vector processor"
        CLINE1=""
        CLINE2="--enable-mpi"
        CLINE3="--enable-single --enable-mpi"
        CLINE4="--enable-long-double --enable-mpi"
      fi
    fi
"""

common_configopts = "--enable-threads --enable-openmp --with-pic"
configopts = [
    common_configopts + " $CLINE1",
    common_configopts + " $CLINE2",
    common_configopts + " $CLINE3",
    common_configopts + " $CLINE4",  # default as last
]

sanity_check_paths = {
    'files': ['bin/fftw%s' % x for x in ['-wisdom', '-wisdom-to-conf', 'f-wisdom', 'l-wisdom']] +
             ['include/fftw3%s' % x for x in ['-mpi.f03', '-mpi.h', '.f', '.f03',
                                              '.h', 'l-mpi.f03', 'l.f03']] +
             ['lib/libfftw3%s%s.a' % (x, y) for x in ['', 'f', 'l'] for y in ['', '_mpi', '_omp', '_threads']],
    'dirs': ['lib/pkgconfig'],
}

moduleclass = 'numlib'

