easyblock = 'ConfigureMake'

name = 'FreeImage'
version = '3.18.0'

homepage = 'http://freeimage.sourceforge.net'
description = """FreeImage is an Open Source library project for developers who would like to support popular graphics
image formats like PNG, BMP, JPEG, TIFF and others as needed by today's multimedia applications. FreeImage is easy to
use, fast, multithreading safe."""

toolchain = {'name': 'GCCcore', 'version': '12.2.0'}
toolchainopts = {'cstd': 'c++14', 'pic': True}

source_urls = [SOURCEFORGE_SOURCE]
sources = [{
    'filename': '%(name)s3180.zip',
    # remove carriage return characters before applying the patches, otherwise they may fail
    'extract_cmd': 'unzip -qq %s && find . -type f -print0 | xargs -0 sed -i "s/\\r$//g"',
}]
patches = [
    'FreeImage-3.18.0_unbundle.patch',
    'FreeImage-3.18.0_fix-CVE-2019-12211-CVE-2019-12213.patch',
    'FreeImage-3.18.0_use_LibTIFF_4.4.0.patch',
]
checksums = [
    {'FreeImage3180.zip': 'f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd'},
    {'FreeImage-3.18.0_unbundle.patch': '9d0bdf9a197a9f779bb56440dec11b3beaa29bf404f051a7923239bc0f11b58f'},
    {'FreeImage-3.18.0_fix-CVE-2019-12211-CVE-2019-12213.patch':
     'aa417916dc29455c2a4bb9e71d4e2e543d1fe28d57c921998ef3dc84a427953e'},
    {'FreeImage-3.18.0_use_LibTIFF_4.4.0.patch': '85a8e1c814306d121ddcb902918b67609f4e4f667d8d8cb4430beb0e57b6eca9'},
]

builddependencies = [('binutils', '2.39')]

dependencies = [
    ('zlib', '1.2.12'),
    ('Imath', '3.1.6'),
    ('libjpeg-turbo', '2.1.4'),
    ('OpenJPEG', '2.5.0'),
    ('OpenEXR', '3.1.5'),
    ('LibTIFF', '4.4.0'),
    ('libwebp', '1.3.1'),
    ('LibRaw', '0.21.3'),
    ('jxrlib', '1.1'),
]

skipsteps = ['configure']

prebuildopts = "cp ./Source/LibJPEG/{transupp.h,jinclude.h} ./Source/ && "
prebuildopts += "cp ./Source/LibTIFF4/{tiffiop,tif_dir}.h ./Source/ && "
prebuildopts += "rm -rf Source/{LibPNG,LibOpenJPEG,ZLib,OpenEXR,LibRawLite,LibTIFF4,LibJPEG,LibWebP,LibJXR} && "
prebuildopts += "sh ./gensrclist.sh && sh ./genfipsrclist.sh && "

buildopts = ['-f Makefile.gnu', '-f Makefile.fip']

installopts = [
    "-f Makefile.gnu INCDIR=%(installdir)s/include INSTALLDIR=%(installdir)s/lib",
    "-f Makefile.fip INCDIR=%(installdir)s/include INSTALLDIR=%(installdir)s/lib",
]

_incs = ['include/FreeImage%s.h' % x for x in ['', 'Plus']]
_libs = ['lib/libfreeimage%s.%s' % (x, y) for x in ['', 'plus'] for y in ['a', SHLIB_EXT]]

sanity_check_paths = {
    'files': _incs + _libs,
    'dirs': [],
}

moduleclass = 'vis'
