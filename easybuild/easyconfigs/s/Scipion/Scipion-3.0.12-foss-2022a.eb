easyblock = 'PythonBundle'

name = 'Scipion'
version = '3.0.12'

homepage = 'https://scipion-em.github.io/docs/release-3.0.0/index.html'
description = """Scipion is an image processing framework to obtain 3D
models of macromolecular complexes using Electron Microscopy (3DEM). It
integrates several software packages and presents an unified interface
for both biologists and developers. Scipion allows to execute workflows
combining different software tools, while taking care of formats and
conversions. Additionally, all steps are tracked and can be reproduced
later on. 
"""

toolchain = {'name': 'foss', 'version': '2022a'}

builddependencies = [
    ('SCons', '4.4.0'),
]

dependencies = [
    ('Python', '3.10.4'),
    ('Tcl', '8.6.12'),
    ('Tk', '8.6.12'),
    ('zlib', '1.2.12'),
    ('Java', '11', '', SYSTEM),
    ('libxml2', '2.9.13'),
    ('libreadline', '8.1.2'),
    ('libxslt', '1.1.34'),
    ('GSL', '2.7'),
    ('freetype', '2.12.1'),
    ('OpenCV', '4.6.0', '-contrib'),
    ('libpng', '1.6.37'),
    ('libjpeg-turbo', '2.1.3'),
    ('LibTIFF', '4.3.0'),
    ('HDF5', '1.12.2'),
    ('SQLite', '3.38.3'),
    ('scikit-learn', '1.1.2'),
    ('Xmipp', '3.22.07-Helios'),

    # Python modules
    ('matplotlib', '3.5.2'),
    # Requires Biopython < 1.78 due to the use of Bio.Alphabet
    # put in extension list
    # ('Biopython', '1.79'),
    ('bibtexparser', '1.4.0'),
    ('Pillow', '9.1.1'),

    # EM packages
    ('ctffind', '4.1.14'),
    # ('RELION', '3.0.7'),
    # ('EMAN2', '2.91'),
    ('MotionCor2', '1.5.0'),
    ('Gctf', '1.06', '', SYSTEM),
]

use_pip = True
sanity_pip_check = True

exts_default_options = {'source_urls': [PYPI_SOURCE]}

# scipion-em-xxx plugins are python modules
exts_list = [
    ('biopython', '1.76', {
        'modulename': 'Bio',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['3873cb98dad5e28d5e3f2215a012565345a398d3d2c4eebf7cd701757b828c72'],
    }),
    ('tkcolorpicker', '2.1.3', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['2933f9781ced0a2b4d31f462dfd6883292a2a72c4dcb4f460026455a7644de99'],
    }),
    ('tifffile', '2022.10.10', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['50b61ba943b866d191295bc38a00191c9fdab23ece063544c7f1a264e3f6aa8e'],
    }),
    ('configparser', '5.0.2', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['85d5de102cfe6d14a5172676f09d19c465ce63d6019cf0a4ef13385fc535e828'],
    }),
    ('emtable', '0.0.14', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['e531cdfb0fe38c9b81ef2cb71503b69a64309652044538f1f1853b43ed52840f'],
    }),
    ('peppercorn', '0.6', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['96d7681d7a04545cfbaf2c6fb66de67b29cfc42421aa263e4c78f2cbb85be4c6'],
    }),
    ('webcolors', '1.12', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['16d043d3a08fd6a1b1b7e3e9e62640d09790dce80d2bdd4792a175b35fe794a9'],
    }),
    ('tikzplotlib', '0.10.1', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['93d141342d143804fc1dfabe03e6d4e38e547cf72803bdf124615affdd56f59d'],
    }),
    ('plotter', '1.3.19', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['3458a72b4fecbfcd41e4b93420acdfd71e74e1a3e8f421ad77ce35222cba778b'],
    }),
    ('PyWavelets', '1.4.1', {
        'modulename': 'pywt',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['6437af3ddf083118c26d8f97ab43b0724b956c9f958e9ea788659f6a2834ba93'],
    }),
    ('littleutils', '0.2.2', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['e6cae3a4203e530d51c9667ed310ffe3b1948f2876e3d69605b3de4b7d96916f'],
    }),
    ('outdated', '0.2.2', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['4b7fdec88e36711120d096d485fc4d5035e4e5ffbd907cf3a6ce2af43058b970'],
    }),
    ('scipion-pyworkflow', '3.0.27', {
        'modulename': 'pyworkflow',
        'patches': [
            '%(name)s-%(version)s_relax_version_requirements.patch',
        ],
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': [
            {'scipion-pyworkflow-3.0.27.tar.gz': '04fa4621559ba9c31828a78810c4000762d799f1acbf606039437d7040dffbd6'},
            {'scipion-pyworkflow-3.0.27_relax_version_requirements.patch':
             '21ff70be7ff99ad23d36873768c234c48d6df8485185ba269e978f802ecfadaf'},
        ],
    }),
    ('scipion-em', '3.0.23', {
        'modulename': 'pwem',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['bbcbbf2d5d234d2319dd97fc9d6e6d447b708a10a4e28e6a16368d9032957a87'],
    }),
    ('scipion-app', version, {
        'modulename': 'scipion',
        'patches': ['%(name)s-%(version)s_relax_version_requirements.patch'],
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': [
            {'scipion-app-3.0.12.tar.gz': '562dfa74abc3a7b13f7ef5b9c401b4b16c8c1bd653f6a80ddb14bc8f248eedc2'},
            {'scipion-app-3.0.12_relax_version_requirements.patch':
             'c8d053157dcb3cc0a4cc40dd8ed524b44a26a5ca0c6cdd8119f152664891ac5f'},
        ],
    }),
    ('scipion-em-xmipp', '22.7.0', {
        'modulename': 'xmipp3',
        'patches': ['%(name)s-%(version)s_relax_version_requirements.patch'],
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': [
            {'scipion-em-xmipp-22.7.0.tar.gz': 'ac30eab918d4d840492ba007f224b5a25909329cff6d8d4eef5e3ca30d1f4ac1'},
            {'scipion-em-xmipp-22.7.0_relax_version_requirements.patch':
             '0b502fb60dc117fc7aa549fee182ca56cc75cc275e5cfb2a347252b5c98aa050'},
        ],
    }),
    ('scipion-em-gctf', '3.1.1', {
        'modulename': 'gctf',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['9e7e32b5716b28f557ca9dc01b5963d8b0f527a5d20ed0f679129ea37b2c5265'],
    }),
]

# Scipion uses TkAgg, make sure matplotlib uses that instead of its default Agg
modextravars = {
    'SCIPION_HOME': '%(installdir)s',
    'MPLBACKEND': 'TkAgg',
}

moduleclass = 'bio'
