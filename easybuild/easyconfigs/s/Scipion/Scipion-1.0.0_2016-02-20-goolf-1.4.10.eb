# This file is an EasyBuild reciPY as per https://github.com/hpcugent/easybuild
# Author: Pablo Escobar Lopez
# sciCORE - University of Basel
# SIB Swiss Institute of Bioinformatics 

easyblock = 'Tarball'

name = 'Scipion'
version = '1.0.0_2016-02-20'

homepage = 'http://scipion.cnb.csic.es/'
description = """Scipion is an image processing framework to obtain 3D models
 of macromolecular complexes using Electron Microscopy"""

toolchain = {'name': 'goolf', 'version': '1.4.10'}

source_urls = ['http://scipion.cnb.csic.es/m/static/install/']
sources = ['scipion_v%(version)s_source.tgz']

# first patch modifies file config/templates/scipion.template to hardcode paths to our openmpi and Java installations at scicore
# second patch modifies the build script so LD_LIBRARY_PATH is not overwritten during build
# https://github.com/I2PC/scipion/pull/363 
patches = ['scipion_v%(version)s_openmpi_goolf_1.4.10_paths.patch', 'scipion_v%(version)s_dont_overwrite_ld_library_path.patch']

unpack_options = '--strip-components=1'

dependencies = [
    ('CMake', '2.8.12'),
    ('Java', '1.7.0_80', '', True),  
    ('GSL', '1.16'),  
]

# first postinstall cmd uncompress a tarball manually generated by Pablo which contains all the dependencies that scipion downloads during a normal installation
# To generate this tarball do a manuall installation and then create a tarball will the .tgz files downloaded in scipion_install_dir/software/tmp and scipion_install_dir/software/em
# This is required so scipion can be installed without internet access. This is the content of the manually generated tarball https://gist.github.com/5d64e4c7b7521d3bfc9a
# You can also remove first postinstallcmds and all the dependencies should be downloaded for you to the install directory
postinstallcmds = ["cd %(installdir)s/software/ && tar xf /export/soft/source/s/Scipion/scipion-v1.0.0_2016-02-20-dependencies.tar.gz",
                   "cd %(installdir)s && ./scipion config ",
                   "cd %(installdir)s && ./scipion install -j 8 ",
                   "cd %(installdir)s && ./scipion  install -j 8 bsoft-1.8.8 bsoft-1.9.0 chimera cryoem ctffind ctffind4 dogpicker eman2.11 eman2.12 frealign gEMpicker_v1.1 motioncorr nma relion-1.3 relion-1.4 relion-1.4_float resmap simple spider summovie unblur"]

sanity_check_paths = {
    'files': ['scipion'],
    'dirs': []
}

modextrapaths = {
       'PATH': "", # add the installation dir to PATH
       'LD_LIBRARY_PATH': 'software/lib',
       'PYTHONPATH': 'software/lib/python2.7/site-packages/',
}

modextravars = {
    'SCIPION_CONFIG':'\$EBROOTSCIPION/config/scipion.conf',
}

moduleclass = 'bio'
