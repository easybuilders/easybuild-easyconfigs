#
easyblock = 'PythonBundle'

name = 'Scipion'
version = '3.1.0'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://scipion-em.github.io/docs/release-3.0.0/index.html'
description = """Scipion is an image processing framework to obtain 3D
models of macromolecular complexes using Electron Microscopy (3DEM). It
integrates several software packages and presents an unified interface
for both biologists and developers. Scipion allows to execute workflows
combining different software tools, while taking care of formats and
conversions. Additionally, all steps are tracked and can be reproduced
later on. 
"""

toolchain = {'name': 'foss', 'version': '2021a'}

builddependencies = [
    ('SCons', '4.1.0.post1'),
]

dependencies = [
    ('Python', '3.9.5'),
    ('CUDA', '11.3.1', '', True),
    ('Tcl', '8.6.11'),
    ('Tk', '8.6.11'),
    ('zlib', '1.2.11'),
    ('Java', '11', '', True),
    ('libxml2', '2.9.10'),
    ('libreadline', '8.1'),
    ('libxslt', '1.1.34'),
    ('GSL', '2.7'),
    ('freetype', '2.10.4'),
    ('OpenCV', '4.5.3', versionsuffix + '-contrib'),
    ('libpng', '1.6.37'),
    ('libjpeg-turbo', '2.0.6'),
    ('LibTIFF', '4.2.0'),
    ('HDF5', '1.10.7'),
    ('SQLite', '3.35.4'),
    ('scikit-learn', '0.24.2'),
    ('h5py', '3.2.1'),
    ('scikit-image', '0.18.3'),
    ('Seaborn', '0.11.2'),
    ('Xmipp', '3.22.07-Helios', versionsuffix),  # Need to build

    # Python modules
    ('matplotlib', '3.4.2'),
    # Requires Biopython < 1.78 due to the use of Bio.Alphabet
    # put in extension list
    # ('Biopython', '1.79'),
    ('bibtexparser', '1.4.0'),
    ('Pillow', '8.2.0'),

    # EM packages
    ('ctffind', '4.1.14', versionsuffix),
    ('RELION', '4.0.0', versionsuffix),
    # ('EMAN2', '2.91'), # Need to build
    ('MotionCor2', '1.4.7', versionsuffix),  # CUDA version need non cuda
    # ('Gctf', '1.06', '', SYSTEM), # Cannot build only works with CUDA 8 at the latest
]

use_pip = True
sanity_pip_check = True

# scipion-em-xxx plugins are python modules
exts_list = [
    ('biopython', '1.76', {
        'modulename': 'Bio',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['3873cb98dad5e28d5e3f2215a012565345a398d3d2c4eebf7cd701757b828c72'],
    }),
    ('tkcolorpicker', '2.1.3', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['2933f9781ced0a2b4d31f462dfd6883292a2a72c4dcb4f460026455a7644de99'],
    }),
    ('tifffile', '2022.10.10', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['50b61ba943b866d191295bc38a00191c9fdab23ece063544c7f1a264e3f6aa8e'],
    }),
    ('configparser', '5.0.2', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['85d5de102cfe6d14a5172676f09d19c465ce63d6019cf0a4ef13385fc535e828'],
    }),
    ('emtable', '0.0.14', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['e531cdfb0fe38c9b81ef2cb71503b69a64309652044538f1f1853b43ed52840f'],
    }),
    ('peppercorn', '0.6', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['96d7681d7a04545cfbaf2c6fb66de67b29cfc42421aa263e4c78f2cbb85be4c6'],
    }),
    ('webcolors', '1.12', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['16d043d3a08fd6a1b1b7e3e9e62640d09790dce80d2bdd4792a175b35fe794a9'],
    }),
    ('tikzplotlib', '0.10.1', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['93d141342d143804fc1dfabe03e6d4e38e547cf72803bdf124615affdd56f59d'],
    }),
    ('plotter', '1.3.19', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['3458a72b4fecbfcd41e4b93420acdfd71e74e1a3e8f421ad77ce35222cba778b'],
    }),
    ('PyWavelets', '1.4.1', {
        'modulename': 'pywt',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['6437af3ddf083118c26d8f97ab43b0724b956c9f958e9ea788659f6a2834ba93'],
    }),
    ('littleutils', '0.2.2', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['e6cae3a4203e530d51c9667ed310ffe3b1948f2876e3d69605b3de4b7d96916f'],
    }),
    ('outdated', '0.2.2', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['4b7fdec88e36711120d096d485fc4d5035e4e5ffbd907cf3a6ce2af43058b970'],
    }),
    ('dill', '0.3.6', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['e5db55f3687856d8fbdab002ed78544e1c4559a130302693d839dfe8f93f2373'],
    }),
    ('multiprocess', '0.70.14', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['3eddafc12f2260d27ae03fe6069b12570ab4764ab59a75e81624fac453fbf46a'],
    }),
    ('pox', '0.3.2', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['e825225297638d6e3d49415f8cfb65407a5d15e56f2fb7fe9d9b9e3050c65ee1'],
    }),
    ('ppft', '1.7.6.7', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['ab34436814e2f18238f35688fd869b2641b2d2d8dca22b8d246f6701dfc954c8'],
    }),
    ('pathos', '0.3.0', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['24fa8db51fbd9284da8e191794097c4bb2aa3fce411090e57af6385e61b97e09'],
    }),
    ('scikit-learn', '0.22', {
        'modulename': 'sklearn',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['314abf60c073c48a1e95feaae9f3ca47a2139bd77cebb5b877c23a45c9e03012'],
    }),
    ('seaborn', '0.12.2', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['374645f36509d0dcab895cba5b47daf0586f77bfe3b36c97c607db7da5be0139'],
    }),
    ('scipion-pyworkflow', '3.0.27', {
        'modulename': 'pyworkflow',
        'patches': ['scipion-pyworkflow-3.0.27_relax_version_requirements.patch'],
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': [
            '04fa4621559ba9c31828a78810c4000762d799f1acbf606039437d7040dffbd6',  # scipion-pyworkflow-3.0.27.tar.gz
            # scipion-pyworkflow-3.0.27_relax_version_requirements.patch
            '21ff70be7ff99ad23d36873768c234c48d6df8485185ba269e978f802ecfadaf',
        ],
    }),
    ('scipion-em', '3.0.23', {
        'modulename': 'pwem',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['bbcbbf2d5d234d2319dd97fc9d6e6d447b708a10a4e28e6a16368d9032957a87'],
    }),
    ('scipion-app', version, {
        'modulename': 'scipion',
        'patches': ['scipion-app-%(version)s_relax_version_requirements.patch'],
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': [
            'ee49fdfe4313ee5b0a8482534c1556ab36a1bacc9b57b04a1a688ff2a62df484',  # scipion-app-3.1.0.tar.gz
            # scipion-app-3.1.0_relax_version_requirements.patch
            '2995d7157ca12f84b195063a4264880915c14901cedb0c65e280599016cbd4cd',
        ],
    }),
    ('scipion-em-xmipp', '22.7.0', {
        'modulename': 'xmipp3',
        'patches': ['scipion-em-xmipp-22.7.0_relax_version_requirements.patch'],
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': [
            'ac30eab918d4d840492ba007f224b5a25909329cff6d8d4eef5e3ca30d1f4ac1',  # scipion-em-xmipp-22.7.0.tar.gz
            # scipion-em-xmipp-22.7.0_relax_version_requirements.patch
            '0b502fb60dc117fc7aa549fee182ca56cc75cc275e5cfb2a347252b5c98aa050',
        ],
    }),
    ('scipion-em-gctf', '3.1.1', {
        'modulename': 'gctf',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['9e7e32b5716b28f557ca9dc01b5963d8b0f527a5d20ed0f679129ea37b2c5265'],
    }),
    ('scipion-em-relion', '4.0', {
        'modulename': 'relion',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['1a928a8b750c3b2f85c21e7de848dc5c1aa03fde4cf4f9f3424b894b1d53dab1'],
    }),
    ('scipion-em-motioncorr', '3.9', {
        'modulename': 'motioncorr',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['42e0a5018efa04bb66b518d0677986e2b770e9e64a9e8d9c975251f04ef095bd'],
    }),
    ('threadpoolctl', version, {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['a335baacfaa4400ae1f0d8e3a58d6674d2f8828e3716bb2802c44955ad391380'],
    }),
    ('scipion-em-prody', '3.3.0', {
        'modulename': 'prody2',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['8075cfd4d5d1ee2fc11e9ac89fbafc7db6c6113b71a63bfe55c5ae8a8fce9452'],
    }),
    ('mrcfile', '1.4.3', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['43c358c59ff8f583fc4dc2079a0099028719109ebf92066e388772bab389c5f5'],
    }),
    ('scipion-em-continuousflex', '3.4.2', {
        'modulename': 'continuousflex',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['e47b227eff3a5c94a59c40262cac3a8a97fe23661e2f67cb556b7687e9b7985b'],
    }),
    ('scipion-em-cryodrgn', '3.11', {
        'modulename': 'cryodrgn',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['d2bbb87dfd1503857078038e6db37295c6397d8606581282fec4d8f5f766d0ce'],
    }),
    ('ProDy', '2.4.0', {
        'modulename': 'prody',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['ca760eb8a17d27fdcb06d17e7a09ce2a05e7371a055f69278599dfbd8fd9525f'],
    }),
    ('emfile', '0.3.0', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['d7e9114aac5e2a29db9d77ab669659499c2f8c38ca13a5ff468c39ec89181a9b'],
    }),
    ('morphsnakes', '2.0.1', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['4e946efc436bf309827453fe7487626004e1903ad3e65551265a86d0af1b63e9'],
    }),
    ('starfile', '0.4.12', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['ea2751b6dbb74ba92c89f75fc8c06dae0f708a1d907e07c2394bc4c54ff7727a'],
    }),
    ('xmipp_metadata', '1.0.13', {
#        'modulename': 'xmipp-metadta',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['b9cf15ce53e824fc8beedead3990aacd2539f1dc4c4f3a0879e8db861474c91d'],
    }),
    ('scipion-em-flexutils', version, {
        'modulename': 'flexutils',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['958fb56ae5fa6d2b29a92581195ea9807715644cf293834e5a718acaa4d24109'],
    }),
]

# Scipion uses TkAgg, make sure matplotlib uses that instead of its default Agg
modextravars = {
    'SCIPION_HOME': '%(installdir)s',
    'MPLBACKEND': 'TkAgg',
}

moduleclass = 'bio'
