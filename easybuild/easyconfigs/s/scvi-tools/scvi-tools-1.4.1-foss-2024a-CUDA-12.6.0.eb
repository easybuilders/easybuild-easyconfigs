easyblock = 'PythonBundle'

name = 'scvi-tools'
version = '1.4.1'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://github.com/scverse/scvi-tools'
description = """scvi-tools (single-cell variational inference tools) is a package for probabilistic modeling and
analysis of single-cell omics data, built on top of PyTorch and AnnData."""

toolchain = {'name': 'foss', 'version': '2024a'}

builddependencies = [
    ('hatchling', '1.27.0'),
    ('coverage', '7.9.2'),
    ('captum', '0.8.0', versionsuffix),
]
dependencies = [
    ('CUDA', '12.6.0', '', SYSTEM),
    ('Python', '3.12.3'),
    ('SciPy-bundle', '2024.05'),
    ('PyTorch', '2.7.1', versionsuffix),
    ('PyTorch-Lightning', '2.5.6', versionsuffix),
    ('Lightning', '2.5.6', versionsuffix),
    ('anndata', '0.11.4'),
    ('matplotlib', '3.9.2'),
    ('scikit-learn', '1.5.2'),
    ('tqdm', '4.66.5'),
    ('h5py', '3.12.1'),
    ('pyro-ppl', '1.9.1', versionsuffix),
    ('ml-collections', '1.1.0'),
    ('numba', '0.60.0'),
    ('scanpy', '1.10.4'),
    ('tensorboard', '2.18.0'),
    ('xarray', '2024.11.0'),
]

# avoid srun problem
# https://github.com/easybuilders/easybuild-easyconfigs/pull/25021#issuecomment-3744728157
local_test_command = 'export SLURM_NTASKS_PER_NODE=$SLURM_NTASKS && '
local_test_command += 'pytest -vs tests '
# skip tests required optional dependencies
local_test_command += (
    '--ignore=tests/external/mrvi_jax '
    '--ignore=tests/external/tangram '
    '--ignore=tests/model/test_jaxscvi.py '
    '--ignore=tests/hub '
    '--ignore=tests/criticism '
    '--ignore=tests/external/cytovi '
    '--deselect=tests/data/test_anndata.py::test_anntorchdataset_dask '
    '--deselect tests/model/test_multivi.py::test_multivi_mudata_rna_atac '
)

exts_list = [
    ('packaging', '25.0', {
        'checksums': ['d443872c98d677bf60f6a1f2f8c1cb748e8fe762d2bf9d3148b5599295b0fc4f'],
    }),
    ('pytest_pretty', '1.3.0', {
        'checksums': ['97e9921be40f003e40ae78db078d4a0c1ea42bf73418097b5077970c2cc43bf3'],
    }),
    ('mudata', '0.3.2', {
        'checksums': ['c9b24f2429f369512f38e48599e341e7684abcf769df277e473700d4f1212740'],
    }),
    ('sparse', '0.17.0', {
        'checksums': ['6b1ad51a810c5be40b6f95e28513ec810fe1c785923bd83b2e4839a751df4bf7'],
    }),
    ('docrep', '0.3.2', {
        'checksums': ['ed8a17e201abd829ef8da78a0b6f4d51fb99a4cbd0554adbed3309297f964314'],
    }),
    (name, version, {
        'modulename': 'scvi',
        'runtest': local_test_command,
        'sources': ['scvi_tools-%(version)s.tar.gz'],
        'testinstall': True,
        'checksums': ['ee75eaac665618b9ee6fa466f6353ef68eb33cd3d7e2c77069e743471ca2103a'],
    }),
]

moduleclass = 'bio'
