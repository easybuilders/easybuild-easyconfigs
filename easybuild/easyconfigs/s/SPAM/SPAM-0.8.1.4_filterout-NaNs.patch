Filter out NaNs to prevent CGAL assertion violation in spambind - fix c++17 update
Author: Pavel Tomanek (UGent/Inuits)
--- src/spam/mesh/unstructured.py.orig	2026-01-26 11:20:43.916497000 +0100
+++ src/spam/mesh/unstructured.py	2026-01-26 11:21:56.395518000 +0100
@@ -549,12 +549,32 @@
     weights = weights.astype("<f4")
     alpha = alpha.astype("<f4")
 
+    # Filter out non-finite points (NaN/Inf) before passing to CGAL (spambind).
+    # Keep original indexing by remapping connectivity after triangulation.
+    good = numpy.isfinite(points).all(axis=1)
+    if not numpy.all(good):
+        orig_idx = numpy.where(good)[0].astype("<u4")
+        points_c = points[good]
+        weights_c = weights[good]
+    else:
+        orig_idx = None
+        points_c = points
+        weights_c = weights
+        
+    # Not enough points to form any tetrahedra
+    if points_c.shape[0] < 4:
+        return numpy.zeros((0, 4), dtype="<u4")
+
     # get the number of tetrahedra so we can properly size our connectivityMatrix
-    nTet = countTetrahedraCGAL(points, weights, alpha)
+    nTet = countTetrahedraCGAL(points_c, weights_c, alpha)
     connectivity = numpy.zeros([nTet, 4], dtype="<u4")
 
     # setup the return types and argument types
-    triangulateCGAL(points, weights, connectivity, alpha)
+    triangulateCGAL(points_c, weights_c, connectivity, alpha)
+    
+    # Remap connectivity indices back to the original point indices
+    if orig_idx is not None and connectivity.size:
+        connectivity = orig_idx[connectivity]
 
     return connectivity
 
