From a27a1f49ce92d985e14b8a24fa80d30e5174add2 Mon Sep 17 00:00:00 2001
From: Aleksandar Jelenak <ajelenak@hdfgroup.org>
Date: Sun, 5 May 2024 20:19:35 +0100
Subject: [PATCH] Lock native float16 dtype only if available

---
 h5py/api_types_hdf5.pxd | 2 ++
 h5py/h5i.pyx            | 1 +
 h5py/h5t.pyx            | 5 ++++-
 3 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/h5py/api_types_hdf5.pxd b/h5py/api_types_hdf5.pxd
index ff96b6ed..5da00e32 100644
--- a/h5py/api_types_hdf5.pxd
+++ b/h5py/api_types_hdf5.pxd
@@ -385,6 +385,8 @@ cdef extern from "hdf5.h":
 
 # === H5I - Identifier and reflection interface ===============================
 
+  int H5I_INVALID_HID
+
   IF HDF5_VERSION < VOL_MIN_HDF5_VERSION:
     ctypedef enum H5I_type_t:
       H5I_UNINIT       = -2,  # uninitialized Group
diff --git a/h5py/h5i.pyx b/h5py/h5i.pyx
index 9033d506..075d46f3 100644
--- a/h5py/h5i.pyx
+++ b/h5py/h5i.pyx
@@ -18,6 +18,7 @@ from ._objects import phil, with_phil
 
 # === Public constants and data structures ====================================
 
+INVALID_HID = H5I_INVALID_HID
 BADID       = H5I_BADID
 FILE        = H5I_FILE
 GROUP       = H5I_GROUP
diff --git a/h5py/h5t.pyx b/h5py/h5t.pyx
index 3cc085fd..31220f10 100644
--- a/h5py/h5t.pyx
+++ b/h5py/h5t.pyx
@@ -232,7 +232,10 @@ LDOUBLE_BE.set_order(H5T_ORDER_BE)
 LDOUBLE_BE.lock()
 
 IF HDF5_VERSION > (1, 14, 3):
-    NATIVE_FLOAT16 = lockid(H5T_NATIVE_FLOAT16)
+    if H5T_NATIVE_FLOAT16 != H5I_INVALID_HID:
+        NATIVE_FLOAT16 = lockid(H5T_NATIVE_FLOAT16)
+    else:
+        NATIVE_FLOAT16 = H5I_INVALID_HID
 
 # Unix time types
 UNIX_D32LE = lockid(H5T_UNIX_D32LE)
-- 
2.39.3

