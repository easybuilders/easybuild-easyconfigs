# This easyconfig was created by the BEAR Software team at the University of Birmingham
easyblock = 'Tarball'
name = 'CUDA'
version = '9.2.88-1'
versionsuffix = '-ppc64le'

homepage = 'https://developer.nvidia.com/cuda-toolkit'
description = """CUDA (formerly Compute Unified Device Architecture) is a parallel
 computing platform and programming model created by NVIDIA and implemented by the
 graphics processing units (GPUs) that they produce. CUDA gives developers access
 to the virtual instruction set and memory of the parallel computational elements in CUDA GPUs."""

toolchain = {'name': 'dummy', 'version': 'dummy'}

# Manually create the source tarball like this:
# Install CUDA 9.2.88 on a ppc64le machine (via the RPMS)
# for x in $(rpm -qa |grep cuda); do echo "$x "; done > cuda_rpms
# rpm -ql $(cuda_rpms) > cuda_files
# tar cvzf cuda-9.2.88-1.ppc64le.tar.gz $(cuda_files)
sources = ['cuda-%(version)s.ppc64le.tar.gz']
checksums = ['4a220b07919162c891c0e1b6327057d9775d74b9ba89c995a05600ab9d326d78']

postinstallcmds = [
    # We don't want the nccl libraries that may have been bundled with CUDA. They cause conflicts in PyTorch.
    'cd %(installdir)s && find . -name *nccl* -delete',
    'cd %(installdir)s && mv usr/local/cuda-9.2/* . ',
    'cd %(installdir)s && mv usr/lib64/pkgconfig . ',
    'cd %(installdir)s && rmdir usr/local/cuda-9.2 && rmdir usr/local && rmdir usr/lib64 && rmdir usr',
]

modextrapaths = {
    'LD_LIBRARY_PATH': ('targets/ppc64le-linux/lib', 'extras/CUPTI/lib64'),
    'LIBRARY_PATH': 'lib64'
}

modextravars = {
    'CUDA_HOME': '',
    'CUDA_ROOT': '',
}

sanity_check_paths = {
    'files': ['bin/nvcc', 'bin/ptxas'],
    'dirs': ['include', 'pkgconfig'],
}

moduleclass = 'system'
