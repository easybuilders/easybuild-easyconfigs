# #
# This is a contribution from HPCNow! (http://hpcnow.com)
# Copyright::   HPCNow!
# Authors::     Jordi Blasco <jordi.blasco@hpcnow.com>
# License::     GPL-v3.0
# #

easyblock = 'ConfigureMake'

name = 'CRIU'
version = '3.13'
versionsuffix = '-Python-%(pyver)s'

homepage = 'https://github.com/checkpoint-restore/criu'
description = """Checkpoint/Restore In Userspace (CRIU) is a Linux software which can freeze a running container
(or an individual application) and checkpoint its state to disk. The data saved can be used to restore the 
application and run it exactly as it was during the time of the freeze. Using this functionality, application 
or container live migration, snapshots, remote debugging, and many other things are now possible."""

toolchain = {'name': 'GCC', 'version': '8.3.0'}
toolchainopts = {'pic': True}

builddependencies = [
    ('Autotools', '20180311'),
    ('protobuf', '3.10.0'),
    ('protobuf-c', '1.3.3'),
    ('pkg-config', '0.29.2'),
]

dependencies = [
    ('Python', '3.7.4'),
    ('future', '0.16.0', versionsuffix),
]

github_account = 'checkpoint-restore'
source_urls = [GITHUB_SOURCE]
sources = ['v%(version)s.tar.gz']
patches = ['%(name)s-%(version)s-install-man-fix.patch']
checksums = [
    '1663bed128283384a0b97a83f5c7fd72db66e0700096a7b8f195f47d7eec4157',  # v3.13.tar.gz
    'b607141dfc95a92c265343cf5ac1002a680d426d921e2483bbc0ba5520db0a73',  # CRIU-v3.13-install-man-fix.patch
]

osdependencies = [
    ('libbsd-dev', 'libbsd-devel'),
    ('libcap-devel', 'libcap-dev'),
    ('libnet-devel', 'libnet1-dev'),
    ('libnl3-devel', 'libnl-3-dev'),
    ('libaio-devel', 'libaio-dev'),
]

# No configure
skipsteps = ['configure']

prebuildopts = 'ln -sf $EBROOTPROTOBUF/include/google/protobuf/descriptor.proto images/google/protobuf/ && '
prebuildopts += 'PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH && '

# Override PREFIX variable from Makefile
installopts = "PREFIX=%(installdir)s"

sanity_check_paths = {
    'files': ['sbin/criu', 'bin/crit', 'bin/compel'],
    'dirs': [],
}

sanity_check_commands = [
    "criu --help",
    "crit --help",
]

moduleclass = 'system'
