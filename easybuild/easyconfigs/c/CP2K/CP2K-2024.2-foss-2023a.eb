name = 'CP2K'
version = '2024.2'

homepage = 'https://www.cp2k.org/'
description = """CP2K is a freely available (GPL) program, written in Fortran 95, to perform atomistic and molecular
 simulations of solid state, liquid, molecular and biological systems. It provides a general framework for different
 methods such as e.g. density functional theory (DFT) using a mixed Gaussian and plane waves approach (GPW), and
 classical pair and many-body potentials. """

toolchain = {'name': 'foss', 'version': '2023a'}
toolchainopts = {'pic': True, 'openmp': True}

source_urls = ['https://github.com/%(namelower)s/%(namelower)s/releases/download/v%(version)s']
sources = [SOURCELOWER_TAR_BZ2]
checksums = ['cc3e56c971dee9e89b705a1103765aba57bf41ad39a11c89d3de04c8b8cdf473']

builddependencies = [
    ('flex', '2.6.4'),
    ('Bison', '3.8.2'),
]

dependencies = [
    ('Libint', '2.7.2', '-lmax-6-cp2k'),
    ('libxc', '6.2.2'),
    ('libvori', '220621'),
    ('FFTW', '3.3.10'),
    ('HDF5', '1.14.0'),
    ('PLUMED', '2.9.3'),
    ('SIRIUS', '7.5.2'),
    ('spglib', '2.5.0'),
    ('GSL', '2.7'),
    ('ELPA', '2023.05.001'),
]

if ARCH == 'x86_64':
    # LIBXSMM is not supported supported on ARM with GCC 12.2.0 and 12.3.0
    # see https://www.cp2k.org/dev:compiler_support
    dependencies += [
        ('libxsmm', '1.17'),
    ]

configopts = '-D__SIRIUS '

type = 'psmp'

ignore_regtest_fails = True

sanity_check_paths = {
    'files': ['bin/%(namelower)s.psmp'],
    'dirs': ['data', 'tests'],
}

moduleclass = 'chem'

#E1:
    # -> put all at 1 -> log5.txt
    # -> --maxtasks 4 --mpiranks 1 --ompthreads 2 -> log4.txt
    # -> --maxtasks 1 --mpiranks 1 --ompthreads 2 -> no: maxtasks >= mpiranks * ompthreads and maxtasks * ompthreads <= #cpus
        # https://github.com/vscentrum/vsc-software-stack/issues/297#issuecomment-2230793160
    # -> set flags: --maxtasks 4 --mpiranks 1 --ompthreads 4 -> log3.txt -> NO
        # python /tmp/vsc47063/easybuild/build/CP2K/2024.2/foss-2023a/cp2k-2024.2/tests/do_regtest.py --maxtasks 4 --mpiranks 1 --ompthreads 4 Linux-x86-64-foss psmp
    # -> run mympirun - update block with --mpiexec mympirun -> log2.txt:
        # *************************** Testing started ****************************
        # Traceback (most recent call last):
        # File "/apps/gent/RHEL9/cascadelake-ib/software/vsc-mympirun/5.4.0/bin/mympirun", line 15, in <module>
        #     __import__('pkg_resources').run_script('vsc-mympirun==5.4.0', 'mympirun')
        # File "/usr/lib/python3.9/site-packages/pkg_resources/__init__.py", line 3243, in <module>
        #     def _initialize_master_working_set():
        # File "/usr/lib/python3.9/site-packages/pkg_resources/__init__.py", line 3226, in _call_aside
        #     f(*args, **kwargs)
        # File "/usr/lib/python3.9/site-packages/pkg_resources/__init__.py", line 3255, in _initialize_master_working_set
        #     working_set = WorkingSet._build_master()
        # File "/usr/lib/python3.9/site-packages/pkg_resources/__init__.py", line 568, in _build_master
        #     ws.require(__requires__)
        # File "/usr/lib/python3.9/site-packages/pkg_resources/__init__.py", line 886, in require
        #     needed = self.resolve(parse_requirements(requirements))
        # File "/usr/lib/python3.9/site-packages/pkg_resources/__init__.py", line 772, in resolve
        #     raise DistributionNotFound(req, requirers)
        # pkg_resources.DistributionNotFound: The 'vsc-mympirun==5.4.0' distribution was not found and is required by the application
        # Could not parse feature flags.
    # -> ssh nodexxx -> log1.txt
    # >>> python /tmp/vsc47063/easybuild/build/CP2K/2024.2/foss-2023a/cp2k-2024.2/tests/do_regtest.py --mpiranks 2 --ompthreads 2 Linux-x86-64-foss psmp
        # == 2025-07-29 12:48:34,271 build_log.py:322 INFO FAILED: Installation ended unsuccessfully: An error was raised during test step: 'Regression test failed (non-zero exit code): 
        # *************************** Testing started ****************************
        # --------------------------------------------------------------------------
        # There are not enough slots available in the system to satisfy the 2 slots that were requested by the application:
        # /tmp/vsc47063/easybuild/build/CP2K/2024.2/foss-2023a/cp2k-2024.2/exe/Linux-x86-64-foss/cp2k.psmp
        # Either request fewer slots for your application, or make more slots available for use.
        # A "slot" is the Open MPI term for an allocatable unit where we can launch a process.  
        # The number of slots available are defined by the environment in which Open MPI processes are run:
        # 1. Hostfile, via "slots=N" clauses (N defaults to number of processor cores if not provided)
        # 2. The --host command line parameter, via a ":N" suffix on the hostname (N defaults to 1 if not provided)
        # 3. Resource manager (e.g., SLURM, PBS/Torque, LSF, etc.)
        # 4. If none of a hostfile, the --host command line parameter, or an RM is present, Open MPI defaults to the number of processor cores
        # In all the above cases, if you want Open MPI to default to the number of hardware threads instead of the number of processor cores, use the
        # --use-hwthread-cpus option. Alternatively, you can use the --oversubscribe option to ignore the number of available slots when deciding the number of processes to launch.
        # --------------------------------------------------------------------------Could not parse feature flags.' (took 6 mins 24 secs)
