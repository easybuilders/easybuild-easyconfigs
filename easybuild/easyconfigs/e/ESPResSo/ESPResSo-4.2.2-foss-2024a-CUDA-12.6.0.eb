easyblock = 'CMakeMake'

name = 'ESPResSo'
version = '4.2.2'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://espressomd.org/wordpress'
description = """A software package for performing and analyzing scientific Molecular Dynamics simulations."""

source_urls = ['https://github.com/espressomd/espresso/releases/download/%(version)s/']
sources = [SOURCELOWER_TAR_GZ]
patches = ['ESPResSo-4.2.2_fix_using_cuda_namespace.patch',
           'ESPResSo-4.2.2_fix_unit_test_packaging_specifiers.patch',
           'ESPResSo-4.2.2_fix_cuda_archs.patch']
checksums = ['2bc02f91632b0030f1203759768bd718bd8a0005f72696980b12331b4bfa0d76',
             {'ESPResSo-4.2.2_fix_using_cuda_namespace.patch':
              '94b423c5a25fd474d91e28ffacda863cadb9092662522d2b4fe682e3570b79bb'},
             {'ESPResSo-4.2.2_fix_unit_test_packaging_specifiers.patch':
              '6fdb9a61812b7a1178804c82254e837bc69552cfc3d40011de3686ea1a6ff527'},
             {'ESPResSo-4.2.2_fix_cuda_archs.patch':
              'e34c589b8bac9285d76993671018aecf3050eea1efeab5400fdeded41caa70a3'},
             ]

toolchain = {'name': 'foss', 'version': '2024a'}
toolchainopts = {'usempi': True, 'pic': True}

builddependencies = [
    ('CMake', '3.29.3'),
    ('Cython', '3.0.10'),
]

dependencies = [
    ('Python', '3.12.3'),
    ('SciPy-bundle', '2024.05'),
    ('Boost.MPI', '1.85.0'),
    ('HDF5', '1.14.5'),
    ('Mesa', '24.1.3'),
    ('GSL', '2.8'),
    ('IPython', '8.28.0'),
    ('Pint', '0.24.4'),
    ('CUDA', '12.6.0', '', SYSTEM),
]

# default CUDA compute capabilities to use (override via --cuda-compute-capabilities)
cuda_compute_capabilities = ['5.2', '6.0', '7.0', '7.5', '8.0', '8.6', '9.0']

configopts = ' -DCMAKE_SKIP_RPATH=OFF -DWITH_TESTS=ON -DWITH_CUDA=ON'
# make sure the right Python is used (note: -DPython3_EXECUTABLE or -DPython_EXECUTABLE does not work!)
configopts += ' -DPYTHON_EXECUTABLE=$EBROOTPYTHON/bin/python '
configopts += ' -DESPRESSO_CUDA_ARCHITECTURES="%(cuda_cc_cmake)s" '

runtest = 'check_unit_tests && make check_python'

_binaries = ['ipypresso',  'pypresso']
_libs = [
    'Espresso_config', 'Espresso_core', 'Espresso_script_interface', 'Espresso_shapes',
    '_init', 'analyze', 'code_info', 'electrokinetics', 'galilei',
    'integrate', 'interactions', 'lb', 'particle_data', 'polymer', 'profiler',
    'script_interface', 'system', 'thermostat', 'utils', 'version',
]

_lib_path = 'lib/python%(pyshortver)s/site-packages/espressomd'

sanity_check_paths = {
    'files': ['bin/%s' % x for x in _binaries] +
             [_lib_path + '/%s.' % x + SHLIB_EXT for x in _libs],
    'dirs': ['bin', 'lib']
}

sanity_check_commands = ['pypresso -h', 'ipypresso -h']

moduleclass = 'chem'
