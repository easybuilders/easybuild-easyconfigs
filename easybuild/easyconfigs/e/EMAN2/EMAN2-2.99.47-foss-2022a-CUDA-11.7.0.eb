easyblock = 'CMakePythonPackage'

name = 'EMAN2'
version = '2.99.47'
_boost_ver = '1.79.0'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://blake.bcm.edu/emanwiki/EMAN2'
description = """
EMAN2 is the successor to EMAN1. It is a broadly based greyscale scientific     
image processing suite  with a primary focus on processing data from            
transmission electron microscopes. """

toolchain = {'name': 'foss', 'version': '2022a'}
toolchainopts = {'pic': True}
options = {'modulename': name}

github_account = 'cryoem'
source_urls = [GITHUB_SOURCE]
sources = ['v%(version)s.tar.gz']
patches = [
    'EMAN2-2.3_use_default_cmake_search_paths.patch',
    'EMAN2-2.3_fix_gsl_include.patch',
    'EMAN2-2.3_fix_missing_stdio.patch',
    'EMAN2-2.91_fix_install_prefix.patch',
    'EMAN2-2.91_fix_multiref_polar_ali_2d_delta_definition.patch',
    'EMAN2-%(version)s_Python3_SITELIB.patch',
    'EMAN2-%(version)s_sphire_install_dir.patch',
    'EMAN2-%(version)s_sphire_qt_cast_int.patch',
]
checksums = [
    {'v2.99.47.tar.gz': '9598122fec462e402e3460ff66b142d8a9057b5398b1f68d7c8c3134efbf988d'},
    {'EMAN2-2.3_use_default_cmake_search_paths.patch':
     '21b1b546e5b3eba795780acd2c32b662e741e8a366eb354288ca6a3b22760d65'},
    {'EMAN2-2.3_fix_gsl_include.patch': '5b0e45292c1446ebb9a31c46b7bd4ff317cdb246fdc218ff61e4892aeff87a20'},
    {'EMAN2-2.3_fix_missing_stdio.patch': '4b09bb41dd81f6d7caa468f0e8849cebe28fd0a1229c883101fa32cdfcb14e7d'},
    {'EMAN2-2.91_fix_install_prefix.patch': '75c8744d482cb46313d8849c0e765b37452e07cfa5107fee00ebb77bb9bf1c99'},
    {'EMAN2-2.91_fix_multiref_polar_ali_2d_delta_definition.patch':
     '49dc7d585d12bce08f2edf65070c9006da2b0e085451d38ef08a5482874fa678'},
    {'EMAN2-2.99.47_Python3_SITELIB.patch': '63b4981f66c170e3583e4a34792ea63d1d7c89d1cc35f449d36fec016058492b'},
    {'EMAN2-2.99.47_sphire_install_dir.patch': '462accb207bc962ce746667f69b0c4646fd11841989b3e9a2ab87bb78e6ba2ee'},
    {'EMAN2-2.99.47_sphire_qt_cast_int.patch': '18e2618fb3fd95847df40e175ab873b5cd94fb61ec54358a9d3690e1760e5860'},
]

configopts = '-DENABLE_EMAN_CUDA=ON -DENABLE_SPARX_CUDA=ON '

builddependencies = [
    ('pkg-config', '0.29.2'),
    ('CMake', '3.24.3'),
]

dependencies = [
    ('Python', '3.10.4'),
    ('Boost', _boost_ver),
    ('Boost.Python-NumPy', _boost_ver),
    ('freetype', '2.12.1'),
    ('FTGL', '2.4.0'),
    ('GSL', '2.7'),
    ('zlib', '1.2.12'),
    ('HDF5', '1.12.2'),
    ('IPython', '8.5.0'),
    ('libGLU', '9.0.2'),
    ('libjpeg-turbo', '2.1.3'),
    ('LibTIFF', '4.3.0'),
    ('libpng', '1.6.37'),
    ('Mesa', '22.0.3'),
    ('PyQt5', '5.15.5'),
    ('bsddb3', '6.2.9'),
    ('PyOpenGL', '3.1.6'),
    ('SciPy-bundle', '2022.05'),
    ('scikit-learn', '1.1.2'),
    ('matplotlib', '3.5.2'),  # req. for sphire
    ('tqdm', '4.64.0'),       # req. for sphire
    ('CUDA', '11.7.0', '', True),
    ('UCX-CUDA', '1.12.1', versionsuffix),
    ('TensorFlow', '2.11.0', versionsuffix),  # req. for e2tomoseg_convert
]

exts_defaultclass = 'PythonPackage'
exts_default_options = {
    'source_urls': [PYPI_SOURCE], 
    'use_pip': True,
    'download_dep_fail': True,
}
exts_list = [
    ('mpi', '1.0.0', {
        'checksums': ['c1f87d6c213ef9102607e0321a2b07bb673359135ce2de06116591b48b90eb4a'],
    }),
]

sanity_pip_check = True

sanity_check_commands = [
    'e2version.py -h',
    'e2speedtest.py'
]

sanity_check_paths = {
    'files': ['lib/libEM2SparxCuda.%s' % SHLIB_EXT, 'lib/python%(pyshortver)s/site-packages/EMAN2_meta.py'],
    'dirs': ['bin', 'examples', 'fonts', 'images', 'lib', 'lib64', 'test', 'utils']
}

moduleclass = 'bio'
