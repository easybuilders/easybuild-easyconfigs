easyblock = 'PythonBundle'

name = 'ESMValTool'
version = '2.0a1'
versionsuffix = '-Python-%(pyver)s'

homepage = 'https://www.esmvaltool.org/'
description = """The Earth System Model eValuation Tool (ESMValTool)
 is a community diagnostics and performance metrics tool
 for the evaluation of Earth System Models (ESMs) that
 allows for routine comparison of single or multiple models,
 either against predecessor versions or against observations."""

toolchain = {'name': 'intel', 'version': '2018b'}
toolchainopts = {'pic': True}

dependencies = [
    ('Python', '3.6.6'),
    ('NCL', '6.6.2'),
    ('R', '3.5.1'),
    ('CDO', '1.9.5'),
    ('GEOS', '3.6.2', versionsuffix),
    ('libjpeg-turbo', '2.0.0'),
    ('libpng', '1.6.34'),
    ('zlib', '1.2.11'),
    ('LibTIFF', '4.0.9'),
    ('freetype', '2.9.1'),
    ('PROJ', '5.0.0'),
    ('GDAL', '2.2.3', versionsuffix),
    ('libmo_unpack', '3.1.2'),
    ('ecCodes', '2.9.2'),
    ('matplotlib', '3.0.0', versionsuffix),
    ('Pillow', '5.3.0', versionsuffix),
    ('PyYAML', '3.13', versionsuffix),
    ('Pyke3', '1.1.1', versionsuffix),
    ('numba', '0.41.0', versionsuffix),
    ('basemap', '1.2.0', versionsuffix),
    ('dask', '1.0.0', versionsuffix),
    ('ncdf4', '1.16.1', '-R-3.5.1'),
]

use_pip = True

exts_list = [
    ('cftime', '1.0.3.4', {
        'source_urls': ['https://pypi.python.org/packages/source/c/cftime'],
        'checksums': ['dd74d0d470baf1c50e31335215793a5e78436903e34b4f151fa9ccbf3a6cc20c'],
    }),
    ('netCDF4', '1.5.0', {
        'modulename': 'netCDF4',
        'source_urls': ['https://pypi.python.org/packages/source/n/netCDF4/'],
        'checksums': ['c258d1104f5fe0f110f4a140b0c84ebf32c2cc5803f186ee72fa93a4a464c0d9'],
    }),
    ('cdo', '1.5.2', {
        'source_urls': ['https://pypi.python.org/packages/source/c/cdo/'],
        'checksums': ['eb4a6dbae6656f7a6f7822f0429aedd410e799df9a0ec37e9c55256d5808be56'],
    }),
    ('Shapely', '1.6.4.post2', {
        'source_urls': ['https://pypi.python.org/packages/source/s/Shapely/'],
        'checksums': ['c4b87bb61fc3de59fc1f85e71a79b0c709dc68364d9584473697aad4aa13240f'],
    }),
    ('stratify', '0.1', {
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/SciTools-incubator/python-stratify/archive/'],
        'checksums': ['e154383bd2336122d153daa85f5ec9f5ba7639df0bf6ee66a52a7fb7b30d3377'],
    }),
    ('yamale', '1.10.0', {
        'source_urls': ['https://pypi.python.org/packages/source/y/yamale/'],
        'checksums': ['0d77ed01ae30a0f4537dfd268e809118f86251ce4a6ab989f888f5f30890373e'],
    }),
    ('Cartopy', '0.17.0', {
        'source_urls': ['https://pypi.python.org/packages/source/c/Cartopy/'],
        'checksums': ['424bd9e9ddef6e48cbdee694ce589ec431be8591f15b6cb93cb2b333a29b2c61'],
    }),
    ('antlr4-python3-runtime', '4.7.2', {
        'modulename': 'antlr4',
        'source_urls': ['https://pypi.python.org/packages/source/a/antlr4-python3-runtime/'],
        'checksums': ['168cdcec8fb9152e84a87ca6fd261b3d54c8f6358f42ab3b813b14a7193bb50b'],
    }),
    ('cf-units', '2.1.1', {
        'source_urls': ['https://pypi.python.org/packages/source/c/cf_units/'],
        'checksums': ['fa0ef8efd84546e61088aa23e76ebbaf7043167dc3a7f35f34549c234b543530'],
    }),
    ('scitools-iris', '2.2.0', {
        'modulename': 'iris',
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/SciTools/iris/archive/'],
        'checksums': ['3ba0b78b93cb69d8c865b9cdcde57be2da9b174096a1c075e6fc9188c8f8afd1'],
    }),
    (name, version, {
        'source_tmpl': 'v%(version)s.tar.gz',
        'source_urls': ['https://github.com/ESMValGroup/ESMValTool/archive/'],
        'checksums': ['65569703f40357adf0964cb1e483e0170f2a0641ae2efb5fde7fdeae52cae74c'],
    }),
]

# pip installs the esmvaltools module but not the other modules such as cmor
postinstallcmds = ['cp -a %(builddir)s/%(name)s/%(name)s-%(version)s/%(namelower)s '
                   '%(installdir)s/lib/python%(pyshortver)s/site-packages/']

moduleclass = 'geo'
