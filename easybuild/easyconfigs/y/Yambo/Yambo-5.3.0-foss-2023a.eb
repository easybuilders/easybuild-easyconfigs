##
# Author: Nicola Spallanzani <nicola.spallanzani@cnr.it>
##

easyblock = 'MakeCp'

name = 'Yambo'
# see https://github.com/yambo-code/yambo/wiki/Releases-%28tar.gz-format%29
version = '5.3.0'

homepage = 'http://www.yambo-code.org'
description = """Yambo is a FORTRAN/C code for Many-Body calculations in solid state and molecular physics.
 Yambo relies on the Kohn-Sham wavefunctions generated by two DFT public codes: abinit, and PWscf."""

toolchain = {'name': 'foss', 'version': '2023a'}
toolchainopts = {'usempi': True, 'openmp': True}

local_yambo_ext_cmd = 'mkdir yambo-%(version)s && '
local_yambo_ext_cmd += 'tar --strip-components=1 -xzf %s -C yambo-%(version)s'

source_urls = ['https://github.com/yambo-code/yambo/archive/']
sources = [
    {
        'download_filename': '%(version)s.tar.gz',
        'filename': 'yambo-%(version)s.tar.gz',
        'extract_cmd': local_yambo_ext_cmd,
    },
    {
        # see https://github.com/yambo-code/yambo/wiki/Libraries#external-libraries
        'source_urls': ['https://github.com/yambo-code/yambo-libraries/raw/refs/heads/master/external/'],
        'filename': 'iotk-y1.2.2.tar.gz',
        'extract_cmd': 'cp %s yambo-%(version)s/lib/archive/',
    },
]
patches = ['Yambo-5.3_fix-timing.patch']
checksums = [
    {'yambo-5.3.0.tar.gz': '97b6867c28af6ea690bb02446745e817adcedf95bcd568f132ef3510abbb1cfe'},
    {'iotk-y1.2.2.tar.gz': '64af6a4b98f3b62fcec603e4e1b00ef994f95a0efa53ab6593ebcfe6de1739ef'},
    {'Yambo-5.3_fix-timing.patch': 'e12b0da1038b7542222856c50dd483015b010678158d4f60eb0e2f5c0df60f13'},
]
dependencies = [
    ('FFTW.MPI', '3.3.10'),
    ('HDF5', '1.14.0'),
    ('netCDF', '4.9.2'),
    ('netCDF-Fortran', '4.6.1'),
    ('FlexiBLAS', '3.3.1'),
    ('ScaLAPACK', '2.2.0', '-fb'),
    ('PETSc', '3.20.3', '-single-fb'),
    ('SLEPc', '3.20.1', '-single-fb'),
    ('libxc', '6.2.2'),
    ('DeviceXlib', '0.8.6', '-fb'),
]

with_configure = True

preconfigopts = ' && '.join([
    'export CPP="gcc -E -P"',
    'export CPPFLAGS="-P"',
    'export FPP="gfortran -E -P -cpp"',
    'export FCFLAGS="-O3 -g -mtune=native -fno-lto -fopenmp"',
    'export FFLAGS="-O3 -g -mtune=native -fno-lto -fopenmp"',
    'export CFLAGS="-O2 -D_C_US -D_FORTRAN_US"',
]) + ' && '


configopts = 'MPIFC=mpifort MPICC=mpicc FC=gfortran CC=gcc F77=gfortran '
configopts += '--prefix=%(builddir)s/%(namelower)s-%(version)s/ '
configopts += '--enable-mpi --enable-open-mp --enable-hdf5-par-io --enable-msgs-comps '
configopts += '--with-blas-libs="-L$EBROOTFLEXIBLAS/lib -lflexiblas" '
configopts += '--with-lapack-libs="-L$EBROOTFLEXIBLAS/lib -lflexiblas" '
configopts += '--with-scalapack-libs="-L$EBROOTSCALAPACK/lib -lscalapack" '
configopts += '--with-blacs-libs="-L$EBROOTSCALAPACK/lib -lscalapack" '
configopts += '--with-fft-path="$EBROOTFFTWMPI" '
configopts += '--with-netcdf-path="$EBROOTNETCDF" '
configopts += '--with-netcdff-path="$EBROOTNETCDFMINFORTRAN" '
configopts += '--with-hdf5-path="$EBROOTHDF5" '
configopts += '--with-petsc-path="$EBROOTPETSC" '
configopts += '--with-slepc-path="$EBROOTSLEPC" '
configopts += '--with-libxc-path="$EBROOTLIBXC" '
configopts += '--with-devxlib-path="$EBROOTDEVICEXLIB" '
configopts += '--enable-par-linalg --enable-slepc-linalg '

prebuildopts = 'unset LIBS && '
prebuildopts += "export SHELL='sh -x' && "

buildopts = 'all'

files_to_copy = [
    (['bin/*'], 'bin'),
]

sanity_check_paths = {
    'files': ['bin/' + x for x in ['a2y', 'p2y', 'yambo', 'ypp']],
    'dirs': []
}

sanity_check_commands = ["yambo -h"]

moduleclass = 'phys'
