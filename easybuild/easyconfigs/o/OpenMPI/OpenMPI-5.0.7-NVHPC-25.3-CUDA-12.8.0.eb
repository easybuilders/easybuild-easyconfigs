name = 'OpenMPI'
version = '5.0.7'

homepage = 'https://www.open-mpi.org/'
description = """The Open MPI Project is an open source MPI-3 implementation."""

toolchain = {'name': 'NVHPC', 'version': '25.3-CUDA-12.8.0'}

source_urls = ['https://www.open-mpi.org/software/ompi/v%(version_major_minor)s/downloads']
sources = [SOURCELOWER_TAR_BZ2]
patches = [
    'OpenMPI-5.0.3_fix_hle_make_errors.patch',
    'OpenMPI-5.0.3_disable_opal_path_nfs_test.patch',
    'OpenMPI-5.0.7_fix-sshmem-build-failure.patch',
    ('OpenMPI-5.0.7_build-with-internal-cuda-header.patch', 1),
    'OpenMPI-5.0.7_fix_gpfs_compatibility.patch',
]
checksums = [
    {'openmpi-5.0.7.tar.bz2': '119f2009936a403334d0df3c0d74d5595a32d99497f9b1d41e90019fee2fc2dd'},
    {'OpenMPI-5.0.3_fix_hle_make_errors.patch': '881c907a9f5901d5d6af41cd33dffdcecba4a67a9e5123e602542aea57a80895'},
    {'OpenMPI-5.0.3_disable_opal_path_nfs_test.patch':
     '75d4417e35252ea3a19b2792f1b06e9aeb408c253aa4921d77226d57b71dee45'},
    {'OpenMPI-5.0.7_fix-sshmem-build-failure.patch':
     '7382a5bbe44c6eff9ab05c8f315a8911d529749655126d4375e44e809bfedec7'},
    {'OpenMPI-5.0.7_build-with-internal-cuda-header.patch':
     '14ffaf02a9c675ac66a2a9af727295179d4ce097174c88db59669d460d8c4da1'},
    {'OpenMPI-5.0.7_fix_gpfs_compatibility.patch': '9739134ce273a691c9deac6e410510653a88c1542b60dbf8789e4a423447d4f6'},
]

builddependencies = [
    ('pkgconf', '2.3.0'),
    ('Perl', '5.40.0'),
    ('Autotools', '20240712'),
]

dependencies = [
    ('zlib', '1.3.1'),
    ('hwloc', '2.11.2'),
    ('libevent', '2.1.12'),
    ('UCX', '1.18.0'),
    ('UCX-CUDA', '1.18.0', '-CUDA-%(cudaver)s'),
    ('libfabric', '2.0.0'),
    ('PMIx', '5.0.6'),
    ('PRRTE', '3.0.8'),
    ('UCC', '1.3.0'),
    ('UCC-CUDA', '1.3.0', '-CUDA-%(cudaver)s'),
]

# CUDA related patches and custom configure option can be removed if CUDA support isn't wanted.
preconfigopts = 'nvc -Iopal/mca/cuda/include -shared opal/mca/cuda/lib/cuda.c -o opal/mca/cuda/lib/libcuda.so && '
# Update configure to include changes from the "disable_opal_path_nfs_test" patch
preconfigopts += './autogen.pl --force && '

configopts = '--with-cuda=%(start_dir)s/opal/mca/cuda '
# Required to prevent internal compiler error in opal.
configopts += ' --enable-alt-short-float=no'
# Do not pick up the system library automatically
configopts += ' --without-xpmem'
# Set PGI compilers manually, as NVHPC compilers are not correctly detected
configopts += ' CC=pgcc CXX=pgc++ FC=pgfortran'
# Disable ISO_FORTRAN_ENV:REAL16 support https://github.com/open-mpi/ompi/issues/13190
configopts += ' ompi_cv_fortran_have_iso_fortran_env_real16=n'

# site specific options
# configopts += ' --without-psm2 '
# configopts += ' --disable-oshmem '
# configopts += ' --with-gpfs '
# configopts += ' --with-slurm '

moduleclass = 'mpi'
